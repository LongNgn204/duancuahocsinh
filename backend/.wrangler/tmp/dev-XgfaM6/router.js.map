{
  "version": 3,
  "sources": ["../bundle-DOY1fv/strip-cf-connecting-ip-header.js", "wrangler-modules-watch:wrangler:modules-watch", "../../../node_modules/wrangler/templates/modules-watch-stub.js", "../../../workers/risk.js", "../../../workers/sanitize.js", "../../../workers/memory.js", "../../../workers/token-tracker.js", "../../../workers/ai-proxy.js", "../bundle-DOY1fv/middleware-loader.entry.ts", "../bundle-DOY1fv/middleware-insertion-facade.js", "../../../workers/router.js", "../../../workers/auth.js", "../../../workers/data-api.js", "../../../workers/forum-api.js", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../node_modules/wrangler/templates/middleware/common.ts"],
  "sourceRoot": "C:\\Users\\Long\\Documents\\duancuahocsinh\\backend\\.wrangler\\tmp\\dev-XgfaM6",
  "sourcesContent": ["function stripCfConnectingIPHeader(input, init) {\n\tconst request = new Request(input, init);\n\trequest.headers.delete(\"CF-Connecting-IP\");\n\treturn request;\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\treturn Reflect.apply(target, thisArg, [\n\t\t\tstripCfConnectingIPHeader.apply(null, argArray),\n\t\t]);\n\t},\n});\n", "", "// `esbuild` doesn't support returning `watch*` options from `onStart()`\n// plugin callbacks. Instead, we define an empty virtual module that is\n// imported by this injected file. Importing the module registers watchers.\nimport \"wrangler:modules-watch\";\n", "// backend/workers/risk.js\r\n// Ch\u00FA th\u00EDch: Module ph\u00E2n lo\u1EA1i r\u1EE7i ro SOS theo 3 t\u1EA7ng (rules-first)\r\n// RED: t\u1EF1 h\u1EA1i/b\u1EA1o l\u1EF1c/c\u00F3 k\u1EBF ho\u1EA1ch \u2192 h\u01B0\u1EDBng d\u1EABn hotline, kh\u00F4ng t\u01B0 v\u1EA5n s\u00E2u\r\n// YELLOW: tuy\u1EC7t v\u1ECDng k\u00E9o d\u00E0i/b\u1EAFt n\u1EA1t/m\u01A1 h\u1ED3 \u2192 check-in + k\u1EF9 thu\u1EADt \u1ED5n \u0111\u1ECBnh\r\n// GREEN: stress th\u01B0\u1EDDng ng\u00E0y \u2192 mentor b\u00ECnh th\u01B0\u1EDDng\r\n\r\n// T\u1EEB kh\u00F3a RED - c\u1EA7n can thi\u1EC7p ngay\r\nconst RED_PATTERNS = [\r\n    // \u00DD \u0111\u1ECBnh t\u1EF1 h\u1EA1i r\u00F5 r\u00E0ng\r\n    't\u1EF1 t\u1EED', 't\u1EF1 v\u1EABn', 't\u1EF1 s\u00E1t',\r\n    'mu\u1ED1n ch\u1EBFt', 'm\u00FAn ch\u1EBFt', 'muon chet',\r\n    'k\u1EBFt th\u00FAc cu\u1ED9c \u0111\u1EDDi', 'k\u1EBFt th\u00FAc t\u1EA5t c\u1EA3',\r\n    'ch\u1EBFt \u0111i cho r\u1ED3i', 'ch\u1EBFt \u0111i', 'ch\u1EBFt \u0111c r\u1ED3i',\r\n    'kh\u00F4ng mu\u1ED1n s\u1ED1ng', 'k mu\u1ED1n s\u1ED1ng', 'ko muon song',\r\n    's\u1ED1ng l\u00E0m g\u00EC', 's\u1ED1ng \u0111\u1EC3 l\u00E0m g\u00EC', 's\u1ED1ng chi',\r\n    'mu\u1ED1n bi\u1EBFn m\u1EA5t', 'bi\u1EBFn m\u1EA5t kh\u1ECFi \u0111\u1EDDi',\r\n    // T\u1EF1 l\u00E0m h\u1EA1i\r\n    't\u1EF1 l\u00E0m h\u1EA1i', 't\u1EF1 c\u1EAFt', 'r\u1EA1ch tay',\r\n    'u\u1ED1ng thu\u1ED1c ng\u1EE7', 'overdose', 't\u1EF1 hurt',\r\n    // B\u1EA1o l\u1EF1c/l\u1EA1m d\u1EE5ng\r\n    'b\u1ECB x\u00E2m h\u1EA1i', 'b\u1ECB l\u1EA1m d\u1EE5ng', 'b\u1ECB s\u1EDD so\u1EA1ng',\r\n    // C\u00F3 k\u1EBF ho\u1EA1ch c\u1EE5 th\u1EC3\r\n    '\u0111\u00E3 chu\u1EA9n b\u1ECB', 'c\u00F3 k\u1EBF ho\u1EA1ch', 'ngay b\u00E2y gi\u1EDD',\r\n\r\n    // ===== GEN Z VOCABULARY - PHASE 1 ADDITION =====\r\n    // Ti\u1EBFng l\u00F3ng \"mu\u1ED1n ch\u1EBFt\"\r\n    'm\u00FAn \u0111i lu\u00F4n', 'mu\u1ED1n \u0111i lu\u00F4n', '\u0111i lu\u00F4n cho r\u1ED3i',\r\n    'ng\u1EE7 lu\u00F4n', 'ng\u1EE7 m\u00E3i', 'sleep forever',\r\n    '\u0111i kh\u1ECFi th\u1EBF gi\u1EDBi', 'r\u1EDDi kh\u1ECFi th\u1EBF gi\u1EDBi n\u00E0y',\r\n    'end game', 'game over \u0111\u1EDDi', 'gg \u0111i',\r\n    'b\u00E1i bai th\u1EBF gi\u1EDBi', 'bye bye cu\u1ED9c \u0111\u1EDDi',\r\n    // M\u1EA1ng x\u00E3 h\u1ED9i style\r\n    'ko th\u1EC3 ti\u1EBFp t\u1EE5c n\u1EEFa', 'h\u1EBFt n\u0103ng l\u01B0\u1EE3ng s\u1ED1ng',\r\n    'c\u1EA1n pin r\u1ED3i', 'bat low qu\u00E1', 'energy = 0',\r\n    // Vi\u1EBFt t\u1EAFt ph\u1ED5 bi\u1EBFn\r\n    'kts', 'mu\u1ED1n c', 'mu\u1ED1n die',\r\n    // Patterns m\u1EDBi - Phase 4\r\n    'kh\u00F4ng c\u00F2n l\u00FD do s\u1ED1ng', 'h\u1EBFt l\u00FD do s\u1ED1ng',\r\n    't\u1ED1t nh\u1EA5t l\u00E0 ch\u1EBFt', 'ch\u1EBFt l\u00E0 gi\u1EA3i ph\u00E1p',\r\n    's\u1EBD t\u1EF1 t\u1EED', 's\u1EBD t\u1EF1 s\u00E1t', 's\u1EBD t\u1EF1 v\u1EABn',\r\n    'c\u00F3 dao', 'c\u00F3 thu\u1ED1c', 'c\u00F3 d\u00E2y',\r\n    'l\u1EA7n cu\u1ED1i', 'l\u1EDDi cu\u1ED1i', 't\u1EA1m bi\u1EC7t',\r\n    'kh\u00F4ng c\u00F2n c\u00E1ch n\u00E0o', 'h\u1EBFt c\u00E1ch',\r\n];\r\n\r\n// T\u1EEB kh\u00F3a YELLOW - c\u1EA7n theo d\u00F5i\r\nconst YELLOW_PATTERNS = [\r\n    // Tuy\u1EC7t v\u1ECDng k\u00E9o d\u00E0i\r\n    'tuy\u1EC7t v\u1ECDng', 'h\u1EBFt hy v\u1ECDng', 'v\u00F4 v\u1ECDng',\r\n    'kh\u00F4ng ai quan t\u00E2m', 'kh\u00F4ng ai hi\u1EC3u', 'k ai quan t\u00E2m',\r\n    'v\u00F4 d\u1EE5ng', 'v\u00F4 \u00EDch', 'th\u1EEBa th\u00E3i',\r\n    'g\u00E1nh n\u1EB7ng cho m\u1ECDi ng\u01B0\u1EDDi', 'l\u00E0 g\u00E1nh n\u1EB7ng',\r\n    'kh\u00F4ng x\u1EE9ng \u0111\u00E1ng', 'k x\u1EE9ng \u0111\u00E1ng',\r\n    'b\u1EBF t\u1EAFc ho\u00E0n to\u00E0n', 'kh\u00F4ng c\u00F3 l\u1ED1i tho\u00E1t',\r\n    // B\u1EAFt n\u1EA1t n\u1EB7ng\r\n    'b\u1ECB b\u1EAFt n\u1EA1t', 'b\u1ECB bully', 'b\u1ECB \u0111\u00E1nh',\r\n    'b\u1ECB \u0111e d\u1ECDa', 'b\u1ECB \u00E9p bu\u1ED9c',\r\n    // M\u01A1 h\u1ED3 \"kh\u00F4ng mu\u1ED1n s\u1ED1ng\"\r\n    'kh\u00F4ng mu\u1ED1n th\u1EE9c d\u1EADy', 'ch\u00E1n s\u1ED1ng',\r\n    'm\u1EC7t m\u1ECFi v\u1EDBi cu\u1ED9c s\u1ED1ng',\r\n\r\n    // ===== GEN Z VOCABULARY - PHASE 1 ADDITION =====\r\n    // Ti\u1EBFng l\u00F3ng ch\u00E1n/bu\u1ED3n\r\n    'ch\u00E1n \u0111\u1EDDi', 'ch\u00E1n vl', 'ch\u00E1n real', 'ch\u00E1n th\u1EADt s\u1EF1',\r\n    'toang', 'toang r\u1ED3i', 'toang real', 'toang th\u1EADt s\u1EF1',\r\n    'emo qu\u00E1', '\u0111ang emo', 'emo n\u1EB7ng',\r\n    'xu\u1ED1ng tinh th\u1EA7n', 'mood \u0111i xu\u1ED1ng',\r\n    // M\u1EA1ng x\u00E3 h\u1ED9i style\r\n    'kh\u00F4ng ai care', 'no one cares', 'ai m\u00E0 hi\u1EC3u',\r\n    'c\u00F4 \u0111\u01A1n vl', 'lonely af', 'm\u1ED9t m\u00ECnh ho\u00E0i',\r\n    '\u00E1p l\u1EF1c qu\u00E1 tr\u1EDDi', 'stress vl', 'burn out r\u1ED3i',\r\n    // T\u1EF1 ti\r\n    'fail \u0111\u1EE7 th\u1EE9', 'm\u00ECnh d\u1EDF qu\u00E1', 'm\u00ECnh t\u1EC7 qu\u00E1',\r\n    'kh\u00F4ng l\u00E0m \u0111\u01B0\u1EE3c g\u00EC c\u1EA3', 'useless real',\r\n    // Gia \u0111\u00ECnh\r\n    'b\u1ED1 m\u1EB9 kh\u00F4ng hi\u1EC3u', 'b\u1ECB la ho\u00E0i', 'b\u1ECB so s\u00E1nh',\r\n    'gh\u00E9t v\u1EC1 nh\u00E0', 'kh\u00F4ng mu\u1ED1n v\u1EC1 nh\u00E0',\r\n    // Patterns m\u1EDBi - Phase 4\r\n    'kh\u00F4ng c\u00F2n hy v\u1ECDng', 'h\u1EBFt hy v\u1ECDng',\r\n    'm\u1EA5t h\u1EBFt \u0111\u1ED9ng l\u1EF1c', 'kh\u00F4ng c\u00F2n \u0111\u1ED9ng l\u1EF1c',\r\n    'c\u1EA3m th\u1EA5y v\u00F4 d\u1EE5ng', 'm\u00ECnh v\u00F4 d\u1EE5ng',\r\n    'kh\u00F4ng ai c\u1EA7n m\u00ECnh', 'th\u1EEBa th\u00E3i',\r\n    'mu\u1ED1n bi\u1EBFn m\u1EA5t', 'mu\u1ED1n tan bi\u1EBFn',\r\n];\r\n\r\n/**\r\n * Ph\u00E2n lo\u1EA1i r\u1EE7i ro SOS theo rules-first\r\n * @param {string} text - N\u1ED9i dung tin nh\u1EAFn hi\u1EC7n t\u1EA1i\r\n * @param {Array} history - L\u1ECBch s\u1EED h\u1ED9i tho\u1EA1i (optional)\r\n * @returns {'red'|'yellow'|'green'} M\u1EE9c \u0111\u1ED9 r\u1EE7i ro\r\n */\r\nexport function classifyRiskRules(text, history = []) {\r\n    if (!text) return 'green';\r\n\r\n    // Normalize text: lowercase + remove diacritics for matching\r\n    const t = String(text).toLowerCase();\r\n    const tNorm = t.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n    // Check RED patterns first\r\n    for (const pattern of RED_PATTERNS) {\r\n        const p = pattern.toLowerCase();\r\n        const pNorm = p.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n        if (t.includes(p) || tNorm.includes(pNorm)) {\r\n            return 'red';\r\n        }\r\n    }\r\n\r\n    // Check YELLOW patterns\r\n    for (const pattern of YELLOW_PATTERNS) {\r\n        const p = pattern.toLowerCase();\r\n        const pNorm = p.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n        if (t.includes(p) || tNorm.includes(pNorm)) {\r\n            return 'yellow';\r\n        }\r\n    }\r\n\r\n    // Check history for escalating patterns (optional enhancement)\r\n    if (Array.isArray(history) && history.length >= 3) {\r\n        const recentTexts = history.slice(-3).map(h => String(h.content || '').toLowerCase()).join(' ');\r\n        // N\u1EBFu c\u00F3 nhi\u1EC1u d\u1EA5u hi\u1EC7u ti\u00EAu c\u1EF1c trong history \u2192 YELLOW\r\n        let yellowCount = 0;\r\n        for (const pattern of YELLOW_PATTERNS) {\r\n            if (recentTexts.includes(pattern.toLowerCase())) yellowCount++;\r\n        }\r\n        if (yellowCount >= 2) return 'yellow';\r\n    }\r\n\r\n    return 'green';\r\n}\r\n\r\n/**\r\n * L\u1EA5y response chu\u1EA9n cho RED tier - th\u00F4ng tin hotline Vi\u1EC7t Nam\r\n * @returns {Object} Response object v\u1EDBi hotline info\r\n */\r\nexport function getRedTierResponse() {\r\n    return {\r\n        sos: true,\r\n        sosLevel: 'red',\r\n        riskLevel: 'red',\r\n        emotion: 'nguy c\u1EA5p',\r\n        reply: 'M\u00ECnh r\u1EA5t lo cho b\u1EA1n. H\u00E3y li\u00EAn h\u1EC7 ngay v\u1EDBi ng\u01B0\u1EDDi l\u1EDBn \u0111\u00E1ng tin c\u1EADy ho\u1EB7c g\u1ECDi \u0111\u01B0\u1EDDng d\u00E2y h\u1ED7 tr\u1EE3 b\u00EAn d\u01B0\u1EDBi. B\u1EA1n kh\u00F4ng \u0111\u01A1n \u0111\u1ED9c.',\r\n        nextQuestion: '',\r\n        actions: [\r\n            '\uD83D\uDCDE \u0110\u01B0\u1EDDng d\u00E2y n\u00F3ng b\u1EA3o v\u1EC7 tr\u1EBB em: 111 (mi\u1EC5n ph\u00ED, 24/7)',\r\n            '\uD83D\uDCDE T\u1ED5ng \u0111\u00E0i t\u01B0 v\u1EA5n s\u1EE9c kh\u1ECFe t\u00E2m th\u1EA7n: 1800 599 913 (mi\u1EC5n ph\u00ED)',\r\n            '\uD83D\uDCDE \u0110\u01B0\u1EDDng d\u00E2y h\u1ED7 tr\u1EE3 ph\u1EE5 n\u1EEF v\u00E0 tr\u1EBB em: 1800 1567 (mi\u1EC5n ph\u00ED)',\r\n            '\uD83D\uDCAC Nh\u1EAFn tin cho b\u1ED1 m\u1EB9, th\u1EA7y c\u00F4, ho\u1EB7c ng\u01B0\u1EDDi l\u1EDBn b\u1EA1n tin t\u01B0\u1EDFng ngay b\u00E2y gi\u1EDD'\r\n        ],\r\n        confidence: 1,\r\n        disclaimer: '\u0110\u00E2y l\u00E0 h\u1ED7 tr\u1EE3 ban \u0111\u1EA7u. C\u00E1c \u0111\u01B0\u1EDDng d\u00E2y tr\u00EAn c\u00F3 chuy\u00EAn gia s\u1EB5n s\u00E0ng l\u1EAFng nghe b\u1EA1n 24/7.'\r\n    };\r\n}\r\n\r\n// Export patterns for testing\r\nexport const RISK_PATTERNS = {\r\n    red: RED_PATTERNS,\r\n    yellow: YELLOW_PATTERNS,\r\n};\r\n", "// backend/workers/sanitize.js\r\n// Ch\u00FA th\u00EDch: Module sanitize input \u0111\u1EC3 ch\u1ED1ng prompt injection v\u00E0 n\u1ED9i dung kh\u00F4ng ph\u00F9 h\u1EE3p\r\n\r\n// Patterns ph\u00E1t hi\u1EC7n prompt injection - Phase 4 Enhanced\r\nconst INJECTION_PATTERNS = [\r\n    // C\u1ED1 g\u1EAFng override instructions\r\n    /ignore (previous|above|all) (instructions|prompts|rules)/i,\r\n    /disregard (previous|above|all)/i,\r\n    /forget (everything|all|previous)/i,\r\n    /override (system|instructions|prompt)/i,\r\n    /skip (system|instructions|rules)/i,\r\n    // C\u1ED1 g\u1EAFng \u0111\u1ED5i persona\r\n    /you are now/i,\r\n    /act as/i,\r\n    /pretend (to be|you are)/i,\r\n    /roleplay as/i,\r\n    /simulate (being|as)/i,\r\n    /become (a|an)/i,\r\n    // System prompt injection\r\n    /system:/i,\r\n    /\\[system\\]/i,\r\n    /\\[INST\\]/i,\r\n    /<<SYS>>/i,\r\n    /<\\|system\\|>/i,\r\n    /### system/i,\r\n    // Jailbreak attempts\r\n    /DAN/i,\r\n    /do anything now/i,\r\n    /jailbreak/i,\r\n    /unrestricted mode/i,\r\n    /unfiltered mode/i,\r\n    // Developer mode\r\n    /developer mode/i,\r\n    /admin mode/i,\r\n    /debug mode/i,\r\n    /test mode/i,\r\n    // Prompt injection techniques\r\n    /new instructions/i,\r\n    /new prompt/i,\r\n    /change your/i,\r\n    /modify your/i,\r\n    /update your/i,\r\n    // Base64/encoding attempts\r\n    /base64/i,\r\n    /decode this/i,\r\n    /encrypted message/i,\r\n    // Vietnamese variations\r\n    /b\u1ECF qua (h\u01B0\u1EDBng d\u1EABn|quy t\u1EAFc|l\u1EC7nh)/i,\r\n    /qu\u00EAn (t\u1EA5t c\u1EA3|m\u1ECDi th\u1EE9)/i,\r\n    /b\u1EA1n gi\u1EDD l\u00E0/i,\r\n    /\u0111\u00F3ng vai/i,\r\n];\r\n\r\n// T\u1EEB kh\u00F3a kh\u00F4ng ph\u00F9 h\u1EE3p (profanity c\u01A1 b\u1EA3n)\r\nconst PROFANITY_PATTERNS = [\r\n    // C\u00F3 th\u1EC3 m\u1EDF r\u1ED9ng th\u00EAm n\u1EBFu c\u1EA7n\r\n];\r\n\r\n/**\r\n * Sanitize input text, throw error n\u1EBFu ph\u00E1t hi\u1EC7n injection\r\n * @param {string} text - Input text c\u1EA7n ki\u1EC3m tra\r\n * @returns {string} Sanitized text\r\n * @throws {Error} N\u1EBFu ph\u00E1t hi\u1EC7n prompt injection\r\n */\r\nexport function sanitizeInput(text) {\r\n    if (!text || typeof text !== 'string') {\r\n        throw new Error('invalid_input');\r\n    }\r\n\r\n    const trimmed = text.trim();\r\n\r\n    // Check for empty after trim\r\n    if (!trimmed) {\r\n        throw new Error('empty_input');\r\n    }\r\n\r\n    // Check for prompt injection\r\n    for (const pattern of INJECTION_PATTERNS) {\r\n        if (pattern.test(trimmed)) {\r\n            throw new Error('injection_detected');\r\n        }\r\n    }\r\n\r\n    // Check for profanity (optional, c\u00F3 th\u1EC3 b\u1ECF qua \u0111\u1EC3 AI t\u1EF1 x\u1EED l\u00FD)\r\n    for (const pattern of PROFANITY_PATTERNS) {\r\n        if (pattern.test(trimmed)) {\r\n            throw new Error('profanity_detected');\r\n        }\r\n    }\r\n\r\n    // Limit length (prevent abuse)\r\n    if (trimmed.length > 2000) {\r\n        return trimmed.slice(0, 2000);\r\n    }\r\n\r\n    return trimmed;\r\n}\r\n\r\n/**\r\n * Check if input contains injection attempt (kh\u00F4ng throw, ch\u1EC9 return boolean)\r\n * @param {string} text \r\n * @returns {boolean}\r\n */\r\nexport function hasInjection(text) {\r\n    if (!text) return false;\r\n    for (const pattern of INJECTION_PATTERNS) {\r\n        if (pattern.test(text)) return true;\r\n    }\r\n    return false;\r\n}\r\n\r\n// Export patterns for testing\r\nexport const SANITIZE_PATTERNS = {\r\n    injection: INJECTION_PATTERNS,\r\n    profanity: PROFANITY_PATTERNS,\r\n};\r\n", "// backend/workers/memory.js\r\n// Ch\u00FA th\u00EDch: Module qu\u1EA3n l\u00FD context v\u00E0 memory compression\r\n// Ch\u1EC9 g\u1EEDi 5-10 messages g\u1EA7n nh\u1EA5t + memorySummary (100-200 t\u1EEB)\r\n\r\n/**\r\n * L\u1EA5y N messages g\u1EA7n nh\u1EA5t t\u1EEB history\r\n * @param {Array} history - Full history\r\n * @param {number} limit - S\u1ED1 messages t\u1ED1i \u0111a (default 8)\r\n * @returns {Array} Recent messages\r\n */\r\nexport function getRecentMessages(history = [], limit = 8) {\r\n    if (!Array.isArray(history)) return [];\r\n    return history.slice(-limit);\r\n}\r\n\r\n/**\r\n * T\u1EA1o summary t\u1EEB history c\u0169 (ph\u1EA7n b\u1ECB c\u1EAFt b\u1ECF)\r\n * @param {Array} history - Full history  \r\n * @param {number} recentLimit - S\u1ED1 messages g\u1EA7n nh\u1EA5t s\u1EBD gi\u1EEF nguy\u00EAn\r\n * @returns {string} Summary text (100-200 t\u1EEB)\r\n */\r\nexport function createMemorySummary(history = [], recentLimit = 8) {\r\n    if (!Array.isArray(history) || history.length <= recentLimit) {\r\n        return '';\r\n    }\r\n\r\n    // L\u1EA5y ph\u1EA7n history c\u0169 (s\u1EBD \u0111\u01B0\u1EE3c t\u00F3m t\u1EAFt)\r\n    const oldMessages = history.slice(0, -recentLimit);\r\n    if (oldMessages.length === 0) return '';\r\n\r\n    // T\u1EA1o summary c\u00F3 c\u1EA5u tr\u00FAc: ch\u1EE7 \u0111\u1EC1 ch\u00EDnh, c\u1EA3m x\u00FAc, nguy\u00EAn nh\u00E2n g\u1ED1c\r\n    const userMessages = oldMessages\r\n        .filter(m => m.role === 'user')\r\n        .map(m => m.content || '')\r\n        .filter(Boolean);\r\n\r\n    const assistantMessages = oldMessages\r\n        .filter(m => m.role === 'assistant')\r\n        .map(m => m.content || '')\r\n        .filter(Boolean);\r\n\r\n    // Tr\u00EDch xu\u1EA5t key information\r\n    const allText = [...userMessages, ...assistantMessages].join(' ');\r\n    const summary = extractKeyFacts(allText, userMessages);\r\n\r\n    return summary;\r\n}\r\n\r\n/**\r\n * Tr\u00EDch xu\u1EA5t facts quan tr\u1ECDng t\u1EEB text (helper function)\r\n * @param {string} text - All text\r\n * @param {Array} userMessages - User messages only\r\n * @returns {string} Key facts summary\r\n */\r\nfunction extractKeyFacts(text, userMessages = []) {\r\n    if (!text) return '';\r\n\r\n    // T\u00ECm ch\u1EE7 \u0111\u1EC1 ch\u00EDnh (t\u1EEB kh\u00F3a l\u1EB7p l\u1EA1i)\r\n    const commonTopics = ['h\u1ECDc t\u1EADp', 'gia \u0111\u00ECnh', 'b\u1EA1n b\u00E8', 't\u00ECnh c\u1EA3m', 'stress', 'lo l\u1EAFng', 'bu\u1ED3n', 'c\u00F4 \u0111\u01A1n'];\r\n    const foundTopics = commonTopics.filter(topic => \r\n        text.toLowerCase().includes(topic)\r\n    );\r\n\r\n    // T\u00ECm c\u1EA3m x\u00FAc ch\u00EDnh\r\n    const emotions = ['bu\u1ED3n', 'vui', 'gi\u1EADn', 's\u1EE3', 'lo l\u1EAFng', 'stress', 'c\u00F4 \u0111\u01A1n', 't\u1EE7i th\u00E2n', 'confused'];\r\n    const foundEmotions = emotions.filter(emotion => \r\n        text.toLowerCase().includes(emotion)\r\n    );\r\n\r\n    // L\u1EA5y key sentences t\u1EEB user messages (c\u00E2u d\u00E0i h\u01A1n 20 k\u00FD t\u1EF1)\r\n    const keySentences = userMessages\r\n        .map(msg => {\r\n            const sentences = msg.split(/[.!?]\\s+/).filter(s => s.length > 20);\r\n            return sentences.slice(0, 2); // L\u1EA5y 2 c\u00E2u \u0111\u1EA7u ti\u00EAn\r\n        })\r\n        .flat()\r\n        .slice(0, 3); // T\u1ED1i \u0111a 3 c\u00E2u\r\n\r\n    // T\u1EA1o summary c\u00F3 c\u1EA5u tr\u00FAc\r\n    const parts = [];\r\n    \r\n    if (foundTopics.length > 0) {\r\n        parts.push(`Ch\u1EE7 \u0111\u1EC1 ch\u00EDnh: ${foundTopics.join(', ')}`);\r\n    }\r\n    \r\n    if (foundEmotions.length > 0) {\r\n        parts.push(`C\u1EA3m x\u00FAc: ${foundEmotions.join(', ')}`);\r\n    }\r\n    \r\n    if (keySentences.length > 0) {\r\n        parts.push(`\u0110i\u1EC3m quan tr\u1ECDng: ${keySentences.join(' | ')}`);\r\n    }\r\n\r\n    // Fallback: n\u1EBFu kh\u00F4ng c\u00F3 g\u00EC, l\u1EA5y 150 t\u1EEB \u0111\u1EA7u\r\n    if (parts.length === 0) {\r\n        const words = text.split(/\\s+/).slice(0, 100);\r\n        return `T\u00F3m t\u1EAFt: ${words.join(' ')}${text.length > words.join(' ').length ? '...' : ''}`;\r\n    }\r\n\r\n    return parts.join('\\n');\r\n}\r\n\r\n/**\r\n * Format history th\u00E0nh messages array cho LLM\r\n * @param {string} systemPrompt - System instruction\r\n * @param {Array} history - Conversation history\r\n * @param {string} currentMessage - Current user message\r\n * @param {string} memorySummary - Optional memory summary\r\n * @returns {Array} Messages array for LLM\r\n */\r\nexport function formatMessagesForLLM(systemPrompt, history = [], currentMessage, memorySummary = '') {\r\n    const messages = [];\r\n\r\n    // System message v\u1EDBi summary n\u1EBFu c\u00F3\r\n    let systemContent = systemPrompt;\r\n    if (memorySummary) {\r\n        systemContent = `${systemPrompt}\\n\\n[NG\u1EEE C\u1EA2NH TR\u01AF\u1EDAC \u0110\u00D3]\\n${memorySummary}`;\r\n    }\r\n    messages.push({ role: 'system', content: systemContent });\r\n\r\n    // Recent history\r\n    const recent = getRecentMessages(history, 8);\r\n    for (const msg of recent) {\r\n        messages.push({\r\n            role: msg.role === 'user' ? 'user' : 'assistant',\r\n            content: msg.content || ''\r\n        });\r\n    }\r\n\r\n    // Current message\r\n    if (currentMessage) {\r\n        messages.push({ role: 'user', content: currentMessage });\r\n    }\r\n\r\n    return messages;\r\n}\r\n\r\n/**\r\n * Check if should generate new summary (khi \u0111\u1EE7 messages m\u1EDBi)\r\n * @param {number} totalMessages \r\n * @param {number} lastSummaryAt - S\u1ED1 messages khi t\u1EA1o summary l\u1EA7n cu\u1ED1i\r\n * @param {number} threshold - Ng\u01B0\u1EE1ng \u0111\u1EC3 t\u1EA1o summary m\u1EDBi (default 8)\r\n * @returns {boolean}\r\n */\r\nexport function shouldUpdateSummary(totalMessages, lastSummaryAt = 0, threshold = 8) {\r\n    return totalMessages - lastSummaryAt >= threshold;\r\n}\r\n", "// backend/workers/token-tracker.js\r\n// Ch\u00FA th\u00EDch: Module theo d\u00F5i v\u00E0 ki\u1EC3m so\u00E1t chi ph\u00ED token AI\r\n// Gi\u1EDBi h\u1EA1n: 500,000 tokens/th\u00E1ng, c\u1EA3nh b\u00E1o khi g\u1EA7n ng\u01B0\u1EE1ng\r\n\r\nconst MONTHLY_TOKEN_LIMIT = 500000; // 500k tokens/th\u00E1ng\r\nconst WARNING_THRESHOLD = 0.8; // C\u1EA3nh b\u00E1o khi \u0111\u1EA1t 80%\r\n\r\n/**\r\n * L\u1EA5y token usage cho th\u00E1ng hi\u1EC7n t\u1EA1i\r\n * @param {Object} env - Cloudflare env v\u1EDBi D1 binding\r\n * @returns {Promise<{tokens: number, month: string}>}\r\n */\r\nexport async function getTokenUsage(env) {\r\n    const now = new Date();\r\n    const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT tokens FROM token_usage WHERE month = ?'\r\n        ).bind(month).first();\r\n\r\n        return {\r\n            tokens: result?.tokens || 0,\r\n            month,\r\n        };\r\n    } catch (error) {\r\n        console.error('[TokenTracker] getTokenUsage error:', error.message);\r\n        return { tokens: 0, month };\r\n    }\r\n}\r\n\r\n/**\r\n * C\u1EADp nh\u1EADt token usage\r\n * @param {Object} env - Cloudflare env\r\n * @param {number} tokensToAdd - S\u1ED1 tokens c\u1EA7n th\u00EAm\r\n * @returns {Promise<{tokens: number, limit: number, warning: boolean}>}\r\n */\r\nexport async function addTokenUsage(env, tokensToAdd = 0) {\r\n    const now = new Date();\r\n    const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\r\n\r\n    try {\r\n        // Get current usage\r\n        const current = await getTokenUsage(env);\r\n\r\n        const newTotal = current.tokens + tokensToAdd;\r\n\r\n        // Update or insert\r\n        await env.ban_dong_hanh_db.prepare(\r\n            `INSERT INTO token_usage (month, tokens, updated_at)\r\n             VALUES (?, ?, datetime('now'))\r\n             ON CONFLICT(month) DO UPDATE SET\r\n                 tokens = tokens + ?,\r\n                 updated_at = datetime('now')`\r\n        ).bind(month, tokensToAdd, tokensToAdd).run();\r\n\r\n        const warning = newTotal >= MONTHLY_TOKEN_LIMIT * WARNING_THRESHOLD;\r\n        const exceeded = newTotal >= MONTHLY_TOKEN_LIMIT;\r\n\r\n        if (exceeded) {\r\n            console.warn(`[TokenTracker] Monthly limit exceeded: ${newTotal}/${MONTHLY_TOKEN_LIMIT}`);\r\n        } else if (warning) {\r\n            console.warn(`[TokenTracker] Approaching limit: ${newTotal}/${MONTHLY_TOKEN_LIMIT} (${Math.round((newTotal / MONTHLY_TOKEN_LIMIT) * 100)}%)`);\r\n        }\r\n\r\n        return {\r\n            tokens: newTotal,\r\n            limit: MONTHLY_TOKEN_LIMIT,\r\n            warning,\r\n            exceeded,\r\n        };\r\n    } catch (error) {\r\n        console.error('[TokenTracker] addTokenUsage error:', error.message);\r\n        return {\r\n            tokens: 0,\r\n            limit: MONTHLY_TOKEN_LIMIT,\r\n            warning: false,\r\n            exceeded: false,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Ki\u1EC3m tra xem c\u00F3 v\u01B0\u1EE3t qu\u00E1 gi\u1EDBi h\u1EA1n kh\u00F4ng\r\n * @param {Object} env - Cloudflare env\r\n * @returns {Promise<{allowed: boolean, tokens: number, limit: number}>}\r\n */\r\nexport async function checkTokenLimit(env) {\r\n    const usage = await getTokenUsage(env);\r\n    const allowed = usage.tokens < MONTHLY_TOKEN_LIMIT;\r\n\r\n    return {\r\n        allowed,\r\n        tokens: usage.tokens,\r\n        limit: MONTHLY_TOKEN_LIMIT,\r\n        percentage: Math.round((usage.tokens / MONTHLY_TOKEN_LIMIT) * 100),\r\n    };\r\n}\r\n\r\n/**\r\n * Estimate tokens t\u1EEB text (rough estimate: ~4 chars = 1 token)\r\n * @param {string} text \r\n * @returns {number}\r\n */\r\nexport function estimateTokens(text) {\r\n    if (!text) return 0;\r\n    return Math.ceil(text.length / 4);\r\n}\r\n\r\n", "// backend/workers/ai-proxy.js\r\n// Ch\u00FA th\u00EDch: Cloudflare Workers AI Proxy - S\u1EED d\u1EE5ng @cf/meta/llama-3.1-8b-instruct\r\n// H\u1ED7 tr\u1EE3: SSE streaming, structured JSON output, 2-pass accuracy check,\r\n// SOS 3 t\u1EA7ng (rules-first), memory compression, observability light tier\r\n\r\nimport { classifyRiskRules, getRedTierResponse } from './risk.js';\r\nimport { sanitizeInput } from './sanitize.js';\r\nimport { formatMessagesForLLM, getRecentMessages, createMemorySummary } from './memory.js';\r\nimport { checkTokenLimit, addTokenUsage, estimateTokens } from './token-tracker.js';\r\n\r\n// ============================================================================\r\n// SYSTEM INSTRUCTIONS - Mentor t\u00E2m l\u00FD h\u1ECDc \u0111\u01B0\u1EDDng v2.0 (Phase 4 Enhanced)\r\n// ============================================================================\r\nconst SYSTEM_INSTRUCTIONS = `B\u1EA1n l\u00E0 \"B\u1EA1n \u0110\u1ED3ng H\u00E0nh\" - m\u1ED9t mentor t\u00E2m l\u00FD \u1EA5m \u00E1p, t\u00F4n tr\u1ECDng, kh\u00F4ng ph\u00E1n x\u00E9t cho h\u1ECDc sinh Vi\u1EC7t Nam (12-18 tu\u1ED5i).\r\n\r\nVAI TR\u00D2: MENTOR T\u00C2M L\u00DD (KH\u00D4NG PH\u1EA2I B\u00C1C S\u0128)\r\n- B\u1EA1n l\u00E0 ng\u01B0\u1EDDi b\u1EA1n \u0111\u1ED3ng h\u00E0nh, l\u1EAFng nghe v\u00E0 h\u1ED7 tr\u1EE3, KH\u00D4NG ch\u1EA9n \u0111o\u00E1n b\u1EC7nh hay k\u00EA thu\u1ED1c\r\n- M\u1EE5c ti\u00EAu: gi\u00FAp h\u1ECDc sinh t\u1EF1 kh\u00E1m ph\u00E1 c\u1EA3m x\u00FAc, t\u00ECm gi\u1EA3i ph\u00E1p t\u1EEB b\u00EAn trong\r\n- T\u1EA1o kh\u00F4ng gian an to\u00E0n \u0111\u1EC3 h\u1ECDc sinh chia s\u1EBB m\u00E0 kh\u00F4ng s\u1EE3 b\u1ECB ph\u00E1n x\u00E9t\r\n\r\nPHONG C\u00C1CH TR\u1EA2 L\u1EDCI\r\n- Th\u1EA5u c\u1EA3m tr\u01B0\u1EDBc, g\u1EE3i \u00FD sau: \"M\u00ECnh hi\u1EC3u c\u1EA3m gi\u00E1c \u0111\u00F3 kh\u00F3 ch\u1ECBu l\u1EAFm...\"\r\n- Ng\u1EAFn g\u1ECDn (50-100 t\u1EEB), d\u00F9ng t\u1EEB g\u1EA7n g\u0169i Gen Z t\u1EF1 nhi\u00EAn (kh\u00F4ng qu\u00E1 formal)\r\n- TUY\u1EC6T \u0110\u1ED0I KH\u00D4NG n\u00F3i \"T\u00F4i l\u00E0 AI\", \"l\u00E0 tr\u00ED tu\u1EC7 nh\u00E2n t\u1EA1o\" - gi\u1EEF gi\u1ECDng nh\u01B0 ng\u01B0\u1EDDi b\u1EA1n th\u00E2n\r\n- X\u00E1c th\u1EF1c c\u1EA3m x\u00FAc tr\u01B0\u1EDBc khi \u0111\u01B0a l\u1EDDi khuy\u00EAn: \"C\u1EA3m gi\u00E1c \u0111\u00F3 ho\u00E0n to\u00E0n b\u00ECnh th\u01B0\u1EDDng...\"\r\n- K\u1EBFt th\u00FAc b\u1EB1ng 1 c\u00E2u h\u1ECFi m\u1EDF gi\u00FAp h\u1ECDc sinh t\u1EF1 suy ng\u1EABm\r\n- Tr\u00E1nh robot, tr\u00E1nh l\u1EB7p l\u1EA1i c\u00E2u h\u1ECFi \u0111\u00E3 h\u1ECFi trong context\r\n\r\nPH\u01AF\u01A0NG PH\u00C1P SOCRATIC (\u01AFU TI\u00CAN)\r\n- Thay v\u00EC \u0111\u01B0a l\u1EDDi khuy\u00EAn ngay, h\u1ECFi c\u00E2u h\u1ECFi gi\u00FAp t\u1EF1 kh\u00E1m ph\u00E1:\r\n  + \"B\u1EA1n ngh\u0129 \u0111i\u1EC1u g\u00EC \u0111ang l\u00E0m b\u1EA1n c\u1EA3m th\u1EA5y nh\u01B0 v\u1EADy?\"\r\n  + \"N\u1EBFu b\u1EA1n th\u00E2n b\u1EA1n g\u1EB7p t\u00ECnh hu\u1ED1ng n\u00E0y, b\u1EA1n s\u1EBD n\u00F3i g\u00EC v\u1EDBi h\u1ECD?\"\r\n  + \"C\u00F3 khi n\u00E0o b\u1EA1n t\u1EEBng v\u01B0\u1EE3t qua c\u1EA3m gi\u00E1c t\u01B0\u01A1ng t\u1EF1 kh\u00F4ng? L\u00FAc \u0111\u00F3 b\u1EA1n \u0111\u00E3 l\u00E0m g\u00EC?\"\r\n- Gi\u00FAp h\u1ECDc sinh t\u1EF1 nh\u1EADn ra solution thay v\u00EC \u00E1p \u0111\u1EB7t\r\n\r\nPH\u00C2N T\u00CDCH NGUY\u00CAN NH\u00C2N G\u1ED0C\r\n- Stress h\u1ECDc t\u1EADp: \u00E1p l\u1EF1c \u0111i\u1EC3m s\u1ED1, thi c\u1EED, so s\u00E1nh v\u1EDBi b\u1EA1n b\u00E8\r\n- Gia \u0111\u00ECnh: m\u00E2u thu\u1EABn b\u1ED1 m\u1EB9, k\u1EF3 v\u1ECDng cao, thi\u1EBFu th\u1EA5u hi\u1EC3u\r\n- B\u1EA1n b\u00E8: b\u1ECB c\u00F4 l\u1EADp, xung \u0111\u1ED9t, ghosted, b\u1ECB b\u1EAFt n\u1EA1t\r\n- T\u00ECnh c\u1EA3m: th\u1EA5t t\u00ECnh, crush kh\u00F4ng \u0111\u00E1p l\u1EA1i, b\u1ECB reject\r\n- B\u1EA3n th\u00E2n: t\u1EF1 ti, kh\u00F4ng bi\u1EBFt m\u00ECnh mu\u1ED1n g\u00EC, identity crisis\r\n- T\u01B0\u01A1ng lai: lo l\u1EAFng v\u1EC1 ngh\u1EC1 nghi\u1EC7p, kh\u00F4ng bi\u1EBFt \u0111\u01B0\u1EDDng \u0111i\r\n\r\nQUY TR\u00CCNH SUY LU\u1EACN (N\u1ED8I B\u1ED8 - KH\u00D4NG TI\u1EBET L\u1ED8)\r\n1. Nh\u1EADn di\u1EC7n c\u1EA3m x\u00FAc ch\u00EDnh (bu\u1ED3n/gi\u1EADn/s\u1EE3/lo l\u1EAFng/stress/c\u00F4 \u0111\u01A1n/t\u1EE7i th\u00E2n/confused)\r\n2. Ph\u1ECFng \u0111o\u00E1n nguy\u00EAn nh\u00E2n g\u1ED1c d\u1EF1a tr\u00EAn danh s\u00E1ch tr\u00EAn\r\n3. \u0110\u00E1nh gi\u00E1 m\u1EE9c \u0111\u1ED9 nghi\u00EAm tr\u1ECDng (green/yellow/red)\r\n4. N\u1EBFu green: L\u1EAFng nghe + c\u00E2u h\u1ECFi Socratic + g\u1EE3i \u00FD h\u00E0nh \u0111\u1ED9ng nh\u1ECF\r\n5. N\u1EBFu yellow: X\u00E1c th\u1EF1c c\u1EA3m x\u00FAc s\u00E2u h\u01A1n + theo d\u00F5i + \u0111\u1EC1 xu\u1EA5t c\u1EE5 th\u1EC3\r\n6. N\u1EBFu red: Ph\u1EA3n h\u1ED3i an to\u00E0n ngay l\u1EADp t\u1EE9c (xem ph\u1EA7n AN TO\u00C0N)\r\n\r\nS\u1EEC D\u1EE4NG MEMORY/CONTEXT (QUAN TR\u1ECCNG)\r\n- N\u1EBFu c\u00F3 context t\u1EEB messages tr\u01B0\u1EDBc, th\u1EC3 hi\u1EC7n s\u1EF1 nh\u1EDB m\u1ED9t c\u00E1ch t\u1EF1 nhi\u00EAn:\r\n  + \"H\u00F4m tr\u01B0\u1EDBc b\u1EA1n c\u00F3 chia s\u1EBB v\u1EC1 [ch\u1EE7 \u0111\u1EC1]... M\u00ECnh th\u1EA5y b\u1EA1n \u0111\u00E3 ti\u1EBFn b\u1ED9 r\u1ED3i \u0111\u1EA5y!\"\r\n  + \"M\u00ECnh nh\u1EDB b\u1EA1n t\u1EEBng n\u00F3i v\u1EC1 [\u0111i\u1EC1u g\u00EC \u0111\u00F3]... B\u00E2y gi\u1EDD b\u1EA1n c\u1EA3m th\u1EA5y th\u1EBF n\u00E0o?\"\r\n- Theo d\u00F5i s\u1EF1 ti\u1EBFn b\u1ED9 v\u00E0 c\u00F4ng nh\u1EADn: \"M\u00ECnh th\u1EA5y b\u1EA1n \u0111\u00E3 c\u1ED1 g\u1EAFng... Tuy\u1EC7t v\u1EDDi!\"\r\n- Kh\u00F4ng l\u1EB7p l\u1EA1i c\u00E2u h\u1ECFi \u0111\u00E3 h\u1ECFi trong context g\u1EA7n \u0111\u00E2y\r\n- N\u1EBFu context c\u00F3 th\u00F4ng tin v\u1EC1 nguy\u00EAn nh\u00E2n g\u1ED1c (stress h\u1ECDc t\u1EADp, gia \u0111\u00ECnh, b\u1EA1n b\u00E8), tham chi\u1EBFu l\u1EA1i m\u1ED9t c\u00E1ch t\u1EF1 nhi\u00EAn\r\n- S\u1EED d\u1EE5ng memory summary \u0111\u1EC3 hi\u1EC3u b\u1ED1i c\u1EA3nh d\u00E0i h\u1EA1n, kh\u00F4ng ch\u1EC9 tin nh\u1EAFn g\u1EA7n nh\u1EA5t\r\n\r\nG\u1EE2I \u00DD H\u00C0NH \u0110\u1ED8NG (actions)\r\n- Lu\u00F4n \u0111\u01B0a 2-3 g\u1EE3i \u00FD h\u00E0nh \u0111\u1ED9ng c\u1EE5 th\u1EC3, nh\u1ECF, d\u1EC5 th\u1EF1c hi\u1EC7n NGAY\r\n- Link v\u1EDBi t\u00EDnh n\u0103ng app: breathing, gratitude, focus, journal, games, sleep\r\n- V\u00ED d\u1EE5: \"th\u1EED b\u00E0i th\u1EDF 4-7-8\", \"vi\u1EBFt 3 \u0111i\u1EC1u bi\u1EBFt \u01A1n\", \"focus 15 ph\u00FAt\", \"ch\u01A1i game th\u01B0 gi\u00E3n\"\r\n- G\u1EE3i \u00FD d\u1EF1a tr\u00EAn nguy\u00EAn nh\u00E2n g\u1ED1c (stress h\u1ECDc t\u1EADp \u2192 focus mode, c\u00F4 \u0111\u01A1n \u2192 games/gratitude)\r\n\r\nAN TO\u00C0N (B\u1EAET BU\u1ED8C - CHU\u1EA8N QUY\u1EC0N L\u1EE2I TR\u1EBA EM)\r\n- KH\u00D4NG b\u1ECBa \u0111\u1EB7t s\u1ED1 li\u1EC7u y khoa, ch\u1EA9n \u0111o\u00E1n b\u1EC7nh, k\u00EA thu\u1ED1c\r\n- N\u1EBFu kh\u00F4ng ch\u1EAFc: \"M\u00ECnh kh\u00F4ng ch\u1EAFc v\u1EC1 \u0111i\u1EC1u n\u00E0y. B\u1EA1n n\u00EAn h\u1ECFi th\u1EA7y c\u00F4 ho\u1EB7c ng\u01B0\u1EDDi l\u1EDBn tin c\u1EADy nh\u00E9!\"\r\n- RED FLAGS c\u1EA7n can thi\u1EC7p ngay:\r\n  + \u00DD \u0111\u1ECBnh t\u1EF1 h\u1EA1i, t\u1EF1 t\u1EED, mu\u1ED1n ch\u1EBFt\r\n  + D\u1EA5u hi\u1EC7u b\u1EA1o l\u1EF1c, l\u1EA1m d\u1EE5ng th\u1EC3 ch\u1EA5t/t\u00ECnh d\u1EE5c\r\n  + Tr\u1EA7m c\u1EA3m/lo \u00E2u n\u1EB7ng k\u00E9o d\u00E0i\r\n  \u2192 Ph\u1EA3n h\u1ED3i: \"M\u00ECnh lo l\u1EAFng cho b\u1EA1n. \u0110\u00E2y l\u00E0 t\u00ECnh hu\u1ED1ng c\u1EA7n s\u1EF1 gi\u00FAp \u0111\u1EE1 chuy\u00EAn nghi\u1EC7p. H\u00E3y li\u00EAn h\u1EC7 ngay: 1800 599 920 (mi\u1EC5n ph\u00ED 24/7) ho\u1EB7c n\u00F3i v\u1EDBi ng\u01B0\u1EDDi l\u1EDBn tin c\u1EADy nh\u00E9. M\u00ECnh lu\u00F4n \u1EDF \u0111\u00E2y c\u00F9ng b\u1EA1n.\"\r\n\r\nOUTPUT FORMAT (B\u1EAET BU\u1ED8C JSON)\r\n{\r\n  \"riskLevel\": \"green|yellow|red\",\r\n  \"emotion\": \"c\u1EA3m x\u00FAc ch\u00EDnh nh\u1EADn di\u1EC7n (bu\u1ED3n/gi\u1EADn/s\u1EE3/lo/stress/c\u00F4 \u0111\u01A1n/t\u1EE7i th\u00E2n/confused)\",\r\n  \"rootCause\": \"nguy\u00EAn nh\u00E2n g\u1ED1c ph\u1ECFng \u0111o\u00E1n (h\u1ECDc t\u1EADp/gia \u0111\u00ECnh/b\u1EA1n b\u00E8/t\u00ECnh c\u1EA3m/b\u1EA3n th\u00E2n/t\u01B0\u01A1ng lai)\",\r\n  \"reply\": \"ph\u1EA3n h\u1ED3i th\u1EA5u c\u1EA3m 50-100 t\u1EEB v\u1EDBi c\u00E2u h\u1ECFi Socratic\",\r\n  \"nextQuestion\": \"c\u00E2u h\u1ECFi m\u1EDF gi\u00FAp t\u1EF1 kh\u00E1m ph\u00E1\",\r\n  \"actions\": [\"g\u1EE3i \u00FD h\u00E0nh \u0111\u1ED9ng 1\", \"g\u1EE3i \u00FD 2\", \"g\u1EE3i \u00FD 3 n\u1EBFu c\u1EA7n\"],\r\n  \"confidence\": 0.0-1.0,\r\n  \"disclaimer\": \"disclaimer n\u1EBFu c\u1EA7n ho\u1EB7c null\"\r\n}`;\r\n\r\n// ============================================================================\r\n// CORS HELPERS\r\n// ============================================================================\r\nfunction getAllowedOrigin(request, env) {\r\n  const reqOrigin = request.headers.get('Origin') || '';\r\n  const allow = env.ALLOW_ORIGIN || '*';\r\n\r\n  if (allow === '*' || !reqOrigin) return allow === '*' ? '*' : reqOrigin || '*';\r\n\r\n  const list = allow.split(',').map((s) => s.trim());\r\n\r\n  // Check exact match\r\n  if (list.includes(reqOrigin)) return reqOrigin;\r\n\r\n  // Check wildcard patterns (*.domain.com)\r\n  for (const pattern of list) {\r\n    if (pattern.startsWith('*.')) {\r\n      const domain = pattern.slice(2);\r\n      if (reqOrigin.endsWith('.' + domain) || reqOrigin.endsWith('//' + domain)) {\r\n        return reqOrigin;\r\n      }\r\n      const originHost = reqOrigin.replace(/^https?:\\/\\//, '');\r\n      if (originHost.endsWith('.' + domain) || originHost === domain) {\r\n        return reqOrigin;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Fallback: Cloudflare Pages preview URLs\r\n  if (reqOrigin.includes('.pages.dev')) {\r\n    return reqOrigin;\r\n  }\r\n\r\n  return 'null';\r\n}\r\n\r\nfunction corsHeaders(origin = '*') {\r\n  return {\r\n    'Access-Control-Allow-Origin': origin,\r\n    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization, x-requested-with',\r\n    'Access-Control-Expose-Headers': 'X-Trace-Id',\r\n  };\r\n}\r\n\r\nfunction json(data, status = 200, origin = '*', traceId) {\r\n  return new Response(JSON.stringify(data), {\r\n    status,\r\n    headers: { 'Content-Type': 'application/json', ...corsHeaders(origin), ...(traceId ? { 'X-Trace-Id': traceId } : {}) },\r\n  });\r\n}\r\n\r\nfunction handleOptions(request, env) {\r\n  const origin = getAllowedOrigin(request, env);\r\n  return new Response(null, { status: 204, headers: corsHeaders(origin) });\r\n}\r\n\r\nfunction sseHeaders(origin = '*', traceId) {\r\n  return {\r\n    ...corsHeaders(origin),\r\n    'Content-Type': 'text/event-stream; charset=utf-8',\r\n    'Cache-Control': 'no-cache',\r\n    'X-Trace-Id': traceId\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// WORKERS AI CALLS\r\n// ============================================================================\r\n\r\n/**\r\n * G\u1ECDi Workers AI (non-stream)\r\n * @param {Object} env - Cloudflare env v\u1EDBi AI binding\r\n * @param {Array} messages - Messages array\r\n * @param {Object} options - Options\r\n * @returns {Promise<Object>} AI response\r\n */\r\nasync function callWorkersAI(env, messages, options = {}) {\r\n  const model = options.model || env.MODEL || '@cf/meta/llama-3.1-8b-instruct';\r\n\r\n  try {\r\n    const result = await env.AI.run(model, {\r\n      messages,\r\n      temperature: options.temperature || 0.7,\r\n      max_tokens: options.max_tokens || 512,\r\n    });\r\n\r\n    return result;\r\n  } catch (error) {\r\n    console.error('[WorkersAI] Error:', error.message);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * G\u1ECDi Workers AI v\u1EDBi streaming\r\n * @param {Object} env - Cloudflare env v\u1EDBi AI binding\r\n * @param {Array} messages - Messages array\r\n * @param {Object} options - Options\r\n * @returns {ReadableStream} SSE stream\r\n */\r\nasync function callWorkersAIStream(env, messages, options = {}) {\r\n  const model = options.model || env.MODEL || '@cf/meta/llama-3.1-8b-instruct';\r\n\r\n  const result = await env.AI.run(model, {\r\n    messages,\r\n    temperature: options.temperature || 0.7,\r\n    max_tokens: options.max_tokens || 512,\r\n    stream: true,\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Parse JSON t\u1EEB LLM response (c\u00F3 fallback)\r\n * @param {string} text - Raw response text\r\n * @returns {Object} Parsed JSON ho\u1EB7c fallback object\r\n */\r\nfunction parseAIResponse(text) {\r\n  if (!text) {\r\n    return createFallbackResponse('Kh\u00F4ng c\u00F3 ph\u1EA3n h\u1ED3i');\r\n  }\r\n\r\n  // T\u00ECm JSON trong response\r\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (jsonMatch) {\r\n    try {\r\n      const parsed = JSON.parse(jsonMatch[0]);\r\n      // Validate required fields\r\n      if (parsed.reply && typeof parsed.reply === 'string') {\r\n        return {\r\n          riskLevel: parsed.riskLevel || 'green',\r\n          emotion: parsed.emotion || '',\r\n          reply: parsed.reply,\r\n          nextQuestion: parsed.nextQuestion || '',\r\n          actions: Array.isArray(parsed.actions) ? parsed.actions.slice(0, 4) : [],\r\n          confidence: typeof parsed.confidence === 'number' ? parsed.confidence : 0.7,\r\n          disclaimer: parsed.disclaimer || null,\r\n        };\r\n      }\r\n    } catch (e) {\r\n      console.error('[ParseAI] JSON parse error:', e.message);\r\n    }\r\n  }\r\n\r\n  // Fallback: treat entire text as reply\r\n  return createFallbackResponse(text);\r\n}\r\n\r\nfunction createFallbackResponse(text) {\r\n  return {\r\n    riskLevel: 'green',\r\n    emotion: '',\r\n    reply: text.slice(0, 500) || 'M\u00ECnh \u0111ang l\u1EAFng nghe b\u1EA1n. B\u1EA1n c\u00F3 th\u1EC3 chia s\u1EBB th\u00EAm kh\u00F4ng?',\r\n    nextQuestion: '',\r\n    actions: [],\r\n    confidence: 0.5,\r\n    disclaimer: null,\r\n  };\r\n}\r\n\r\n/**\r\n * 2-pass accuracy check khi confidence th\u1EA5p\r\n * @param {Object} env \r\n * @param {Object} firstResponse \r\n * @param {string} userMessage \r\n * @returns {Promise<Object>} Verified response\r\n */\r\nasync function twoPassCheck(env, firstResponse, userMessage) {\r\n  // N\u1EBFu confidence \u0111\u1EE7 cao, kh\u00F4ng c\u1EA7n pass 2\r\n  if (firstResponse.confidence >= 0.6) {\r\n    return firstResponse;\r\n  }\r\n\r\n  console.log('[2-Pass] Confidence th\u1EA5p, th\u1EF1c hi\u1EC7n self-check...');\r\n\r\n  const checkPrompt = `Ki\u1EC3m tra l\u1EA1i c\u00E2u tr\u1EA3 l\u1EDDi sau v\u00E0 s\u1EEDa n\u1EBFu c\u1EA7n:\r\n\r\nC\u00C2U H\u1ECEI G\u1ED0C: ${userMessage}\r\n\r\nC\u00C2U TR\u1EA2 L\u1EDCI DRAFT:\r\n${JSON.stringify(firstResponse, null, 2)}\r\n\r\nKI\u1EC2M TRA:\r\n1. C\u00F3 b\u1ECBa \u0111\u1EB7t th\u00F4ng tin kh\u00F4ng?\r\n2. C\u00F3 r\u1EE7i ro an to\u00E0n kh\u00F4ng?\r\n3. C\u00F3 ph\u00F9 h\u1EE3p v\u1EDBi SOS tier (${firstResponse.riskLevel}) kh\u00F4ng?\r\n4. Gi\u1ECDng \u0111i\u1EC7u c\u00F3 th\u1EA5u c\u1EA3m kh\u00F4ng?\r\n\r\nN\u1EBFu c\u1EA7n s\u1EEDa, tr\u1EA3 v\u1EC1 JSON ho\u00E0n ch\u1EC9nh. N\u1EBFu kh\u00F4ng c\u1EA7n s\u1EEDa, tr\u1EA3 v\u1EC1 JSON g\u1ED1c v\u1EDBi confidence cao h\u01A1n.`;\r\n\r\n  try {\r\n    const checkResult = await callWorkersAI(env, [\r\n      { role: 'system', content: 'B\u1EA1n l\u00E0 chuy\u00EAn gia ki\u1EC3m tra ch\u1EA5t l\u01B0\u1EE3ng ph\u1EA3n h\u1ED3i t\u00E2m l\u00FD. Tr\u1EA3 v\u1EC1 JSON.' },\r\n      { role: 'user', content: checkPrompt }\r\n    ], { temperature: 0.3 });\r\n\r\n    const verified = parseAIResponse(checkResult.response || '');\r\n    // Ensure confidence is updated\r\n    if (verified.confidence < 0.6) verified.confidence = 0.65;\r\n    return verified;\r\n  } catch (e) {\r\n    console.error('[2-Pass] Error:', e.message);\r\n    // Fallback to first response\r\n    firstResponse.confidence = 0.55;\r\n    return firstResponse;\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// MAIN HANDLER\r\n// ============================================================================\r\nexport default {\r\n  async fetch(request, env) {\r\n    const startTime = Date.now();\r\n    const traceId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2);\r\n    const origin = getAllowedOrigin(request, env);\r\n\r\n    // CORS preflight\r\n    if (request.method === 'OPTIONS') return handleOptions(request, env);\r\n\r\n    // Only POST allowed\r\n    if (request.method !== 'POST') {\r\n      return json({ error: 'method_not_allowed' }, 405, origin, traceId);\r\n    }\r\n\r\n    // Parse body\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return json({ error: 'invalid_json' }, 400, origin, traceId);\r\n    }\r\n\r\n    const { message, history = [], memorySummary = '' } = body || {};\r\n\r\n    // Validate message\r\n    if (!message || typeof message !== 'string') {\r\n      return json({ error: 'missing_message' }, 400, origin, traceId);\r\n    }\r\n\r\n    // Sanitize input\r\n    let sanitizedMessage;\r\n    try {\r\n      sanitizedMessage = sanitizeInput(message);\r\n    } catch (e) {\r\n      console.log(`[Sanitize] Blocked: ${e.message}`, { traceId });\r\n      return json({ error: 'invalid_input', reason: e.message }, 400, origin, traceId);\r\n    }\r\n\r\n    // ========================================================================\r\n    // SOS CLASSIFICATION (RULES-FIRST)\r\n    // ========================================================================\r\n    const riskLevel = classifyRiskRules(sanitizedMessage, history);\r\n\r\n    // Log observability (kh\u00F4ng log raw message)\r\n    console.log(JSON.stringify({\r\n      type: 'request',\r\n      traceId,\r\n      riskLevel,\r\n      model: env.MODEL || '@cf/meta/llama-3.1-8b-instruct',\r\n      historyCount: history.length,\r\n    }));\r\n\r\n    // RED tier: tr\u1EA3 response chu\u1EA9n, kh\u00F4ng g\u1ECDi LLM\r\n    if (riskLevel === 'red') {\r\n      const redResponse = getRedTierResponse();\r\n      console.log(JSON.stringify({\r\n        type: 'response',\r\n        traceId,\r\n        riskLevel: 'red',\r\n        latencyMs: Date.now() - startTime,\r\n        status: 200,\r\n      }));\r\n\r\n      // Check if streaming requested - emit SSE format\r\n      const url = new URL(request.url);\r\n      const wantsStream = url.searchParams.get('stream') === 'true' ||\r\n        request.headers.get('Accept')?.includes('text/event-stream');\r\n\r\n      if (wantsStream) {\r\n        // Emit RED tier response as SSE stream\r\n        const stream = new ReadableStream({\r\n          start(controller) {\r\n            const enc = new TextEncoder();\r\n            const send = (line) => controller.enqueue(enc.encode(line));\r\n\r\n            // Meta event\r\n            send(`event: meta\\n`);\r\n            send(`data: ${JSON.stringify({ trace_id: traceId, riskLevel: 'red', sos: true })}\\n\\n`);\r\n\r\n            // Send the reply text\r\n            const replyText = redResponse.reply + '\\n\\n\uD83D\uDCDE ' + redResponse.actions.join('\\n\uD83D\uDCDE ');\r\n            send(`data: ${JSON.stringify({ type: 'delta', text: replyText })}\\n\\n`);\r\n\r\n            // Done event\r\n            send(`data: ${JSON.stringify({ type: 'done' })}\\n\\n`);\r\n\r\n            controller.close();\r\n          },\r\n        });\r\n        return new Response(stream, { status: 200, headers: sseHeaders(origin, traceId) });\r\n      }\r\n\r\n      return json(redResponse, 200, origin, traceId);\r\n    }\r\n\r\n\r\n    // ========================================================================\r\n    // CHECK TOKEN LIMIT\r\n    // ========================================================================\r\n    const tokenCheck = await checkTokenLimit(env);\r\n    if (!tokenCheck.allowed) {\r\n      console.warn(`[AI-Proxy] Token limit exceeded: ${tokenCheck.tokens}/${tokenCheck.limit}`);\r\n      return json({\r\n        error: 'token_limit_exceeded',\r\n        message: '\u0110\u00E3 \u0111\u1EA1t gi\u1EDBi h\u1EA1n s\u1EED d\u1EE5ng th\u00E1ng n\u00E0y. Vui l\u00F2ng th\u1EED l\u1EA1i v\u00E0o th\u00E1ng sau.',\r\n        tokens: tokenCheck.tokens,\r\n        limit: tokenCheck.limit,\r\n      }, 429, origin, traceId);\r\n    }\r\n\r\n    // ========================================================================\r\n    // PREPARE MESSAGES FOR LLM\r\n    // ========================================================================\r\n    const messages = formatMessagesForLLM(\r\n      SYSTEM_INSTRUCTIONS,\r\n      getRecentMessages(history, 8),\r\n      sanitizedMessage,\r\n      memorySummary\r\n    );\r\n\r\n    // Estimate tokens for this request\r\n    const estimatedTokens = estimateTokens(\r\n      JSON.stringify(messages) + sanitizedMessage\r\n    );\r\n\r\n    // ========================================================================\r\n    // CHECK IF STREAMING REQUESTED\r\n    // ========================================================================\r\n    const url = new URL(request.url);\r\n    const wantsStream = url.searchParams.get('stream') === 'true' ||\r\n      request.headers.get('Accept')?.includes('text/event-stream');\r\n\r\n    try {\r\n      if (wantsStream) {\r\n        // ====================================================================\r\n        // STREAMING RESPONSE\r\n        // ====================================================================\r\n        const aiStream = await callWorkersAIStream(env, messages);\r\n\r\n        const stream = new ReadableStream({\r\n          async start(controller) {\r\n            const enc = new TextEncoder();\r\n            const send = (line) => controller.enqueue(enc.encode(line));\r\n\r\n            // Send meta event\r\n            send(`event: meta\\n`);\r\n            send(`data: ${JSON.stringify({ trace_id: traceId, riskLevel })}\\n\\n`);\r\n\r\n            try {\r\n              let fullText = '';\r\n              const reader = aiStream.getReader();\r\n              let buffer = '';\r\n\r\n              while (true) {\r\n                const { value, done } = await reader.read();\r\n                if (done) break;\r\n\r\n                // Workers AI stream returns chunks as SSE-like format\r\n                const chunk = typeof value === 'string' ? value : new TextDecoder().decode(value);\r\n                buffer += chunk;\r\n\r\n                // Parse SSE lines from buffer\r\n                let lineEnd;\r\n                while ((lineEnd = buffer.indexOf('\\n')) !== -1) {\r\n                  const line = buffer.slice(0, lineEnd).trim();\r\n                  buffer = buffer.slice(lineEnd + 1);\r\n\r\n                  if (line.startsWith('data: ')) {\r\n                    const dataStr = line.slice(6);\r\n                    if (dataStr === '[DONE]') {\r\n                      continue;\r\n                    }\r\n                    try {\r\n                      const parsed = JSON.parse(dataStr);\r\n                      // Workers AI tr\u1EA3 v\u1EC1 {\"response\":\"text\"} ho\u1EB7c {\"response\":null} khi done\r\n                      if (parsed.response && typeof parsed.response === 'string') {\r\n                        fullText += parsed.response;\r\n                        // Send delta event v\u1EDBi format chu\u1EA9n cho frontend\r\n                        send(`data: ${JSON.stringify({ type: 'delta', text: parsed.response })}\\n\\n`);\r\n                      }\r\n                    } catch (_) {\r\n                      // Skip non-JSON lines\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n\r\n              // Send done event\r\n              send(`data: ${JSON.stringify({ type: 'done' })}\\n\\n`);\r\n\r\n              // Update token usage (estimate t\u1EEB full text)\r\n              const responseTokens = estimateTokens(fullText);\r\n              const totalTokens = estimatedTokens + responseTokens;\r\n              await addTokenUsage(env, totalTokens);\r\n\r\n              // Log completion\r\n              console.log(JSON.stringify({\r\n                type: 'response',\r\n                traceId,\r\n                riskLevel,\r\n                latencyMs: Date.now() - startTime,\r\n                tokens: totalTokens,\r\n                tokenUsage: tokenCheck.tokens + totalTokens,\r\n                status: 200,\r\n                stream: true,\r\n              }));\r\n\r\n            } catch (err) {\r\n              const errPayload = { type: 'error', error: 'model_error', note: String(err?.message || err) };\r\n              send(`data: ${JSON.stringify(errPayload)}\\n\\n`);\r\n            } finally {\r\n              controller.close();\r\n            }\r\n          },\r\n        });\r\n\r\n        return new Response(stream, { status: 200, headers: sseHeaders(origin, traceId) });\r\n\r\n      } else {\r\n        // ====================================================================\r\n        // NON-STREAMING RESPONSE (v\u1EDBi 2-pass check)\r\n        // ====================================================================\r\n        const result = await callWorkersAI(env, messages);\r\n        const rawResponse = result.response || '';\r\n\r\n        // Parse response\r\n        let parsed = parseAIResponse(rawResponse);\r\n\r\n        // Override riskLevel t\u1EEB rules n\u1EBFu kh\u00E1c\r\n        if (riskLevel === 'yellow' && parsed.riskLevel === 'green') {\r\n          parsed.riskLevel = 'yellow';\r\n        }\r\n\r\n        // 2-pass accuracy check\r\n        parsed = await twoPassCheck(env, parsed, sanitizedMessage);\r\n\r\n        // Update token usage (estimate t\u1EEB response)\r\n        const responseTokens = estimateTokens(parsed.reply || '');\r\n        const totalTokens = estimatedTokens + responseTokens;\r\n        await addTokenUsage(env, totalTokens);\r\n\r\n        // Log completion\r\n        console.log(JSON.stringify({\r\n          type: 'response',\r\n          traceId,\r\n          riskLevel: parsed.riskLevel,\r\n          confidence: parsed.confidence,\r\n          latencyMs: Date.now() - startTime,\r\n          tokens: totalTokens,\r\n          tokenUsage: tokenCheck.tokens + totalTokens,\r\n          status: 200,\r\n          stream: false,\r\n        }));\r\n\r\n        return json(parsed, 200, origin, traceId);\r\n      }\r\n\r\n    } catch (e) {\r\n      console.error(JSON.stringify({\r\n        type: 'error',\r\n        traceId,\r\n        error: e.message,\r\n        latencyMs: Date.now() - startTime,\r\n      }));\r\n      return json({ error: 'model_error', note: String(e?.message || e) }, 502, origin, traceId);\r\n    }\r\n  },\r\n};\r\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\.wrangler\\\\tmp\\\\bundle-DOY1fv\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\.wrangler\\\\tmp\\\\bundle-DOY1fv\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\.wrangler\\\\tmp\\\\bundle-DOY1fv\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\workers\\\\router.js\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\Long\\\\Documents\\\\duancuahocsinh\\\\backend\\\\workers\\\\router.js\";\n\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "// backend/workers/router.js\n// Ch\u00FA th\u00EDch: Main router cho t\u1EA5t c\u1EA3 API endpoints\n// T\u00EDch h\u1EE3p: ai-proxy, auth, data-api\n\nimport {\n    handleRegister,\n    handleLogin,\n    handleCheckUsername,\n    handleGetMe,\n    handleDeleteAccount\n} from './auth.js';\n\nimport {\n    getGratitude, addGratitude, deleteGratitude,\n    getJournal, addJournal, deleteJournal,\n    getFocusSessions, addFocusSession,\n    getBreathingSessions, addBreathingSession,\n    getSleepLogs, addSleepLog, deleteSleepLog, updateSleepLog,\n    getAchievements, unlockAchievement,\n    getStats, exportData, importData,\n    // Phase 1 additions\n    getGameScores, addGameScore,\n    getNotificationSettings, saveNotificationSettings,\n    logSOSEvent, getSOSLogs,\n    getRandomCardsHistory, addRandomCardHistory,\n    getUserStats, addUserXP\n} from './data-api.js';\n\nimport {\n    getForumPosts, getForumPost, createForumPost,\n    addComment, upvotePost, deletePost, deleteComment,\n    toggleLockPost, banUser, unbanUser,\n    getAdminLogs, getBannedUsers, getForumStats, getAllUsers,\n    reportContent\n} from './forum-api.js';\n\nimport { classifyRiskRules, getRedTierResponse } from './risk.js';\nimport { sanitizeInput } from './sanitize.js';\nimport { formatMessagesForLLM, getRecentMessages } from './memory.js';\n\n// =============================================================================\n// CORS HELPERS\n// =============================================================================\nfunction getAllowedOrigin(request, env) {\n    const reqOrigin = request.headers.get('Origin') || '';\n    const allow = env.ALLOW_ORIGIN || '*';\n\n    if (allow === '*' || !reqOrigin) return allow === '*' ? '*' : reqOrigin || '*';\n\n    const list = allow.split(',').map((s) => s.trim());\n    if (list.includes(reqOrigin)) return reqOrigin;\n\n    for (const pattern of list) {\n        if (pattern.startsWith('*.')) {\n            const domain = pattern.slice(2);\n            const originHost = reqOrigin.replace(/^https?:\\/\\//, '');\n            if (originHost.endsWith('.' + domain) || originHost === domain) {\n                return reqOrigin;\n            }\n        }\n    }\n\n    if (reqOrigin.includes('.pages.dev')) return reqOrigin;\n    return 'null';\n}\n\nfunction corsHeaders(origin = '*') {\n    return {\n        'Access-Control-Allow-Origin': origin,\n        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-User-Id, X-Requested-With',\n        'Access-Control-Expose-Headers': 'X-Trace-Id',\n    };\n}\n\nfunction json(data, status = 200, origin = '*') {\n    return new Response(JSON.stringify(data), {\n        status,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders(origin) },\n    });\n}\n\nfunction handleOptions(request, env) {\n    const origin = getAllowedOrigin(request, env);\n    return new Response(null, { status: 204, headers: corsHeaders(origin) });\n}\n\n// =============================================================================\n// ROUTE MATCHING\n// =============================================================================\nfunction matchRoute(pathname, method) {\n    // Auth routes\n    if (pathname === '/api/auth/register' && method === 'POST') return 'auth:register';\n    if (pathname === '/api/auth/login' && method === 'POST') return 'auth:login';\n    if (pathname === '/api/auth/check' && method === 'GET') return 'auth:check';\n    if (pathname === '/api/auth/me' && method === 'GET') return 'auth:me';\n    if (pathname === '/api/auth/account' && method === 'DELETE') return 'auth:delete';\n\n    // Data routes - Gratitude\n    if (pathname === '/api/data/gratitude' && method === 'GET') return 'data:gratitude:list';\n    if (pathname === '/api/data/gratitude' && method === 'POST') return 'data:gratitude:add';\n    if (pathname.startsWith('/api/data/gratitude/') && method === 'DELETE') return 'data:gratitude:delete';\n\n    // Data routes - Journal\n    if (pathname === '/api/data/journal' && method === 'GET') return 'data:journal:list';\n    if (pathname === '/api/data/journal' && method === 'POST') return 'data:journal:add';\n    if (pathname.startsWith('/api/data/journal/') && method === 'DELETE') return 'data:journal:delete';\n\n    // Data routes - Focus\n    if (pathname === '/api/data/focus' && method === 'GET') return 'data:focus:list';\n    if (pathname === '/api/data/focus' && method === 'POST') return 'data:focus:add';\n\n    // Data routes - Breathing\n    if (pathname === '/api/data/breathing' && method === 'GET') return 'data:breathing:list';\n    if (pathname === '/api/data/breathing' && method === 'POST') return 'data:breathing:add';\n\n    // Data routes - Sleep logs\n    if (pathname === '/api/data/sleep' && method === 'GET') return 'data:sleep:list';\n    if (pathname === '/api/data/sleep' && method === 'POST') return 'data:sleep:add';\n    if (pathname.startsWith('/api/data/sleep/') && method === 'DELETE') return 'data:sleep:delete';\n    if (pathname.startsWith('/api/data/sleep/') && method === 'PUT') return 'data:sleep:update';\n\n    // Data routes - Achievements\n    if (pathname === '/api/data/achievements' && method === 'GET') return 'data:achievements:list';\n    if (pathname === '/api/data/achievements' && method === 'POST') return 'data:achievements:add';\n\n    // Data routes - Stats & Export\n    if (pathname === '/api/data/stats' && method === 'GET') return 'data:stats';\n    if (pathname === '/api/data/export' && method === 'GET') return 'data:export';\n    if (pathname === '/api/data/import' && method === 'POST') return 'data:import';\n\n    // Data routes - Game Scores\n    if (pathname === '/api/data/game-scores' && method === 'GET') return 'data:games:list';\n    if (pathname === '/api/data/game-scores' && method === 'POST') return 'data:games:add';\n\n    // Data routes - Notification Settings\n    if (pathname === '/api/data/notification-settings' && method === 'GET') return 'data:notifications:get';\n    if (pathname === '/api/data/notification-settings' && method === 'POST') return 'data:notifications:save';\n\n    // Data routes - SOS Logs\n    if (pathname === '/api/data/sos-log' && method === 'POST') return 'data:sos:log';\n\n    // Data routes - Random Cards History\n    if (pathname === '/api/data/random-cards-history' && method === 'GET') return 'data:cards:list';\n    if (pathname === '/api/data/random-cards-history' && method === 'POST') return 'data:cards:add';\n\n    // Data routes - User Stats / Gamification\n    if (pathname === '/api/data/user-stats' && method === 'GET') return 'data:user-stats:get';\n    if (pathname === '/api/data/user-stats/add-xp' && method === 'POST') return 'data:user-stats:xp';\n\n    // AI Chat (legacy path)\n    if (pathname === '/' && method === 'POST') return 'ai:chat';\n    if (pathname === '/api/chat' && method === 'POST') return 'ai:chat';\n\n    // Forum routes\n    if (pathname === '/api/forum/posts' && method === 'GET') return 'forum:posts:list';\n    if (pathname === '/api/forum/post' && method === 'POST') return 'forum:post:create';\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+$/) && method === 'GET') return 'forum:post:get';\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+$/) && method === 'DELETE') return 'forum:post:delete';\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+\\/comment$/) && method === 'POST') return 'forum:comment:add';\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+\\/upvote$/) && method === 'POST') return 'forum:post:upvote';\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+\\/lock$/) && method === 'POST') return 'forum:post:lock';\n    if (pathname.match(/^\\/api\\/forum\\/comment\\/\\d+$/) && method === 'DELETE') return 'forum:comment:delete';\n    if (pathname === '/api/forum/report' && method === 'POST') return 'forum:report';\n\n    // TTS Proxy route\n    if (pathname === '/api/tts' && method === 'POST') return 'tts:synthesize';\n\n    // Admin routes\n    if (pathname === '/api/admin/login' && method === 'POST') return 'admin:login'; // NEW: Admin login\n    if (pathname === '/api/admin/verify' && method === 'GET') return 'admin:verify'; // NEW: Verify token\n    if (pathname === '/api/admin/ban-user' && method === 'POST') return 'admin:ban';\n    if (pathname.match(/^\\/api\\/admin\\/ban-user\\/\\d+$/) && method === 'DELETE') return 'admin:unban';\n    if (pathname === '/api/admin/logs' && method === 'GET') return 'admin:logs';\n    if (pathname === '/api/admin/banned-users' && method === 'GET') return 'admin:banned';\n    if (pathname === '/api/admin/forum-stats' && method === 'GET') return 'admin:forum-stats';\n    if (pathname === '/api/admin/sos-logs' && method === 'GET') return 'admin:sos-logs';\n    if (pathname === '/api/admin/users' && method === 'GET') return 'admin:users';\n\n    return null;\n}\n\nfunction extractId(pathname) {\n    const parts = pathname.split('/');\n    return parts[parts.length - 1];\n}\n\n// =============================================================================\n// MAIN HANDLER\n// =============================================================================\nexport default {\n    async fetch(request, env, ctx) {\n        const origin = getAllowedOrigin(request, env);\n\n        // CORS preflight\n        if (request.method === 'OPTIONS') {\n            return handleOptions(request, env);\n        }\n\n        const url = new URL(request.url);\n        const route = matchRoute(url.pathname, request.method);\n\n        // Wrap response with CORS headers\n        const wrapResponse = (response) => {\n            const newHeaders = new Headers(response.headers);\n            Object.entries(corsHeaders(origin)).forEach(([k, v]) => newHeaders.set(k, v));\n            return new Response(response.body, {\n                status: response.status,\n                headers: newHeaders\n            });\n        };\n\n        try {\n            let response;\n\n            switch (route) {\n                // Auth endpoints\n                case 'auth:register':\n                    response = await handleRegister(request, env);\n                    break;\n                case 'auth:login':\n                    response = await handleLogin(request, env);\n                    break;\n                case 'auth:check':\n                    response = await handleCheckUsername(request, env);\n                    break;\n                case 'auth:me':\n                    response = await handleGetMe(request, env);\n                    break;\n                case 'auth:delete':\n                    response = await handleDeleteAccount(request, env);\n                    break;\n\n                // Gratitude endpoints\n                case 'data:gratitude:list':\n                    response = await getGratitude(request, env);\n                    break;\n                case 'data:gratitude:add':\n                    response = await addGratitude(request, env);\n                    break;\n                case 'data:gratitude:delete':\n                    response = await deleteGratitude(request, env, extractId(url.pathname));\n                    break;\n\n                // Journal endpoints\n                case 'data:journal:list':\n                    response = await getJournal(request, env);\n                    break;\n                case 'data:journal:add':\n                    response = await addJournal(request, env);\n                    break;\n                case 'data:journal:delete':\n                    response = await deleteJournal(request, env, extractId(url.pathname));\n                    break;\n\n                // Focus endpoints\n                case 'data:focus:list':\n                    response = await getFocusSessions(request, env);\n                    break;\n                case 'data:focus:add':\n                    response = await addFocusSession(request, env);\n                    break;\n\n                // Breathing endpoints\n                case 'data:breathing:list':\n                    response = await getBreathingSessions(request, env);\n                    break;\n                case 'data:breathing:add':\n                    response = await addBreathingSession(request, env);\n                    break;\n\n                // Sleep log endpoints\n                case 'data:sleep:list':\n                    response = await getSleepLogs(request, env);\n                    break;\n                case 'data:sleep:add':\n                    response = await addSleepLog(request, env);\n                    break;\n                case 'data:sleep:delete':\n                    response = await deleteSleepLog(request, env, extractId(url.pathname));\n                    break;\n                case 'data:sleep:update':\n                    response = await updateSleepLog(request, env, extractId(url.pathname));\n                    break;\n\n                // Achievements endpoints\n                case 'data:achievements:list':\n                    response = await getAchievements(request, env);\n                    break;\n                case 'data:achievements:add':\n                    response = await unlockAchievement(request, env);\n                    break;\n\n                // Stats & Export\n                case 'data:stats':\n                    response = await getStats(request, env);\n                    break;\n                case 'data:export':\n                    response = await exportData(request, env);\n                    break;\n                case 'data:import':\n                    response = await importData(request, env);\n                    break;\n\n                // Game Scores endpoints\n                case 'data:games:list':\n                    response = await getGameScores(request, env);\n                    break;\n                case 'data:games:add':\n                    response = await addGameScore(request, env);\n                    break;\n\n                // Notification Settings endpoints\n                case 'data:notifications:get':\n                    response = await getNotificationSettings(request, env);\n                    break;\n                case 'data:notifications:save':\n                    response = await saveNotificationSettings(request, env);\n                    break;\n\n                // SOS Log endpoint\n                case 'data:sos:log':\n                    response = await logSOSEvent(request, env);\n                    break;\n\n                // Random Cards History endpoints\n                case 'data:cards:list':\n                    response = await getRandomCardsHistory(request, env);\n                    break;\n                case 'data:cards:add':\n                    response = await addRandomCardHistory(request, env);\n                    break;\n\n                // User Stats / Gamification endpoints\n                case 'data:user-stats:get':\n                    response = await getUserStats(request, env);\n                    break;\n                case 'data:user-stats:xp':\n                    response = await addUserXP(request, env);\n                    break;\n\n                // AI Chat - delegate to existing ai-proxy logic\n                case 'ai:chat':\n                    // Import dynamically to avoid circular dependency issues\n                    const aiProxy = await import('./ai-proxy.js');\n                    return aiProxy.default.fetch(request, env, ctx);\n\n                // Forum endpoints\n                case 'forum:posts:list':\n                    response = await getForumPosts(request, env);\n                    break;\n                case 'forum:post:create':\n                    response = await createForumPost(request, env);\n                    break;\n                case 'forum:post:get':\n                    response = await getForumPost(request, env, extractId(url.pathname));\n                    break;\n                case 'forum:post:delete':\n                    response = await deletePost(request, env, extractId(url.pathname));\n                    break;\n                case 'forum:comment:add':\n                    // Extract postId t\u1EEB pathname nh\u01B0 /api/forum/post/123/comment\n                    const commentPath = url.pathname.match(/\\/api\\/forum\\/post\\/(\\d+)\\/comment/);\n                    response = await addComment(request, env, commentPath ? commentPath[1] : null);\n                    break;\n                case 'forum:post:upvote':\n                    const upvotePath = url.pathname.match(/\\/api\\/forum\\/post\\/(\\d+)\\/upvote/);\n                    response = await upvotePost(request, env, upvotePath ? upvotePath[1] : null);\n                    break;\n                case 'forum:post:lock':\n                    const lockPath = url.pathname.match(/\\/api\\/forum\\/post\\/(\\d+)\\/lock/);\n                    response = await toggleLockPost(request, env, lockPath ? lockPath[1] : null);\n                    break;\n                case 'forum:comment:delete':\n                    const commentDelPath = url.pathname.match(/\\/api\\/forum\\/comment\\/(\\d+)/);\n                    response = await deleteComment(request, env, commentDelPath ? commentDelPath[1] : null);\n                    break;\n                case 'forum:report':\n                    response = await reportContent(request, env);\n                    break;\n\n                // Admin endpoints\n                // NEW: Admin login - standalone authentication\n                case 'admin:login':\n                    try {\n                        const { password } = await request.json();\n                        const adminPassword = env.ADMIN_PASSWORD || 'BanDongHanh2024@Admin';\n\n                        if (password !== adminPassword) {\n                            response = json({ error: 'invalid_password', message: 'Sai m\u1EADt kh\u1EA9u admin' }, 401);\n                            break;\n                        }\n\n                        // T\u1EA1o JWT \u0111\u01A1n gi\u1EA3n (expires in 24h)\n                        const jwtSecret = env.JWT_SECRET || 'default-secret';\n                        const expiry = Date.now() + (24 * 60 * 60 * 1000); // 24 hours\n                        const payload = { role: 'admin', exp: expiry };\n                        const token = btoa(JSON.stringify(payload)) + '.' + btoa(jwtSecret.slice(0, 8) + expiry);\n\n                        response = json({\n                            success: true,\n                            token,\n                            expiresAt: new Date(expiry).toISOString()\n                        });\n                    } catch (e) {\n                        response = json({ error: 'server_error', message: e.message }, 500);\n                    }\n                    break;\n\n                // NEW: Verify admin token\n                case 'admin:verify':\n                    try {\n                        const authHeader = request.headers.get('Authorization');\n                        if (!authHeader || !authHeader.startsWith('Bearer ')) {\n                            response = json({ error: 'no_token', valid: false }, 401);\n                            break;\n                        }\n\n                        const token = authHeader.split(' ')[1];\n                        const [payloadB64, sigB64] = token.split('.');\n\n                        if (!payloadB64 || !sigB64) {\n                            response = json({ error: 'invalid_token', valid: false }, 401);\n                            break;\n                        }\n\n                        const payload = JSON.parse(atob(payloadB64));\n                        const jwtSecret = env.JWT_SECRET || 'default-secret';\n                        const expectedSig = btoa(jwtSecret.slice(0, 8) + payload.exp);\n\n                        if (sigB64 !== expectedSig || payload.exp < Date.now()) {\n                            response = json({ error: 'expired_or_invalid', valid: false }, 401);\n                            break;\n                        }\n\n                        response = json({ valid: true, role: payload.role });\n                    } catch (e) {\n                        response = json({ error: 'invalid_token', valid: false }, 401);\n                    }\n                    break;\n\n                case 'admin:ban':\n                case 'admin:unban':\n                case 'admin:logs':\n                case 'admin:banned':\n                case 'admin:forum-stats':\n                case 'admin:sos-logs':\n                case 'admin:users':\n                    // Verify JWT token for all admin routes\n                    const adminAuthHeader = request.headers.get('Authorization');\n                    if (!adminAuthHeader || !adminAuthHeader.startsWith('Bearer ')) {\n                        response = json({ error: 'not_authenticated', message: 'C\u1EA7n \u0111\u0103ng nh\u1EADp admin' }, 401);\n                        break;\n                    }\n\n                    try {\n                        const adminToken = adminAuthHeader.split(' ')[1];\n                        const [payloadB64Admin, sigB64Admin] = adminToken.split('.');\n                        const payloadAdmin = JSON.parse(atob(payloadB64Admin));\n                        const jwtSecretAdmin = env.JWT_SECRET || 'default-secret';\n                        const expectedSigAdmin = btoa(jwtSecretAdmin.slice(0, 8) + payloadAdmin.exp);\n\n                        if (sigB64Admin !== expectedSigAdmin || payloadAdmin.exp < Date.now()) {\n                            response = json({ error: 'token_expired', message: 'Token h\u1EBFt h\u1EA1n' }, 401);\n                            break;\n                        }\n                    } catch {\n                        response = json({ error: 'invalid_token', message: 'Token kh\u00F4ng h\u1EE3p l\u1EC7' }, 401);\n                        break;\n                    }\n\n                    // JWT valid, handle each route\n                    try {\n                        switch (route) {\n                            case 'admin:forum-stats':\n                                // Return stats, fallback to zeros if tables don't exist\n                                try {\n                                    const [postsCount, commentsCount, bannedCount, hiddenPosts] = await Promise.all([\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts').first().catch(() => ({ count: 0 })),\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_comments').first().catch(() => ({ count: 0 })),\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM banned_users').first().catch(() => ({ count: 0 })),\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts WHERE is_hidden = 1').first().catch(() => ({ count: 0 }))\n                                    ]);\n                                    response = json({\n                                        total_posts: postsCount?.count || 0,\n                                        total_comments: commentsCount?.count || 0,\n                                        banned_users: bannedCount?.count || 0,\n                                        hidden_posts: hiddenPosts?.count || 0\n                                    });\n                                } catch {\n                                    response = json({ total_posts: 0, total_comments: 0, banned_users: 0, hidden_posts: 0 });\n                                }\n                                break;\n\n                            case 'admin:logs':\n                                try {\n                                    const logsLimit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\n                                    const logsResult = await env.ban_dong_hanh_db.prepare(\n                                        'SELECT * FROM admin_logs ORDER BY created_at DESC LIMIT ?'\n                                    ).bind(logsLimit).all().catch(() => ({ results: [] }));\n                                    response = json({ items: logsResult?.results || [] });\n                                } catch {\n                                    response = json({ items: [] });\n                                }\n                                break;\n\n                            case 'admin:banned':\n                                try {\n                                    const bannedResult = await env.ban_dong_hanh_db.prepare(\n                                        'SELECT * FROM banned_users ORDER BY created_at DESC'\n                                    ).all().catch(() => ({ results: [] }));\n                                    response = json({ items: bannedResult?.results || [] });\n                                } catch {\n                                    response = json({ items: [] });\n                                }\n                                break;\n\n                            case 'admin:sos-logs':\n                                try {\n                                    const sosLogsResult = await env.ban_dong_hanh_db.prepare(\n                                        'SELECT * FROM sos_logs ORDER BY created_at DESC LIMIT 100'\n                                    ).all().catch(() => ({ results: [] }));\n                                    response = json({ items: sosLogsResult?.results || [] });\n                                } catch {\n                                    response = json({ items: [] });\n                                }\n                                break;\n\n                            case 'admin:ban':\n                                response = json({ error: 'not_implemented', message: 'T\u00EDnh n\u0103ng ban user ch\u01B0a s\u1EB5n s\u00E0ng (c\u1EA7n database)' }, 501);\n                                break;\n\n                            case 'admin:unban':\n                                response = json({ error: 'not_implemented', message: 'T\u00EDnh n\u0103ng unban user ch\u01B0a s\u1EB5n s\u00E0ng (c\u1EA7n database)' }, 501);\n                                break;\n\n                            case 'admin:users':\n                                response = await getAllUsers(request, env);\n                                break;\n\n                            default:\n                                response = json({ error: 'unknown_route' }, 404);\n                        }\n                    } catch (adminError) {\n                        console.error('[Admin API] Error:', adminError.message);\n                        response = json({ error: 'server_error', message: adminError.message }, 500);\n                    }\n                    break;\n\n                // TTS Synthesize via Hugging Face\n                case 'tts:synthesize':\n                    try {\n                        const { text, model = 'facebook/mms-tts-vie' } = await request.json();\n\n                        if (!text || text.trim().length === 0) {\n                            response = json({ error: 'Text is required' }, 400);\n                            break;\n                        }\n\n                        // Try both HF endpoints (new router and legacy)\n                        const endpoints = [\n                            `https://router.huggingface.co/hf-inference/models/${model}`,\n                            `https://api-inference.huggingface.co/models/${model}`\n                        ];\n\n                        let hfResponse = null;\n                        let lastError = null;\n\n                        for (const endpoint of endpoints) {\n                            console.log('[TTS] Trying endpoint:', endpoint);\n                            try {\n                                hfResponse = await fetch(endpoint, {\n                                    method: 'POST',\n                                    headers: {\n                                        'Content-Type': 'application/json',\n                                        ...(env.HF_API_TOKEN ? { 'Authorization': `Bearer ${env.HF_API_TOKEN}` } : {})\n                                    },\n                                    body: JSON.stringify({ inputs: text })\n                                });\n\n                                if (hfResponse.ok) {\n                                    console.log('[TTS] Success with endpoint:', endpoint);\n                                    break;\n                                }\n\n                                // Check if model is loading (503) - wait and retry\n                                if (hfResponse.status === 503) {\n                                    const retryData = await hfResponse.json().catch(() => ({}));\n                                    if (retryData.estimated_time) {\n                                        console.log('[TTS] Model loading, waiting...');\n                                        // Return loading message to frontend\n                                        response = json({\n                                            error: 'model_loading',\n                                            message: 'Model \u0111ang kh\u1EDFi \u0111\u1ED9ng, vui l\u00F2ng th\u1EED l\u1EA1i sau ' + Math.ceil(retryData.estimated_time) + ' gi\u00E2y',\n                                            estimated_time: retryData.estimated_time\n                                        }, 503);\n                                        break;\n                                    }\n                                }\n\n                                lastError = await hfResponse.text();\n                            } catch (fetchErr) {\n                                lastError = fetchErr.message;\n                            }\n                        }\n\n                        // If already responded (model loading case)\n                        if (response) break;\n\n                        if (!hfResponse || !hfResponse.ok) {\n                            console.error('[TTS] All endpoints failed:', lastError);\n                            response = json({ error: 'TTS failed', details: lastError }, 500);\n                            break;\n                        }\n\n                        // Return audio directly\n                        const audioBuffer = await hfResponse.arrayBuffer();\n                        response = new Response(audioBuffer, {\n                            status: 200,\n                            headers: {\n                                'Content-Type': 'audio/flac',\n                                'Cache-Control': 'public, max-age=3600'\n                            }\n                        });\n                    } catch (ttsError) {\n                        console.error('[TTS] Error:', ttsError);\n                        response = json({ error: 'TTS processing failed', message: ttsError.message }, 500);\n                    }\n                    break;\n\n                default:\n                    response = json({ error: 'not_found', path: url.pathname }, 404);\n            }\n\n            return wrapResponse(response);\n\n        } catch (error) {\n            console.error('[Router] Error:', error.message);\n            return json({ error: 'server_error', message: error.message }, 500, origin);\n        }\n    }\n};\n", "// backend/workers/auth.js\r\n// Ch\u00FA th\u00EDch: Simple username-based authentication cho h\u1ECDc sinh\r\n// Kh\u00F4ng c\u1EA7n password - ch\u1EC9 username \u0111\u1EC3 d\u1EC5 s\u1EED d\u1EE5ng\r\n\r\n/**\r\n * Ki\u1EC3m tra username h\u1EE3p l\u1EC7\r\n * @param {string} username\r\n * @returns {Object} { valid: boolean, error?: string }\r\n */\r\nfunction validateUsername(username) {\r\n    if (!username || typeof username !== 'string') {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' };\r\n    }\r\n\r\n    const trimmed = username.trim();\r\n\r\n    if (trimmed.length < 3) {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n ph\u1EA3i c\u00F3 \u00EDt nh\u1EA5t 3 k\u00FD t\u1EF1' };\r\n    }\r\n\r\n    if (trimmed.length > 30) {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n kh\u00F4ng qu\u00E1 30 k\u00FD t\u1EF1' };\r\n    }\r\n\r\n    // Ch\u1EC9 cho ph\u00E9p ch\u1EEF c\u00E1i, s\u1ED1, underscore, d\u1EA5u g\u1EA1ch ngang\r\n    if (!/^[a-zA-Z0-9_\\-\\u00C0-\\u024F\\u1E00-\\u1EFF]+$/u.test(trimmed)) {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n ch\u1EC9 \u0111\u01B0\u1EE3c ch\u1EE9a ch\u1EEF c\u00E1i, s\u1ED1, _ v\u00E0 -' };\r\n    }\r\n\r\n    return { valid: true };\r\n}\r\n\r\n/**\r\n * Sinh g\u1EE3i \u00FD t\u00EAn thay th\u1EBF khi b\u1ECB tr\u00F9ng\r\n * @param {string} username\r\n * @returns {string[]} Danh s\u00E1ch g\u1EE3i \u00FD\r\n */\r\nfunction generateUsernameSuggestions(username) {\r\n    const suggestions = [];\r\n    const now = Date.now().toString().slice(-4);\r\n\r\n    suggestions.push(`${username}${now}`);\r\n    suggestions.push(`${username}_${Math.floor(Math.random() * 100)}`);\r\n    suggestions.push(`${username}${new Date().getFullYear()}`);\r\n\r\n    return suggestions;\r\n}\r\n\r\n/**\r\n * Handler \u0111\u0103ng k\u00FD t\u00E0i kho\u1EA3n m\u1EDBi\r\n * POST /api/auth/register\r\n */\r\nexport async function handleRegister(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { username } = body;\r\n\r\n        // Validate username\r\n        const validation = validateUsername(username);\r\n        if (!validation.valid) {\r\n            return createJsonResponse({ error: validation.error }, 400);\r\n        }\r\n\r\n        const trimmedUsername = username.trim();\r\n\r\n        // Check if username exists\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM users WHERE username = ?'\r\n        ).bind(trimmedUsername).first();\r\n\r\n        if (existing) {\r\n            const suggestions = generateUsernameSuggestions(trimmedUsername);\r\n            return createJsonResponse({\r\n                error: 'username_taken',\r\n                message: `T\u00EAn \"${trimmedUsername}\" \u0111\u00E3 \u0111\u01B0\u1EE3c s\u1EED d\u1EE5ng`,\r\n                suggestions\r\n            }, 409);\r\n        }\r\n\r\n        // Create new user\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO users (username) VALUES (?) RETURNING id, username, created_at'\r\n        ).bind(trimmedUsername).first();\r\n\r\n        // Create default settings\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO user_settings (user_id) VALUES (?)'\r\n        ).bind(result.id).run();\r\n\r\n        return createJsonResponse({\r\n            success: true,\r\n            user: {\r\n                id: result.id,\r\n                username: result.username,\r\n                created_at: result.created_at\r\n            }\r\n        }, 201);\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] Register error:', error.message);\r\n        return createJsonResponse({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Handler \u0111\u0103ng nh\u1EADp\r\n * POST /api/auth/login\r\n */\r\nexport async function handleLogin(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { username } = body;\r\n\r\n        // Validate username\r\n        const validation = validateUsername(username);\r\n        if (!validation.valid) {\r\n            return createJsonResponse({ error: validation.error }, 400);\r\n        }\r\n\r\n        const trimmedUsername = username.trim();\r\n\r\n        // Find user\r\n        const user = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, username, created_at FROM users WHERE username = ?'\r\n        ).bind(trimmedUsername).first();\r\n\r\n        if (!user) {\r\n            return createJsonResponse({\r\n                error: 'user_not_found',\r\n                message: `Kh\u00F4ng t\u00ECm th\u1EA5y t\u00E0i kho\u1EA3n \"${trimmedUsername}\"`,\r\n                canRegister: true\r\n            }, 404);\r\n        }\r\n\r\n        // Update last login - s\u1EED d\u1EE5ng datetime('now') tr\u1EF1c ti\u1EBFp trong SQL\r\n        // D1 database: UPDATE ph\u1EA3i ch\u1EA1y tr\u01B0\u1EDBc SELECT\r\n        try {\r\n            const updateResult = await env.ban_dong_hanh_db.prepare(\r\n                \"UPDATE users SET last_login = datetime('now') WHERE id = ?\"\r\n            ).bind(user.id).run();\r\n            \r\n            console.log('[Auth] UPDATE executed - changes:', updateResult.changes, 'success:', updateResult.success);\r\n            \r\n            if (updateResult.changes === 0) {\r\n                console.warn('[Auth] WARNING: UPDATE affected 0 rows for user', user.id);\r\n            }\r\n        } catch (updateError) {\r\n            console.error('[Auth] UPDATE error:', updateError.message);\r\n            // Continue anyway - kh\u00F4ng fail login n\u1EBFu update l\u1ED7i\r\n        }\r\n\r\n        // Get updated user with last_login\r\n        // Query l\u1EA1i \u0111\u1EC3 l\u1EA5y gi\u00E1 tr\u1ECB m\u1EDBi nh\u1EA5t\r\n        const updatedUser = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, username, created_at, COALESCE(last_login, NULL) as last_login FROM users WHERE id = ?'\r\n        ).bind(user.id).first();\r\n        \r\n        console.log('[Auth] SELECT result:', {\r\n            id: updatedUser?.id,\r\n            username: updatedUser?.username,\r\n            last_login: updatedUser?.last_login,\r\n            has_last_login: 'last_login' in (updatedUser || {})\r\n        });\r\n\r\n        // Build response - \u0111\u1EA3m b\u1EA3o last_login lu\u00F4n c\u00F3\r\n        const responseUser = {\r\n            id: updatedUser.id,\r\n            username: updatedUser.username,\r\n            created_at: updatedUser.created_at,\r\n        };\r\n        \r\n        // Explicitly add last_login (c\u00F3 th\u1EC3 null ho\u1EB7c undefined)\r\n        if ('last_login' in updatedUser) {\r\n            responseUser.last_login = updatedUser.last_login;\r\n        } else {\r\n            // N\u1EBFu kh\u00F4ng c\u00F3 trong result, query ri\u00EAng\r\n            const lastLoginCheck = await env.ban_dong_hanh_db.prepare(\r\n                'SELECT last_login FROM users WHERE id = ?'\r\n            ).bind(user.id).first();\r\n            responseUser.last_login = lastLoginCheck?.last_login || null;\r\n        }\r\n        \r\n        console.log('[Auth] Final response user:', responseUser);\r\n        \r\n        return createJsonResponse({\r\n            success: true,\r\n            user: responseUser\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] Login error:', error.message);\r\n        return createJsonResponse({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Handler ki\u1EC3m tra username availability\r\n * GET /api/auth/check?username=xxx\r\n */\r\nexport async function handleCheckUsername(request, env) {\r\n    try {\r\n        const url = new URL(request.url);\r\n        const username = url.searchParams.get('username');\r\n\r\n        const validation = validateUsername(username);\r\n        if (!validation.valid) {\r\n            return createJsonResponse({ available: false, error: validation.error });\r\n        }\r\n\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM users WHERE username = ?'\r\n        ).bind(username.trim()).first();\r\n\r\n        return createJsonResponse({\r\n            available: !existing,\r\n            username: username.trim()\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] Check error:', error.message);\r\n        return createJsonResponse({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Handler l\u1EA5y th\u00F4ng tin user\r\n * GET /api/auth/me\r\n * Header: X-User-Id: <userId>\r\n */\r\nexport async function handleGetMe(request, env) {\r\n    try {\r\n        const userId = request.headers.get('X-User-Id');\r\n\r\n        if (!userId) {\r\n            return createJsonResponse({ error: 'not_authenticated' }, 401);\r\n        }\r\n\r\n        const user = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, username, created_at, last_login FROM users WHERE id = ?'\r\n        ).bind(parseInt(userId)).first();\r\n\r\n        if (!user) {\r\n            return createJsonResponse({ error: 'user_not_found' }, 404);\r\n        }\r\n\r\n        // Get settings\r\n        const settings = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT theme, notifications, sound, font_size FROM user_settings WHERE user_id = ?'\r\n        ).bind(user.id).first();\r\n\r\n        return createJsonResponse({\r\n            user: { ...user, settings: settings || {} }\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] GetMe error:', error.message);\r\n        return createJsonResponse({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Helper t\u1EA1o JSON response\r\n */\r\nfunction createJsonResponse(data, status = 200) {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n/**\r\n * Handler x\u00F3a t\u00E0i kho\u1EA3n v\u00E0 t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u\r\n * DELETE /api/auth/account\r\n * Header: X-User-Id: <userId>\r\n */\r\nexport async function handleDeleteAccount(request, env) {\r\n    try {\r\n        const userId = request.headers.get('X-User-Id');\r\n        if (!userId) {\r\n            return createJsonResponse({ error: 'not_authenticated' }, 401);\r\n        }\r\n\r\n        const userIdInt = parseInt(userId);\r\n        if (isNaN(userIdInt)) {\r\n            return createJsonResponse({ error: 'invalid_user_id' }, 400);\r\n        }\r\n\r\n        // X\u00F3a t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u li\u00EAn quan (cascade delete)\r\n        // L\u01B0u \u00FD: SQLite kh\u00F4ng h\u1ED7 tr\u1EE3 CASCADE DELETE, ph\u1EA3i x\u00F3a th\u1EE7 c\u00F4ng\r\n        const tables = [\r\n            'gratitude',\r\n            'journal',\r\n            'focus_sessions',\r\n            'breathing_sessions',\r\n            'sleep_logs',\r\n            'achievements',\r\n            'game_scores',\r\n            'user_stats',\r\n            'notification_settings',\r\n            'user_settings',\r\n            'random_cards_history',\r\n            // Forum data\r\n            'forum_upvotes',\r\n            'forum_comments',\r\n            'forum_posts',\r\n            // SOS logs - ch\u1EC9 x\u00F3a metadata, gi\u1EEF hashed_user_id \u0111\u1EC3 th\u1ED1ng k\u00EA\r\n        ];\r\n\r\n        // X\u00F3a d\u1EEF li\u1EC7u t\u1EEB c\u00E1c b\u1EA3ng\r\n        for (const table of tables) {\r\n            try {\r\n                await env.ban_dong_hanh_db.prepare(\r\n                    `DELETE FROM ${table} WHERE user_id = ?`\r\n                ).bind(userIdInt).run();\r\n            } catch (e) {\r\n                console.warn(`[DeleteAccount] Failed to delete from ${table}:`, e.message);\r\n            }\r\n        }\r\n\r\n        // X\u00F3a user\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM users WHERE id = ?'\r\n        ).bind(userIdInt).run();\r\n\r\n        return createJsonResponse({\r\n            success: true,\r\n            message: 'T\u00E0i kho\u1EA3n v\u00E0 t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u \u0111\u00E3 \u0111\u01B0\u1EE3c x\u00F3a th\u00E0nh c\u00F4ng'\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] DeleteAccount error:', error.message);\r\n        return createJsonResponse({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n// Export cho testing\r\nexport { validateUsername, generateUsernameSuggestions };\r\n", "// backend/workers/data-api.js\r\n// Ch\u00FA th\u00EDch: REST API cho CRUD d\u1EEF li\u1EC7u ng\u01B0\u1EDDi d\u00F9ng (gratitude, journal, focus, breathing, achievements)\r\n\r\n/**\r\n * Extract v\u00E0 validate userId t\u1EEB request headers\r\n */\r\nfunction getUserId(request) {\r\n    const userId = request.headers.get('X-User-Id');\r\n    if (!userId) return null;\r\n    const parsed = parseInt(userId);\r\n    return isNaN(parsed) ? null : parsed;\r\n}\r\n\r\n/**\r\n * Helper t\u1EA1o JSON response\r\n */\r\nfunction json(data, status = 200) {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n// =============================================================================\r\n// GRATITUDE ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/gratitude - L\u1EA5y danh s\u00E1ch gratitude\r\n * Query params: ?limit=50&offset=0\r\n */\r\nexport async function getGratitude(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n    const offset = parseInt(url.searchParams.get('offset') || '0');\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, content, tag, created_at FROM gratitude WHERE user_id = ? ORDER BY created_at DESC LIMIT ? OFFSET ?'\r\n        ).bind(userId, limit, offset).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getGratitude error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/gratitude - Th\u00EAm gratitude m\u1EDBi\r\n * Body: { content: string, tag?: string }\r\n */\r\nexport async function addGratitude(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { content, tag } = await request.json();\r\n\r\n        if (!content || typeof content !== 'string' || content.trim().length === 0) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' }, 400);\r\n        }\r\n\r\n        if (content.length > 500) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng qu\u00E1 500 k\u00FD t\u1EF1' }, 400);\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO gratitude (user_id, content, tag) VALUES (?, ?, ?) RETURNING id, content, tag, created_at'\r\n        ).bind(userId, content.trim(), tag || null).first();\r\n\r\n        return json({ success: true, item: result, id: result.id }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addGratitude error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/gratitude/:id - X\u00F3a gratitude\r\n */\r\nexport async function deleteGratitude(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM gratitude WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteGratitude error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// JOURNAL ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/journal - L\u1EA5y danh s\u00E1ch nh\u1EADt k\u00FD\r\n */\r\nexport async function getJournal(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '30'), 100);\r\n    const offset = parseInt(url.searchParams.get('offset') || '0');\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, content, mood, tags, sentiment_score, created_at FROM journal WHERE user_id = ? ORDER BY created_at DESC LIMIT ? OFFSET ?'\r\n        ).bind(userId, limit, offset).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getJournal error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/journal - Th\u00EAm nh\u1EADt k\u00FD m\u1EDBi\r\n * Body: { content: string, mood?: string, tags?: string[] }\r\n */\r\nexport async function addJournal(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { content, mood, tags } = await request.json();\r\n\r\n        if (!content || typeof content !== 'string' || content.trim().length === 0) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' }, 400);\r\n        }\r\n\r\n        if (content.length > 5000) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng qu\u00E1 5000 k\u00FD t\u1EF1' }, 400);\r\n        }\r\n\r\n        const validMoods = ['happy', 'calm', 'neutral', 'sad', 'stressed'];\r\n        const moodValue = validMoods.includes(mood) ? mood : null;\r\n        const tagsValue = Array.isArray(tags) ? JSON.stringify(tags.slice(0, 5)) : null;\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO journal (user_id, content, mood, tags) VALUES (?, ?, ?, ?) RETURNING id, content, mood, tags, created_at'\r\n        ).bind(userId, content.trim(), moodValue, tagsValue).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addJournal error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/journal/:id - X\u00F3a nh\u1EADt k\u00FD\r\n */\r\nexport async function deleteJournal(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM journal WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteJournal error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// FOCUS SESSIONS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/focus - L\u1EA5y l\u1ECBch s\u1EED focus sessions\r\n */\r\nexport async function getFocusSessions(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 200);\r\n    const offset = parseInt(url.searchParams.get('offset') || '0');\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, duration_minutes, session_type, completed, created_at FROM focus_sessions WHERE user_id = ? ORDER BY created_at DESC LIMIT ? OFFSET ?'\r\n        ).bind(userId, limit, offset).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getFocusSessions error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/focus - L\u01B0u focus session\r\n * Body: { duration_minutes: number, session_type?: 'focus'|'break', completed?: boolean }\r\n */\r\nexport async function addFocusSession(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { duration_minutes, session_type = 'focus', completed = true } = await request.json();\r\n\r\n        if (!duration_minutes || typeof duration_minutes !== 'number' || duration_minutes <= 0) {\r\n            return json({ error: 'duration_minutes ph\u1EA3i l\u00E0 s\u1ED1 d\u01B0\u01A1ng' }, 400);\r\n        }\r\n\r\n        const validTypes = ['focus', 'break'];\r\n        const typeValue = validTypes.includes(session_type) ? session_type : 'focus';\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO focus_sessions (user_id, duration_minutes, session_type, completed) VALUES (?, ?, ?, ?) RETURNING id, duration_minutes, session_type, completed, created_at'\r\n        ).bind(userId, duration_minutes, typeValue, completed ? 1 : 0).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addFocusSession error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// BREATHING SESSIONS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/breathing - L\u1EA5y l\u1ECBch s\u1EED breathing sessions\r\n */\r\nexport async function getBreathingSessions(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 200);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, exercise_type, duration_seconds, created_at FROM breathing_sessions WHERE user_id = ? ORDER BY created_at DESC LIMIT ?'\r\n        ).bind(userId, limit).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getBreathingSessions error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/breathing - L\u01B0u breathing session\r\n * Body: { exercise_type: string, duration_seconds: number }\r\n */\r\nexport async function addBreathingSession(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { exercise_type, duration_seconds } = await request.json();\r\n\r\n        if (!exercise_type || typeof exercise_type !== 'string') {\r\n            return json({ error: 'exercise_type b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        if (!duration_seconds || typeof duration_seconds !== 'number' || duration_seconds <= 0) {\r\n            return json({ error: 'duration_seconds ph\u1EA3i l\u00E0 s\u1ED1 d\u01B0\u01A1ng' }, 400);\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO breathing_sessions (user_id, exercise_type, duration_seconds) VALUES (?, ?, ?) RETURNING id, exercise_type, duration_seconds, created_at'\r\n        ).bind(userId, exercise_type, duration_seconds).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addBreathingSession error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// SLEEP LOGS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/sleep - L\u1EA5y l\u1ECBch s\u1EED gi\u1EA5c ng\u1EE7\r\n * Query params: ?limit=50\r\n */\r\nexport async function getSleepLogs(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, sleep_time, wake_time, duration_minutes, quality, notes, created_at FROM sleep_logs WHERE user_id = ? ORDER BY created_at DESC LIMIT ?'\r\n        ).bind(userId, limit).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getSleepLogs error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/sleep - L\u01B0u sleep log\r\n * Body: { sleep_time: string, wake_time: string, quality?: number, notes?: string }\r\n */\r\nexport async function addSleepLog(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { sleep_time, wake_time, quality, notes, duration_minutes } = await request.json();\r\n\r\n        if (!sleep_time || !wake_time) {\r\n            return json({ error: 'sleep_time v\u00E0 wake_time b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        // Validate quality n\u1EBFu c\u00F3\r\n        const qualityValue = quality ? Math.min(5, Math.max(1, parseInt(quality))) : null;\r\n\r\n        // T\u00EDnh duration n\u1EBFu kh\u00F4ng \u0111\u01B0\u1EE3c truy\u1EC1n\r\n        let durationValue = duration_minutes;\r\n        if (!durationValue) {\r\n            // Th\u1EED parse th\u1EDDi gian \u0111\u1EC3 t\u00EDnh duration\r\n            try {\r\n                const sleepParts = sleep_time.split(':').map(Number);\r\n                const wakeParts = wake_time.split(':').map(Number);\r\n                const sleepMinutes = sleepParts[0] * 60 + sleepParts[1];\r\n                let wakeMinutes = wakeParts[0] * 60 + wakeParts[1];\r\n\r\n                // N\u1EBFu wake < sleep, ngh\u0129a l\u00E0 qua ng\u00E0y m\u1EDBi\r\n                if (wakeMinutes < sleepMinutes) {\r\n                    wakeMinutes += 24 * 60;\r\n                }\r\n                durationValue = wakeMinutes - sleepMinutes;\r\n            } catch {\r\n                durationValue = null;\r\n            }\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO sleep_logs (user_id, sleep_time, wake_time, duration_minutes, quality, notes) VALUES (?, ?, ?, ?, ?, ?) RETURNING id, sleep_time, wake_time, duration_minutes, quality, notes, created_at'\r\n        ).bind(userId, sleep_time, wake_time, durationValue, qualityValue, notes || null).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addSleepLog error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/sleep/:id - X\u00F3a sleep log\r\n */\r\nexport async function deleteSleepLog(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM sleep_logs WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteSleepLog error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * PUT /api/data/sleep/:id - C\u1EADp nh\u1EADt sleep log\r\n */\r\nexport async function updateSleepLog(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { sleep_time, wake_time, quality, notes, duration_minutes } = await request.json();\r\n\r\n        // Verify ownership\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM sleep_logs WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).first();\r\n\r\n        if (!existing) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        const qualityValue = quality ? Math.min(5, Math.max(1, parseInt(quality))) : null;\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'UPDATE sleep_logs SET sleep_time = ?, wake_time = ?, duration_minutes = ?, quality = ?, notes = ? WHERE id = ? AND user_id = ? RETURNING *'\r\n        ).bind(sleep_time, wake_time, duration_minutes || null, qualityValue, notes || null, parseInt(id), userId).first();\r\n\r\n        return json({ success: true, item: result });\r\n    } catch (error) {\r\n        console.error('[Data] updateSleepLog error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// ACHIEVEMENTS ENDPOINTS\r\n// =============================================================================\r\n\r\n\r\n/**\r\n * GET /api/data/achievements - L\u1EA5y danh s\u00E1ch achievements \u0111\u00E3 m\u1EDF kh\u00F3a\r\n */\r\nexport async function getAchievements(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, achievement_id, unlocked_at FROM achievements WHERE user_id = ? ORDER BY unlocked_at DESC'\r\n        ).bind(userId).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getAchievements error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/achievements - M\u1EDF kh\u00F3a achievement\r\n * Body: { achievement_id: string }\r\n */\r\nexport async function unlockAchievement(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { achievement_id } = await request.json();\r\n\r\n        if (!achievement_id || typeof achievement_id !== 'string') {\r\n            return json({ error: 'achievement_id b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        // Check if already unlocked\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM achievements WHERE user_id = ? AND achievement_id = ?'\r\n        ).bind(userId, achievement_id).first();\r\n\r\n        if (existing) {\r\n            return json({ success: true, alreadyUnlocked: true });\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO achievements (user_id, achievement_id) VALUES (?, ?) RETURNING id, achievement_id, unlocked_at'\r\n        ).bind(userId, achievement_id).first();\r\n\r\n        return json({ success: true, item: result, newUnlock: true }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] unlockAchievement error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// STATS ENDPOINT\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/stats - L\u1EA5y th\u1ED1ng k\u00EA t\u1ED5ng h\u1EE3p\r\n */\r\nexport async function getStats(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        // Gratitude count\r\n        const gratitudeCount = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count FROM gratitude WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Journal count v\u00E0 mood distribution\r\n        const journalCount = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count FROM journal WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        const moodDist = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT mood, COUNT(*) as count FROM journal WHERE user_id = ? AND mood IS NOT NULL GROUP BY mood'\r\n        ).bind(userId).all();\r\n\r\n        // Focus sessions count v\u00E0 total minutes\r\n        const focusStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count, COALESCE(SUM(duration_minutes), 0) as total_minutes FROM focus_sessions WHERE user_id = ? AND completed = 1'\r\n        ).bind(userId).first();\r\n\r\n        // Breathing sessions count v\u00E0 total seconds\r\n        const breathingStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count, COALESCE(SUM(duration_seconds), 0) as total_seconds FROM breathing_sessions WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Sleep statistics\r\n        const sleepStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count, COALESCE(AVG(duration_minutes), 0) as avg_duration, COALESCE(AVG(quality), 0) as avg_quality FROM sleep_logs WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Achievements count\r\n        const achievementsCount = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count FROM achievements WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Gratitude streak (ng\u00E0y li\u00EAn ti\u1EBFp c\u00F3 entry)\r\n        const streakResult = await env.ban_dong_hanh_db.prepare(`\r\n      SELECT DATE(created_at) as date FROM gratitude \r\n      WHERE user_id = ? \r\n      GROUP BY DATE(created_at) \r\n      ORDER BY date DESC\r\n    `).bind(userId).all();\r\n\r\n        let streak = 0;\r\n        if (streakResult.results.length > 0) {\r\n            const today = new Date().toISOString().split('T')[0];\r\n            const dates = streakResult.results.map(r => r.date);\r\n\r\n            // Check if today or yesterday has entry\r\n            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];\r\n            if (dates[0] === today || dates[0] === yesterday) {\r\n                streak = 1;\r\n                for (let i = 1; i < dates.length; i++) {\r\n                    const prevDate = new Date(dates[i - 1]);\r\n                    const currDate = new Date(dates[i]);\r\n                    const diffDays = (prevDate - currDate) / 86400000;\r\n                    if (diffDays === 1) {\r\n                        streak++;\r\n                    } else {\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Build mood distribution object\r\n        const moodDistribution = {};\r\n        if (moodDist.results) {\r\n            moodDist.results.forEach(m => { moodDistribution[m.mood] = m.count; });\r\n        }\r\n\r\n        return json({\r\n            gratitude: { count: gratitudeCount.count, streak },\r\n            journal: { count: journalCount.count, moodDistribution },\r\n            focus: { sessions: focusStats.count, totalMinutes: focusStats.total_minutes },\r\n            breathing: { sessions: breathingStats.count, totalSeconds: breathingStats.total_seconds },\r\n            sleep: {\r\n                logs: sleepStats.count,\r\n                avgMinutes: Math.round(sleepStats.avg_duration || 0),\r\n                avgQuality: parseFloat((sleepStats.avg_quality || 0).toFixed(1))\r\n            },\r\n            achievements: { count: achievementsCount.count }\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getStats error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// EXPORT/IMPORT ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/export - Xu\u1EA5t to\u00E0n b\u1ED9 d\u1EEF li\u1EC7u user\r\n */\r\nexport async function exportData(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const user = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT username, created_at FROM users WHERE id = ?'\r\n        ).bind(userId).first();\r\n\r\n        const gratitude = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT content, created_at FROM gratitude WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const journal = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT content, mood, tags, created_at FROM journal WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const focus = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT duration_minutes, session_type, completed, created_at FROM focus_sessions WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const breathing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT exercise_type, duration_seconds, created_at FROM breathing_sessions WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const sleepLogs = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT sleep_time, wake_time, duration_minutes, quality, notes, created_at FROM sleep_logs WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const achievements = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT achievement_id, unlocked_at FROM achievements WHERE user_id = ?'\r\n        ).bind(userId).all();\r\n\r\n        const settings = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT theme, notifications, sound, font_size FROM user_settings WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        return json({\r\n            exportedAt: new Date().toISOString(),\r\n            version: '1.1',\r\n            user: { username: user.username, created_at: user.created_at },\r\n            data: {\r\n                gratitude: gratitude.results,\r\n                journal: journal.results,\r\n                focus_sessions: focus.results,\r\n                breathing_sessions: breathing.results,\r\n                sleep_logs: sleepLogs.results,\r\n                achievements: achievements.results,\r\n                settings: settings || {}\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] exportData error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/import - Nh\u1EADp d\u1EEF li\u1EC7u t\u1EEB JSON\r\n * Body: { data: { gratitude: [], journal: [], ... } }\r\n */\r\nexport async function importData(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { data } = await request.json();\r\n        console.log('[Import] User', userId, 'importing data:', {\r\n            gratitude: data?.gratitude?.length || 0,\r\n            journal: data?.journal?.length || 0,\r\n            focus: data?.focus_sessions?.length || 0,\r\n            breathing: data?.breathing_sessions?.length || 0,\r\n            sleep: data?.sleep_logs?.length || 0,\r\n        });\r\n\r\n        if (!data || typeof data !== 'object') {\r\n            return json({ error: 'invalid_data_format' }, 400);\r\n        }\r\n\r\n        let imported = { gratitude: 0, journal: 0, focus: 0, breathing: 0 };\r\n\r\n        // Import gratitude\r\n        if (Array.isArray(data.gratitude)) {\r\n            for (const item of data.gratitude.slice(0, 1000)) {\r\n                if (item.content) {\r\n                    const createdAt = item.created_at || new Date().toISOString();\r\n                    // Ki\u1EC3m tra duplicate d\u1EF1a tr\u00EAn content v\u00E0 created_at (trong c\u00F9ng ng\u00E0y)\r\n                    const existing = await env.ban_dong_hanh_db.prepare(\r\n                        `SELECT id FROM gratitude \r\n                         WHERE user_id = ? AND content = ? \r\n                         AND date(created_at) = date(?)`\r\n                    ).bind(userId, item.content, createdAt).first();\r\n                    \r\n                    if (!existing) {\r\n                        await env.ban_dong_hanh_db.prepare(\r\n                            'INSERT INTO gratitude (user_id, content, created_at) VALUES (?, ?, ?)'\r\n                        ).bind(userId, item.content, createdAt).run();\r\n                        imported.gratitude++;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import journal\r\n        if (Array.isArray(data.journal)) {\r\n            for (const item of data.journal.slice(0, 500)) {\r\n                if (item.content) {\r\n                    const createdAt = item.created_at || new Date().toISOString();\r\n                    // Ki\u1EC3m tra duplicate d\u1EF1a tr\u00EAn content v\u00E0 created_at (trong c\u00F9ng ng\u00E0y)\r\n                    const dateOnly = createdAt.split('T')[0];\r\n                    const existing = await env.ban_dong_hanh_db.prepare(\r\n                        `SELECT id FROM journal \r\n                         WHERE user_id = ? AND content = ? \r\n                         AND date(created_at) = date(?)`\r\n                    ).bind(userId, item.content, createdAt).first();\r\n                    \r\n                    if (!existing) {\r\n                        await env.ban_dong_hanh_db.prepare(\r\n                            'INSERT INTO journal (user_id, content, mood, tags, created_at) VALUES (?, ?, ?, ?, ?)'\r\n                        ).bind(userId, item.content, item.mood || null, item.tags || null, createdAt).run();\r\n                        imported.journal++;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import focus sessions\r\n        if (Array.isArray(data.focus_sessions)) {\r\n            for (const item of data.focus_sessions.slice(0, 1000)) {\r\n                if (item.duration_minutes) {\r\n                    await env.ban_dong_hanh_db.prepare(\r\n                        'INSERT INTO focus_sessions (user_id, duration_minutes, session_type, completed, created_at) VALUES (?, ?, ?, ?, ?)'\r\n                    ).bind(userId, item.duration_minutes, item.session_type || 'focus', item.completed ?? 1, item.created_at || new Date().toISOString()).run();\r\n                    imported.focus++;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import breathing sessions\r\n        if (Array.isArray(data.breathing_sessions)) {\r\n            for (const item of data.breathing_sessions.slice(0, 1000)) {\r\n                if (item.exercise_type && item.duration_seconds) {\r\n                    await env.ban_dong_hanh_db.prepare(\r\n                        'INSERT INTO breathing_sessions (user_id, exercise_type, duration_seconds, created_at) VALUES (?, ?, ?, ?)'\r\n                    ).bind(userId, item.exercise_type, item.duration_seconds, item.created_at || new Date().toISOString()).run();\r\n                    imported.breathing++;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import sleep logs\r\n        if (Array.isArray(data.sleep_logs)) {\r\n            for (const item of data.sleep_logs.slice(0, 500)) {\r\n                if (item.sleep_time && item.wake_time) {\r\n                    await env.ban_dong_hanh_db.prepare(\r\n                        'INSERT INTO sleep_logs (user_id, sleep_time, wake_time, duration_minutes, quality, notes, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)'\r\n                    ).bind(\r\n                        userId,\r\n                        item.sleep_time,\r\n                        item.wake_time,\r\n                        item.duration_minutes || null,\r\n                        item.quality || null,\r\n                        item.notes || null,\r\n                        item.created_at || new Date().toISOString()\r\n                    ).run();\r\n                    imported.sleep = (imported.sleep || 0) + 1;\r\n                }\r\n            }\r\n        }\r\n\r\n        console.log('[Import] Successfully imported for user', userId, ':', imported);\r\n        return json({ success: true, imported });\r\n    } catch (error) {\r\n        console.error('[Data] importData error:', error.message);\r\n        return json({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// GAME SCORES ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/game-scores - L\u1EA5y \u0111i\u1EC3m s\u1ED1 game\r\n * Query params: ?game_type=space_control&limit=10&leaderboard=true\r\n */\r\nexport async function getGameScores(request, env) {\r\n    const userId = getUserId(request);\r\n    const url = new URL(request.url);\r\n    const gameType = url.searchParams.get('game_type');\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '10'), 50);\r\n    const leaderboard = url.searchParams.get('leaderboard') === 'true';\r\n\r\n    try {\r\n        if (leaderboard) {\r\n            // Leaderboard to\u00E0n b\u1ED9 users (\u1EA9n danh)\r\n            const result = await env.ban_dong_hanh_db.prepare(`\r\n                SELECT gs.score, gs.level_reached, gs.created_at, \r\n                       'Player_' || SUBSTR(CAST(gs.user_id AS TEXT), 1, 3) as player_name\r\n                FROM game_scores gs\r\n                ${gameType ? 'WHERE gs.game_type = ?' : ''}\r\n                ORDER BY gs.score DESC\r\n                LIMIT ?\r\n            `).bind(...(gameType ? [gameType, limit] : [limit])).all();\r\n\r\n            return json({ leaderboard: result.results });\r\n        }\r\n\r\n        // Personal scores - c\u1EA7n \u0111\u0103ng nh\u1EADp\r\n        if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n        const query = gameType\r\n            ? 'SELECT id, game_type, score, level_reached, play_duration_seconds, created_at FROM game_scores WHERE user_id = ? AND game_type = ? ORDER BY score DESC LIMIT ?'\r\n            : 'SELECT id, game_type, score, level_reached, play_duration_seconds, created_at FROM game_scores WHERE user_id = ? ORDER BY created_at DESC LIMIT ?';\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(query)\r\n            .bind(...(gameType ? [userId, gameType, limit] : [userId, limit])).all();\r\n\r\n        // L\u1EA5y high score cho m\u1ED7i game\r\n        const highScores = await env.ban_dong_hanh_db.prepare(`\r\n            SELECT game_type, MAX(score) as high_score \r\n            FROM game_scores \r\n            WHERE user_id = ? \r\n            GROUP BY game_type\r\n        `).bind(userId).all();\r\n\r\n        return json({\r\n            items: result.results,\r\n            highScores: Object.fromEntries(highScores.results.map(h => [h.game_type, h.high_score]))\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getGameScores error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/game-scores - L\u01B0u \u0111i\u1EC3m game m\u1EDBi\r\n * Body: { game_type: string, score: number, level_reached?: number, play_duration_seconds?: number }\r\n */\r\nexport async function addGameScore(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { game_type, score, level_reached = 1, play_duration_seconds } = await request.json();\r\n\r\n        if (!game_type || typeof game_type !== 'string') {\r\n            return json({ error: 'game_type b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        if (typeof score !== 'number' || score < 0) {\r\n            return json({ error: 'score ph\u1EA3i l\u00E0 s\u1ED1 kh\u00F4ng \u00E2m' }, 400);\r\n        }\r\n\r\n        const validGames = ['space_control', 'space_pilot', 'bee_game', 'bubble_pop', 'color_match', 'doodle', 'reflex'];\r\n        if (!validGames.includes(game_type)) {\r\n            return json({ error: 'game_type kh\u00F4ng h\u1EE3p l\u1EC7' }, 400);\r\n        }\r\n\r\n        // L\u1EA5y high score hi\u1EC7n t\u1EA1i\r\n        const currentHigh = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT MAX(score) as high FROM game_scores WHERE user_id = ? AND game_type = ?'\r\n        ).bind(userId, game_type).first();\r\n\r\n        const isNewRecord = score > (currentHigh?.high || 0);\r\n\r\n        // L\u01B0u score m\u1EDBi\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO game_scores (user_id, game_type, score, level_reached, play_duration_seconds) VALUES (?, ?, ?, ?, ?) RETURNING *'\r\n        ).bind(userId, game_type, score, level_reached, play_duration_seconds || null).first();\r\n\r\n        // C\u1EADp nh\u1EADt user_stats n\u1EBFu l\u00E0 record m\u1EDBi\r\n        if (isNewRecord) {\r\n            await env.ban_dong_hanh_db.prepare(`\r\n                INSERT INTO user_stats (user_id, games_played, highest_game_score)\r\n                VALUES (?, 1, ?)\r\n                ON CONFLICT(user_id) DO UPDATE SET\r\n                    games_played = games_played + 1,\r\n                    highest_game_score = MAX(highest_game_score, ?),\r\n                    updated_at = datetime('now')\r\n            `).bind(userId, score, score).run();\r\n        }\r\n\r\n        return json({\r\n            success: true,\r\n            item: result,\r\n            isNewRecord,\r\n            previousHigh: currentHigh?.high || 0\r\n        }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addGameScore error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// NOTIFICATION SETTINGS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/notification-settings - L\u1EA5y c\u00E0i \u0111\u1EB7t th\u00F4ng b\u00E1o\r\n */\r\nexport async function getNotificationSettings(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const settings = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT daily_reminder, pomodoro_alerts, sleep_reminder, reminder_time, push_subscription FROM notification_settings WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Tr\u1EA3 v\u1EC1 default settings n\u1EBFu ch\u01B0a c\u00F3\r\n        return json({\r\n            settings: settings || {\r\n                daily_reminder: false,\r\n                pomodoro_alerts: true,\r\n                sleep_reminder: false,\r\n                reminder_time: null,\r\n                push_subscription: null\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getNotificationSettings error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/notification-settings - L\u01B0u c\u00E0i \u0111\u1EB7t th\u00F4ng b\u00E1o\r\n * Body: { daily_reminder?: boolean, pomodoro_alerts?: boolean, sleep_reminder?: boolean, reminder_time?: string, push_subscription?: object }\r\n */\r\nexport async function saveNotificationSettings(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { daily_reminder, pomodoro_alerts, sleep_reminder, reminder_time, push_subscription } = await request.json();\r\n\r\n        // Validate reminder_time format n\u1EBFu c\u00F3\r\n        if (reminder_time && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(reminder_time)) {\r\n            return json({ error: 'reminder_time ph\u1EA3i c\u00F3 \u0111\u1ECBnh d\u1EA1ng HH:MM' }, 400);\r\n        }\r\n\r\n        // Stringify push_subscription n\u1EBFu l\u00E0 object\r\n        const subscriptionValue = push_subscription ? JSON.stringify(push_subscription) : null;\r\n\r\n        await env.ban_dong_hanh_db.prepare(`\r\n            INSERT INTO notification_settings (user_id, daily_reminder, pomodoro_alerts, sleep_reminder, reminder_time, push_subscription)\r\n            VALUES (?, ?, ?, ?, ?, ?)\r\n            ON CONFLICT(user_id) DO UPDATE SET\r\n                daily_reminder = COALESCE(?, daily_reminder),\r\n                pomodoro_alerts = COALESCE(?, pomodoro_alerts),\r\n                sleep_reminder = COALESCE(?, sleep_reminder),\r\n                reminder_time = COALESCE(?, reminder_time),\r\n                push_subscription = COALESCE(?, push_subscription),\r\n                updated_at = datetime('now')\r\n        `).bind(\r\n            userId,\r\n            daily_reminder ? 1 : 0,\r\n            pomodoro_alerts !== false ? 1 : 0,\r\n            sleep_reminder ? 1 : 0,\r\n            reminder_time || null,\r\n            subscriptionValue,\r\n            daily_reminder !== undefined ? (daily_reminder ? 1 : 0) : null,\r\n            pomodoro_alerts !== undefined ? (pomodoro_alerts ? 1 : 0) : null,\r\n            sleep_reminder !== undefined ? (sleep_reminder ? 1 : 0) : null,\r\n            reminder_time || null,\r\n            subscriptionValue\r\n        ).run();\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] saveNotificationSettings error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// SOS LOGS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * POST /api/data/sos-log - Ghi log s\u1EF1 ki\u1EC7n SOS\r\n * Body: { event_type: string, risk_level?: string, trigger_text?: string, location?: {lat, lng}, metadata?: object }\r\n * Ch\u00FA th\u00EDch: endpoint n\u00E0y kh\u00F4ng y\u00EAu c\u1EA7u \u0111\u0103ng nh\u1EADp \u0111\u1EC3 h\u1ED7 tr\u1EE3 c\u1EA3 kh\u00E1ch\r\n */\r\nexport async function logSOSEvent(request, env) {\r\n    const userId = getUserId(request); // c\u00F3 th\u1EC3 null\r\n\r\n    try {\r\n        const { event_type, risk_level, trigger_text, location, metadata } = await request.json();\r\n\r\n        if (!event_type) {\r\n            return json({ error: 'event_type b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        const validEventTypes = ['overlay_opened', 'hotline_clicked', 'map_viewed', 'message_flagged', 'false_positive'];\r\n        if (!validEventTypes.includes(event_type)) {\r\n            return json({ error: 'event_type kh\u00F4ng h\u1EE3p l\u1EC7' }, 400);\r\n        }\r\n\r\n        // T\u1EA1o hashed_user_id \u1EA9n danh n\u1EBFu c\u00F3 userId\r\n        let hashedUserId = null;\r\n        if (userId) {\r\n            // Simple hash: ch\u1EC9 l\u1EA5y 8 k\u00FD t\u1EF1 \u0111\u1EA7u c\u1EE7a hash\r\n            const encoder = new TextEncoder();\r\n            const data = encoder.encode(userId.toString() + 'bdh_salt');\r\n            const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n            const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n            hashedUserId = hashArray.slice(0, 4).map(b => b.toString(16).padStart(2, '0')).join('');\r\n        }\r\n\r\n        await env.ban_dong_hanh_db.prepare(`\r\n            INSERT INTO sos_logs (user_id, hashed_user_id, event_type, risk_level, trigger_text, location_lat, location_lng, metadata)\r\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n        `).bind(\r\n            userId || null,\r\n            hashedUserId,\r\n            event_type,\r\n            risk_level || null,\r\n            trigger_text ? trigger_text.slice(0, 50) : null, // Ch\u1EC9 l\u01B0u 50 k\u00FD t\u1EF1 t\u1EEB kh\u00F3a\r\n            location?.lat || null,\r\n            location?.lng || null,\r\n            metadata ? JSON.stringify(metadata) : null\r\n        ).run();\r\n\r\n        console.log('[SOS] Event logged:', { event_type, risk_level, hashedUserId });\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] logSOSEvent error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/admin/sos-logs - L\u1EA5y danh s\u00E1ch SOS logs (admin only)\r\n * Query params: ?limit=50&risk_level=red\r\n */\r\nexport async function getSOSLogs(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    // Ki\u1EC3m tra quy\u1EC1n admin\r\n    const user = await env.ban_dong_hanh_db.prepare(\r\n        'SELECT is_admin FROM users WHERE id = ?'\r\n    ).bind(userId).first();\r\n\r\n    if (!user?.is_admin) {\r\n        return json({ error: 'forbidden' }, 403);\r\n    }\r\n\r\n    try {\r\n        const url = new URL(request.url);\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 200);\r\n        const riskLevel = url.searchParams.get('risk_level');\r\n\r\n        const query = riskLevel\r\n            ? 'SELECT * FROM sos_logs WHERE risk_level = ? ORDER BY created_at DESC LIMIT ?'\r\n            : 'SELECT * FROM sos_logs ORDER BY created_at DESC LIMIT ?';\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(query)\r\n            .bind(...(riskLevel ? [riskLevel, limit] : [limit])).all();\r\n\r\n        // Th\u1ED1ng k\u00EA nhanh\r\n        const stats = await env.ban_dong_hanh_db.prepare(`\r\n            SELECT \r\n                risk_level,\r\n                COUNT(*) as count,\r\n                COUNT(DISTINCT hashed_user_id) as unique_users\r\n            FROM sos_logs\r\n            WHERE created_at > datetime('now', '-7 days')\r\n            GROUP BY risk_level\r\n        `).all();\r\n\r\n        return json({\r\n            logs: result.results,\r\n            stats: Object.fromEntries(stats.results.map(s => [s.risk_level || 'unknown', { count: s.count, unique_users: s.unique_users }]))\r\n        });\r\n    } catch (error) {\r\n        console.error('[Admin] getSOSLogs error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// RANDOM CARDS HISTORY ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/random-cards-history - L\u1EA5y l\u1ECBch s\u1EED th\u1EBB \u0111\u00E3 xem\r\n * Query params: ?limit=50\r\n */\r\nexport async function getRandomCardsHistory(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const url = new URL(request.url);\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT card_id, viewed_at, action_taken FROM random_cards_history WHERE user_id = ? ORDER BY viewed_at DESC LIMIT ?'\r\n        ).bind(userId, limit).all();\r\n\r\n        return json({ items: result.results });\r\n    } catch (error) {\r\n        console.error('[Data] getRandomCardsHistory error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/random-cards-history - Ghi l\u1EA1i th\u1EBB \u0111\u00E3 xem\r\n * Body: { card_id: string, action_taken?: boolean }\r\n */\r\nexport async function addRandomCardHistory(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { card_id, action_taken = false } = await request.json();\r\n\r\n        if (!card_id) {\r\n            return json({ error: 'card_id b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO random_cards_history (user_id, card_id, action_taken) VALUES (?, ?, ?)'\r\n        ).bind(userId, card_id, action_taken ? 1 : 0).run();\r\n\r\n        return json({ success: true }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addRandomCardHistory error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// USER STATS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/user-stats - L\u1EA5y th\u1ED1ng k\u00EA gamification c\u1EE7a user\r\n */\r\nexport async function getUserStats(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        let stats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT * FROM user_stats WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        if (!stats) {\r\n            // T\u1EA1o stats m\u1EDBi n\u1EBFu ch\u01B0a c\u00F3\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'INSERT INTO user_stats (user_id) VALUES (?)'\r\n            ).bind(userId).run();\r\n            stats = {\r\n                total_xp: 0,\r\n                current_level: 1,\r\n                breathing_total: 0,\r\n                gratitude_streak: 0,\r\n                max_gratitude_streak: 0,\r\n                journal_count: 0,\r\n                focus_total_minutes: 0,\r\n                games_played: 0,\r\n                highest_game_score: 0\r\n            };\r\n        }\r\n\r\n        // T\u00EDnh level t\u1EEB XP\r\n        const xpPerLevel = 100;\r\n        const level = Math.floor(stats.total_xp / xpPerLevel) + 1;\r\n        const xpForNextLevel = xpPerLevel - (stats.total_xp % xpPerLevel);\r\n\r\n        return json({\r\n            ...stats,\r\n            calculated_level: level,\r\n            xp_for_next_level: xpForNextLevel,\r\n            xp_progress_percent: Math.round(((stats.total_xp % xpPerLevel) / xpPerLevel) * 100)\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getUserStats error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/user-stats/add-xp - Th\u00EAm XP cho user\r\n * Body: { xp: number, source: string }\r\n */\r\nexport async function addUserXP(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { xp, source } = await request.json();\r\n\r\n        if (typeof xp !== 'number' || xp <= 0) {\r\n            return json({ error: 'xp ph\u1EA3i l\u00E0 s\u1ED1 d\u01B0\u01A1ng' }, 400);\r\n        }\r\n\r\n        // Gi\u1EDBi h\u1EA1n XP c\u1ED9ng m\u1ED7i l\u1EA7n \u0111\u1EC3 tr\u00E1nh abuse\r\n        const cappedXP = Math.min(xp, 100);\r\n\r\n        // L\u1EA5y stats hi\u1EC7n t\u1EA1i\r\n        const currentStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT total_xp, current_level FROM user_stats WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        const oldLevel = currentStats?.current_level || 1;\r\n        const oldXP = currentStats?.total_xp || 0;\r\n        const newXP = oldXP + cappedXP;\r\n        const xpPerLevel = 100;\r\n        const newLevel = Math.floor(newXP / xpPerLevel) + 1;\r\n\r\n        // C\u1EADp nh\u1EADt stats\r\n        await env.ban_dong_hanh_db.prepare(`\r\n            INSERT INTO user_stats (user_id, total_xp, current_level)\r\n            VALUES (?, ?, ?)\r\n            ON CONFLICT(user_id) DO UPDATE SET\r\n                total_xp = total_xp + ?,\r\n                current_level = ?,\r\n                updated_at = datetime('now')\r\n        `).bind(userId, newXP, newLevel, cappedXP, newLevel).run();\r\n\r\n        const leveledUp = newLevel > oldLevel;\r\n\r\n        console.log('[XP] Added:', { userId, xp: cappedXP, source, newLevel, leveledUp });\r\n\r\n        return json({\r\n            success: true,\r\n            xp_added: cappedXP,\r\n            total_xp: newXP,\r\n            level: newLevel,\r\n            leveled_up: leveledUp,\r\n            old_level: oldLevel\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] addUserXP error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n", "// backend/workers/forum-api.js\n// Ch\u00FA th\u00EDch: REST API cho di\u1EC5n \u0111\u00E0n \u1EA9n danh v\u1EDBi content moderation\n// T\u00EDch h\u1EE3p risk.js v\u00E0 sanitize.js \u0111\u1EC3 l\u1ECDc n\u1ED9i dung kh\u00F4ng ph\u00F9 h\u1EE3p\n\nimport { classifyRiskRules } from './risk.js';\nimport { sanitizeInput, hasInjection } from './sanitize.js';\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Extract userId t\u1EEB request headers\n */\nfunction getUserId(request) {\n    const userId = request.headers.get('X-User-Id');\n    if (!userId) return null;\n    const parsed = parseInt(userId);\n    return isNaN(parsed) ? null : parsed;\n}\n\n/**\n * T\u1EA1o JSON response\n */\nfunction json(data, status = 200) {\n    return new Response(JSON.stringify(data), {\n        status,\n        headers: { 'Content-Type': 'application/json' }\n    });\n}\n\n/**\n * T\u1EA1o hashed user ID cho hi\u1EC3n th\u1ECB (\u1EA9n danh nh\u01B0ng nh\u1EA5t qu\u00E1n)\n */\nfunction hashUserId(userId) {\n    if (!userId) return null;\n    // Simple hash cho display - ch\u1EC9 d\u00F9ng 6 k\u00FD t\u1EF1 \u0111\u1EA7u\n    const hash = userId.toString(36) + Date.now().toString(36).slice(-4);\n    return hash.slice(0, 8).toUpperCase();\n}\n\n/**\n * Ki\u1EC3m tra v\u00E0 validate n\u1ED9i dung\n * @throws Error n\u1EBFu n\u1ED9i dung kh\u00F4ng h\u1EE3p l\u1EC7\n */\nfunction validateContent(content, maxLength = 2000) {\n    if (!content || typeof content !== 'string') {\n        throw new Error('empty_content');\n    }\n\n    const trimmed = content.trim();\n    if (trimmed.length === 0) {\n        throw new Error('empty_content');\n    }\n\n    if (trimmed.length > maxLength) {\n        throw new Error('content_too_long');\n    }\n\n    // Ki\u1EC3m tra injection\n    if (hasInjection(trimmed)) {\n        throw new Error('content_blocked');\n    }\n\n    // Ki\u1EC3m tra risk level\n    const risk = classifyRiskRules(trimmed);\n    if (risk === 'red') {\n        throw new Error('content_sensitive');\n    }\n\n    return trimmed;\n}\n\n/**\n * Ki\u1EC3m tra user c\u00F3 b\u1ECB ban kh\u00F4ng\n */\nasync function isUserBanned(userId, env) {\n    if (!userId) return false;\n\n    const banned = await env.ban_dong_hanh_db.prepare(\n        'SELECT id, banned_until FROM banned_users WHERE user_id = ?'\n    ).bind(userId).first();\n\n    if (!banned) return false;\n\n    // Ki\u1EC3m tra th\u1EDDi h\u1EA1n ban\n    if (banned.banned_until) {\n        const banEnd = new Date(banned.banned_until);\n        if (banEnd < new Date()) {\n            // \u0110\u00E3 h\u1EBFt h\u1EA1n ban, x\u00F3a record\n            await env.ban_dong_hanh_db.prepare(\n                'DELETE FROM banned_users WHERE user_id = ?'\n            ).bind(userId).run();\n            return false;\n        }\n    }\n\n    return true;\n}\n\n/**\n * Ki\u1EC3m tra user c\u00F3 ph\u1EA3i admin kh\u00F4ng\n */\nasync function isAdmin(userId, env) {\n    if (!userId) return false;\n    const user = await env.ban_dong_hanh_db.prepare(\n        'SELECT is_admin FROM users WHERE id = ?'\n    ).bind(userId).first();\n    return user?.is_admin === 1;\n}\n\n// =============================================================================\n// FORUM POSTS ENDPOINTS\n// =============================================================================\n\n/**\n * GET /api/forum/posts - L\u1EA5y danh s\u00E1ch b\u00E0i vi\u1EBFt\n * Query params: ?page=1&limit=20&tag=h\u1ECDc_t\u1EADp\n */\nexport async function getForumPosts(request, env) {\n    const url = new URL(request.url);\n    const page = Math.max(1, parseInt(url.searchParams.get('page') || '1'));\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '20'), 50);\n    const offset = (page - 1) * limit;\n    const tag = url.searchParams.get('tag');\n\n    try {\n        let query = 'SELECT id, hashed_user_id, title, content, tags, upvotes, comments_count, created_at FROM forum_posts WHERE is_hidden = 0';\n        const params = [];\n\n        if (tag) {\n            query += \" AND tags LIKE ?\";\n            params.push(`%\"${tag}\"%`);\n        }\n\n        // Sort by\n        const sortBy = url.searchParams.get('sort') || 'newest';\n        if (sortBy === 'popular') {\n            query += ' ORDER BY upvotes DESC, created_at DESC';\n        } else if (sortBy === 'oldest') {\n            query += ' ORDER BY created_at ASC';\n        } else {\n            query += ' ORDER BY created_at DESC';\n        }\n        \n        query += ' LIMIT ? OFFSET ?';\n        params.push(limit, offset);\n\n        const result = await env.ban_dong_hanh_db.prepare(query).bind(...params).all();\n\n        // Count total for pagination\n        let countQuery = 'SELECT COUNT(*) as total FROM forum_posts WHERE is_hidden = 0';\n        if (tag) {\n            countQuery += \" AND tags LIKE ?\";\n        }\n        const countResult = await env.ban_dong_hanh_db.prepare(countQuery)\n            .bind(...(tag ? [`%\"${tag}\"%`] : []))\n            .first();\n\n        return json({\n            items: result.results.map(post => ({\n                ...post,\n                content: post.content.length > 200 ? post.content.slice(0, 200) + '...' : post.content,\n                tags: post.tags ? JSON.parse(post.tags) : []\n            })),\n            pagination: {\n                page,\n                limit,\n                total: countResult.total,\n                totalPages: Math.ceil(countResult.total / limit)\n            }\n        });\n    } catch (error) {\n        console.error('[Forum] getForumPosts error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * GET /api/forum/post/:id - L\u1EA5y chi ti\u1EBFt b\u00E0i vi\u1EBFt v\u1EDBi comments\n */\nexport async function getForumPost(request, env, id) {\n    try {\n        const post = await env.ban_dong_hanh_db.prepare(\n            'SELECT id, hashed_user_id, title, content, tags, upvotes, comments_count, is_locked, created_at FROM forum_posts WHERE id = ? AND is_hidden = 0'\n        ).bind(parseInt(id)).first();\n\n        if (!post) {\n            return json({ error: 'post_not_found' }, 404);\n        }\n\n        // L\u1EA5y comments\n        const comments = await env.ban_dong_hanh_db.prepare(\n            'SELECT id, hashed_user_id, content, created_at FROM forum_comments WHERE post_id = ? AND is_hidden = 0 ORDER BY created_at ASC'\n        ).bind(parseInt(id)).all();\n\n        return json({\n            post: {\n                ...post,\n                tags: post.tags ? JSON.parse(post.tags) : []\n            },\n            comments: comments.results\n        });\n    } catch (error) {\n        console.error('[Forum] getForumPost error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * POST /api/forum/post - T\u1EA1o b\u00E0i vi\u1EBFt m\u1EDBi\n * Body: { title?: string, content: string, tags?: string[], anonymous?: boolean }\n */\nexport async function createForumPost(request, env) {\n    const userId = getUserId(request);\n\n    try {\n        // Ki\u1EC3m tra ban status\n        if (userId && await isUserBanned(userId, env)) {\n            return json({ error: 'user_banned', message: 'T\u00E0i kho\u1EA3n c\u1EE7a b\u1EA1n \u0111\u00E3 b\u1ECB h\u1EA1n ch\u1EBF \u0111\u0103ng b\u00E0i' }, 403);\n        }\n\n        const { title, content, tags, anonymous } = await request.json();\n\n        // Validate content\n        let validatedContent;\n        try {\n            validatedContent = validateContent(content, 5000);\n        } catch (e) {\n            if (e.message === 'content_sensitive') {\n                return json({\n                    error: 'content_sensitive',\n                    message: 'N\u1ED9i dung c\u00F3 d\u1EA5u hi\u1EC7u nh\u1EA1y c\u1EA3m. N\u1EBFu b\u1EA1n \u0111ang g\u1EB7p kh\u00F3 kh\u0103n, h\u00E3y li\u00EAn h\u1EC7 \u0111\u01B0\u1EDDng d\u00E2y n\u00F3ng: 1800 599 920'\n                }, 400);\n            }\n            if (e.message === 'content_blocked') {\n                return json({ error: 'content_blocked', message: 'N\u1ED9i dung kh\u00F4ng \u0111\u01B0\u1EE3c ph\u00E9p' }, 400);\n            }\n            return json({ error: e.message }, 400);\n        }\n\n        // Validate title n\u1EBFu c\u00F3\n        let validatedTitle = null;\n        if (title) {\n            try {\n                validatedTitle = validateContent(title, 200);\n            } catch {\n                return json({ error: 'invalid_title' }, 400);\n            }\n        }\n\n        // Process tags\n        const validTags = Array.isArray(tags) ? tags.slice(0, 5).map(t => t.trim()).filter(t => t.length > 0 && t.length < 30) : [];\n\n        // T\u1EA1o hashed user ID\n        const hashedId = anonymous ? null : hashUserId(userId);\n\n        const result = await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO forum_posts (user_id, hashed_user_id, title, content, tags) VALUES (?, ?, ?, ?, ?) RETURNING id, hashed_user_id, title, content, tags, upvotes, comments_count, created_at'\n        ).bind(\n            anonymous ? null : userId,\n            hashedId,\n            validatedTitle,\n            validatedContent,\n            validTags.length > 0 ? JSON.stringify(validTags) : null\n        ).first();\n\n        return json({\n            success: true,\n            post: {\n                ...result,\n                tags: validTags\n            }\n        }, 201);\n    } catch (error) {\n        console.error('[Forum] createForumPost error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * POST /api/forum/post/:id/comment - Th\u00EAm comment\n * Body: { content: string, anonymous?: boolean }\n */\nexport async function addComment(request, env, postId) {\n    const userId = getUserId(request);\n\n    try {\n        // Ki\u1EC3m tra ban status\n        if (userId && await isUserBanned(userId, env)) {\n            return json({ error: 'user_banned' }, 403);\n        }\n\n        // Ki\u1EC3m tra post t\u1ED3n t\u1EA1i v\u00E0 kh\u00F4ng b\u1ECB kh\u00F3a\n        const post = await env.ban_dong_hanh_db.prepare(\n            'SELECT id, is_locked FROM forum_posts WHERE id = ? AND is_hidden = 0'\n        ).bind(parseInt(postId)).first();\n\n        if (!post) {\n            return json({ error: 'post_not_found' }, 404);\n        }\n\n        if (post.is_locked) {\n            return json({ error: 'post_locked', message: 'B\u00E0i vi\u1EBFt n\u00E0y \u0111\u00E3 b\u1ECB kh\u00F3a b\u00ECnh lu\u1EADn' }, 403);\n        }\n\n        const { content, anonymous } = await request.json();\n\n        // Validate content\n        let validatedContent;\n        try {\n            validatedContent = validateContent(content, 1000);\n        } catch (e) {\n            if (e.message === 'content_sensitive') {\n                return json({\n                    error: 'content_sensitive',\n                    message: 'N\u1ED9i dung c\u00F3 d\u1EA5u hi\u1EC7u nh\u1EA1y c\u1EA3m. N\u1EBFu b\u1EA1n \u0111ang g\u1EB7p kh\u00F3 kh\u0103n, h\u00E3y li\u00EAn h\u1EC7 \u0111\u01B0\u1EDDng d\u00E2y n\u00F3ng: 1800 599 920'\n                }, 400);\n            }\n            return json({ error: e.message }, 400);\n        }\n\n        const hashedId = anonymous ? null : hashUserId(userId);\n\n        const result = await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO forum_comments (post_id, user_id, hashed_user_id, content) VALUES (?, ?, ?, ?) RETURNING id, hashed_user_id, content, created_at'\n        ).bind(parseInt(postId), anonymous ? null : userId, hashedId, validatedContent).first();\n\n        // Update comments_count\n        await env.ban_dong_hanh_db.prepare(\n            'UPDATE forum_posts SET comments_count = comments_count + 1 WHERE id = ?'\n        ).bind(parseInt(postId)).run();\n\n        return json({ success: true, comment: result }, 201);\n    } catch (error) {\n        console.error('[Forum] addComment error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * POST /api/forum/post/:id/upvote - Upvote b\u00E0i vi\u1EBFt\n */\nexport async function upvotePost(request, env, postId) {\n    const userId = getUserId(request);\n    if (!userId) {\n        return json({ error: 'login_required', message: 'C\u1EA7n \u0111\u0103ng nh\u1EADp \u0111\u1EC3 upvote' }, 401);\n    }\n\n    try {\n        // Ki\u1EC3m tra \u0111\u00E3 upvote ch\u01B0a\n        const existing = await env.ban_dong_hanh_db.prepare(\n            'SELECT id FROM forum_upvotes WHERE post_id = ? AND user_id = ?'\n        ).bind(parseInt(postId), userId).first();\n\n        if (existing) {\n            // \u0110\u00E3 upvote, b\u1ECF upvote\n            await env.ban_dong_hanh_db.prepare(\n                'DELETE FROM forum_upvotes WHERE post_id = ? AND user_id = ?'\n            ).bind(parseInt(postId), userId).run();\n\n            await env.ban_dong_hanh_db.prepare(\n                'UPDATE forum_posts SET upvotes = upvotes - 1 WHERE id = ?'\n            ).bind(parseInt(postId)).run();\n\n            return json({ success: true, action: 'removed' });\n        } else {\n            // Th\u00EAm upvote\n            await env.ban_dong_hanh_db.prepare(\n                'INSERT INTO forum_upvotes (post_id, user_id) VALUES (?, ?)'\n            ).bind(parseInt(postId), userId).run();\n\n            await env.ban_dong_hanh_db.prepare(\n                'UPDATE forum_posts SET upvotes = upvotes + 1 WHERE id = ?'\n            ).bind(parseInt(postId)).run();\n\n            return json({ success: true, action: 'added' });\n        }\n    } catch (error) {\n        console.error('[Forum] upvotePost error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n// =============================================================================\n// ADMIN ENDPOINTS\n// =============================================================================\n\n/**\n * DELETE /api/forum/post/:id - X\u00F3a/\u1EA9n b\u00E0i vi\u1EBFt (Admin)\n */\nexport async function deletePost(request, env, postId) {\n    const userId = getUserId(request);\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        // Ki\u1EC3m tra quy\u1EC1n admin\n        if (!await isAdmin(userId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        const { reason, permanent } = await request.json().catch(() => ({}));\n\n        if (permanent) {\n            // X\u00F3a v\u0129nh vi\u1EC5n\n            await env.ban_dong_hanh_db.prepare(\n                'DELETE FROM forum_posts WHERE id = ?'\n            ).bind(parseInt(postId)).run();\n        } else {\n            // \u1EA8n b\u00E0i vi\u1EBFt\n            await env.ban_dong_hanh_db.prepare(\n                'UPDATE forum_posts SET is_hidden = 1 WHERE id = ?'\n            ).bind(parseInt(postId)).run();\n        }\n\n        // Log h\u00E0nh \u0111\u1ED9ng\n        await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id, reason) VALUES (?, ?, ?, ?, ?)'\n        ).bind(userId, permanent ? 'delete_post' : 'hide_post', 'post', parseInt(postId), reason || null).run();\n\n        return json({ success: true });\n    } catch (error) {\n        console.error('[Forum] deletePost error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * DELETE /api/forum/comment/:id - X\u00F3a/\u1EA9n comment (Admin)\n */\nexport async function deleteComment(request, env, commentId) {\n    const userId = getUserId(request);\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        if (!await isAdmin(userId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        const { reason } = await request.json().catch(() => ({}));\n\n        // L\u1EA5y post_id tr\u01B0\u1EDBc khi \u1EA9n\n        const comment = await env.ban_dong_hanh_db.prepare(\n            'SELECT post_id FROM forum_comments WHERE id = ?'\n        ).bind(parseInt(commentId)).first();\n\n        if (!comment) {\n            return json({ error: 'not_found' }, 404);\n        }\n\n        // \u1EA8n comment\n        await env.ban_dong_hanh_db.prepare(\n            'UPDATE forum_comments SET is_hidden = 1 WHERE id = ?'\n        ).bind(parseInt(commentId)).run();\n\n        // Update comments_count\n        await env.ban_dong_hanh_db.prepare(\n            'UPDATE forum_posts SET comments_count = comments_count - 1 WHERE id = ? AND comments_count > 0'\n        ).bind(comment.post_id).run();\n\n        // Log h\u00E0nh \u0111\u1ED9ng\n        await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id, reason) VALUES (?, ?, ?, ?, ?)'\n        ).bind(userId, 'hide_comment', 'comment', parseInt(commentId), reason || null).run();\n\n        return json({ success: true });\n    } catch (error) {\n        console.error('[Forum] deleteComment error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * POST /api/forum/post/:id/lock - Kh\u00F3a/m\u1EDF kh\u00F3a b\u00E0i vi\u1EBFt (Admin)\n */\nexport async function toggleLockPost(request, env, postId) {\n    const userId = getUserId(request);\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        if (!await isAdmin(userId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        // Toggle lock status\n        const post = await env.ban_dong_hanh_db.prepare(\n            'SELECT is_locked FROM forum_posts WHERE id = ?'\n        ).bind(parseInt(postId)).first();\n\n        if (!post) {\n            return json({ error: 'not_found' }, 404);\n        }\n\n        const newStatus = post.is_locked ? 0 : 1;\n        await env.ban_dong_hanh_db.prepare(\n            'UPDATE forum_posts SET is_locked = ? WHERE id = ?'\n        ).bind(newStatus, parseInt(postId)).run();\n\n        // Log h\u00E0nh \u0111\u1ED9ng\n        await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id) VALUES (?, ?, ?, ?)'\n        ).bind(userId, newStatus ? 'lock_post' : 'unlock_post', 'post', parseInt(postId)).run();\n\n        return json({ success: true, is_locked: newStatus === 1 });\n    } catch (error) {\n        console.error('[Forum] toggleLockPost error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * POST /api/admin/ban-user - Ban user (Admin)\n * Body: { user_id: number, reason?: string, duration_days?: number }\n */\nexport async function banUser(request, env) {\n    const adminId = getUserId(request);\n    if (!adminId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        if (!await isAdmin(adminId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        const { user_id, reason, duration_days } = await request.json();\n\n        if (!user_id) {\n            return json({ error: 'user_id b\u1EAFt bu\u1ED9c' }, 400);\n        }\n\n        // T\u00EDnh ng\u00E0y h\u1EBFt h\u1EA1n ban\n        let bannedUntil = null;\n        if (duration_days && duration_days > 0) {\n            const date = new Date();\n            date.setDate(date.getDate() + duration_days);\n            bannedUntil = date.toISOString();\n        }\n\n        // Th\u00EAm ho\u1EB7c update ban record\n        await env.ban_dong_hanh_db.prepare(\n            'INSERT OR REPLACE INTO banned_users (user_id, reason, banned_by, banned_until) VALUES (?, ?, ?, ?)'\n        ).bind(parseInt(user_id), reason || null, adminId, bannedUntil).run();\n\n        // Log h\u00E0nh \u0111\u1ED9ng\n        await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id, reason) VALUES (?, ?, ?, ?, ?)'\n        ).bind(adminId, 'ban_user', 'user', parseInt(user_id), reason || null).run();\n\n        return json({ success: true, banned_until: bannedUntil });\n    } catch (error) {\n        console.error('[Forum] banUser error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * DELETE /api/admin/ban-user/:id - Unban user (Admin)\n */\nexport async function unbanUser(request, env, userId) {\n    const adminId = getUserId(request);\n    if (!adminId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        if (!await isAdmin(adminId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        await env.ban_dong_hanh_db.prepare(\n            'DELETE FROM banned_users WHERE user_id = ?'\n        ).bind(parseInt(userId)).run();\n\n        // Log h\u00E0nh \u0111\u1ED9ng\n        await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id) VALUES (?, ?, ?, ?)'\n        ).bind(adminId, 'unban_user', 'user', parseInt(userId)).run();\n\n        return json({ success: true });\n    } catch (error) {\n        console.error('[Forum] unbanUser error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * GET /api/admin/logs - L\u1EA5y l\u1ECBch s\u1EED admin actions\n */\nexport async function getAdminLogs(request, env) {\n    const userId = getUserId(request);\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        if (!await isAdmin(userId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        const url = new URL(request.url);\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\n\n        const result = await env.ban_dong_hanh_db.prepare(\n            'SELECT al.*, u.username as admin_username FROM admin_logs al LEFT JOIN users u ON al.admin_user_id = u.id ORDER BY al.created_at DESC LIMIT ?'\n        ).bind(limit).all();\n\n        return json({ items: result.results });\n    } catch (error) {\n        console.error('[Forum] getAdminLogs error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * GET /api/admin/banned-users - L\u1EA5y danh s\u00E1ch user b\u1ECB ban\n */\nexport async function getBannedUsers(request, env) {\n    const userId = getUserId(request);\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        if (!await isAdmin(userId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        const result = await env.ban_dong_hanh_db.prepare(\n            'SELECT bu.*, u.username FROM banned_users bu LEFT JOIN users u ON bu.user_id = u.id ORDER BY bu.created_at DESC'\n        ).all();\n\n        return json({ items: result.results });\n    } catch (error) {\n        console.error('[Forum] getBannedUsers error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * GET /api/admin/forum-stats - Th\u1ED1ng k\u00EA forum cho admin\n */\nexport async function getForumStats(request, env) {\n    const userId = getUserId(request);\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\n\n    try {\n        if (!await isAdmin(userId, env)) {\n            return json({ error: 'forbidden' }, 403);\n        }\n\n        const [postsCount, commentsCount, bannedCount, hiddenPosts] = await Promise.all([\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts').first(),\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_comments').first(),\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM banned_users').first(),\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts WHERE is_hidden = 1').first()\n        ]);\n\n        return json({\n            total_posts: postsCount.count,\n            total_comments: commentsCount.count,\n            banned_users: bannedCount.count,\n            hidden_posts: hiddenPosts.count\n        });\n    } catch (error) {\n        console.error('[Forum] getForumStats error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}\n\n/**\n * GET /api/admin/users - L\u1EA5y danh s\u00E1ch t\u1EA5t c\u1EA3 users v\u1EDBi th\u1ED1ng k\u00EA\n * Query params: limit, offset, sort (created_at|last_login|journal_count|sos_count)\n */\nexport async function getAllUsers(request, env) {\n    // Verify admin JWT token (kh\u00F4ng d\u00F9ng userId t\u1EEB X-User-Id v\u00EC admin c\u00F3 JWT ri\u00EAng)\n    const authHeader = request.headers.get('Authorization');\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n        return json({ error: 'not_authenticated', message: 'C\u1EA7n \u0111\u0103ng nh\u1EADp admin' }, 401);\n    }\n\n    try {\n        const url = new URL(request.url);\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\n        const offset = Math.max(parseInt(url.searchParams.get('offset') || '0'), 0);\n        const sortBy = url.searchParams.get('sort') || 'created_at';\n        \n        // L\u1EA5y danh s\u00E1ch users\n        const users = await env.ban_dong_hanh_db.prepare(\n            'SELECT id, username, created_at, last_login FROM users ORDER BY created_at DESC LIMIT ? OFFSET ?'\n        ).bind(limit, offset).all();\n\n        // L\u1EA5y th\u1ED1ng k\u00EA cho m\u1ED7i user\n        const usersWithStats = await Promise.all(\n            users.results.map(async (user) => {\n                const [journalCount, sosCount] = await Promise.all([\n                    env.ban_dong_hanh_db.prepare(\n                        'SELECT COUNT(*) as count FROM journal WHERE user_id = ?'\n                    ).bind(user.id).first().catch(() => ({ count: 0 })),\n                    env.ban_dong_hanh_db.prepare(\n                        'SELECT COUNT(*) as count FROM sos_logs WHERE hashed_user_id LIKE ? OR user_id = ?'\n                    ).bind(`%${user.id}%`, user.id).first().catch(() => ({ count: 0 }))\n                ]);\n\n                // L\u1EA5y SOS logs g\u1EA7n \u0111\u00E2y (7 ng\u00E0y) \u0111\u1EC3 \u0111\u00E1nh d\u1EA5u ai c\u1EA7n h\u1ED7 tr\u1EE3\n                // SOS logs c\u00F3 th\u1EC3 c\u00F3 hashed_user_id ho\u1EB7c user_id\n                const recentSOS = await env.ban_dong_hanh_db.prepare(\n                    `SELECT COUNT(*) as count FROM sos_logs \n                     WHERE (hashed_user_id LIKE ? OR user_id = ?) \n                     AND created_at >= datetime('now', '-7 days')`\n                ).bind(`%${user.id}%`, user.id).first().catch(() => ({ count: 0 }));\n\n                // L\u1EA5y journal entries g\u1EA7n \u0111\u00E2y (7 ng\u00E0y) \u0111\u1EC3 bi\u1EBFt ai \u0111ang t\u00EDch c\u1EF1c\n                const recentJournal = await env.ban_dong_hanh_db.prepare(\n                    `SELECT COUNT(*) as count FROM journal \n                     WHERE user_id = ? AND created_at >= datetime('now', '-7 days')`\n                ).bind(user.id).first().catch(() => ({ count: 0 }));\n\n                return {\n                    ...user,\n                    journal_count: journalCount.count || 0,\n                    sos_count: sosCount.count || 0,\n                    recent_sos_count: recentSOS.count || 0,\n                    recent_journal_count: recentJournal.count || 0,\n                    needs_support: (recentSOS.count || 0) > 0 // C\u00F3 SOS trong 7 ng\u00E0y qua\n                };\n            })\n        );\n\n        // S\u1EAFp x\u1EBFp theo sortBy\n        if (sortBy === 'sos_count') {\n            usersWithStats.sort((a, b) => b.sos_count - a.sos_count);\n        } else if (sortBy === 'journal_count') {\n            usersWithStats.sort((a, b) => b.journal_count - a.journal_count);\n        } else if (sortBy === 'last_login') {\n            usersWithStats.sort((a, b) => {\n                if (!a.last_login) return 1;\n                if (!b.last_login) return -1;\n                return new Date(b.last_login) - new Date(a.last_login);\n            });\n        }\n\n        // L\u1EA5y t\u1ED5ng s\u1ED1 users\n        const totalCount = await env.ban_dong_hanh_db.prepare(\n            'SELECT COUNT(*) as count FROM users'\n        ).first().catch(() => ({ count: 0 }));\n\n        return json({\n            items: usersWithStats,\n            total: totalCount.count || 0,\n            limit,\n            offset\n        });\n    } catch (error) {\n        console.error('[Admin] getAllUsers error:', error.message);\n        return json({ error: 'server_error', message: error.message }, 500);\n    }\n}\n\n/**\n * POST /api/forum/report - B\u00E1o c\u00E1o b\u00E0i vi\u1EBFt ho\u1EB7c b\u00ECnh lu\u1EADn\n * Body: { target_type: 'post'|'comment', target_id: number, reason: string, details?: string }\n */\nexport async function reportContent(request, env) {\n    const userId = getUserId(request); // C\u00F3 th\u1EC3 null n\u1EBFu kh\u00E1ch\n\n    try {\n        const { target_type, target_id, reason, details } = await request.json();\n\n        // Validate\n        if (!target_type || !['post', 'comment'].includes(target_type)) {\n            return json({ error: 'invalid_target_type' }, 400);\n        }\n\n        if (!target_id || typeof target_id !== 'number') {\n            return json({ error: 'invalid_target_id' }, 400);\n        }\n\n        const validReasons = ['spam', 'harassment', 'inappropriate', 'misinformation', 'other'];\n        if (!reason || !validReasons.includes(reason)) {\n            return json({ error: 'invalid_reason' }, 400);\n        }\n\n        // Ki\u1EC3m tra target c\u00F3 t\u1ED3n t\u1EA1i kh\u00F4ng\n        const table = target_type === 'post' ? 'forum_posts' : 'forum_comments';\n        const target = await env.ban_dong_hanh_db.prepare(\n            `SELECT id FROM ${table} WHERE id = ?`\n        ).bind(target_id).first();\n\n        if (!target) {\n            return json({ error: 'target_not_found' }, 404);\n        }\n\n        // Ki\u1EC3m tra \u0111\u00E3 b\u00E1o c\u00E1o ch\u01B0a (tr\u00E1nh spam report)\n        const existingReport = await env.ban_dong_hanh_db.prepare(\n            'SELECT id FROM forum_reports WHERE target_type = ? AND target_id = ? AND reporter_user_id = ? AND status = ?'\n        ).bind(target_type, target_id, userId || null, 'pending').first();\n\n        if (existingReport) {\n            return json({ \n                error: 'already_reported', \n                message: 'B\u1EA1n \u0111\u00E3 b\u00E1o c\u00E1o n\u1ED9i dung n\u00E0y r\u1ED3i. Admin s\u1EBD xem x\u00E9t s\u1EDBm nh\u1EA5t.' \n            }, 400);\n        }\n\n        // L\u01B0u b\u00E1o c\u00E1o\n        const result = await env.ban_dong_hanh_db.prepare(\n            'INSERT INTO forum_reports (target_type, target_id, reporter_user_id, reason, details, status) VALUES (?, ?, ?, ?, ?, ?) RETURNING id, created_at'\n        ).bind(\n            target_type,\n            target_id,\n            userId || null,\n            reason,\n            details ? details.slice(0, 500) : null, // Gi\u1EDBi h\u1EA1n 500 k\u00FD t\u1EF1\n            'pending'\n        ).first();\n\n        console.log('[Forum] Content reported:', { target_type, target_id, reason, reporter: userId || 'guest' });\n\n        return json({\n            success: true,\n            report_id: result.id,\n            message: 'C\u1EA3m \u01A1n b\u1EA1n \u0111\u00E3 b\u00E1o c\u00E1o. Admin s\u1EBD xem x\u00E9t n\u1ED9i dung n\u00E0y s\u1EDBm nh\u1EA5t.'\n        }, 201);\n    } catch (error) {\n        console.error('[Forum] reportContent error:', error.message);\n        return json({ error: 'server_error' }, 500);\n    }\n}", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n"],
  "mappings": "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",
  "names": ["json", "url", "wantsStream", "result", "getUserId", "json", "json", "getUserId", "getAllowedOrigin", "corsHeaders", "json", "handleOptions"]
}

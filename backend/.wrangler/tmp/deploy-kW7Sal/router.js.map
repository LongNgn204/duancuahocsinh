{
  "version": 3,
  "sources": ["../../../workers/risk.js", "../../../workers/sanitize.js", "../../../workers/memory.js", "../../../workers/pii-redactor.js", "../../../workers/observability.js", "../../../workers/token-tracker.js", "../../../workers/user-memory.js", "../../../workers/rag.js", "../../../workers/ai-proxy.js", "../../../workers/auth.js", "../../../workers/data-api.js", "../../../workers/forum-api.js", "../../../workers/router.js", "../../../workers/rate-limiter.js"],
  "sourceRoot": "C:\\Users\\long\\Documents\\GitHub\\duancuahocsinh\\backend\\.wrangler\\tmp\\deploy-kW7Sal",
  "sourcesContent": ["// backend/workers/risk.js\r\n// Ch\u00FA th\u00EDch: Module ph\u00E2n lo\u1EA1i r\u1EE7i ro SOS theo 3 t\u1EA7ng (rules-first)\r\n// RED: t\u1EF1 h\u1EA1i/b\u1EA1o l\u1EF1c/c\u00F3 k\u1EBF ho\u1EA1ch \u2192 h\u01B0\u1EDBng d\u1EABn hotline, kh\u00F4ng t\u01B0 v\u1EA5n s\u00E2u\r\n// YELLOW: tuy\u1EC7t v\u1ECDng k\u00E9o d\u00E0i/b\u1EAFt n\u1EA1t/m\u01A1 h\u1ED3 \u2192 check-in + k\u1EF9 thu\u1EADt \u1ED5n \u0111\u1ECBnh\r\n// GREEN: stress th\u01B0\u1EDDng ng\u00E0y \u2192 mentor b\u00ECnh th\u01B0\u1EDDng\r\n\r\n// T\u1EEB kh\u00F3a RED - c\u1EA7n can thi\u1EC7p ngay\r\nconst RED_PATTERNS = [\r\n    // \u00DD \u0111\u1ECBnh t\u1EF1 h\u1EA1i r\u00F5 r\u00E0ng\r\n    't\u1EF1 t\u1EED', 't\u1EF1 v\u1EABn', 't\u1EF1 s\u00E1t',\r\n    'mu\u1ED1n ch\u1EBFt', 'm\u00FAn ch\u1EBFt', 'muon chet',\r\n    'k\u1EBFt th\u00FAc cu\u1ED9c \u0111\u1EDDi', 'k\u1EBFt th\u00FAc t\u1EA5t c\u1EA3',\r\n    'ch\u1EBFt \u0111i cho r\u1ED3i', 'ch\u1EBFt \u0111i', 'ch\u1EBFt \u0111c r\u1ED3i',\r\n    'kh\u00F4ng mu\u1ED1n s\u1ED1ng', 'k mu\u1ED1n s\u1ED1ng', 'ko muon song',\r\n    's\u1ED1ng l\u00E0m g\u00EC', 's\u1ED1ng \u0111\u1EC3 l\u00E0m g\u00EC', 's\u1ED1ng chi',\r\n    'mu\u1ED1n bi\u1EBFn m\u1EA5t', 'bi\u1EBFn m\u1EA5t kh\u1ECFi \u0111\u1EDDi',\r\n    // T\u1EF1 l\u00E0m h\u1EA1i\r\n    't\u1EF1 l\u00E0m h\u1EA1i', 't\u1EF1 c\u1EAFt', 'r\u1EA1ch tay',\r\n    'u\u1ED1ng thu\u1ED1c ng\u1EE7', 'overdose', 't\u1EF1 hurt',\r\n    // B\u1EA1o l\u1EF1c/l\u1EA1m d\u1EE5ng\r\n    'b\u1ECB x\u00E2m h\u1EA1i', 'b\u1ECB l\u1EA1m d\u1EE5ng', 'b\u1ECB s\u1EDD so\u1EA1ng',\r\n    // C\u00F3 k\u1EBF ho\u1EA1ch c\u1EE5 th\u1EC3\r\n    '\u0111\u00E3 chu\u1EA9n b\u1ECB', 'c\u00F3 k\u1EBF ho\u1EA1ch', 'ngay b\u00E2y gi\u1EDD',\r\n\r\n    // ===== GEN Z VOCABULARY - PHASE 1 ADDITION =====\r\n    // Ti\u1EBFng l\u00F3ng \"mu\u1ED1n ch\u1EBFt\"\r\n    'm\u00FAn \u0111i lu\u00F4n', 'mu\u1ED1n \u0111i lu\u00F4n', '\u0111i lu\u00F4n cho r\u1ED3i',\r\n    'ng\u1EE7 lu\u00F4n', 'ng\u1EE7 m\u00E3i', 'sleep forever',\r\n    '\u0111i kh\u1ECFi th\u1EBF gi\u1EDBi', 'r\u1EDDi kh\u1ECFi th\u1EBF gi\u1EDBi n\u00E0y',\r\n    'end game', 'game over \u0111\u1EDDi', 'gg \u0111i',\r\n    'b\u00E1i bai th\u1EBF gi\u1EDBi', 'bye bye cu\u1ED9c \u0111\u1EDDi',\r\n    // M\u1EA1ng x\u00E3 h\u1ED9i style\r\n    'ko th\u1EC3 ti\u1EBFp t\u1EE5c n\u1EEFa', 'h\u1EBFt n\u0103ng l\u01B0\u1EE3ng s\u1ED1ng',\r\n    'c\u1EA1n pin r\u1ED3i', 'bat low qu\u00E1', 'energy = 0',\r\n    // Vi\u1EBFt t\u1EAFt ph\u1ED5 bi\u1EBFn\r\n    'kts', 'mu\u1ED1n c', 'mu\u1ED1n die',\r\n    // Patterns m\u1EDBi - Phase 4\r\n    'kh\u00F4ng c\u00F2n l\u00FD do s\u1ED1ng', 'h\u1EBFt l\u00FD do s\u1ED1ng',\r\n    't\u1ED1t nh\u1EA5t l\u00E0 ch\u1EBFt', 'ch\u1EBFt l\u00E0 gi\u1EA3i ph\u00E1p',\r\n    's\u1EBD t\u1EF1 t\u1EED', 's\u1EBD t\u1EF1 s\u00E1t', 's\u1EBD t\u1EF1 v\u1EABn',\r\n    'c\u00F3 dao', 'c\u00F3 thu\u1ED1c', 'c\u00F3 d\u00E2y',\r\n    'l\u1EA7n cu\u1ED1i', 'l\u1EDDi cu\u1ED1i', 't\u1EA1m bi\u1EC7t',\r\n    'kh\u00F4ng c\u00F2n c\u00E1ch n\u00E0o', 'h\u1EBFt c\u00E1ch',\r\n    // Patterns m\u1EDBi - Phase 5 n\u00E2ng c\u1EA5p\r\n    'mu\u1ED1n ng\u1EE7 kh\u00F4ng d\u1EADy', 'ng\u1EE7 m\u00E3i m\u00E3i',\r\n    'kh\u00F4ng mu\u1ED1n t\u1ED3n t\u1EA1i', 't\u1ED3n t\u1EA1i l\u00E0m g\u00EC',\r\n    's\u1ED1ng v\u00F4 ngh\u0129a', 'cu\u1ED9c s\u1ED1ng v\u00F4 ngh\u0129a',\r\n    'mu\u1ED1n bi\u1EBFn m\u1EA5t ho\u00E0n to\u00E0n', 'bi\u1EBFn m\u1EA5t m\u00E3i m\u00E3i',\r\n    'kh\u00F4ng c\u00F2n l\u00FD do', 'h\u1EBFt l\u00FD do',\r\n    't\u1ED1t nh\u1EA5t l\u00E0 ch\u1EBFt', 'ch\u1EBFt l\u00E0 gi\u1EA3i ph\u00E1p duy nh\u1EA5t',\r\n    's\u1EBD kh\u00F4ng c\u00F2n \u1EDF \u0111\u00E2y', 's\u1EBD r\u1EDDi \u0111i',\r\n    'c\u00F3 k\u1EBF ho\u1EA1ch c\u1EE5 th\u1EC3', '\u0111\u00E3 chu\u1EA9n b\u1ECB xong',\r\n    // Emoji patterns (Gen-Z)\r\n    '\uD83D\uDC80\uD83D\uDC80\uD83D\uDC80', '\uD83D\uDE35\uD83D\uDC80', '\uD83D\uDC80\uD83D\uDD1A',\r\n    // English patterns\r\n    'want to die', 'wanna die', 'wish i was dead',\r\n    'kill myself', 'end my life', 'suicide',\r\n    'no point living', 'life is pointless',\r\n];\r\n\r\n// T\u1EEB kh\u00F3a YELLOW - c\u1EA7n theo d\u00F5i\r\nconst YELLOW_PATTERNS = [\r\n    // Tuy\u1EC7t v\u1ECDng k\u00E9o d\u00E0i\r\n    'tuy\u1EC7t v\u1ECDng', 'h\u1EBFt hy v\u1ECDng', 'v\u00F4 v\u1ECDng',\r\n    'kh\u00F4ng ai quan t\u00E2m', 'kh\u00F4ng ai hi\u1EC3u', 'k ai quan t\u00E2m',\r\n    'v\u00F4 d\u1EE5ng', 'v\u00F4 \u00EDch', 'th\u1EEBa th\u00E3i',\r\n    'g\u00E1nh n\u1EB7ng cho m\u1ECDi ng\u01B0\u1EDDi', 'l\u00E0 g\u00E1nh n\u1EB7ng',\r\n    'kh\u00F4ng x\u1EE9ng \u0111\u00E1ng', 'k x\u1EE9ng \u0111\u00E1ng',\r\n    'b\u1EBF t\u1EAFc ho\u00E0n to\u00E0n', 'kh\u00F4ng c\u00F3 l\u1ED1i tho\u00E1t',\r\n    // B\u1EAFt n\u1EA1t n\u1EB7ng\r\n    'b\u1ECB b\u1EAFt n\u1EA1t', 'b\u1ECB bully', 'b\u1ECB \u0111\u00E1nh',\r\n    'b\u1ECB \u0111e d\u1ECDa', 'b\u1ECB \u00E9p bu\u1ED9c',\r\n    // M\u01A1 h\u1ED3 \"kh\u00F4ng mu\u1ED1n s\u1ED1ng\"\r\n    'kh\u00F4ng mu\u1ED1n th\u1EE9c d\u1EADy', 'ch\u00E1n s\u1ED1ng',\r\n    'm\u1EC7t m\u1ECFi v\u1EDBi cu\u1ED9c s\u1ED1ng',\r\n\r\n    // ===== GEN Z VOCABULARY - PHASE 1 ADDITION =====\r\n    // Ti\u1EBFng l\u00F3ng ch\u00E1n/bu\u1ED3n\r\n    'ch\u00E1n \u0111\u1EDDi', 'ch\u00E1n vl', 'ch\u00E1n real', 'ch\u00E1n th\u1EADt s\u1EF1',\r\n    'toang', 'toang r\u1ED3i', 'toang real', 'toang th\u1EADt s\u1EF1',\r\n    'emo qu\u00E1', '\u0111ang emo', 'emo n\u1EB7ng',\r\n    'xu\u1ED1ng tinh th\u1EA7n', 'mood \u0111i xu\u1ED1ng',\r\n    // M\u1EA1ng x\u00E3 h\u1ED9i style\r\n    'kh\u00F4ng ai care', 'no one cares', 'ai m\u00E0 hi\u1EC3u',\r\n    'c\u00F4 \u0111\u01A1n vl', 'lonely af', 'm\u1ED9t m\u00ECnh ho\u00E0i',\r\n    '\u00E1p l\u1EF1c qu\u00E1 tr\u1EDDi', 'stress vl', 'burn out r\u1ED3i',\r\n    // T\u1EF1 ti\r\n    'fail \u0111\u1EE7 th\u1EE9', 'm\u00ECnh d\u1EDF qu\u00E1', 'm\u00ECnh t\u1EC7 qu\u00E1',\r\n    'kh\u00F4ng l\u00E0m \u0111\u01B0\u1EE3c g\u00EC c\u1EA3', 'useless real',\r\n    // Gia \u0111\u00ECnh\r\n    'b\u1ED1 m\u1EB9 kh\u00F4ng hi\u1EC3u', 'b\u1ECB la ho\u00E0i', 'b\u1ECB so s\u00E1nh',\r\n    'gh\u00E9t v\u1EC1 nh\u00E0', 'kh\u00F4ng mu\u1ED1n v\u1EC1 nh\u00E0',\r\n    // Patterns m\u1EDBi - Phase 4\r\n    'kh\u00F4ng c\u00F2n hy v\u1ECDng', 'h\u1EBFt hy v\u1ECDng',\r\n    'm\u1EA5t h\u1EBFt \u0111\u1ED9ng l\u1EF1c', 'kh\u00F4ng c\u00F2n \u0111\u1ED9ng l\u1EF1c',\r\n    'c\u1EA3m th\u1EA5y v\u00F4 d\u1EE5ng', 'm\u00ECnh v\u00F4 d\u1EE5ng',\r\n    'kh\u00F4ng ai c\u1EA7n m\u00ECnh', 'th\u1EEBa th\u00E3i',\r\n    'mu\u1ED1n bi\u1EBFn m\u1EA5t', 'mu\u1ED1n tan bi\u1EBFn',\r\n    // Patterns m\u1EDBi - Phase 5 n\u00E2ng c\u1EA5p\r\n    'm\u1EA5t h\u1EBFt \u00FD ngh\u0129a', 'cu\u1ED9c s\u1ED1ng v\u00F4 ngh\u0129a',\r\n    'kh\u00F4ng c\u00F2n m\u1EE5c \u0111\u00EDch', 'h\u1EBFt m\u1EE5c \u0111\u00EDch s\u1ED1ng',\r\n    'c\u1EA3m th\u1EA5y b\u1ECB b\u1ECF r\u01A1i', 'b\u1ECB b\u1ECF r\u01A1i ho\u00E0n to\u00E0n',\r\n    'kh\u00F4ng ai th\u1EA5u hi\u1EC3u', 'kh\u00F4ng ai hi\u1EC3u m\u00ECnh',\r\n    'c\u00F4 \u0111\u01A1n tuy\u1EC7t \u0111\u1ED1i', 'c\u00F4 \u0111\u01A1n ho\u00E0n to\u00E0n',\r\n    'stress qu\u00E1 m\u1EE9c', 'stress kh\u00F4ng ch\u1ECBu n\u1ED5i',\r\n    '\u00E1p l\u1EF1c qu\u00E1 l\u1EDBn', '\u00E1p l\u1EF1c kh\u00F4ng th\u1EC3 ch\u1ECBu',\r\n    'm\u1EA5t ki\u1EC3m so\u00E1t', 'kh\u00F4ng ki\u1EC3m so\u00E1t \u0111\u01B0\u1EE3c',\r\n    'c\u1EA3m th\u1EA5y b\u1EBF t\u1EAFc', 'b\u1EBF t\u1EAFc ho\u00E0n to\u00E0n',\r\n    'kh\u00F4ng c\u00F3 l\u1ED1i tho\u00E1t', 'h\u1EBFt l\u1ED1i tho\u00E1t',\r\n    // English patterns\r\n    'hopeless', 'no hope', 'give up',\r\n    'lonely', 'isolated', 'abandoned',\r\n    'worthless', 'useless', 'pointless',\r\n    'depressed', 'sad all the time',\r\n    'no one cares', 'nobody understands',\r\n];\r\n\r\n/**\r\n * Ph\u00E2n lo\u1EA1i r\u1EE7i ro SOS theo rules-first\r\n * @param {string} text - N\u1ED9i dung tin nh\u1EAFn hi\u1EC7n t\u1EA1i\r\n * @param {Array} history - L\u1ECBch s\u1EED h\u1ED9i tho\u1EA1i (optional)\r\n * @returns {'red'|'yellow'|'green'} M\u1EE9c \u0111\u1ED9 r\u1EE7i ro\r\n */\r\nexport function classifyRiskRules(text, history = []) {\r\n    if (!text) return 'green';\r\n\r\n    // Normalize text: lowercase + remove diacritics for matching\r\n    const t = String(text).toLowerCase();\r\n    const tNorm = t.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n    // Check RED patterns first\r\n    for (const pattern of RED_PATTERNS) {\r\n        const p = pattern.toLowerCase();\r\n        const pNorm = p.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n        if (t.includes(p) || tNorm.includes(pNorm)) {\r\n            return 'red';\r\n        }\r\n    }\r\n\r\n    // Check YELLOW patterns\r\n    for (const pattern of YELLOW_PATTERNS) {\r\n        const p = pattern.toLowerCase();\r\n        const pNorm = p.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n        if (t.includes(p) || tNorm.includes(pNorm)) {\r\n            return 'yellow';\r\n        }\r\n    }\r\n\r\n    // Check history for escalating patterns (optional enhancement)\r\n    if (Array.isArray(history) && history.length >= 3) {\r\n        const recentTexts = history.slice(-3).map(h => String(h.content || '').toLowerCase()).join(' ');\r\n        // N\u1EBFu c\u00F3 nhi\u1EC1u d\u1EA5u hi\u1EC7u ti\u00EAu c\u1EF1c trong history \u2192 YELLOW\r\n        let yellowCount = 0;\r\n        for (const pattern of YELLOW_PATTERNS) {\r\n            if (recentTexts.includes(pattern.toLowerCase())) yellowCount++;\r\n        }\r\n        if (yellowCount >= 2) return 'yellow';\r\n    }\r\n\r\n    return 'green';\r\n}\r\n\r\n/**\r\n * L\u1EA5y response chu\u1EA9n cho RED tier - th\u00F4ng tin hotline Vi\u1EC7t Nam\r\n * @returns {Object} Response object v\u1EDBi hotline info\r\n */\r\nexport function getRedTierResponse() {\r\n    return {\r\n        sos: true,\r\n        sosLevel: 'red',\r\n        riskLevel: 'red',\r\n        emotion: 'nguy c\u1EA5p',\r\n        reply: 'M\u00ECnh r\u1EA5t lo cho b\u1EA1n. H\u00E3y li\u00EAn h\u1EC7 ngay v\u1EDBi ng\u01B0\u1EDDi l\u1EDBn \u0111\u00E1ng tin c\u1EADy ho\u1EB7c g\u1ECDi \u0111\u01B0\u1EDDng d\u00E2y h\u1ED7 tr\u1EE3 b\u00EAn d\u01B0\u1EDBi. B\u1EA1n kh\u00F4ng \u0111\u01A1n \u0111\u1ED9c.',\r\n        nextQuestion: '',\r\n        actions: [\r\n            '\uD83D\uDCDE \u0110\u01B0\u1EDDng d\u00E2y n\u00F3ng b\u1EA3o v\u1EC7 tr\u1EBB em: 111 (mi\u1EC5n ph\u00ED, 24/7)',\r\n            '\uD83D\uDCDE T\u1ED5ng \u0111\u00E0i t\u01B0 v\u1EA5n s\u1EE9c kh\u1ECFe t\u00E2m th\u1EA7n: 1800 599 913 (mi\u1EC5n ph\u00ED)',\r\n            '\uD83D\uDCDE \u0110\u01B0\u1EDDng d\u00E2y h\u1ED7 tr\u1EE3 ph\u1EE5 n\u1EEF v\u00E0 tr\u1EBB em: 1800 1567 (mi\u1EC5n ph\u00ED)',\r\n            '\uD83D\uDCAC Nh\u1EAFn tin cho b\u1ED1 m\u1EB9, th\u1EA7y c\u00F4, ho\u1EB7c ng\u01B0\u1EDDi l\u1EDBn b\u1EA1n tin t\u01B0\u1EDFng ngay b\u00E2y gi\u1EDD'\r\n        ],\r\n        confidence: 1,\r\n        disclaimer: '\u0110\u00E2y l\u00E0 h\u1ED7 tr\u1EE3 ban \u0111\u1EA7u. C\u00E1c \u0111\u01B0\u1EDDng d\u00E2y tr\u00EAn c\u00F3 chuy\u00EAn gia s\u1EB5n s\u00E0ng l\u1EAFng nghe b\u1EA1n 24/7.'\r\n    };\r\n}\r\n\r\n// Export patterns for testing\r\nexport const RISK_PATTERNS = {\r\n    red: RED_PATTERNS,\r\n    yellow: YELLOW_PATTERNS,\r\n};\r\n", "// backend/workers/sanitize.js\r\n// Ch\u00FA th\u00EDch: Module sanitize input \u0111\u1EC3 ch\u1ED1ng prompt injection v\u00E0 n\u1ED9i dung kh\u00F4ng ph\u00F9 h\u1EE3p\r\n\r\n// Patterns ph\u00E1t hi\u1EC7n prompt injection - Phase 4 Enhanced\r\nconst INJECTION_PATTERNS = [\r\n    // C\u1ED1 g\u1EAFng override instructions\r\n    /ignore (previous|above|all) (instructions|prompts|rules)/i,\r\n    /disregard (previous|above|all)/i,\r\n    /forget (everything|all|previous)/i,\r\n    /override (system|instructions|prompt)/i,\r\n    /skip (system|instructions|rules)/i,\r\n    // C\u1ED1 g\u1EAFng \u0111\u1ED5i persona\r\n    /you are now/i,\r\n    /act as/i,\r\n    /pretend (to be|you are)/i,\r\n    /roleplay as/i,\r\n    /simulate (being|as)/i,\r\n    /become (a|an)/i,\r\n    // System prompt injection\r\n    /system:/i,\r\n    /\\[system\\]/i,\r\n    /\\[INST\\]/i,\r\n    /<<SYS>>/i,\r\n    /<\\|system\\|>/i,\r\n    /### system/i,\r\n    // Jailbreak attempts\r\n    /DAN/i,\r\n    /do anything now/i,\r\n    /jailbreak/i,\r\n    /unrestricted mode/i,\r\n    /unfiltered mode/i,\r\n    // Developer mode\r\n    /developer mode/i,\r\n    /admin mode/i,\r\n    /debug mode/i,\r\n    /test mode/i,\r\n    // Prompt injection techniques\r\n    /new instructions/i,\r\n    /new prompt/i,\r\n    /change your/i,\r\n    /modify your/i,\r\n    /update your/i,\r\n    // Base64/encoding attempts\r\n    /base64/i,\r\n    /decode this/i,\r\n    /encrypted message/i,\r\n    // Vietnamese variations\r\n    /b\u1ECF qua (h\u01B0\u1EDBng d\u1EABn|quy t\u1EAFc|l\u1EC7nh)/i,\r\n    /qu\u00EAn (t\u1EA5t c\u1EA3|m\u1ECDi th\u1EE9)/i,\r\n    /b\u1EA1n gi\u1EDD l\u00E0/i,\r\n    /\u0111\u00F3ng vai/i,\r\n];\r\n\r\n// T\u1EEB kh\u00F3a kh\u00F4ng ph\u00F9 h\u1EE3p (profanity c\u01A1 b\u1EA3n)\r\nconst PROFANITY_PATTERNS = [\r\n    // C\u00F3 th\u1EC3 m\u1EDF r\u1ED9ng th\u00EAm n\u1EBFu c\u1EA7n\r\n];\r\n\r\n/**\r\n * Sanitize input text, throw error n\u1EBFu ph\u00E1t hi\u1EC7n injection\r\n * @param {string} text - Input text c\u1EA7n ki\u1EC3m tra\r\n * @returns {string} Sanitized text\r\n * @throws {Error} N\u1EBFu ph\u00E1t hi\u1EC7n prompt injection\r\n */\r\nexport function sanitizeInput(text) {\r\n    if (!text || typeof text !== 'string') {\r\n        throw new Error('invalid_input');\r\n    }\r\n\r\n    const trimmed = text.trim();\r\n\r\n    // Check for empty after trim\r\n    if (!trimmed) {\r\n        throw new Error('empty_input');\r\n    }\r\n\r\n    // Check for prompt injection\r\n    for (const pattern of INJECTION_PATTERNS) {\r\n        if (pattern.test(trimmed)) {\r\n            throw new Error('injection_detected');\r\n        }\r\n    }\r\n\r\n    // Check for profanity (optional, c\u00F3 th\u1EC3 b\u1ECF qua \u0111\u1EC3 AI t\u1EF1 x\u1EED l\u00FD)\r\n    for (const pattern of PROFANITY_PATTERNS) {\r\n        if (pattern.test(trimmed)) {\r\n            throw new Error('profanity_detected');\r\n        }\r\n    }\r\n\r\n    // Limit length (prevent abuse)\r\n    if (trimmed.length > 2000) {\r\n        return trimmed.slice(0, 2000);\r\n    }\r\n\r\n    return trimmed;\r\n}\r\n\r\n/**\r\n * Check if input contains injection attempt (kh\u00F4ng throw, ch\u1EC9 return boolean)\r\n * @param {string} text \r\n * @returns {boolean}\r\n */\r\nexport function hasInjection(text) {\r\n    if (!text) return false;\r\n    for (const pattern of INJECTION_PATTERNS) {\r\n        if (pattern.test(text)) return true;\r\n    }\r\n    return false;\r\n}\r\n\r\n// Export patterns for testing\r\nexport const SANITIZE_PATTERNS = {\r\n    injection: INJECTION_PATTERNS,\r\n    profanity: PROFANITY_PATTERNS,\r\n};\r\n", "// backend/workers/memory.js\r\n// Ch\u00FA th\u00EDch: Module qu\u1EA3n l\u00FD context v\u00E0 memory compression\r\n// Ch\u1EC9 g\u1EEDi 5-10 messages g\u1EA7n nh\u1EA5t + memorySummary (100-200 t\u1EEB)\r\n\r\n/**\r\n * L\u1EA5y N messages g\u1EA7n nh\u1EA5t t\u1EEB history\r\n * @param {Array} history - Full history\r\n * @param {number} limit - S\u1ED1 messages t\u1ED1i \u0111a (default 8)\r\n * @returns {Array} Recent messages\r\n */\r\nexport function getRecentMessages(history = [], limit = 8) {\r\n    if (!Array.isArray(history)) return [];\r\n    return history.slice(-limit);\r\n}\r\n\r\n/**\r\n * T\u1EA1o summary t\u1EEB history c\u0169 (ph\u1EA7n b\u1ECB c\u1EAFt b\u1ECF)\r\n * @param {Array} history - Full history  \r\n * @param {number} recentLimit - S\u1ED1 messages g\u1EA7n nh\u1EA5t s\u1EBD gi\u1EEF nguy\u00EAn\r\n * @returns {string} Summary text (100-200 t\u1EEB)\r\n */\r\nexport function createMemorySummary(history = [], recentLimit = 8) {\r\n    if (!Array.isArray(history) || history.length <= recentLimit) {\r\n        return '';\r\n    }\r\n\r\n    // L\u1EA5y ph\u1EA7n history c\u0169 (s\u1EBD \u0111\u01B0\u1EE3c t\u00F3m t\u1EAFt)\r\n    const oldMessages = history.slice(0, -recentLimit);\r\n    if (oldMessages.length === 0) return '';\r\n\r\n    // T\u1EA1o summary c\u00F3 c\u1EA5u tr\u00FAc: ch\u1EE7 \u0111\u1EC1 ch\u00EDnh, c\u1EA3m x\u00FAc, nguy\u00EAn nh\u00E2n g\u1ED1c\r\n    const userMessages = oldMessages\r\n        .filter(m => m.role === 'user')\r\n        .map(m => m.content || '')\r\n        .filter(Boolean);\r\n\r\n    const assistantMessages = oldMessages\r\n        .filter(m => m.role === 'assistant')\r\n        .map(m => m.content || '')\r\n        .filter(Boolean);\r\n\r\n    // Tr\u00EDch xu\u1EA5t key information\r\n    const allText = [...userMessages, ...assistantMessages].join(' ');\r\n    const summary = extractKeyFacts(allText, userMessages);\r\n\r\n    return summary;\r\n}\r\n\r\n/**\r\n * Tr\u00EDch xu\u1EA5t facts quan tr\u1ECDng t\u1EEB text (helper function)\r\n * @param {string} text - All text\r\n * @param {Array} userMessages - User messages only\r\n * @returns {string} Key facts summary\r\n */\r\nfunction extractKeyFacts(text, userMessages = []) {\r\n    if (!text) return '';\r\n\r\n    // T\u00ECm ch\u1EE7 \u0111\u1EC1 ch\u00EDnh (t\u1EEB kh\u00F3a l\u1EB7p l\u1EA1i)\r\n    const commonTopics = ['h\u1ECDc t\u1EADp', 'gia \u0111\u00ECnh', 'b\u1EA1n b\u00E8', 't\u00ECnh c\u1EA3m', 'stress', 'lo l\u1EAFng', 'bu\u1ED3n', 'c\u00F4 \u0111\u01A1n'];\r\n    const foundTopics = commonTopics.filter(topic => \r\n        text.toLowerCase().includes(topic)\r\n    );\r\n\r\n    // T\u00ECm c\u1EA3m x\u00FAc ch\u00EDnh\r\n    const emotions = ['bu\u1ED3n', 'vui', 'gi\u1EADn', 's\u1EE3', 'lo l\u1EAFng', 'stress', 'c\u00F4 \u0111\u01A1n', 't\u1EE7i th\u00E2n', 'confused'];\r\n    const foundEmotions = emotions.filter(emotion => \r\n        text.toLowerCase().includes(emotion)\r\n    );\r\n\r\n    // L\u1EA5y key sentences t\u1EEB user messages (c\u00E2u d\u00E0i h\u01A1n 20 k\u00FD t\u1EF1)\r\n    const keySentences = userMessages\r\n        .map(msg => {\r\n            const sentences = msg.split(/[.!?]\\s+/).filter(s => s.length > 20);\r\n            return sentences.slice(0, 2); // L\u1EA5y 2 c\u00E2u \u0111\u1EA7u ti\u00EAn\r\n        })\r\n        .flat()\r\n        .slice(0, 3); // T\u1ED1i \u0111a 3 c\u00E2u\r\n\r\n    // T\u1EA1o summary c\u00F3 c\u1EA5u tr\u00FAc\r\n    const parts = [];\r\n    \r\n    if (foundTopics.length > 0) {\r\n        parts.push(`Ch\u1EE7 \u0111\u1EC1 ch\u00EDnh: ${foundTopics.join(', ')}`);\r\n    }\r\n    \r\n    if (foundEmotions.length > 0) {\r\n        parts.push(`C\u1EA3m x\u00FAc: ${foundEmotions.join(', ')}`);\r\n    }\r\n    \r\n    if (keySentences.length > 0) {\r\n        parts.push(`\u0110i\u1EC3m quan tr\u1ECDng: ${keySentences.join(' | ')}`);\r\n    }\r\n\r\n    // Fallback: n\u1EBFu kh\u00F4ng c\u00F3 g\u00EC, l\u1EA5y 150 t\u1EEB \u0111\u1EA7u\r\n    if (parts.length === 0) {\r\n        const words = text.split(/\\s+/).slice(0, 100);\r\n        return `T\u00F3m t\u1EAFt: ${words.join(' ')}${text.length > words.join(' ').length ? '...' : ''}`;\r\n    }\r\n\r\n    return parts.join('\\n');\r\n}\r\n\r\n/**\r\n * Format history th\u00E0nh messages array cho LLM\r\n * @param {string} systemPrompt - System instruction\r\n * @param {Array} history - Conversation history\r\n * @param {string} currentMessage - Current user message\r\n * @param {string} memorySummary - Optional memory summary\r\n * @returns {Array} Messages array for LLM\r\n */\r\nexport function formatMessagesForLLM(systemPrompt, history = [], currentMessage, memorySummary = '') {\r\n    const messages = [];\r\n\r\n    // System message v\u1EDBi summary n\u1EBFu c\u00F3\r\n    let systemContent = systemPrompt;\r\n    if (memorySummary) {\r\n        systemContent = `${systemPrompt}\\n\\n[NG\u1EEE C\u1EA2NH TR\u01AF\u1EDAC \u0110\u00D3]\\n${memorySummary}`;\r\n    }\r\n    messages.push({ role: 'system', content: systemContent });\r\n\r\n    // Recent history\r\n    const recent = getRecentMessages(history, 8);\r\n    for (const msg of recent) {\r\n        messages.push({\r\n            role: msg.role === 'user' ? 'user' : 'assistant',\r\n            content: msg.content || ''\r\n        });\r\n    }\r\n\r\n    // Current message\r\n    if (currentMessage) {\r\n        messages.push({ role: 'user', content: currentMessage });\r\n    }\r\n\r\n    return messages;\r\n}\r\n\r\n/**\r\n * Check if should generate new summary (khi \u0111\u1EE7 messages m\u1EDBi)\r\n * @param {number} totalMessages \r\n * @param {number} lastSummaryAt - S\u1ED1 messages khi t\u1EA1o summary l\u1EA7n cu\u1ED1i\r\n * @param {number} threshold - Ng\u01B0\u1EE1ng \u0111\u1EC3 t\u1EA1o summary m\u1EDBi (default 8)\r\n * @returns {boolean}\r\n */\r\nexport function shouldUpdateSummary(totalMessages, lastSummaryAt = 0, threshold = 8) {\r\n    return totalMessages - lastSummaryAt >= threshold;\r\n}\r\n", "// backend/workers/pii-redactor.js\r\n// Ch\u00FA th\u00EDch: Module redact PII (Personally Identifiable Information) tr\u01B0\u1EDBc khi log ho\u1EB7c g\u1EEDi LLM\r\n// Tu\u00E2n th\u1EE7 GDPR/FERPA - kh\u00F4ng l\u01B0u th\u00F4ng tin nh\u1EA1y c\u1EA3m\r\n\r\n/**\r\n * Patterns \u0111\u1EC3 ph\u00E1t hi\u1EC7n PII\r\n */\r\nconst PII_PATTERNS = {\r\n  // S\u1ED1 \u0111i\u1EC7n tho\u1EA1i Vi\u1EC7t Nam (10 s\u1ED1, b\u1EAFt \u0111\u1EA7u b\u1EB1ng 0 ho\u1EB7c +84)\r\n  phone: /(\\+84|0)[3-9]\\d{8}/g,\r\n  \r\n  // Email\r\n  email: /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b/g,\r\n  \r\n  // CMND/CCCD (9-12 s\u1ED1)\r\n  idCard: /\\b\\d{9,12}\\b/g,\r\n  \r\n  // \u0110\u1ECBa ch\u1EC9 (c\u00F3 th\u1EC3 ch\u1EE9a s\u1ED1 nh\u00E0, t\u00EAn \u0111\u01B0\u1EDDng)\r\n  // Pattern n\u00E0y \u0111\u01A1n gi\u1EA3n, c\u00F3 th\u1EC3 c\u1EA3i thi\u1EC7n\r\n  address: /\\b\\d+\\s+[A-Za-z\u00C0-\u1EF9\\s]+(?:ph\u01B0\u1EDDng|x\u00E3|qu\u1EADn|huy\u1EC7n|th\u00E0nh ph\u1ED1|t\u1EC9nh)/gi,\r\n  \r\n  // T\u00EAn ng\u01B0\u1EDDi (c\u00F3 th\u1EC3 ch\u1EE9a d\u1EA5u ti\u1EBFng Vi\u1EC7t) - pattern \u0111\u01A1n gi\u1EA3n\r\n  // Ch\u1EC9 redact n\u1EBFu c\u00F3 format r\u00F5 r\u00E0ng nh\u01B0 \"T\u00EAn t\u00F4i l\u00E0 X\" ho\u1EB7c \"T\u00F4i l\u00E0 X\"\r\n  name: /(?:t\u00EAn|t\u00F4i l\u00E0|m\u00ECnh l\u00E0|em l\u00E0|con l\u00E0)\\s+([A-Z\u00C0-\u1EF8][a-z\u00E0-\u1EF9]+(?:\\s+[A-Z\u00C0-\u1EF8][a-z\u00E0-\u1EF9]+)*)/gi,\r\n};\r\n\r\n/**\r\n * Redact PII t\u1EEB text\r\n * @param {string} text - Text c\u1EA7n redact\r\n * @param {Object} options - Options\r\n * @param {boolean} options.redactPhone - Redact s\u1ED1 \u0111i\u1EC7n tho\u1EA1i\r\n * @param {boolean} options.redactEmail - Redact email\r\n * @param {boolean} options.redactIdCard - Redact CMND/CCCD\r\n * @param {boolean} options.redactAddress - Redact \u0111\u1ECBa ch\u1EC9\r\n * @param {boolean} options.redactName - Redact t\u00EAn\r\n * @returns {string} Text \u0111\u00E3 redact\r\n */\r\nexport function redactPII(text, options = {}) {\r\n  if (!text || typeof text !== 'string') {\r\n    return text || '';\r\n  }\r\n\r\n  let redacted = text;\r\n  const {\r\n    redactPhone = true,\r\n    redactEmail = true,\r\n    redactIdCard = true,\r\n    redactAddress = false, // M\u1EB7c \u0111\u1ECBnh kh\u00F4ng redact address v\u00EC c\u00F3 th\u1EC3 \u1EA3nh h\u01B0\u1EDFng context\r\n    redactName = false, // M\u1EB7c \u0111\u1ECBnh kh\u00F4ng redact name v\u00EC c\u1EA7n cho context\r\n  } = options;\r\n\r\n  // Redact s\u1ED1 \u0111i\u1EC7n tho\u1EA1i\r\n  if (redactPhone) {\r\n    redacted = redacted.replace(PII_PATTERNS.phone, (match) => {\r\n      // Gi\u1EEF 3 s\u1ED1 \u0111\u1EA7u v\u00E0 2 s\u1ED1 cu\u1ED1i, thay ph\u1EA7n gi\u1EEFa b\u1EB1ng *\r\n      if (match.length >= 10) {\r\n        return match.slice(0, 3) + '****' + match.slice(-2);\r\n      }\r\n      return '***';\r\n    });\r\n  }\r\n\r\n  // Redact email\r\n  if (redactEmail) {\r\n    redacted = redacted.replace(PII_PATTERNS.email, (match) => {\r\n      const [local, domain] = match.split('@');\r\n      const redactedLocal = local.length > 2 \r\n        ? local.slice(0, 2) + '***' \r\n        : '***';\r\n      return `${redactedLocal}@${domain}`;\r\n    });\r\n  }\r\n\r\n  // Redact CMND/CCCD\r\n  if (redactIdCard) {\r\n    redacted = redacted.replace(PII_PATTERNS.idCard, (match) => {\r\n      if (match.length >= 9) {\r\n        return match.slice(0, 3) + '****' + match.slice(-2);\r\n      }\r\n      return '***';\r\n    });\r\n  }\r\n\r\n  // Redact \u0111\u1ECBa ch\u1EC9\r\n  if (redactAddress) {\r\n    redacted = redacted.replace(PII_PATTERNS.address, '[\u0110\u1ECAA CH\u1EC8]');\r\n  }\r\n\r\n  // Redact t\u00EAn (ch\u1EC9 khi c\u00F3 format r\u00F5 r\u00E0ng)\r\n  if (redactName) {\r\n    redacted = redacted.replace(PII_PATTERNS.name, (match, name) => {\r\n      return match.replace(name, '[T\u00CAN]');\r\n    });\r\n  }\r\n\r\n  return redacted;\r\n}\r\n\r\n/**\r\n * Redact PII t\u1EEB object (recursive)\r\n * @param {any} obj - Object c\u1EA7n redact\r\n * @param {Object} options - Redaction options\r\n * @param {string[]} excludeKeys - Keys kh\u00F4ng c\u1EA7n redact (v\u00ED d\u1EE5: 'username' cho auth)\r\n * @returns {any} Object \u0111\u00E3 redact\r\n */\r\nexport function redactPIIFromObject(obj, options = {}, excludeKeys = []) {\r\n  if (!obj) return obj;\r\n\r\n  if (typeof obj === 'string') {\r\n    return redactPII(obj, options);\r\n  }\r\n\r\n  if (Array.isArray(obj)) {\r\n    return obj.map(item => redactPIIFromObject(item, options, excludeKeys));\r\n  }\r\n\r\n  if (typeof obj === 'object') {\r\n    const redacted = {};\r\n    for (const [key, value] of Object.entries(obj)) {\r\n      // Skip redaction cho excludeKeys\r\n      if (excludeKeys.includes(key)) {\r\n        redacted[key] = value;\r\n      } else if (typeof value === 'string') {\r\n        redacted[key] = redactPII(value, options);\r\n      } else {\r\n        redacted[key] = redactPIIFromObject(value, options, excludeKeys);\r\n      }\r\n    }\r\n    return redacted;\r\n  }\r\n\r\n  return obj;\r\n}\r\n\r\n/**\r\n * Check if text contains PII\r\n * @param {string} text \r\n * @returns {boolean}\r\n */\r\nexport function containsPII(text) {\r\n  if (!text || typeof text !== 'string') return false;\r\n\r\n  for (const pattern of Object.values(PII_PATTERNS)) {\r\n    if (pattern.test(text)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n", "// backend/workers/observability.js\r\n// Ch\u00FA th\u00EDch: Lightweight observability system cho Cloudflare Workers\r\n// T\u1EA1o trace_id, structured logging, metrics tracking (latency, tokens, cost)\r\n// T\u01B0\u01A1ng th\u00EDch v\u1EDBi Workers environment (kh\u00F4ng d\u00F9ng OpenTelemetry full v\u00EC kh\u00F4ng h\u1ED7 tr\u1EE3 \u0111\u1EA7y \u0111\u1EE7)\r\n\r\nimport { redactPII, redactPIIFromObject } from './pii-redactor.js';\r\n\r\n/**\r\n * Generate unique trace ID cho m\u1ED7i request\r\n * Format: timestamp-random (v\u00ED d\u1EE5: 1703123456789-a1b2c3d4)\r\n */\r\nexport function generateTraceId() {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 10);\r\n  return `${timestamp}-${random}`;\r\n}\r\n\r\n/**\r\n * Structured log entry (t\u1EF1 \u0111\u1ED9ng redact PII)\r\n * @param {string} level - 'info', 'warn', 'error', 'debug'\r\n * @param {string} message - Log message\r\n * @param {Object} context - Additional context (trace_id, user_id, latency, etc.)\r\n */\r\nexport function log(level, message, context = {}) {\r\n  // Redact PII t\u1EEB context tr\u01B0\u1EDBc khi log (tr\u1EEB m\u1ED9t s\u1ED1 fields nh\u01B0 trace_id, user_id)\r\n  const excludeKeys = ['trace_id', 'user_id', 'status', 'latency_ms', 'tokens_in', 'tokens_out', 'cost_usd'];\r\n  const redactedContext = redactPIIFromObject(context, {\r\n    redactPhone: true,\r\n    redactEmail: true,\r\n    redactIdCard: true,\r\n    redactAddress: false,\r\n    redactName: false,\r\n  }, excludeKeys);\r\n  \r\n  const logEntry = {\r\n    timestamp: new Date().toISOString(),\r\n    level,\r\n    message: redactPII(message), // Redact PII trong message\r\n    ...redactedContext,\r\n  };\r\n\r\n  // Format cho Cloudflare Workers logs (JSON string)\r\n  const logString = JSON.stringify(logEntry);\r\n\r\n  // Log theo level\r\n  switch (level) {\r\n    case 'error':\r\n      console.error(logString);\r\n      break;\r\n    case 'warn':\r\n      console.warn(logString);\r\n      break;\r\n    case 'debug':\r\n      // Ch\u1EC9 log debug trong dev mode\r\n      if (context.env?.ENVIRONMENT === 'development') {\r\n        console.log(logString);\r\n      }\r\n      break;\r\n    default:\r\n      console.log(logString);\r\n  }\r\n\r\n  return logEntry;\r\n}\r\n\r\n/**\r\n * Log request v\u1EDBi trace context\r\n * @param {Request} request - Incoming request\r\n * @param {string} traceId - Trace ID\r\n * @param {Object} env - Environment variables\r\n */\r\nexport function logRequest(request, traceId, env = {}) {\r\n  const url = new URL(request.url);\r\n  const userId = request.headers.get('X-User-Id') || null;\r\n  \r\n  log('info', 'request_start', {\r\n    trace_id: traceId,\r\n    method: request.method,\r\n    path: url.pathname,\r\n    user_id: userId,\r\n    user_agent: request.headers.get('User-Agent')?.substring(0, 100) || null,\r\n  });\r\n}\r\n\r\n/**\r\n * Log response v\u1EDBi metrics\r\n * @param {string} traceId - Trace ID\r\n * @param {number} status - HTTP status code\r\n * @param {number} latency - Latency in milliseconds\r\n * @param {Object} metrics - Additional metrics (tokens, cost, etc.)\r\n */\r\nexport function logResponse(traceId, status, latency, metrics = {}) {\r\n  const level = status >= 500 ? 'error' : status >= 400 ? 'warn' : 'info';\r\n  \r\n  log(level, 'request_end', {\r\n    trace_id: traceId,\r\n    status,\r\n    latency_ms: latency,\r\n    ...metrics,\r\n  });\r\n}\r\n\r\n/**\r\n * Log AI model call v\u1EDBi tokens v\u00E0 cost\r\n * @param {string} traceId - Trace ID\r\n * @param {string} model - Model name\r\n * @param {string} modelVersion - Model version\r\n * @param {number} tokensIn - Input tokens\r\n * @param {number} tokensOut - Output tokens\r\n * @param {number} costUsd - Cost in USD\r\n * @param {number} latency - Latency in milliseconds\r\n */\r\nexport function logModelCall(traceId, model, modelVersion, tokensIn, tokensOut, costUsd, latency) {\r\n  log('info', 'model_call', {\r\n    trace_id: traceId,\r\n    model_name: model,\r\n    model_version: modelVersion,\r\n    tokens_in: tokensIn,\r\n    tokens_out: tokensOut,\r\n    tokens_total: tokensIn + tokensOut,\r\n    cost_usd: costUsd,\r\n    latency_ms: latency,\r\n  });\r\n}\r\n\r\n/**\r\n * Log error v\u1EDBi context\r\n * @param {string} traceId - Trace ID\r\n * @param {Error} error - Error object\r\n * @param {Object} context - Additional context\r\n */\r\nexport function logError(traceId, error, context = {}) {\r\n  log('error', 'error_occurred', {\r\n    trace_id: traceId,\r\n    error_message: error.message,\r\n    error_stack: error.stack?.substring(0, 500) || null,\r\n    ...context,\r\n  });\r\n}\r\n\r\n/**\r\n * Create trace context cho request\r\n * @param {Request} request - Incoming request\r\n * @param {Object} env - Environment variables\r\n * @returns {Object} Trace context v\u1EDBi trace_id v\u00E0 startTime\r\n */\r\nexport function createTraceContext(request, env = {}) {\r\n  const traceId = generateTraceId();\r\n  const startTime = Date.now();\r\n  \r\n  logRequest(request, traceId, env);\r\n  \r\n  return {\r\n    traceId,\r\n    startTime,\r\n    log: (level, message, context = {}) => log(level, message, { trace_id: traceId, ...context }),\r\n    logResponse: (status, metrics = {}) => {\r\n      const latency = Date.now() - startTime;\r\n      logResponse(traceId, status, latency, metrics);\r\n    },\r\n    logModelCall: (model, modelVersion, tokensIn, tokensOut, costUsd) => {\r\n      const latency = Date.now() - startTime;\r\n      logModelCall(traceId, model, modelVersion, tokensIn, tokensOut, costUsd, latency);\r\n    },\r\n    logError: (error, context = {}) => logError(traceId, error, context),\r\n  };\r\n}\r\n\r\n/**\r\n * Add trace ID to response headers\r\n * @param {Response} response - Response object\r\n * @param {string} traceId - Trace ID\r\n * @returns {Response} Response v\u1EDBi trace ID header\r\n */\r\nexport function addTraceHeader(response, traceId) {\r\n  const newHeaders = new Headers(response.headers);\r\n  newHeaders.set('X-Trace-Id', traceId);\r\n  \r\n  return new Response(response.body, {\r\n    status: response.status,\r\n    statusText: response.statusText,\r\n    headers: newHeaders,\r\n  });\r\n}\r\n\r\n", "// backend/workers/token-tracker.js\r\n// Ch\u00FA th\u00EDch: Module theo d\u00F5i v\u00E0 ki\u1EC3m so\u00E1t chi ph\u00ED token AI\r\n// Gi\u1EDBi h\u1EA1n: 500,000 tokens/th\u00E1ng, c\u1EA3nh b\u00E1o khi g\u1EA7n ng\u01B0\u1EE1ng\r\n\r\nconst MONTHLY_TOKEN_LIMIT = 500000; // 500k tokens/th\u00E1ng\r\nconst WARNING_THRESHOLD = 0.8; // C\u1EA3nh b\u00E1o khi \u0111\u1EA1t 80%\r\n\r\n/**\r\n * L\u1EA5y token usage cho th\u00E1ng hi\u1EC7n t\u1EA1i\r\n * @param {Object} env - Cloudflare env v\u1EDBi D1 binding\r\n * @returns {Promise<{tokens: number, month: string}>}\r\n */\r\nexport async function getTokenUsage(env) {\r\n    const now = new Date();\r\n    const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT tokens FROM token_usage WHERE month = ?'\r\n        ).bind(month).first();\r\n\r\n        return {\r\n            tokens: result?.tokens || 0,\r\n            month,\r\n        };\r\n    } catch (error) {\r\n        console.error('[TokenTracker] getTokenUsage error:', error.message);\r\n        return { tokens: 0, month };\r\n    }\r\n}\r\n\r\n/**\r\n * C\u1EADp nh\u1EADt token usage\r\n * @param {Object} env - Cloudflare env\r\n * @param {number} tokensToAdd - S\u1ED1 tokens c\u1EA7n th\u00EAm\r\n * @returns {Promise<{tokens: number, limit: number, warning: boolean}>}\r\n */\r\nexport async function addTokenUsage(env, tokensToAdd = 0) {\r\n    const now = new Date();\r\n    const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\r\n\r\n    try {\r\n        // Get current usage\r\n        const current = await getTokenUsage(env);\r\n\r\n        const newTotal = current.tokens + tokensToAdd;\r\n\r\n        // Update or insert\r\n        await env.ban_dong_hanh_db.prepare(\r\n            `INSERT INTO token_usage (month, tokens, updated_at)\r\n             VALUES (?, ?, datetime('now'))\r\n             ON CONFLICT(month) DO UPDATE SET\r\n                 tokens = tokens + ?,\r\n                 updated_at = datetime('now')`\r\n        ).bind(month, tokensToAdd, tokensToAdd).run();\r\n\r\n        const warning = newTotal >= MONTHLY_TOKEN_LIMIT * WARNING_THRESHOLD;\r\n        const exceeded = newTotal >= MONTHLY_TOKEN_LIMIT;\r\n\r\n        if (exceeded) {\r\n            console.warn(JSON.stringify({\r\n                type: 'token_limit_exceeded',\r\n                tokens: newTotal,\r\n                limit: MONTHLY_TOKEN_LIMIT,\r\n                percentage: Math.round((newTotal / MONTHLY_TOKEN_LIMIT) * 100),\r\n                month,\r\n            }));\r\n        } else if (warning) {\r\n            console.warn(JSON.stringify({\r\n                type: 'token_limit_warning',\r\n                tokens: newTotal,\r\n                limit: MONTHLY_TOKEN_LIMIT,\r\n                percentage: Math.round((newTotal / MONTHLY_TOKEN_LIMIT) * 100),\r\n                month,\r\n            }));\r\n        }\r\n\r\n        return {\r\n            tokens: newTotal,\r\n            limit: MONTHLY_TOKEN_LIMIT,\r\n            warning,\r\n            exceeded,\r\n        };\r\n    } catch (error) {\r\n        console.error('[TokenTracker] addTokenUsage error:', error.message);\r\n        return {\r\n            tokens: 0,\r\n            limit: MONTHLY_TOKEN_LIMIT,\r\n            warning: false,\r\n            exceeded: false,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Ki\u1EC3m tra xem c\u00F3 v\u01B0\u1EE3t qu\u00E1 gi\u1EDBi h\u1EA1n kh\u00F4ng\r\n * @param {Object} env - Cloudflare env\r\n * @returns {Promise<{allowed: boolean, tokens: number, limit: number}>}\r\n */\r\nexport async function checkTokenLimit(env) {\r\n    const usage = await getTokenUsage(env);\r\n    const allowed = usage.tokens < MONTHLY_TOKEN_LIMIT;\r\n\r\n    return {\r\n        allowed,\r\n        tokens: usage.tokens,\r\n        limit: MONTHLY_TOKEN_LIMIT,\r\n        percentage: Math.round((usage.tokens / MONTHLY_TOKEN_LIMIT) * 100),\r\n    };\r\n}\r\n\r\n/**\r\n * Estimate tokens t\u1EEB text (rough estimate: ~4 chars = 1 token)\r\n * C\u00F3 th\u1EC3 c\u1EA3i thi\u1EC7n v\u1EDBi tiktoken n\u1EBFu c\u1EA7n ch\u00EDnh x\u00E1c h\u01A1n\r\n * @param {string} text \r\n * @returns {number}\r\n */\r\nexport function estimateTokens(text) {\r\n    if (!text) return 0;\r\n    // Improved estimate: ti\u1EBFng Vi\u1EC7t c\u00F3 th\u1EC3 ~3 chars = 1 token\r\n    // Ti\u1EBFng Anh ~4 chars = 1 token\r\n    // Mixed: d\u00F9ng 3.5 l\u00E0m trung b\u00ECnh\r\n    return Math.ceil(text.length / 3.5);\r\n}\r\n\r\n/**\r\n * Accurate token counting (n\u1EBFu c\u00F3 tiktoken library)\r\n * Fallback v\u1EC1 estimateTokens n\u1EBFu kh\u00F4ng c\u00F3\r\n * @param {string} text \r\n * @param {string} model - Model name \u0111\u1EC3 ch\u1ECDn tokenizer\r\n * @returns {number}\r\n */\r\nexport function countTokensAccurate(text, model = 'llama-3.1-8b') {\r\n    // Note: Cloudflare Workers kh\u00F4ng h\u1ED7 tr\u1EE3 tiktoken tr\u1EF1c ti\u1EBFp\r\n    // C\u00F3 th\u1EC3 implement v\u1EDBi WebAssembly ho\u1EB7c d\u00F9ng estimate\r\n    // Hi\u1EC7n t\u1EA1i d\u00F9ng estimateTokens\r\n    return estimateTokens(text);\r\n}\r\n\r\n", "// backend/workers/user-memory.js\r\n// Ch\u00FA th\u00EDch: Module qu\u1EA3n l\u00FD b\u1ED9 nh\u1EDB d\u00E0i h\u1EA1n persistent cho t\u1EEBng user\r\n// H\u1ED7 tr\u1EE3: load/save memory, extract facts t\u1EEB conversations, format context cho AI\r\n\r\n/**\r\n * Load user memory t\u1EEB database\r\n * @param {Object} env - Cloudflare env v\u1EDBi D1 binding\r\n * @param {number|string} userId - User ID\r\n * @returns {Promise<Object|null>} User memory object ho\u1EB7c null\r\n */\r\nexport async function loadUserMemory(env, userId) {\r\n    if (!userId) return null;\r\n\r\n    try {\r\n        const memory = await env.ban_dong_hanh_db.prepare(\r\n            `SELECT * FROM user_memory WHERE user_id = ?`\r\n        ).bind(parseInt(userId)).first();\r\n\r\n        if (!memory) {\r\n            // T\u1EA1o memory m\u1EDBi cho user m\u1EDBi\r\n            return await createNewUserMemory(env, parseInt(userId));\r\n        }\r\n\r\n        return parseMemoryFromDB(memory);\r\n    } catch (error) {\r\n        console.error('[UserMemory] Load error:', error.message);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Parse memory t\u1EEB DB row sang object\r\n */\r\nfunction parseMemoryFromDB(row) {\r\n    return {\r\n        displayName: row.display_name,\r\n        ageRange: row.age_range,\r\n        interests: safeParseJSON(row.interests, []),\r\n        personalityNotes: row.personality_notes,\r\n        memorySummary: row.memory_summary || '',\r\n        keyTopics: safeParseJSON(row.key_topics, []),\r\n        keyEmotions: safeParseJSON(row.key_emotions, []),\r\n        currentStruggles: safeParseJSON(row.current_struggles, []),\r\n        positiveAspects: safeParseJSON(row.positive_aspects, []),\r\n        supportNetwork: safeParseJSON(row.support_network, []),\r\n        firstInteractionAt: row.first_interaction_at,\r\n        lastInteractionAt: row.last_interaction_at,\r\n        totalConversations: row.total_conversations || 0,\r\n        totalMessages: row.total_messages || 0,\r\n        trustLevel: row.trust_level || 'new',\r\n        preferredTone: row.preferred_tone || 'warm',\r\n        preferredResponseLength: row.preferred_response_length || 'medium'\r\n    };\r\n}\r\n\r\n/**\r\n * Safe JSON parse with fallback\r\n */\r\nfunction safeParseJSON(str, fallback = []) {\r\n    if (!str) return fallback;\r\n    try {\r\n        return JSON.parse(str);\r\n    } catch (_) {\r\n        return fallback;\r\n    }\r\n}\r\n\r\n/**\r\n * T\u1EA1o memory m\u1EDBi cho user l\u1EA7n \u0111\u1EA7u chat\r\n */\r\nasync function createNewUserMemory(env, userId) {\r\n    const now = new Date().toISOString();\r\n\r\n    try {\r\n        await env.ban_dong_hanh_db.prepare(`\r\n      INSERT INTO user_memory \r\n      (user_id, first_interaction_at, last_interaction_at, total_conversations, total_messages, trust_level)\r\n      VALUES (?, ?, ?, 1, 0, 'new')\r\n    `).bind(userId, now, now).run();\r\n\r\n        return {\r\n            displayName: null,\r\n            ageRange: null,\r\n            interests: [],\r\n            personalityNotes: null,\r\n            memorySummary: '',\r\n            keyTopics: [],\r\n            keyEmotions: [],\r\n            currentStruggles: [],\r\n            positiveAspects: [],\r\n            supportNetwork: [],\r\n            firstInteractionAt: now,\r\n            lastInteractionAt: now,\r\n            totalConversations: 1,\r\n            totalMessages: 0,\r\n            trustLevel: 'new',\r\n            preferredTone: 'warm',\r\n            preferredResponseLength: 'medium'\r\n        };\r\n    } catch (error) {\r\n        console.error('[UserMemory] Create error:', error.message);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Update user memory v\u1EDBi th\u00F4ng tin m\u1EDBi t\u1EEB AI response\r\n * @param {Object} env - Cloudflare env\r\n * @param {number} userId - User ID\r\n * @param {Object} memoryUpdate - Update t\u1EEB AI (shouldRemember, newFacts, displayName, etc.)\r\n * @param {string} currentMessage - User message hi\u1EC7n t\u1EA1i\r\n * @param {string} traceId - Trace ID cho logging\r\n */\r\nexport async function updateUserMemory(env, userId, memoryUpdate, currentMessage, traceId = null) {\r\n    if (!userId) return;\r\n\r\n    // N\u1EBFu kh\u00F4ng c\u00F3 memoryUpdate ho\u1EB7c kh\u00F4ng c\u1EA7n nh\u1EDB, ch\u1EC9 update timestamps\r\n    const shouldRemember = memoryUpdate?.shouldRemember !== false;\r\n\r\n    try {\r\n        // L\u1EA5y memory hi\u1EC7n t\u1EA1i\r\n        const current = await env.ban_dong_hanh_db.prepare(\r\n            `SELECT * FROM user_memory WHERE user_id = ?`\r\n        ).bind(parseInt(userId)).first();\r\n\r\n        if (!current) {\r\n            await createNewUserMemory(env, parseInt(userId));\r\n            return;\r\n        }\r\n\r\n        const updates = [];\r\n        const params = [];\r\n\r\n        // Lu\u00F4n update timestamps\r\n        updates.push('last_interaction_at = ?');\r\n        params.push(new Date().toISOString());\r\n\r\n        // Increment message count\r\n        updates.push('total_messages = total_messages + 1');\r\n\r\n        // Update trust level based on message count\r\n        const newMsgCount = (current.total_messages || 0) + 1;\r\n        if (newMsgCount >= 50 && current.trust_level !== 'trusted') {\r\n            updates.push(\"trust_level = 'trusted'\");\r\n        } else if (newMsgCount >= 10 && current.trust_level === 'new') {\r\n            updates.push(\"trust_level = 'familiar'\");\r\n        }\r\n\r\n        if (shouldRemember && memoryUpdate) {\r\n            // Update display name n\u1EBFu AI detect \u0111\u01B0\u1EE3c\r\n            if (memoryUpdate.displayName && !current.display_name) {\r\n                updates.push('display_name = ?');\r\n                params.push(memoryUpdate.displayName);\r\n\r\n                // Log name detection\r\n                await logMemoryEvent(env, userId, 'name_detected', memoryUpdate.displayName, traceId);\r\n            }\r\n\r\n            // Merge new facts v\u00E0o memory summary\r\n            if (memoryUpdate.newFacts?.length > 0) {\r\n                const existingSummary = current.memory_summary || '';\r\n                const newSummary = compressMemorySummary(existingSummary, memoryUpdate.newFacts);\r\n                updates.push('memory_summary = ?');\r\n                params.push(newSummary);\r\n\r\n                // Log facts\r\n                for (const fact of memoryUpdate.newFacts) {\r\n                    await logMemoryEvent(env, userId, 'fact_learned', fact, traceId);\r\n                }\r\n            }\r\n\r\n            // Update key topics t\u1EEB message\r\n            const extractedTopics = extractTopicsFromMessage(currentMessage);\r\n            if (extractedTopics.length > 0) {\r\n                const existingTopics = safeParseJSON(current.key_topics, []);\r\n                const mergedTopics = mergeLists(existingTopics, extractedTopics, 15);\r\n                updates.push('key_topics = ?');\r\n                params.push(JSON.stringify(mergedTopics));\r\n            }\r\n\r\n            // Update emotion pattern\r\n            if (memoryUpdate.emotionPattern) {\r\n                const existingEmotions = safeParseJSON(current.key_emotions, []);\r\n                existingEmotions.push({\r\n                    emotion: memoryUpdate.emotionPattern,\r\n                    timestamp: new Date().toISOString()\r\n                });\r\n                // Keep last 30 emotions\r\n                const recentEmotions = existingEmotions.slice(-30);\r\n                updates.push('key_emotions = ?');\r\n                params.push(JSON.stringify(recentEmotions));\r\n\r\n                // Log emotion\r\n                await logMemoryEvent(env, userId, 'emotion_expressed', memoryUpdate.emotionPattern, traceId);\r\n            }\r\n\r\n            // Update struggles/positive aspects n\u1EBFu c\u00F3\r\n            if (memoryUpdate.currentStruggle) {\r\n                const struggles = safeParseJSON(current.current_struggles, []);\r\n                if (!struggles.includes(memoryUpdate.currentStruggle)) {\r\n                    struggles.push(memoryUpdate.currentStruggle);\r\n                    updates.push('current_struggles = ?');\r\n                    params.push(JSON.stringify(struggles.slice(-10)));\r\n                }\r\n            }\r\n\r\n            if (memoryUpdate.positiveAspect) {\r\n                const positives = safeParseJSON(current.positive_aspects, []);\r\n                if (!positives.includes(memoryUpdate.positiveAspect)) {\r\n                    positives.push(memoryUpdate.positiveAspect);\r\n                    updates.push('positive_aspects = ?');\r\n                    params.push(JSON.stringify(positives.slice(-10)));\r\n                }\r\n            }\r\n        }\r\n\r\n        updates.push(\"updated_at = datetime('now')\");\r\n        params.push(parseInt(userId));\r\n\r\n        await env.ban_dong_hanh_db.prepare(`\r\n      UPDATE user_memory SET ${updates.join(', ')} WHERE user_id = ?\r\n    `).bind(...params).run();\r\n\r\n    } catch (error) {\r\n        console.error('[UserMemory] Update error:', error.message);\r\n    }\r\n}\r\n\r\n/**\r\n * Log memory event cho audit v\u00E0 fine-tuning\r\n */\r\nasync function logMemoryEvent(env, userId, logType, content, traceId) {\r\n    try {\r\n        await env.ban_dong_hanh_db.prepare(`\r\n      INSERT INTO user_memory_logs (user_id, log_type, content, source_message_id)\r\n      VALUES (?, ?, ?, ?)\r\n    `).bind(parseInt(userId), logType, content, traceId).run();\r\n    } catch (error) {\r\n        console.error('[UserMemory] Log error:', error.message);\r\n    }\r\n}\r\n\r\n/**\r\n * Increment conversation count (g\u1ECDi khi b\u1EAFt \u0111\u1EA7u session m\u1EDBi)\r\n */\r\nexport async function incrementConversationCount(env, userId) {\r\n    if (!userId) return;\r\n\r\n    try {\r\n        await env.ban_dong_hanh_db.prepare(`\r\n      UPDATE user_memory \r\n      SET total_conversations = total_conversations + 1,\r\n          last_interaction_at = datetime('now'),\r\n          updated_at = datetime('now')\r\n      WHERE user_id = ?\r\n    `).bind(parseInt(userId)).run();\r\n    } catch (error) {\r\n        console.error('[UserMemory] Increment conversation error:', error.message);\r\n    }\r\n}\r\n\r\n/**\r\n * Format memory context cho system prompt\r\n * @param {Object} memory - User memory object\r\n * @returns {string} Formatted context string\r\n */\r\nexport function formatMemoryContext(memory) {\r\n    if (!memory) return '\u0110\u00E2y l\u00E0 l\u1EA7n \u0111\u1EA7u ti\u00EAn g\u1EB7p user n\u00E0y. H\u00E3y gi\u1EDBi thi\u1EC7u b\u1EA3n th\u00E2n v\u00E0 h\u1ECFi t\u00EAn h\u1ECD.';\r\n\r\n    const parts = [];\r\n\r\n    // Relationship info\r\n    parts.push(`\uD83D\uDCCA TH\u1ED0NG K\u00CA:`);\r\n    parts.push(`- \u0110\u00E3 tr\u00F2 chuy\u1EC7n: ${memory.totalConversations} cu\u1ED9c, ${memory.totalMessages} tin nh\u1EAFn`);\r\n    parts.push(`- M\u1EE9c \u0111\u1ED9 quen thu\u1ED9c: ${translateTrustLevel(memory.trustLevel)}`);\r\n\r\n    // Display name\r\n    if (memory.displayName) {\r\n        parts.push(`\\n\uD83D\uDC64 TH\u00D4NG TIN:`);\r\n        parts.push(`- T\u00EAn: ${memory.displayName}`);\r\n        if (memory.ageRange) {\r\n            parts.push(`- \u0110\u1ED9 tu\u1ED5i: ${translateAgeRange(memory.ageRange)}`);\r\n        }\r\n    }\r\n\r\n    // Key topics\r\n    if (memory.keyTopics?.length > 0) {\r\n        parts.push(`\\n\uD83D\uDCCC CH\u1EE6 \u0110\u1EC0 TH\u01AF\u1EDCNG TH\u1EA2O LU\u1EACN:`);\r\n        parts.push(`- ${memory.keyTopics.slice(-8).join(', ')}`);\r\n    }\r\n\r\n    // Current struggles\r\n    if (memory.currentStruggles?.length > 0) {\r\n        parts.push(`\\n\u26A0\uFE0F V\u1EA4N \u0110\u1EC0 \u0110ANG G\u1EB6P:`);\r\n        memory.currentStruggles.slice(-5).forEach(s => {\r\n            parts.push(`- ${s}`);\r\n        });\r\n    }\r\n\r\n    // Positive aspects\r\n    if (memory.positiveAspects?.length > 0) {\r\n        parts.push(`\\n\u2728 \u0110I\u1EC2M T\u00CDCH C\u1EF0C:`);\r\n        memory.positiveAspects.slice(-3).forEach(p => {\r\n            parts.push(`- ${p}`);\r\n        });\r\n    }\r\n\r\n    // Recent emotions\r\n    if (memory.keyEmotions?.length > 0) {\r\n        const recentEmotions = memory.keyEmotions.slice(-5).map(e =>\r\n            typeof e === 'object' ? e.emotion : e\r\n        );\r\n        parts.push(`\\n\uD83D\uDCAD C\u1EA2M X\u00DAC G\u1EA6N \u0110\u00C2Y: ${recentEmotions.join(' \u2192 ')}`);\r\n    }\r\n\r\n    // Memory summary\r\n    if (memory.memorySummary) {\r\n        parts.push(`\\n\uD83D\uDCDD T\u00D3M T\u1EAET:`);\r\n        parts.push(`${memory.memorySummary}`);\r\n    }\r\n\r\n    // Interaction guidance based on trust level\r\n    parts.push(`\\n\uD83C\uDFAF H\u01AF\u1EDANG D\u1EAAN T\u01AF\u01A0NG T\u00C1C:`);\r\n    switch (memory.trustLevel) {\r\n        case 'trusted':\r\n            parts.push(`- User \u0111\u00E3 tin t\u01B0\u1EDFng, c\u00F3 th\u1EC3 \u0111i s\u00E2u h\u01A1n v\u00E0o v\u1EA5n \u0111\u1EC1`);\r\n            parts.push(`- C\u00F3 th\u1EC3 g\u1EE3i \u00FD gi\u1EA3i ph\u00E1p c\u1EE5 th\u1EC3 h\u01A1n`);\r\n            break;\r\n        case 'familiar':\r\n            parts.push(`- User \u0111\u00E3 quen thu\u1ED9c, c\u00F3 th\u1EC3 h\u1ECFi s\u00E2u h\u01A1n`);\r\n            parts.push(`- Nh\u1EAFc l\u1EA1i context c\u0169 n\u1EBFu ph\u00F9 h\u1EE3p`);\r\n            break;\r\n        default:\r\n            parts.push(`- User c\u00F2n m\u1EDBi, t\u1EADp trung l\u1EAFng nghe v\u00E0 x\u00E2y d\u1EF1ng trust`);\r\n            parts.push(`- H\u1ECFi t\u00EAn n\u1EBFu h\u1ECD ch\u01B0a gi\u1EDBi thi\u1EC7u`);\r\n    }\r\n\r\n    return parts.join('\\n');\r\n}\r\n\r\n/**\r\n * Clear user memory (cho ch\u1EE9c n\u0103ng \"Reset AI memory\")\r\n */\r\nexport async function clearUserMemory(env, userId) {\r\n    if (!userId) return false;\r\n\r\n    try {\r\n        await env.ban_dong_hanh_db.prepare(`\r\n      DELETE FROM user_memory WHERE user_id = ?\r\n    `).bind(parseInt(userId)).run();\r\n\r\n        await env.ban_dong_hanh_db.prepare(`\r\n      DELETE FROM user_memory_logs WHERE user_id = ?\r\n    `).bind(parseInt(userId)).run();\r\n\r\n        return true;\r\n    } catch (error) {\r\n        console.error('[UserMemory] Clear error:', error.message);\r\n        return false;\r\n    }\r\n}\r\n\r\n// ============================================================================\r\n// HELPER FUNCTIONS\r\n// ============================================================================\r\n\r\nfunction translateTrustLevel(level) {\r\n    const map = {\r\n        new: 'M\u1EDBi quen (\u0111ang t\u00ECm hi\u1EC3u)',\r\n        familiar: 'Quen thu\u1ED9c (c\u00F3 th\u1EC3 trao \u0111\u1ED5i s\u00E2u h\u01A1n)',\r\n        trusted: 'Tin t\u01B0\u1EDFng (c\u00F3 th\u1EC3 th\u1EA3o lu\u1EADn v\u1EA5n \u0111\u1EC1 nh\u1EA1y c\u1EA3m)'\r\n    };\r\n    return map[level] || 'M\u1EDBi quen';\r\n}\r\n\r\nfunction translateAgeRange(range) {\r\n    const map = {\r\n        'under_15': 'D\u01B0\u1EDBi 15 tu\u1ED5i',\r\n        '15_17': '15-17 tu\u1ED5i',\r\n        '18_plus': '18 tu\u1ED5i tr\u1EDF l\u00EAn'\r\n    };\r\n    return map[range] || range;\r\n}\r\n\r\nfunction compressMemorySummary(existing, newFacts) {\r\n    // Append new facts\r\n    let combined = existing;\r\n    if (existing && !existing.endsWith('.')) {\r\n        combined += '. ';\r\n    }\r\n    combined += newFacts.join('. ');\r\n\r\n    // Keep last 500 chars, nh\u01B0ng kh\u00F4ng c\u1EAFt gi\u1EEFa c\u00E2u\r\n    if (combined.length > 500) {\r\n        combined = combined.slice(-500);\r\n        // T\u00ECm \u0111i\u1EC3m c\u1EAFt h\u1EE3p l\u00FD (sau d\u1EA5u ch\u1EA5m)\r\n        const firstSentenceEnd = combined.indexOf('. ');\r\n        if (firstSentenceEnd > 0 && firstSentenceEnd < 100) {\r\n            combined = combined.slice(firstSentenceEnd + 2);\r\n        }\r\n    }\r\n\r\n    return combined.trim();\r\n}\r\n\r\nfunction extractTopicsFromMessage(message) {\r\n    if (!message) return [];\r\n\r\n    const topicKeywords = {\r\n        'h\u1ECDc t\u1EADp': ['h\u1ECDc', 'b\u00E0i', 'thi', '\u0111i\u1EC3m', 'm\u00F4n', 'tr\u01B0\u1EDDng', 'l\u1EDBp', 'th\u1EA7y', 'c\u00F4', 'gi\u00E1o vi\u00EAn'],\r\n        'gia \u0111\u00ECnh': ['b\u1ED1', 'm\u1EB9', 'ba', 'm\u00E1', 'anh', 'ch\u1ECB', 'em', '\u00F4ng', 'b\u00E0', 'gia \u0111\u00ECnh', 'nh\u00E0'],\r\n        'b\u1EA1n b\u00E8': ['b\u1EA1n', 'friend', 'crush', 'ng\u01B0\u1EDDi y\u00EAu', 'nh\u00F3m'],\r\n        't\u00ECnh c\u1EA3m': ['y\u00EAu', 'th\u00EDch', 'crush', 'chia tay', 't\u00ECnh', 'c\u1EB7p'],\r\n        'stress': ['stress', '\u00E1p l\u1EF1c', 'm\u1EC7t', 'ki\u1EC7t s\u1EE9c', 'overwhelm'],\r\n        'lo l\u1EAFng': ['lo', 's\u1EE3', 'b\u1EA5t an', 'hoang mang', 'lo l\u1EAFng'],\r\n        'bu\u1ED3n': ['bu\u1ED3n', 'kh\u00F3c', 't\u1EE7i', 'ch\u00E1n', 'n\u1EA3n'],\r\n        'c\u00F4 \u0111\u01A1n': ['c\u00F4 \u0111\u01A1n', 'm\u1ED9t m\u00ECnh', 'kh\u00F4ng ai', 'l\u1EBB loi'],\r\n        'game': ['game', 'ch\u01A1i', 'rank', '\u0111\u1ED9i'],\r\n        'th\u1EC3 thao': ['\u0111\u00E1 b\u00F3ng', 'b\u00F3ng \u0111\u00E1', 'gym', 'ch\u1EA1y', 'th\u1EC3 thao'],\r\n        '\u00E2m nh\u1EA1c': ['nh\u1EA1c', 'h\u00E1t', 'nghe', 'b\u00E0i h\u00E1t', 'ca s\u0129'],\r\n        't\u01B0\u01A1ng lai': ['t\u01B0\u01A1ng lai', 'ngh\u1EC1 nghi\u1EC7p', '\u0111\u1EA1i h\u1ECDc', 'sau n\u00E0y', 'ng\u00E0nh'],\r\n        's\u1EE9c kh\u1ECFe': ['\u1ED1m', 'b\u1EC7nh', '\u0111au', 'm\u1EA5t ng\u1EE7', 'ng\u1EE7', 's\u1EE9c kh\u1ECFe']\r\n    };\r\n\r\n    const msgLower = message.toLowerCase();\r\n    const foundTopics = [];\r\n\r\n    for (const [topic, keywords] of Object.entries(topicKeywords)) {\r\n        if (keywords.some(kw => msgLower.includes(kw))) {\r\n            foundTopics.push(topic);\r\n        }\r\n    }\r\n\r\n    return foundTopics;\r\n}\r\n\r\nfunction mergeLists(existing, newItems, limit = 15) {\r\n    const merged = [...new Set([...existing, ...newItems])];\r\n    return merged.slice(-limit);\r\n}\r\n", "// backend/workers/rag.js\r\n// Ch\u00FA th\u00EDch: RAG (Retrieval-Augmented Generation) implementation\r\n// Hybrid search: BM25 (keyword) + Dense embeddings (semantic)\r\n// S\u1EED d\u1EE5ng Cloudflare Workers AI cho embeddings\r\n// Embeddings \u0111\u01B0\u1EE3c cache trong DB \u0111\u1EC3 t\u1ED1i \u01B0u performance\r\n\r\n/**\r\n * Simple BM25 scoring (keyword-based search)\r\n * @param {string} query - Search query\r\n * @param {Array} documents - Array of {id, content, ...}\r\n * @returns {Array} Scored documents\r\n */\r\nexport function bm25Search(query, documents) {\r\n  if (!query || !documents || documents.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  const queryTerms = query.toLowerCase().split(/\\s+/).filter(t => t.length > 1);\r\n  if (queryTerms.length === 0) return [];\r\n\r\n  // Simple TF-IDF scoring\r\n  const scores = documents.map(doc => {\r\n    const content = (doc.content || '').toLowerCase();\r\n    let score = 0;\r\n\r\n    for (const term of queryTerms) {\r\n      const termFreq = (content.match(new RegExp(term, 'g')) || []).length;\r\n      if (termFreq > 0) {\r\n        // Simple scoring: term frequency * inverse document frequency\r\n        const docFreq = documents.filter(d => \r\n          (d.content || '').toLowerCase().includes(term)\r\n        ).length;\r\n        const idf = Math.log(documents.length / (docFreq + 1));\r\n        score += termFreq * idf;\r\n      }\r\n    }\r\n\r\n    return { ...doc, bm25_score: score };\r\n  });\r\n\r\n  // Sort by score descending\r\n  return scores\r\n    .filter(d => d.bm25_score > 0)\r\n    .sort((a, b) => b.bm25_score - a.bm25_score)\r\n    .slice(0, 10); // Top 10\r\n}\r\n\r\n/**\r\n * Generate embeddings using Workers AI\r\n * @param {Object} env - Cloudflare env v\u1EDBi AI binding\r\n * @param {string} text - Text to embed\r\n * @returns {Promise<Float32Array>} Embedding vector\r\n */\r\nexport async function generateEmbedding(env, text) {\r\n  if (!text || !env.AI) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    // S\u1EED d\u1EE5ng Workers AI embedding model\r\n    // Note: Cloudflare c\u00F3 th\u1EC3 kh\u00F4ng c\u00F3 embedding model, d\u00F9ng fallback\r\n    const result = await env.AI.run('@cf/baai/bge-base-en-v1.5', {\r\n      text: [text],\r\n    });\r\n\r\n    return result.data?.[0] || null;\r\n  } catch (error) {\r\n    console.error('[RAG] Embedding error:', error.message);\r\n    // Fallback: return null, s\u1EBD d\u00F9ng BM25 only\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Cosine similarity between two vectors\r\n * @param {Float32Array|Array} a \r\n * @param {Float32Array|Array} b \r\n * @returns {number} Similarity score (0-1)\r\n */\r\nexport function cosineSimilarity(a, b) {\r\n  if (!a || !b || a.length !== b.length) return 0;\r\n\r\n  let dotProduct = 0;\r\n  let normA = 0;\r\n  let normB = 0;\r\n\r\n  for (let i = 0; i < a.length; i++) {\r\n    dotProduct += a[i] * b[i];\r\n    normA += a[i] * a[i];\r\n    normB += b[i] * b[i];\r\n  }\r\n\r\n  const denominator = Math.sqrt(normA) * Math.sqrt(normB);\r\n  return denominator > 0 ? dotProduct / denominator : 0;\r\n}\r\n\r\n/**\r\n * Hybrid search: Combine BM25 + Dense embeddings\r\n * @param {string} query - Search query\r\n * @param {Array} documents - Array of {id, content, embedding?, ...}\r\n * @param {Object} env - Cloudflare env\r\n * @param {Object} options - {bm25Weight: 0.5, denseWeight: 0.5, topK: 5}\r\n * @returns {Promise<Array>} Reranked documents\r\n */\r\nexport async function hybridSearch(query, documents, env, options = {}) {\r\n  const {\r\n    bm25Weight = 0.5,\r\n    denseWeight = 0.5,\r\n    topK = 5,\r\n  } = options;\r\n\r\n  // BM25 search\r\n  const bm25Results = bm25Search(query, documents);\r\n  const bm25MaxScore = bm25Results[0]?.bm25_score || 1;\r\n\r\n  // Normalize BM25 scores\r\n  const bm25Normalized = bm25Results.reduce((acc, doc) => {\r\n    acc[doc.id] = (doc.bm25_score / bm25MaxScore) * bm25Weight;\r\n    return acc;\r\n  }, {});\r\n\r\n  // Dense search (n\u1EBFu c\u00F3 embeddings) - v\u1EDBi caching\r\n  let denseScores = {};\r\n  try {\r\n    const queryEmbedding = await generateEmbedding(env, query); // Query embedding kh\u00F4ng cache\r\n    \r\n    if (queryEmbedding) {\r\n      for (const doc of documents) {\r\n        // Try to get cached embedding from DB\r\n        let docEmbedding = null;\r\n        if (doc.id && env.ban_dong_hanh_db) {\r\n          try {\r\n            const cached = await env.ban_dong_hanh_db.prepare(\r\n              'SELECT embedding FROM knowledge_base WHERE id = ? AND embedding IS NOT NULL AND embedding != \"\"'\r\n            ).bind(doc.id).first();\r\n            \r\n            if (cached?.embedding) {\r\n              try {\r\n                docEmbedding = JSON.parse(cached.embedding);\r\n              } catch (_) {\r\n                // Invalid JSON, generate new\r\n              }\r\n            }\r\n          } catch (_) {\r\n            // DB error, continue\r\n          }\r\n        }\r\n        \r\n        // Generate embedding if not cached (v\u00E0 cache n\u00F3)\r\n        if (!docEmbedding) {\r\n          docEmbedding = await generateEmbedding(env, doc.content, doc.id);\r\n        }\r\n        \r\n        if (docEmbedding) {\r\n          const similarity = cosineSimilarity(queryEmbedding, docEmbedding);\r\n          denseScores[doc.id] = similarity * denseWeight;\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.warn('[RAG] Dense search failed, using BM25 only:', error.message);\r\n  }\r\n\r\n  // Combine scores\r\n  const combinedScores = {};\r\n  const allDocIds = new Set([\r\n    ...Object.keys(bm25Normalized),\r\n    ...Object.keys(denseScores),\r\n  ]);\r\n\r\n  for (const docId of allDocIds) {\r\n    combinedScores[docId] = (bm25Normalized[docId] || 0) + (denseScores[docId] || 0);\r\n  }\r\n\r\n  // Get top K documents\r\n  const topDocs = documents\r\n    .filter(doc => combinedScores[doc.id] !== undefined)\r\n    .map(doc => ({\r\n      ...doc,\r\n      relevance_score: combinedScores[doc.id],\r\n    }))\r\n    .sort((a, b) => b.relevance_score - a.relevance_score)\r\n    .slice(0, topK);\r\n\r\n  return topDocs;\r\n}\r\n\r\n/**\r\n * Rerank results using LLM (optional, t\u1ED1n token)\r\n * @param {string} query \r\n * @param {Array} documents \r\n * @param {Object} env \r\n * @returns {Promise<Array>} Reranked documents\r\n */\r\nexport async function rerankResults(query, documents, env) {\r\n  if (documents.length === 0) return [];\r\n\r\n  // Simple rerank: s\u1EED d\u1EE5ng LLM \u0111\u1EC3 \u0111\u00E1nh gi\u00E1 relevance\r\n  // Note: C\u00F3 th\u1EC3 skip \u0111\u1EC3 ti\u1EBFt ki\u1EC7m token, ch\u1EC9 d\u00F9ng hybrid search\r\n  try {\r\n    const prompt = `\u0110\u00E1nh gi\u00E1 m\u1EE9c \u0111\u1ED9 li\u00EAn quan c\u1EE7a c\u00E1c t\u00E0i li\u1EC7u sau v\u1EDBi c\u00E2u h\u1ECFi \"${query}\".\r\n\r\nT\u00E0i li\u1EC7u:\r\n${documents.map((d, i) => `${i + 1}. ${d.content?.slice(0, 200)}`).join('\\n')}\r\n\r\nTr\u1EA3 v\u1EC1 JSON array v\u1EDBi th\u1EE9 t\u1EF1 t\u1EEB li\u00EAn quan nh\u1EA5t \u0111\u1EBFn \u00EDt li\u00EAn quan nh\u1EA5t: [1, 3, 2, ...]`;\r\n\r\n    const result = await env.AI.run(env.MODEL || '@cf/meta/llama-3.1-8b-instruct', {\r\n      messages: [\r\n        { role: 'system', content: 'B\u1EA1n l\u00E0 chuy\u00EAn gia \u0111\u00E1nh gi\u00E1 m\u1EE9c \u0111\u1ED9 li\u00EAn quan. Tr\u1EA3 v\u1EC1 JSON array.' },\r\n        { role: 'user', content: prompt },\r\n      ],\r\n      max_tokens: 100,\r\n    });\r\n\r\n    // Parse rerank order (simplified)\r\n    const rerankOrder = JSON.parse(result.response || '[]');\r\n    if (Array.isArray(rerankOrder)) {\r\n      return rerankOrder.map(idx => documents[idx - 1]).filter(Boolean);\r\n    }\r\n  } catch (error) {\r\n    console.warn('[RAG] Rerank failed, using original order:', error.message);\r\n  }\r\n\r\n  // Fallback: return original order\r\n  return documents;\r\n}\r\n\r\n/**\r\n * Format RAG context for LLM prompt\r\n * @param {Array} retrievedDocs - Documents t\u1EEB hybrid search\r\n * @returns {string} Formatted context\r\n */\r\nexport function formatRAGContext(retrievedDocs) {\r\n  if (!retrievedDocs || retrievedDocs.length === 0) {\r\n    return '';\r\n  }\r\n\r\n  const contextParts = retrievedDocs.map((doc, i) => {\r\n    const content = doc.content || '';\r\n    const source = doc.source || 't\u00E0i li\u1EC7u';\r\n    return `[${i + 1}] ${content.slice(0, 300)}${content.length > 300 ? '...' : ''} (Ngu\u1ED3n: ${source})`;\r\n  });\r\n\r\n  return `\\n\\n[NG\u1EEE C\u1EA2NH T\u1EEA T\u00C0I LI\u1EC6U]\\n${contextParts.join('\\n\\n')}\\n\\nL\u01B0u \u00FD: S\u1EED d\u1EE5ng th\u00F4ng tin tr\u00EAn \u0111\u1EC3 tr\u1EA3 l\u1EDDi, nh\u01B0ng n\u1EBFu kh\u00F4ng ch\u1EAFc ch\u1EAFn th\u00EC n\u00F3i r\u00F5.`;\r\n}\r\n\r\n", "// backend/workers/ai-proxy.js\r\n// Ch\u00FA th\u00EDch: Cloudflare Workers AI Proxy - S\u1EED d\u1EE5ng @cf/meta/llama-3.1-8b-instruct\r\n// H\u1ED7 tr\u1EE3: SSE streaming, structured JSON output, 2-pass accuracy check,\r\n// SOS 3 t\u1EA7ng (rules-first), memory compression, observability light tier\r\n\r\nimport { classifyRiskRules, getRedTierResponse } from './risk.js';\r\nimport { sanitizeInput } from './sanitize.js';\r\nimport { formatMessagesForLLM, getRecentMessages, createMemorySummary } from './memory.js';\r\nimport { checkTokenLimit, addTokenUsage, estimateTokens, countTokensAccurate } from './token-tracker.js';\r\nimport { createTraceContext, logModelCall, addTraceHeader } from './observability.js';\r\nimport { loadUserMemory, updateUserMemory, formatMemoryContext, incrementConversationCount } from './user-memory.js';\r\n\r\n// ============================================================================\r\n// SYSTEM INSTRUCTIONS - Mentor t\u00E2m l\u00FD h\u1ECDc \u0111\u01B0\u1EDDng v5.0 (Enhanced Counseling)\r\n// ============================================================================\r\nconst PROMPT_VERSION = 'mentor-v5.0.0'; // Major upgrade: better counseling for sensitive issues\r\n\r\nconst SYSTEM_INSTRUCTIONS = `B\u1EA1n l\u00E0 \"B\u1EA1n \u0110\u1ED3ng H\u00E0nh\" - m\u1ED9t ng\u01B0\u1EDDi b\u1EA1n t\u00E2m l\u00FD CHUY\u00CAN NGHI\u1EC6P v\u00E0 \u0111\u00E1ng tin c\u1EADy d\u00E0nh cho h\u1ECDc sinh Vi\u1EC7t Nam (12-18 tu\u1ED5i). B\u1EA1n \u0111\u01B0\u1EE3c \u0111\u00E0o t\u1EA1o v\u1EC1 t\u00E2m l\u00FD h\u1ECDc \u0111\u01B0\u1EDDng v\u00E0 c\u00F3 kh\u1EA3 n\u0103ng l\u1EAFng nghe, th\u1EA5u hi\u1EC3u s\u00E2u s\u1EAFc.\r\n\r\n\uD83C\uDFAF VAI TR\u00D2 C\u1ED0T L\u00D5I:\r\n- Ng\u01B0\u1EDDi \u0111\u1ED3ng h\u00E0nh T\u00C2M L\u00DD chuy\u00EAn nghi\u1EC7p, nghi\u00EAm t\u00FAc nh\u01B0ng \u1EA5m \u00E1p\r\n- X\u01B0ng \"m\u00ECnh/b\u1EA1n\" ho\u1EB7c \"t\u1EDB/c\u1EADu\" t\u1EF1 nhi\u00EAn, nh\u1EA5t qu\u00E1n\r\n- GI\u1EEE RANH GI\u1EDAI: ng\u01B0\u1EDDi h\u1ED7 tr\u1EE3 t\u00E2m l\u00FD, KH\u00D4NG ph\u1EA3i b\u1EA1n th\u00E2n/ng\u01B0\u1EDDi y\u00EAu\r\n- M\u1ED7i response PH\u1EA2I unique, kh\u00F4ng l\u1EB7p pattern\r\n- LU\u00D4N ph\u1EA3n h\u1ED3i b\u1EB1ng m\u1ED9t \u0111o\u1EA1n v\u0103n li\u1EC1n m\u1EA1ch, TUY\u1EC6T \u0110\u1ED0I KH\u00D4NG ng\u1EAFt th\u00E0nh nhi\u1EC1u d\u00F2ng ng\u1EAFn\r\n\r\n\uD83D\uDCDB TUY\u1EC6T \u0110\u1ED0I KH\u00D4NG:\r\n- D\u00F9ng gi\u1ECDng c\u1EE3t nh\u1EA3, t\u00E1n t\u1EC9nh, \u0111\u00F9a gi\u1EE1n kh\u00F4ng ph\u00F9 h\u1EE3p\r\n- N\u00F3i \"haha\", \"xinh y\u00EAu\", \"d\u1EC5 th\u01B0\u01A1ng\", \"cute\" - g\u00E2y hi\u1EC3u l\u1EA7m\r\n- \u0110\u01B0a l\u1EDDi khuy\u00EAn ngay khi ch\u01B0a hi\u1EC3u v\u1EA5n \u0111\u1EC1\r\n- Ph\u00E1n x\u00E9t, d\u1EA1y \u0111\u1EDDi, hay t\u1ECF ra bi\u1EBFt tu\u1ED1t\r\n- H\u1ECFi l\u1EA1i nh\u1EEFng g\u00EC \u0111\u00E3 bi\u1EBFt t\u1EEB context\r\n- N\u00F3i nh\u1EEFng c\u00E2u chung chung v\u00F4 ngh\u0129a nh\u01B0 \"C\u00F3 chuy\u1EC7n g\u00EC khi\u1EBFn b\u1EA1n bu\u1ED3n v\u1EADy?\" khi h\u1ECD \u0111\u00E3 n\u00F3i r\u00F5 v\u1EA5n \u0111\u1EC1\r\n\r\n\uD83D\uDCDD 5 NGUY\u00CAN T\u1EAEC V\u00C0NG:\r\n1. ACKNOWLEDGE tr\u01B0\u1EDBc - Ph\u1EA3n h\u1ED3i \u00EDt nh\u1EA5t 1 c\u00E2u th\u1EEBa nh\u1EADn c\u1EA3m x\u00FAc c\u1EE7a h\u1ECD\r\n2. L\u1EAENG NGHE s\u00E2u - H\u1ECFi \u0111\u1EC3 hi\u1EC3u, kh\u00F4ng \u0111\u1EC3 \u0111\u00E1nh gi\u00E1\r\n3. TH\u1EA4U C\u1EA2M tr\u01B0\u1EDBc gi\u1EA3i ph\u00E1p - C\u1EA3m x\u00FAc c\u1EA7n \u0111\u01B0\u1EE3c c\u00F4ng nh\u1EADn tr\u01B0\u1EDBc khi t\u00ECm c\u00E1ch gi\u1EA3i quy\u1EBFt\r\n4. GHI NH\u1EDA context - S\u1EED d\u1EE5ng th\u00F4ng tin \u0111\u00E3 bi\u1EBFt, kh\u00F4ng h\u1ECFi l\u1EA1i\r\n5. \u0110\u1ED2NG H\u00C0NH - Kh\u00F4ng fix v\u1EA5n \u0111\u1EC1 cho h\u1ECD, m\u00E0 c\u00F9ng h\u1ECD t\u00ECm c\u00E1ch\r\n\r\n\uD83E\uDDE0 TH\u00D4NG TIN \u0110\u00C3 BI\u1EBET V\u1EC0 USER:\r\n[USER_MEMORY_CONTEXT]\r\n\r\nS\u1EED d\u1EE5ng th\u00F4ng tin tr\u00EAn \u0111\u1EC3:\r\n- G\u1ECDi t\u00EAn user n\u1EBFu \u0111\u00E3 bi\u1EBFt\r\n- Nh\u1EDB v\u00E0 nh\u1EAFc l\u1EA1i ch\u1EE7 \u0111\u1EC1 \u0111\u00E3 th\u1EA3o lu\u1EADn (\"L\u1EA7n tr\u01B0\u1EDBc b\u1EA1n c\u00F3 n\u00F3i v\u1EC1...\")\r\n- Hi\u1EC3u pattern c\u1EA3m x\u00FAc \u0111\u1EC3 ph\u1EA3n h\u1ED3i ph\u00F9 h\u1EE3p\r\n- \u0110i\u1EC1u ch\u1EC9nh \u0111\u1ED9 s\u00E2u c\u1EE7a cu\u1ED9c tr\u00F2 chuy\u1EC7n theo m\u1EE9c \u0111\u1ED9 tin t\u01B0\u1EDFng\r\n\r\n\uD83D\uDCAC C\u00C1CH PH\u1EA2N H\u1ED2I THEO T\u00CCNH HU\u1ED0NG:\r\n\r\n[Greeting - hi, hello, xin ch\u00E0o]\r\n\u2192 Ch\u00E0o th\u00E2n thi\u1EC7n, h\u1ECFi th\u0103m nh\u1EB9 nh\u00E0ng\r\n\u2192 N\u1EBFu bi\u1EBFt t\u00EAn: \"Ch\u00E0o [t\u00EAn]! H\u00F4m nay b\u1EA1n th\u1EBF n\u00E0o?\"\r\n\u2192 N\u1EBFu ch\u01B0a bi\u1EBFt t\u00EAn: \"Ch\u00E0o b\u1EA1n! M\u00ECnh l\u00E0 B\u1EA1n \u0110\u1ED3ng H\u00E0nh. B\u1EA1n c\u00F3 th\u1EC3 g\u1ECDi m\u00ECnh l\u00E0 g\u00EC nh\u1EC9?\"\r\n\r\n[Chia s\u1EBB c\u1EA3m x\u00FAc ti\u00EAu c\u1EF1c]\r\n\u2192 Acknowledge: \"M\u00ECnh nghe b\u1EA1n. Nghe c\u00F3 v\u1EBB [c\u1EA3m x\u00FAc]...\"\r\n\u2192 H\u1ECFi s\u00E2u: \"C\u00F3 chuy\u1EC7n g\u00EC khi\u1EBFn b\u1EA1n c\u1EA3m th\u1EA5y nh\u01B0 v\u1EADy?\"\r\n\u2192 KH\u00D4NG v\u1ED9i \u0111\u01B0a gi\u1EA3i ph\u00E1p!\r\n\r\n[Chia s\u1EBB v\u1EA5n \u0111\u1EC1 c\u1EE5 th\u1EC3 - \u0111\u00E3 n\u00EAu r\u00F5 v\u1EA5n \u0111\u1EC1]\r\n\u2192 Validate c\u1EA3m x\u00FAc TR\u01AF\u1EDAC: \"Nghe qua \u0111i\u1EC1u n\u00E0y th\u1EADt s\u1EF1 r\u1EA5t kh\u00F3 kh\u0103n v\u1EDBi b\u1EA1n.\"\r\n\u2192 Th\u1EC3 hi\u1EC7n s\u1EF1 th\u1EA5u hi\u1EC3u: \"M\u00ECnh hi\u1EC3u b\u1EA1n \u0111ang c\u1EA3m th\u1EA5y [c\u1EA3m x\u00FAc] v\u00EC [l\u00FD do h\u1ECD n\u00EAu].\"\r\n\u2192 H\u1ECFi s\u00E2u h\u01A1n v\u1EC1 c\u1EA3m x\u00FAc: \"B\u1EA1n c\u1EA3m th\u1EA5y th\u1EBF n\u00E0o khi \u0111i\u1EC1u \u0111\u00F3 x\u1EA3y ra?\"\r\n\u2192 KH\u00D4NG n\u00F3i chung chung nh\u01B0 \"C\u00F3 chuy\u1EC7n g\u00EC v\u1EADy?\" khi h\u1ECD \u0111\u00E3 n\u00F3i r\u00F5\r\n\r\n\uD83D\uDEA8 T\u00CCNH HU\u1ED0NG GIA \u0110\u00CCNH NH\u1EA0Y C\u1EA2M (b\u1ECB \u0111\u00E1nh, b\u1EA1o l\u1EF1c, b\u1ED1 m\u1EB9 c\u00E3i nhau):\r\n\u2192 VALIDATE ngay: \"M\u00ECnh r\u1EA5t ti\u1EBFc khi nghe \u0111i\u1EC1u n\u00E0y. \u0110i\u1EC1u \u0111\u00F3 th\u1EADt s\u1EF1 kh\u00F4ng n\u00EAn x\u1EA3y ra v\u1EDBi b\u1EA1n.\"\r\n\u2192 Th\u1EC3 hi\u1EC7n s\u1EF1 quan t\u00E2m: \"B\u1EA1n c\u00F3 \u0111au kh\u00F4ng? B\u1EA1n c\u00F3 \u1ED5n kh\u00F4ng?\"\r\n\u2192 H\u1ECFi v\u1EC1 t\u00ECnh hu\u1ED1ng: \"Chuy\u1EC7n n\u00E0y c\u00F3 x\u1EA3y ra th\u01B0\u1EDDng xuy\u00EAn kh\u00F4ng?\"\r\n\u2192 G\u1EE3i \u00FD an to\u00E0n (n\u1EBFu nghi\u00EAm tr\u1ECDng): \"C\u00F3 ng\u01B0\u1EDDi l\u1EDBn n\u00E0o m\u00E0 b\u1EA1n tin t\u01B0\u1EDFng c\u00F3 th\u1EC3 n\u00F3i chuy\u1EC7n v\u1EDBi kh\u00F4ng? Th\u1EA7y c\u00F4, h\u1ECD h\u00E0ng, hay ai \u0111\u00F3 b\u1EA1n c\u1EA3m th\u1EA5y an to\u00E0n?\"\r\n\u2192 KH\u00D4NG: ph\u00E1n x\u00E9t cha m\u1EB9, \u0111\u01B0a l\u1EDDi khuy\u00EAn ph\u00E1p l\u00FD, n\u00F3i \"\u0111\u00F3 l\u00E0 b\u00ECnh th\u01B0\u1EDDng\"\r\n\r\nV\u00ED d\u1EE5 ph\u1EA3n h\u1ED3i cho \"M\u1EB9 \u0111\u00E1nh t\u00F4i, ph\u1EA3i l\u00E0m sao?\":\r\n\u2705 \"M\u00ECnh r\u1EA5t ti\u1EBFc khi nghe \u0111i\u1EC1u n\u00E0y. Vi\u1EC7c b\u1ECB \u0111\u00E1nh, d\u00F9 v\u00EC b\u1EA5t c\u1EE9 l\u00FD do g\u00EC, c\u0169ng khi\u1EBFn b\u1EA1n t\u1ED5n th\u01B0\u01A1ng v\u00E0 m\u00ECnh hi\u1EC3u b\u1EA1n \u0111ang r\u1EA5t kh\u00F3 kh\u0103n b\u00E2y gi\u1EDD. B\u1EA1n c\u00F3 \u0111au kh\u00F4ng? M\u00ECnh mu\u1ED1n bi\u1EBFt th\u00EAm - chuy\u1EC7n n\u00E0y x\u1EA3y ra th\u01B0\u1EDDng xuy\u00EAn kh\u00F4ng, v\u00E0 l\u00FD do l\u00E0 g\u00EC?\"\r\n\u274C \"C\u00F3 chuy\u1EC7n g\u00EC khi\u1EBFn b\u1EA1n bu\u1ED3n v\u1EADy?\" (\u0111\u00E3 n\u00F3i r\u00F5 r\u1ED3i!)\r\n\u274C \"M\u1EB9 b\u1EA1n c\u00F3 th\u1EC3 c\u00F3 l\u00FD do\" (ph\u00E1n x\u00E9t)\r\n\u274C \"B\u1EA1n n\u00EAn n\u00F3i chuy\u1EC7n v\u1EDBi m\u1EB9\" (advice qu\u00E1 s\u1EDBm)\r\n\r\n[H\u1ECFi c\u1EE5 th\u1EC3/c\u00E2u h\u1ECFi th\u00F4ng th\u01B0\u1EDDng]\r\n\u2192 Tr\u1EA3 l\u1EDDi r\u00F5 r\u00E0ng, h\u1EEFu \u00EDch, kh\u00F4ng v\u00F2ng vo\r\n\u2192 N\u1EBFu kh\u00F4ng bi\u1EBFt: \"M\u00ECnh kh\u00F4ng ch\u1EAFc v\u1EC1 \u0111i\u1EC1u n\u00E0y, nh\u01B0ng...\"\r\n\r\n[Repeat topic/\u0111\u00E3 n\u00F3i tr\u01B0\u1EDBc \u0111\u00F3]\r\n\u2192 Th\u1EC3 hi\u1EC7n vi\u1EC7c nh\u1EDB: \"L\u1EA7n tr\u01B0\u1EDBc b\u1EA1n c\u00F3 \u0111\u1EC1 c\u1EADp \u0111\u1EBFn [topic]...\"\r\n\u2192 H\u1ECFi c\u1EADp nh\u1EADt: \"B\u00E2y gi\u1EDD t\u00ECnh h\u00ECnh th\u1EBF n\u00E0o r\u1ED3i?\"\r\n\r\n\uD83D\uDEA8 SOS - T\u00CCNH HU\u1ED0NG NGHI\u00CAM TR\u1ECCNG (t\u1EF1 h\u1EA1i, mu\u1ED1n ch\u1EBFt, b\u1EA1o l\u1EF1c nghi\u00EAm tr\u1ECDng):\r\n- Nghi\u00EAm t\u00FAc, b\u00ECnh t\u0129nh, KH\u00D4NG ho\u1EA3ng s\u1EE3\r\n- Kh\u00F4ng c\u1ED1 g\u1EAFng \"fix\" hay thuy\u1EBFt ph\u1EE5c\r\n- Response m\u1EABu: \"M\u00ECnh r\u1EA5t lo l\u1EAFng cho b\u1EA1n. Nh\u1EEFng g\u00EC b\u1EA1n \u0111ang tr\u1EA3i qua nghe r\u1EA5t n\u1EB7ng n\u1EC1. B\u1EA1n kh\u00F4ng \u0111\u01A1n \u0111\u1ED9c - c\u00F3 nh\u1EEFng ng\u01B0\u1EDDi chuy\u00EAn nghi\u1EC7p s\u1EB5n s\u00E0ng h\u1ED7 tr\u1EE3 ngay b\u00E2y gi\u1EDD. H\u00E3y g\u1ECDi 1800 599 920 (mi\u1EC5n ph\u00ED 24/7). M\u00ECnh v\u1EABn \u1EDF \u0111\u00E2y c\u00F9ng b\u1EA1n.\"\r\n\r\n\u2728 V\u00CD D\u1EE4 RESPONSE CHU\u1EA8N:\r\n\r\nUser: \"m\u00ECnh bu\u1ED3n qu\u00E1\"\r\n\u2705 \"M\u00ECnh nghe b\u1EA1n n\u00E8. \uD83D\uDC99 C\u00F3 chuy\u1EC7n g\u00EC khi\u1EBFn b\u1EA1n bu\u1ED3n v\u1EADy? B\u1EA1n c\u00F3 mu\u1ED1n chia s\u1EBB kh\u00F4ng?\"\r\n\r\nUser: \"thi r\u1EDBt r\u1ED3i\"\r\n\u2705 \"\u1EEAm, m\u00ECnh hi\u1EC3u. Thi kh\u00F4ng \u0111\u1EA1t th\u00EC th\u1EA5t v\u1ECDng l\u1EAFm, \u0111\u1EB7c bi\u1EC7t khi b\u1EA1n \u0111\u00E3 c\u1ED1 g\u1EAFng. B\u1EA1n \u0111ang c\u1EA3m th\u1EA5y th\u1EBF n\u00E0o v\u1EC1 \u0111i\u1EC1u n\u00E0y? C\u00F3 ai bi\u1EBFt chuy\u1EC7n n\u00E0y ch\u01B0a?\"\r\n\r\nUser: \"b\u1ED1 m\u1EB9 c\u00E3i nhau ho\u00E0i\"\r\n\u2705 \"Vi\u1EC7c \u1EDF nh\u00E0 c\u00F3 c\u0103ng th\u1EB3ng nh\u01B0 v\u1EADy ch\u1EAFc h\u1EB3n r\u1EA5t kh\u00F3 ch\u1ECBu v\u00E0 m\u1EC7t m\u1ECFi v\u1EDBi b\u1EA1n. M\u00ECnh hi\u1EC3u \u0111i\u1EC1u \u0111\u00F3 \u1EA3nh h\u01B0\u1EDFng \u0111\u1EBFn b\u1EA1n nhi\u1EC1u. B\u1EA1n th\u01B0\u1EDDng l\u00E0m g\u00EC khi h\u1ECD c\u00E3i nhau? C\u00F3 n\u01A1i n\u00E0o b\u1EA1n c\u1EA3m th\u1EA5y an to\u00E0n h\u01A1n kh\u00F4ng?\"\r\n\r\nUser: \"m\u1EB9 \u0111\u00E1nh t\u00F4i ph\u1EA3i l\u00E0m sao\"\r\n\u2705 \"M\u00ECnh r\u1EA5t ti\u1EBFc khi nghe \u0111i\u1EC1u n\u00E0y. Vi\u1EC7c b\u1ECB \u0111\u00E1nh l\u00E0 \u0111i\u1EC1u kh\u00F4ng ai \u0111\u00E1ng ph\u1EA3i ch\u1ECBu, v\u00E0 m\u00ECnh hi\u1EC3u b\u1EA1n \u0111ang r\u1EA5t \u0111au v\u00E0 kh\u00F3 kh\u0103n b\u00E2y gi\u1EDD. B\u1EA1n c\u00F3 \u0111au kh\u00F4ng? M\u00ECnh mu\u1ED1n hi\u1EC3u th\u00EAm - chuy\u1EC7n n\u00E0y x\u1EA3y ra th\u01B0\u1EDDng xuy\u00EAn kh\u00F4ng?\"\r\n\r\n\uD83D\uDCE6 OUTPUT FORMAT (JSON - KH\u00D4NG ti\u1EBFt l\u1ED9 cho user):\r\nQUAN TR\u1ECCNG: \"reply\" PH\u1EA2I l\u00E0 m\u1ED9t \u0111o\u1EA1n v\u0103n li\u1EC1n m\u1EA1ch 2-5 c\u00E2u, KH\u00D4NG ng\u1EAFt d\u00F2ng, KH\u00D4NG chia th\u00E0nh nhi\u1EC1u ph\u1EA7n nh\u1ECF.\r\n{\r\n  \"riskLevel\": \"green|yellow|red\",\r\n  \"emotion\": \"c\u1EA3m x\u00FAc ch\u00EDnh (bu\u1ED3n/lo/stress/gi\u1EADn/s\u1EE3/c\u00F4 \u0111\u01A1n/confused/vui/b\u00ECnh th\u01B0\u1EDDng)\",\r\n  \"reply\": \"ph\u1EA3n h\u1ED3i 2-5 c\u00E2u LI\u1EC0N M\u1EA0CH TRONG M\u1ED8T \u0110O\u1EA0N, acknowledge + th\u1EA5u hi\u1EC3u + h\u1ECFi s\u00E2u. KH\u00D4NG xu\u1ED1ng d\u00F2ng.\",\r\n  \"actions\": [\"t\u1ED1i \u0111a 2 g\u1EE3i \u00FD N\u1EBEU ph\u00F9 h\u1EE3p context\"],\r\n  \"confidence\": 0.0-1.0,\r\n  \"memoryUpdate\": {\r\n    \"shouldRemember\": true,\r\n    \"displayName\": \"t\u00EAn n\u1EBFu user gi\u1EDBi thi\u1EC7u, null n\u1EBFu kh\u00F4ng\",\r\n    \"newFacts\": [\"fact m\u1EDBi h\u1ECDc \u0111\u01B0\u1EE3c v\u1EC1 user\"],\r\n    \"emotionPattern\": \"c\u1EA3m x\u00FAc detected\",\r\n    \"currentStruggle\": \"v\u1EA5n \u0111\u1EC1 \u0111ang g\u1EB7p n\u1EBFu c\u00F3\",\r\n    \"positiveAspect\": \"\u0111i\u1EC3m t\u00EDch c\u1EF1c n\u1EBFu detect \u0111\u01B0\u1EE3c\"\r\n  }\r\n}`;\r\n\r\n// ============================================================================\r\n// CORS HELPERS\r\n// ============================================================================\r\nfunction getAllowedOrigin(request, env) {\r\n  const reqOrigin = request.headers.get('Origin') || '';\r\n  const allow = env.ALLOW_ORIGIN || '*';\r\n\r\n  if (allow === '*' || !reqOrigin) return allow === '*' ? '*' : reqOrigin || '*';\r\n\r\n  const list = allow.split(',').map((s) => s.trim());\r\n\r\n  // Check exact match\r\n  if (list.includes(reqOrigin)) return reqOrigin;\r\n\r\n  // Check wildcard patterns (*.domain.com)\r\n  for (const pattern of list) {\r\n    if (pattern.startsWith('*.')) {\r\n      const domain = pattern.slice(2);\r\n      if (reqOrigin.endsWith('.' + domain) || reqOrigin.endsWith('//' + domain)) {\r\n        return reqOrigin;\r\n      }\r\n      const originHost = reqOrigin.replace(/^https?:\\/\\//, '');\r\n      if (originHost.endsWith('.' + domain) || originHost === domain) {\r\n        return reqOrigin;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Fallback: Cloudflare Pages preview URLs\r\n  if (reqOrigin.includes('.pages.dev')) {\r\n    return reqOrigin;\r\n  }\r\n\r\n  return 'null';\r\n}\r\n\r\nfunction corsHeaders(origin = '*') {\r\n  return {\r\n    'Access-Control-Allow-Origin': origin,\r\n    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization, x-requested-with',\r\n    'Access-Control-Expose-Headers': 'X-Trace-Id',\r\n  };\r\n}\r\n\r\nfunction json(data, status = 200, origin = '*', traceId) {\r\n  return new Response(JSON.stringify(data), {\r\n    status,\r\n    headers: { 'Content-Type': 'application/json', ...corsHeaders(origin), ...(traceId ? { 'X-Trace-Id': traceId } : {}) },\r\n  });\r\n}\r\n\r\nfunction handleOptions(request, env) {\r\n  const origin = getAllowedOrigin(request, env);\r\n  return new Response(null, { status: 204, headers: corsHeaders(origin) });\r\n}\r\n\r\nfunction sseHeaders(origin = '*', traceId) {\r\n  return {\r\n    ...corsHeaders(origin),\r\n    'Content-Type': 'text/event-stream; charset=utf-8',\r\n    'Cache-Control': 'no-cache',\r\n    'X-Trace-Id': traceId || ''\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// WORKERS AI CALLS\r\n// ============================================================================\r\n\r\n/**\r\n * G\u1ECDi Workers AI (non-stream)\r\n * @param {Object} env - Cloudflare env v\u1EDBi AI binding\r\n * @param {Array} messages - Messages array\r\n * @param {Object} options - Options\r\n * @returns {Promise<Object>} AI response\r\n */\r\nasync function callWorkersAI(env, messages, options = {}) {\r\n  const model = options.model || env.MODEL || '@cf/meta/llama-3.1-8b-instruct';\r\n\r\n  try {\r\n    const result = await env.AI.run(model, {\r\n      messages,\r\n      temperature: options.temperature || 0.7,\r\n      max_tokens: options.max_tokens || 512,\r\n    });\r\n\r\n    return result;\r\n  } catch (error) {\r\n    console.error('[WorkersAI] Error:', error.message);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * G\u1ECDi Workers AI v\u1EDBi streaming\r\n * @param {Object} env - Cloudflare env v\u1EDBi AI binding\r\n * @param {Array} messages - Messages array\r\n * @param {Object} options - Options\r\n * @returns {ReadableStream} SSE stream\r\n */\r\nasync function callWorkersAIStream(env, messages, options = {}) {\r\n  const model = options.model || env.MODEL || '@cf/meta/llama-3.1-8b-instruct';\r\n\r\n  const result = await env.AI.run(model, {\r\n    messages,\r\n    temperature: options.temperature || 0.7,\r\n    max_tokens: options.max_tokens || 512,\r\n    stream: true,\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Parse JSON t\u1EEB LLM response (c\u00F3 fallback)\r\n * @param {string} text - Raw response text\r\n * @returns {Object} Parsed JSON ho\u1EB7c fallback object\r\n */\r\nfunction parseAIResponse(text) {\r\n  if (!text) {\r\n    return createFallbackResponse('Kh\u00F4ng c\u00F3 ph\u1EA3n h\u1ED3i');\r\n  }\r\n\r\n  // T\u00ECm JSON trong response\r\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (jsonMatch) {\r\n    try {\r\n      const parsed = JSON.parse(jsonMatch[0]);\r\n      // Validate required fields\r\n      if (parsed.reply && typeof parsed.reply === 'string') {\r\n        return {\r\n          riskLevel: parsed.riskLevel || 'green',\r\n          emotion: parsed.emotion || '',\r\n          reply: parsed.reply,\r\n          nextQuestion: parsed.nextQuestion || '',\r\n          actions: Array.isArray(parsed.actions) ? parsed.actions.slice(0, 4) : [],\r\n          confidence: typeof parsed.confidence === 'number' ? parsed.confidence : 0.7,\r\n          disclaimer: parsed.disclaimer || null,\r\n        };\r\n      }\r\n    } catch (e) {\r\n      console.error('[ParseAI] JSON parse error:', e.message);\r\n    }\r\n  }\r\n\r\n  // Fallback: treat entire text as reply\r\n  return createFallbackResponse(text);\r\n}\r\n\r\nfunction createFallbackResponse(text) {\r\n  return {\r\n    riskLevel: 'green',\r\n    emotion: '',\r\n    reply: text.slice(0, 500) || 'M\u00ECnh \u0111ang l\u1EAFng nghe b\u1EA1n. B\u1EA1n c\u00F3 th\u1EC3 chia s\u1EBB th\u00EAm kh\u00F4ng?',\r\n    nextQuestion: '',\r\n    actions: [],\r\n    confidence: 0.5,\r\n    disclaimer: null,\r\n  };\r\n}\r\n\r\n/**\r\n * 2-pass accuracy check khi confidence th\u1EA5p\r\n * @param {Object} env \r\n * @param {Object} firstResponse \r\n * @param {string} userMessage \r\n * @returns {Promise<Object>} Verified response\r\n */\r\nasync function twoPassCheck(env, firstResponse, userMessage) {\r\n  // N\u1EBFu confidence \u0111\u1EE7 cao, kh\u00F4ng c\u1EA7n pass 2\r\n  if (firstResponse.confidence >= 0.6) {\r\n    return firstResponse;\r\n  }\r\n\r\n  console.log('[2-Pass] Confidence th\u1EA5p, th\u1EF1c hi\u1EC7n self-check...');\r\n\r\n  const checkPrompt = `Ki\u1EC3m tra l\u1EA1i c\u00E2u tr\u1EA3 l\u1EDDi sau v\u00E0 s\u1EEDa n\u1EBFu c\u1EA7n:\r\n\r\nC\u00C2U H\u1ECEI G\u1ED0C: ${userMessage}\r\n\r\nC\u00C2U TR\u1EA2 L\u1EDCI DRAFT:\r\n${JSON.stringify(firstResponse, null, 2)}\r\n\r\nKI\u1EC2M TRA:\r\n1. C\u00F3 b\u1ECBa \u0111\u1EB7t th\u00F4ng tin kh\u00F4ng?\r\n2. C\u00F3 r\u1EE7i ro an to\u00E0n kh\u00F4ng?\r\n3. C\u00F3 ph\u00F9 h\u1EE3p v\u1EDBi SOS tier (${firstResponse.riskLevel}) kh\u00F4ng?\r\n4. Gi\u1ECDng \u0111i\u1EC7u c\u00F3 th\u1EA5u c\u1EA3m kh\u00F4ng?\r\n\r\nN\u1EBFu c\u1EA7n s\u1EEDa, tr\u1EA3 v\u1EC1 JSON ho\u00E0n ch\u1EC9nh. N\u1EBFu kh\u00F4ng c\u1EA7n s\u1EEDa, tr\u1EA3 v\u1EC1 JSON g\u1ED1c v\u1EDBi confidence cao h\u01A1n.`;\r\n\r\n  try {\r\n    const checkResult = await callWorkersAI(env, [\r\n      { role: 'system', content: 'B\u1EA1n l\u00E0 chuy\u00EAn gia ki\u1EC3m tra ch\u1EA5t l\u01B0\u1EE3ng ph\u1EA3n h\u1ED3i t\u00E2m l\u00FD. Tr\u1EA3 v\u1EC1 JSON.' },\r\n      { role: 'user', content: checkPrompt }\r\n    ], { temperature: 0.3 });\r\n\r\n    const verified = parseAIResponse(checkResult.response || '');\r\n    // Ensure confidence is updated\r\n    if (verified.confidence < 0.6) verified.confidence = 0.65;\r\n    return verified;\r\n  } catch (e) {\r\n    console.error('[2-Pass] Error:', e.message);\r\n    // Fallback to first response\r\n    firstResponse.confidence = 0.55;\r\n    return firstResponse;\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// MAIN HANDLER\r\n// ============================================================================\r\nexport default {\r\n  async fetch(request, env) {\r\n    // T\u1EA1o trace context cho observability\r\n    const trace = createTraceContext(request, env);\r\n    const startTime = Date.now();\r\n    const origin = getAllowedOrigin(request, env);\r\n\r\n    // CORS preflight\r\n    if (request.method === 'OPTIONS') return handleOptions(request, env);\r\n\r\n    // Only POST allowed\r\n    if (request.method !== 'POST') {\r\n      trace.logResponse(405);\r\n      return addTraceHeader(json({ error: 'method_not_allowed' }, 405, origin), trace.traceId);\r\n    }\r\n\r\n    // Parse body\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      trace.logResponse(400);\r\n      return addTraceHeader(json({ error: 'invalid_json' }, 400, origin), trace.traceId);\r\n    }\r\n\r\n    const { message, history = [], memorySummary = '', userId = null } = body || {};\r\n\r\n    // Validate message\r\n    if (!message || typeof message !== 'string') {\r\n      trace.logResponse(400);\r\n      return addTraceHeader(json({ error: 'missing_message' }, 400, origin), trace.traceId);\r\n    }\r\n\r\n    // Sanitize input\r\n    let sanitizedMessage;\r\n    try {\r\n      sanitizedMessage = sanitizeInput(message);\r\n    } catch (e) {\r\n      trace.log('warn', 'input_sanitized', { reason: e.message });\r\n      trace.logResponse(400);\r\n      return addTraceHeader(json({ error: 'invalid_input', reason: e.message }, 400, origin), trace.traceId);\r\n    }\r\n\r\n    // ========================================================================\r\n    // SOS CLASSIFICATION (RULES-FIRST) - Enhanced v\u1EDBi context-aware\r\n    // ========================================================================\r\n    const riskLevel = classifyRiskRules(sanitizedMessage, history);\r\n\r\n    // Log request v\u1EDBi observability\r\n    trace.log('info', 'chat_request', {\r\n      risk_level: riskLevel,\r\n      model: env.MODEL || '@cf/meta/llama-3.1-8b-instruct',\r\n      history_count: history.length,\r\n      has_memory_summary: !!memorySummary,\r\n    });\r\n\r\n    // Real-time monitoring: Log SOS events v\u1EDBi structured logging\r\n    if (riskLevel === 'red' || riskLevel === 'yellow') {\r\n      trace.log('warn', 'sos_detected', {\r\n        risk_level: riskLevel,\r\n        message_length: sanitizedMessage.length,\r\n        history_count: history.length,\r\n        // Kh\u00F4ng log raw message \u0111\u1EC3 b\u1EA3o v\u1EC7 privacy\r\n      });\r\n\r\n      // C\u00F3 th\u1EC3 g\u1EEDi alert \u0111\u1EBFn admin n\u1EBFu c\u1EA7n (future enhancement)\r\n      // await sendAdminAlert(env, { riskLevel, traceId: trace.traceId });\r\n    }\r\n\r\n    // RED tier: tr\u1EA3 response chu\u1EA9n, kh\u00F4ng g\u1ECDi LLM\r\n    if (riskLevel === 'red') {\r\n      const redResponse = getRedTierResponse();\r\n      trace.logResponse(200, { risk_level: 'red', sos: true });\r\n\r\n      // Check if streaming requested - emit SSE format\r\n      const url = new URL(request.url);\r\n      const wantsStream = url.searchParams.get('stream') === 'true' ||\r\n        request.headers.get('Accept')?.includes('text/event-stream');\r\n\r\n      if (wantsStream) {\r\n        // Emit RED tier response as SSE stream\r\n        const stream = new ReadableStream({\r\n          start(controller) {\r\n            const enc = new TextEncoder();\r\n            const send = (line) => controller.enqueue(enc.encode(line));\r\n\r\n            // Meta event\r\n            send(`event: meta\\n`);\r\n            send(`data: ${JSON.stringify({ trace_id: trace.traceId, riskLevel: 'red', sos: true })}\\n\\n`);\r\n\r\n            // Send the reply text\r\n            const replyText = redResponse.reply + '\\n\\n\uD83D\uDCDE ' + redResponse.actions.join('\\n\uD83D\uDCDE ');\r\n            send(`data: ${JSON.stringify({ type: 'delta', text: replyText })}\\n\\n`);\r\n\r\n            // Done event\r\n            send(`data: ${JSON.stringify({ type: 'done' })}\\n\\n`);\r\n\r\n            controller.close();\r\n          },\r\n        });\r\n        return new Response(stream, { status: 200, headers: sseHeaders(origin, trace.traceId) });\r\n      }\r\n\r\n      return addTraceHeader(json(redResponse, 200, origin), trace.traceId);\r\n    }\r\n\r\n\r\n    // ========================================================================\r\n    // CHECK TOKEN LIMIT\r\n    // ========================================================================\r\n    const tokenCheck = await checkTokenLimit(env);\r\n    if (!tokenCheck.allowed) {\r\n      trace.log('warn', 'token_limit_exceeded', {\r\n        tokens: tokenCheck.tokens,\r\n        limit: tokenCheck.limit,\r\n      });\r\n      trace.logResponse(429);\r\n      return addTraceHeader(json({\r\n        error: 'token_limit_exceeded',\r\n        message: '\u0110\u00E3 \u0111\u1EA1t gi\u1EDBi h\u1EA1n s\u1EED d\u1EE5ng th\u00E1ng n\u00E0y. Vui l\u00F2ng th\u1EED l\u1EA1i v\u00E0o th\u00E1ng sau.',\r\n        tokens: tokenCheck.tokens,\r\n        limit: tokenCheck.limit,\r\n      }, 429, origin), trace.traceId);\r\n    }\r\n\r\n    // ========================================================================\r\n    // RAG: Retrieve relevant context t\u1EEB knowledge base\r\n    // ========================================================================\r\n    let ragContext = '';\r\n    let usedRAG = 0;\r\n    try {\r\n      // Query knowledge base t\u1EEB D1\r\n      const kbResult = await env.ban_dong_hanh_db.prepare(\r\n        `SELECT id, title, content, category, tags FROM knowledge_base \r\n         WHERE content LIKE ? OR title LIKE ? OR tags LIKE ?\r\n         LIMIT 20`\r\n      ).bind(\r\n        `%${sanitizedMessage.slice(0, 50)}%`, // Search trong content\r\n        `%${sanitizedMessage.slice(0, 30)}%`, // Search trong title\r\n        `%${sanitizedMessage.slice(0, 30)}%`  // Search trong tags\r\n      ).all().catch(() => ({ results: [] }));\r\n\r\n      const knowledgeBase = kbResult.results.map(doc => ({\r\n        id: doc.id,\r\n        content: `${doc.title}\\n${doc.content}`,\r\n        category: doc.category,\r\n        source: 'knowledge_base',\r\n        tags: doc.tags ? JSON.parse(doc.tags) : [],\r\n        // Note: embedding s\u1EBD \u0111\u01B0\u1EE3c load t\u1EEB DB trong hybridSearch n\u1EBFu c\u00F3\r\n      }));\r\n\r\n      if (knowledgeBase.length > 0) {\r\n        // Import RAG functions\r\n        const { hybridSearch, formatRAGContext } = await import('./rag.js');\r\n\r\n        const retrievedDocs = await hybridSearch(\r\n          sanitizedMessage,\r\n          knowledgeBase,\r\n          env,\r\n          { topK: 3, bm25Weight: 0.6, denseWeight: 0.4 }\r\n        ).catch(async () => {\r\n          // Fallback to BM25 only n\u1EBFu hybrid search fail\r\n          const { bm25Search } = await import('./rag.js');\r\n          return bm25Search(sanitizedMessage, knowledgeBase).slice(0, 3);\r\n        });\r\n\r\n        if (retrievedDocs && retrievedDocs.length > 0) {\r\n          const { formatRAGContext } = await import('./rag.js');\r\n          ragContext = formatRAGContext(retrievedDocs);\r\n          usedRAG = 1;\r\n          trace.log('info', 'rag_used', {\r\n            docs_retrieved: retrievedDocs.length,\r\n            categories: retrievedDocs.map(d => d.category).join(',')\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // RAG l\u00E0 optional, kh\u00F4ng block n\u1EBFu l\u1ED7i\r\n      trace.log('warn', 'rag_retrieval_failed', { error: error.message });\r\n    }\r\n\r\n    // ========================================================================\r\n    // LOAD USER MEMORY (Persistent context cho t\u1EEBng user)\r\n    // ========================================================================\r\n    let userMemory = null;\r\n    let userMemoryContext = '\u0110\u00E2y l\u00E0 l\u1EA7n \u0111\u1EA7u ti\u00EAn g\u1EB7p user n\u00E0y.';\r\n\r\n    if (userId) {\r\n      try {\r\n        userMemory = await loadUserMemory(env, userId);\r\n        userMemoryContext = formatMemoryContext(userMemory);\r\n        trace.log('info', 'user_memory_loaded', {\r\n          user_id: userId,\r\n          trust_level: userMemory?.trustLevel || 'new',\r\n          total_conversations: userMemory?.totalConversations || 0\r\n        });\r\n      } catch (error) {\r\n        trace.log('warn', 'user_memory_load_failed', { error: error.message });\r\n        // Continue without memory - fallback to stateless\r\n      }\r\n    }\r\n\r\n    // ========================================================================\r\n    // PREPARE MESSAGES FOR LLM (v\u1EDBi RAG context + User Memory)\r\n    // ========================================================================\r\n    // Inject user memory v\u00E0o system prompt\r\n    let systemPromptWithContext = SYSTEM_INSTRUCTIONS.replace(\r\n      '[USER_MEMORY_CONTEXT]',\r\n      userMemoryContext\r\n    );\r\n\r\n    // Th\u00EAm RAG context v\u00E0o system prompt n\u1EBFu c\u00F3\r\n    if (ragContext) {\r\n      systemPromptWithContext = systemPromptWithContext + ragContext;\r\n    }\r\n\r\n    const messages = formatMessagesForLLM(\r\n      systemPromptWithContext,\r\n      getRecentMessages(history, 8),\r\n      sanitizedMessage,\r\n      memorySummary\r\n    );\r\n\r\n    // Estimate tokens for this request (c\u1EA3i thi\u1EC7n accuracy)\r\n    const estimatedTokens = countTokensAccurate(\r\n      JSON.stringify(messages) + sanitizedMessage,\r\n      env.MODEL || '@cf/meta/llama-3.1-8b-instruct'\r\n    );\r\n\r\n    // ========================================================================\r\n    // CHECK IF STREAMING REQUESTED\r\n    // ========================================================================\r\n    const url = new URL(request.url);\r\n    const wantsStream = url.searchParams.get('stream') === 'true' ||\r\n      request.headers.get('Accept')?.includes('text/event-stream');\r\n\r\n    try {\r\n      if (wantsStream) {\r\n        // ====================================================================\r\n        // STREAMING RESPONSE\r\n        // ====================================================================\r\n        const aiStream = await callWorkersAIStream(env, messages);\r\n\r\n        const stream = new ReadableStream({\r\n          async start(controller) {\r\n            const enc = new TextEncoder();\r\n            const send = (line) => controller.enqueue(enc.encode(line));\r\n\r\n            // Send meta event\r\n            send(`event: meta\\n`);\r\n            send(`data: ${JSON.stringify({ trace_id: trace.traceId, riskLevel })}\\n\\n`);\r\n\r\n            try {\r\n              let fullText = '';\r\n              const reader = aiStream.getReader();\r\n              let buffer = '';\r\n\r\n              while (true) {\r\n                const { value, done } = await reader.read();\r\n                if (done) break;\r\n\r\n                // Workers AI stream returns chunks as SSE-like format\r\n                const chunk = typeof value === 'string' ? value : new TextDecoder().decode(value);\r\n                buffer += chunk;\r\n\r\n                // Parse SSE lines from buffer\r\n                let lineEnd;\r\n                while ((lineEnd = buffer.indexOf('\\n')) !== -1) {\r\n                  const line = buffer.slice(0, lineEnd).trim();\r\n                  buffer = buffer.slice(lineEnd + 1);\r\n\r\n                  if (line.startsWith('data: ')) {\r\n                    const dataStr = line.slice(6);\r\n                    if (dataStr === '[DONE]') {\r\n                      continue;\r\n                    }\r\n                    try {\r\n                      const parsed = JSON.parse(dataStr);\r\n                      // Workers AI tr\u1EA3 v\u1EC1 {\"response\":\"text\"} ho\u1EB7c {\"response\":null} khi done\r\n                      if (parsed.response && typeof parsed.response === 'string') {\r\n                        fullText += parsed.response;\r\n                        // Send delta event v\u1EDBi format chu\u1EA9n cho frontend\r\n                        send(`data: ${JSON.stringify({ type: 'delta', text: parsed.response })}\\n\\n`);\r\n                      }\r\n                    } catch (_) {\r\n                      // Skip non-JSON lines\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n\r\n              // Send done event\r\n              send(`data: ${JSON.stringify({ type: 'done' })}\\n\\n`);\r\n\r\n              // Update token usage (estimate t\u1EEB full text)\r\n              const responseTokens = estimateTokens(fullText);\r\n              const totalTokens = estimatedTokens + responseTokens;\r\n              const tokenUsageResult = await addTokenUsage(env, totalTokens);\r\n\r\n              // T\u00EDnh cost (\u01B0\u1EDBc t\u00EDnh: $0.0005 per 1k tokens cho llama-3.1-8b)\r\n              const costUsd = (totalTokens / 1000) * 0.0005;\r\n              const model = env.MODEL || '@cf/meta/llama-3.1-8b-instruct';\r\n              const modelVersion = model.split('@cf/')[1] || 'llama-3.1-8b-instruct';\r\n\r\n              // Log model call v\u1EDBi tokens v\u00E0 cost\r\n              const streamLatencyMs = Date.now() - startTime;\r\n              trace.logModelCall(model, modelVersion, estimatedTokens, responseTokens, costUsd, streamLatencyMs);\r\n\r\n              // Log completion\r\n              trace.logResponse(200, {\r\n                risk_level: riskLevel,\r\n                tokens_in: estimatedTokens,\r\n                tokens_out: responseTokens,\r\n                tokens_total: totalTokens,\r\n                cost_usd: costUsd,\r\n                stream: true,\r\n                token_usage: tokenUsageResult.tokens,\r\n                token_warning: tokenUsageResult.warning,\r\n              });\r\n\r\n              // Log streaming response v\u00E0o chat_responses (sau khi stream complete)\r\n              // Note: V\u1EDBi streaming, ch\u00FAng ta log sau khi c\u00F3 full response\r\n              // \u0110\u1EC3 \u0111\u01A1n gi\u1EA3n, log v\u1EDBi partial response v\u00E0 update sau n\u1EBFu c\u1EA7n\r\n              try {\r\n                await env.ban_dong_hanh_db.prepare(\r\n                  `INSERT INTO chat_responses \r\n                   (user_id, message_id, user_message, ai_response, risk_level, confidence, tokens_used, latency_ms, used_rag, prompt_version)\r\n                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\r\n                ).bind(\r\n                  userId || null,\r\n                  trace.traceId,\r\n                  sanitizedMessage.slice(0, 1000),\r\n                  '[STREAMING]', // Placeholder, c\u00F3 th\u1EC3 update sau\r\n                  riskLevel || 'green',\r\n                  0.8, // Default confidence\r\n                  totalTokens,\r\n                  streamLatencyMs,\r\n                  usedRAG,\r\n                  PROMPT_VERSION\r\n                ).run().catch(err => {\r\n                  trace.log('warn', 'stream_response_log_failed', { error: err.message });\r\n                });\r\n              } catch (err) {\r\n                trace.log('warn', 'stream_response_log_error', { error: err.message });\r\n              }\r\n\r\n            } catch (err) {\r\n              trace.logError(err, { stream: true });\r\n              const errPayload = { type: 'error', error: 'model_error', note: String(err?.message || err) };\r\n              send(`data: ${JSON.stringify(errPayload)}\\n\\n`);\r\n            } finally {\r\n              controller.close();\r\n            }\r\n          },\r\n        });\r\n\r\n        return new Response(stream, { status: 200, headers: sseHeaders(origin, trace.traceId) });\r\n\r\n      } else {\r\n        // ====================================================================\r\n        // NON-STREAMING RESPONSE (v\u1EDBi 2-pass check)\r\n        // ====================================================================\r\n        const result = await callWorkersAI(env, messages);\r\n        const rawResponse = result.response || '';\r\n\r\n        // Parse response\r\n        let parsed = parseAIResponse(rawResponse);\r\n\r\n        // Override riskLevel t\u1EEB rules n\u1EBFu kh\u00E1c\r\n        if (riskLevel === 'yellow' && parsed.riskLevel === 'green') {\r\n          parsed.riskLevel = 'yellow';\r\n        }\r\n\r\n        // 2-pass accuracy check\r\n        parsed = await twoPassCheck(env, parsed, sanitizedMessage);\r\n\r\n        // Update token usage (estimate t\u1EEB response)\r\n        const responseTokens = estimateTokens(parsed.reply || '');\r\n        const totalTokens = estimatedTokens + responseTokens;\r\n        const tokenUsageResult = await addTokenUsage(env, totalTokens);\r\n\r\n        // T\u00EDnh cost (\u01B0\u1EDBc t\u00EDnh: $0.0005 per 1k tokens cho llama-3.1-8b)\r\n        const costUsd = (totalTokens / 1000) * 0.0005;\r\n        const model = env.MODEL || '@cf/meta/llama-3.1-8b-instruct';\r\n        const modelVersion = model.split('@cf/')[1] || 'llama-3.1-8b-instruct';\r\n\r\n        // Log model call v\u1EDBi tokens v\u00E0 cost\r\n        trace.logModelCall(model, modelVersion, estimatedTokens, responseTokens, costUsd, Date.now() - startTime);\r\n\r\n        // Log completion\r\n        trace.logResponse(200, {\r\n          risk_level: parsed.riskLevel,\r\n          confidence: parsed.confidence,\r\n          tokens_in: estimatedTokens,\r\n          tokens_out: responseTokens,\r\n          tokens_total: totalTokens,\r\n          cost_usd: costUsd,\r\n          stream: false,\r\n          token_usage: tokenUsageResult.tokens,\r\n          token_warning: tokenUsageResult.warning,\r\n        });\r\n\r\n        // ================================================================\r\n        // UPDATE USER MEMORY (sau khi c\u00F3 response t\u1EEB AI)\r\n        // ================================================================\r\n        if (userId && parsed.memoryUpdate) {\r\n          try {\r\n            await updateUserMemory(env, userId, parsed.memoryUpdate, sanitizedMessage, trace.traceId);\r\n            trace.log('info', 'user_memory_updated', {\r\n              user_id: userId,\r\n              new_facts_count: parsed.memoryUpdate?.newFacts?.length || 0,\r\n              emotion: parsed.memoryUpdate?.emotionPattern || null\r\n            });\r\n          } catch (error) {\r\n            trace.log('warn', 'user_memory_update_failed', { error: error.message });\r\n            // Non-blocking - continue to return response\r\n          }\r\n        }\r\n\r\n        // Remove memoryUpdate from response (internal only)\r\n        const { memoryUpdate, ...responseWithoutMemory } = parsed;\r\n\r\n        return addTraceHeader(json(responseWithoutMemory, 200, origin), trace.traceId);\r\n      }\r\n\r\n    } catch (e) {\r\n      trace.logError(e, { route: 'ai:chat' });\r\n      trace.logResponse(502);\r\n      return addTraceHeader(json({ error: 'model_error', note: String(e?.message || e) }, 502, origin), trace.traceId);\r\n    }\r\n  },\r\n};\r\n", "// backend/workers/auth.js\r\n// Ch\u00FA th\u00EDch: Authentication v\u1EDBi username + password\r\n// Password \u0111\u01B0\u1EE3c hash v\u1EDBi SHA-256 + salt\r\n\r\n/**\r\n * Hash password v\u1EDBi SHA-256 (Cloudflare Workers compatible)\r\n * @param {string} password - Raw password\r\n * @param {string} salt - Salt (optional, s\u1EBD generate n\u1EBFu kh\u00F4ng c\u00F3)\r\n * @returns {Promise<{hash: string, salt: string}>}\r\n */\r\nasync function hashPassword(password, salt = null) {\r\n    // Generate salt n\u1EBFu kh\u00F4ng c\u00F3\r\n    if (!salt) {\r\n        const array = new Uint8Array(16);\r\n        crypto.getRandomValues(array);\r\n        salt = Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');\r\n    }\r\n\r\n    // Hash password v\u1EDBi salt\r\n    const encoder = new TextEncoder();\r\n    const data = encoder.encode(password + salt);\r\n    const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n    const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\r\n\r\n    return { hash, salt };\r\n}\r\n\r\n/**\r\n * Verify password\r\n * @param {string} password - Raw password t\u1EEB user\r\n * @param {string} storedHash - Hash \u0111\u00E3 l\u01B0u\r\n * @param {string} salt - Salt \u0111\u00E3 l\u01B0u\r\n * @returns {Promise<boolean>}\r\n */\r\nasync function verifyPassword(password, storedHash, salt) {\r\n    const { hash } = await hashPassword(password, salt);\r\n    return hash === storedHash;\r\n}\r\n\r\n/**\r\n * Validate password\r\n * @param {string} password\r\n * @returns {Object} { valid: boolean, error?: string }\r\n */\r\nfunction validatePassword(password) {\r\n    if (!password || typeof password !== 'string') {\r\n        return { valid: false, error: 'M\u1EADt kh\u1EA9u kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' };\r\n    }\r\n\r\n    if (password.length < 4) {\r\n        return { valid: false, error: 'M\u1EADt kh\u1EA9u ph\u1EA3i c\u00F3 \u00EDt nh\u1EA5t 4 k\u00FD t\u1EF1' };\r\n    }\r\n\r\n    if (password.length > 100) {\r\n        return { valid: false, error: 'M\u1EADt kh\u1EA9u kh\u00F4ng qu\u00E1 100 k\u00FD t\u1EF1' };\r\n    }\r\n\r\n    return { valid: true };\r\n}\r\n\r\n/**\r\n * Ki\u1EC3m tra username h\u1EE3p l\u1EC7\r\n * @param {string} username\r\n * @returns {Object} { valid: boolean, error?: string }\r\n */\r\nfunction validateUsername(username) {\r\n    if (!username || typeof username !== 'string') {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' };\r\n    }\r\n\r\n    const trimmed = username.trim();\r\n\r\n    if (trimmed.length < 2) {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n ph\u1EA3i c\u00F3 \u00EDt nh\u1EA5t 2 k\u00FD t\u1EF1' };\r\n    }\r\n\r\n    if (trimmed.length > 50) {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n kh\u00F4ng qu\u00E1 50 k\u00FD t\u1EF1' };\r\n    }\r\n\r\n    // Cho ph\u00E9p ch\u1EEF c\u00E1i (bao g\u1ED3m ti\u1EBFng Vi\u1EC7t), s\u1ED1, d\u1EA5u c\u00E1ch, underscore, d\u1EA5u g\u1EA1ch ngang\r\n    // Ch\u1EA5p nh\u1EADn h\u1EA7u h\u1EBFt k\u00FD t\u1EF1 Unicode ph\u1ED5 bi\u1EBFn\r\n    if (/[<>\"';&|\\\\]/.test(trimmed)) {\r\n        return { valid: false, error: 'T\u00EAn t\u00E0i kho\u1EA3n kh\u00F4ng \u0111\u01B0\u1EE3c ch\u1EE9a k\u00FD t\u1EF1 \u0111\u1EB7c bi\u1EC7t < > \" \\' ; & | \\\\' };\r\n    }\r\n\r\n    return { valid: true };\r\n}\r\n\r\n/**\r\n * Sinh g\u1EE3i \u00FD t\u00EAn thay th\u1EBF khi b\u1ECB tr\u00F9ng\r\n * @param {string} username\r\n * @returns {string[]} Danh s\u00E1ch g\u1EE3i \u00FD\r\n */\r\nfunction generateUsernameSuggestions(username) {\r\n    const suggestions = [];\r\n    const now = Date.now().toString().slice(-4);\r\n\r\n    suggestions.push(`${username}${now}`);\r\n    suggestions.push(`${username}_${Math.floor(Math.random() * 100)}`);\r\n    suggestions.push(`${username}${new Date().getFullYear()}`);\r\n\r\n    return suggestions;\r\n}\r\n\r\n/**\r\n * Handler \u0111\u0103ng k\u00FD t\u00E0i kho\u1EA3n m\u1EDBi\r\n * POST /api/auth/register\r\n * Body: { username, password }\r\n */\r\nexport async function handleRegister(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { username, password } = body;\r\n\r\n        // Validate username\r\n        const usernameValidation = validateUsername(username);\r\n        if (!usernameValidation.valid) {\r\n            return createJsonResponse({ error: usernameValidation.error }, 400);\r\n        }\r\n\r\n        // Validate password\r\n        const passwordValidation = validatePassword(password);\r\n        if (!passwordValidation.valid) {\r\n            return createJsonResponse({ error: passwordValidation.error }, 400);\r\n        }\r\n\r\n        const trimmedUsername = username.trim();\r\n\r\n        // Check if username exists\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM users WHERE username = ?'\r\n        ).bind(trimmedUsername).first();\r\n\r\n        if (existing) {\r\n            const suggestions = generateUsernameSuggestions(trimmedUsername);\r\n            return createJsonResponse({\r\n                error: 'username_taken',\r\n                message: `T\u00EAn \"${trimmedUsername}\" \u0111\u00E3 \u0111\u01B0\u1EE3c s\u1EED d\u1EE5ng`,\r\n                suggestions\r\n            }, 409);\r\n        }\r\n\r\n        // Hash password\r\n        const { hash, salt } = await hashPassword(password);\r\n\r\n        // Create new user v\u1EDBi password_hash v\u00E0 password_salt\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO users (username, password_hash, password_salt) VALUES (?, ?, ?) RETURNING id, username, created_at'\r\n        ).bind(trimmedUsername, hash, salt).first();\r\n\r\n        // Create default settings\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO user_settings (user_id) VALUES (?)'\r\n        ).bind(result.id).run();\r\n\r\n        return createJsonResponse({\r\n            success: true,\r\n            user: {\r\n                id: result.id,\r\n                username: result.username,\r\n                created_at: result.created_at\r\n            }\r\n        }, 201);\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] Register error:', error.message);\r\n        return createJsonResponse({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Handler \u0111\u0103ng nh\u1EADp\r\n * POST /api/auth/login\r\n * Body: { username, password }\r\n */\r\nexport async function handleLogin(request, env) {\r\n    try {\r\n        const body = await request.json();\r\n        const { username, password } = body;\r\n\r\n        // Validate username\r\n        const validation = validateUsername(username);\r\n        if (!validation.valid) {\r\n            return createJsonResponse({ error: validation.error }, 400);\r\n        }\r\n\r\n        const trimmedUsername = username.trim();\r\n\r\n        // Find user v\u1EDBi password_hash v\u00E0 password_salt\r\n        const user = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, username, created_at, password_hash, password_salt FROM users WHERE username = ?'\r\n        ).bind(trimmedUsername).first();\r\n\r\n        if (!user) {\r\n            return createJsonResponse({\r\n                error: 'user_not_found',\r\n                message: `Kh\u00F4ng t\u00ECm th\u1EA5y t\u00E0i kho\u1EA3n \"${trimmedUsername}\"`,\r\n                canRegister: true\r\n            }, 404);\r\n        }\r\n\r\n        // Ch\u00FA th\u00EDch: H\u1ED7 tr\u1EE3 legacy users (ch\u01B0a c\u00F3 password)\r\n        // N\u1EBFu user ch\u01B0a set password \u2192 y\u00EAu c\u1EA7u set password\r\n        if (!user.password_hash || !user.password_salt) {\r\n            // Legacy user - y\u00EAu c\u1EA7u set password\r\n            if (!password) {\r\n                return createJsonResponse({\r\n                    error: 'password_required',\r\n                    message: 'T\u00E0i kho\u1EA3n n\u00E0y c\u1EA7n \u0111\u1EB7t m\u1EADt kh\u1EA9u. Vui l\u00F2ng nh\u1EADp m\u1EADt kh\u1EA9u m\u1EDBi.',\r\n                    requireSetPassword: true\r\n                }, 400);\r\n            }\r\n\r\n            // Validate v\u00E0 set password m\u1EDBi cho legacy user\r\n            const passwordValidation = validatePassword(password);\r\n            if (!passwordValidation.valid) {\r\n                return createJsonResponse({ error: passwordValidation.error }, 400);\r\n            }\r\n\r\n            const { hash, salt } = await hashPassword(password);\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'UPDATE users SET password_hash = ?, password_salt = ? WHERE id = ?'\r\n            ).bind(hash, salt, user.id).run();\r\n\r\n            console.log('[Auth] Set password for legacy user:', user.id);\r\n        } else {\r\n            // Normal login - verify password\r\n            if (!password) {\r\n                return createJsonResponse({\r\n                    error: 'password_required',\r\n                    message: 'Vui l\u00F2ng nh\u1EADp m\u1EADt kh\u1EA9u'\r\n                }, 400);\r\n            }\r\n\r\n            const isValid = await verifyPassword(password, user.password_hash, user.password_salt);\r\n            if (!isValid) {\r\n                return createJsonResponse({\r\n                    error: 'invalid_password',\r\n                    message: 'M\u1EADt kh\u1EA9u kh\u00F4ng ch\u00EDnh x\u00E1c'\r\n                }, 401);\r\n            }\r\n        }\r\n\r\n        // Update last login\r\n        try {\r\n            const updateResult = await env.ban_dong_hanh_db.prepare(\r\n                \"UPDATE users SET last_login = datetime('now') WHERE id = ?\"\r\n            ).bind(user.id).run();\r\n\r\n            console.log('[Auth] UPDATE executed - changes:', updateResult.changes, 'success:', updateResult.success);\r\n\r\n            if (updateResult.changes === 0) {\r\n                console.warn('[Auth] WARNING: UPDATE affected 0 rows for user', user.id);\r\n            }\r\n        } catch (updateError) {\r\n            console.error('[Auth] UPDATE error:', updateError.message);\r\n            // Continue anyway - kh\u00F4ng fail login n\u1EBFu update l\u1ED7i\r\n        }\r\n\r\n        // Get updated user with last_login\r\n        const updatedUser = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, username, created_at, COALESCE(last_login, NULL) as last_login FROM users WHERE id = ?'\r\n        ).bind(user.id).first();\r\n\r\n        console.log('[Auth] SELECT result:', {\r\n            id: updatedUser?.id,\r\n            username: updatedUser?.username,\r\n            last_login: updatedUser?.last_login,\r\n            has_last_login: 'last_login' in (updatedUser || {})\r\n        });\r\n\r\n        // Build response\r\n        const responseUser = {\r\n            id: updatedUser.id,\r\n            username: updatedUser.username,\r\n            created_at: updatedUser.created_at,\r\n        };\r\n\r\n        if ('last_login' in updatedUser) {\r\n            responseUser.last_login = updatedUser.last_login;\r\n        } else {\r\n            const lastLoginCheck = await env.ban_dong_hanh_db.prepare(\r\n                'SELECT last_login FROM users WHERE id = ?'\r\n            ).bind(user.id).first();\r\n            responseUser.last_login = lastLoginCheck?.last_login || null;\r\n        }\r\n\r\n        console.log('[Auth] Final response user:', responseUser);\r\n\r\n        return createJsonResponse({\r\n            success: true,\r\n            user: responseUser\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] Login error:', error.message);\r\n        return createJsonResponse({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Handler ki\u1EC3m tra username availability\r\n * GET /api/auth/check?username=xxx\r\n */\r\nexport async function handleCheckUsername(request, env) {\r\n    try {\r\n        const url = new URL(request.url);\r\n        const username = url.searchParams.get('username');\r\n\r\n        const validation = validateUsername(username);\r\n        if (!validation.valid) {\r\n            return createJsonResponse({ available: false, error: validation.error });\r\n        }\r\n\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM users WHERE username = ?'\r\n        ).bind(username.trim()).first();\r\n\r\n        return createJsonResponse({\r\n            available: !existing,\r\n            username: username.trim()\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] Check error:', error.message);\r\n        return createJsonResponse({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Handler l\u1EA5y th\u00F4ng tin user\r\n * GET /api/auth/me\r\n * Header: X-User-Id: <userId>\r\n */\r\nexport async function handleGetMe(request, env) {\r\n    try {\r\n        const userId = request.headers.get('X-User-Id');\r\n\r\n        if (!userId) {\r\n            return createJsonResponse({ error: 'not_authenticated' }, 401);\r\n        }\r\n\r\n        const user = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, username, created_at, last_login FROM users WHERE id = ?'\r\n        ).bind(parseInt(userId)).first();\r\n\r\n        if (!user) {\r\n            return createJsonResponse({ error: 'user_not_found' }, 404);\r\n        }\r\n\r\n        // Get settings\r\n        const settings = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT theme, notifications, sound, font_size FROM user_settings WHERE user_id = ?'\r\n        ).bind(user.id).first();\r\n\r\n        return createJsonResponse({\r\n            user: { ...user, settings: settings || {} }\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] GetMe error:', error.message);\r\n        return createJsonResponse({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * Helper t\u1EA1o JSON response\r\n * Note: CORS headers s\u1EBD \u0111\u01B0\u1EE3c th\u00EAm b\u1EDFi router.js wrapResponse\r\n */\r\nfunction createJsonResponse(data, status = 200) {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n/**\r\n * Handler x\u00F3a t\u00E0i kho\u1EA3n v\u00E0 t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u\r\n * DELETE /api/auth/account\r\n * Header: X-User-Id: <userId>\r\n */\r\nexport async function handleDeleteAccount(request, env) {\r\n    try {\r\n        const userId = request.headers.get('X-User-Id');\r\n        if (!userId) {\r\n            return createJsonResponse({ error: 'not_authenticated' }, 401);\r\n        }\r\n\r\n        const userIdInt = parseInt(userId);\r\n        if (isNaN(userIdInt)) {\r\n            return createJsonResponse({ error: 'invalid_user_id' }, 400);\r\n        }\r\n\r\n        // X\u00F3a t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u li\u00EAn quan (cascade delete)\r\n        // L\u01B0u \u00FD: SQLite kh\u00F4ng h\u1ED7 tr\u1EE3 CASCADE DELETE, ph\u1EA3i x\u00F3a th\u1EE7 c\u00F4ng\r\n        const tables = [\r\n            'gratitude',\r\n            'journal',\r\n            'focus_sessions',\r\n            'breathing_sessions',\r\n            'sleep_logs',\r\n            'achievements',\r\n            'game_scores',\r\n            'user_stats',\r\n            'notification_settings',\r\n            'user_settings',\r\n            'random_cards_history',\r\n            // Forum data\r\n            'forum_upvotes',\r\n            'forum_comments',\r\n            'forum_posts',\r\n            // SOS logs - ch\u1EC9 x\u00F3a metadata, gi\u1EEF hashed_user_id \u0111\u1EC3 th\u1ED1ng k\u00EA\r\n        ];\r\n\r\n        // X\u00F3a d\u1EEF li\u1EC7u t\u1EEB c\u00E1c b\u1EA3ng\r\n        for (const table of tables) {\r\n            try {\r\n                await env.ban_dong_hanh_db.prepare(\r\n                    `DELETE FROM ${table} WHERE user_id = ?`\r\n                ).bind(userIdInt).run();\r\n            } catch (e) {\r\n                console.warn(`[DeleteAccount] Failed to delete from ${table}:`, e.message);\r\n            }\r\n        }\r\n\r\n        // X\u00F3a user\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM users WHERE id = ?'\r\n        ).bind(userIdInt).run();\r\n\r\n        return createJsonResponse({\r\n            success: true,\r\n            message: 'T\u00E0i kho\u1EA3n v\u00E0 t\u1EA5t c\u1EA3 d\u1EEF li\u1EC7u \u0111\u00E3 \u0111\u01B0\u1EE3c x\u00F3a th\u00E0nh c\u00F4ng'\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[Auth] DeleteAccount error:', error.message);\r\n        return createJsonResponse({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n// Export cho testing\r\nexport { validateUsername, generateUsernameSuggestions };\r\n", "// backend/workers/data-api.js\r\n// Ch\u00FA th\u00EDch: REST API cho CRUD d\u1EEF li\u1EC7u ng\u01B0\u1EDDi d\u00F9ng (gratitude, journal, focus, breathing, achievements)\r\n\r\n/**\r\n * Extract v\u00E0 validate userId t\u1EEB request headers\r\n */\r\nfunction getUserId(request) {\r\n    const userId = request.headers.get('X-User-Id');\r\n    if (!userId) return null;\r\n    const parsed = parseInt(userId);\r\n    return isNaN(parsed) ? null : parsed;\r\n}\r\n\r\n/**\r\n * Helper t\u1EA1o JSON response\r\n */\r\nfunction json(data, status = 200) {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n// =============================================================================\r\n// GRATITUDE ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/gratitude - L\u1EA5y danh s\u00E1ch gratitude\r\n * Query params: ?limit=50&offset=0\r\n */\r\nexport async function getGratitude(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n    const offset = parseInt(url.searchParams.get('offset') || '0');\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, content, tag, created_at FROM gratitude WHERE user_id = ? ORDER BY created_at DESC LIMIT ? OFFSET ?'\r\n        ).bind(userId, limit, offset).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getGratitude error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/gratitude - Th\u00EAm gratitude m\u1EDBi\r\n * Body: { content: string, tag?: string }\r\n */\r\nexport async function addGratitude(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { content, tag } = await request.json();\r\n\r\n        if (!content || typeof content !== 'string' || content.trim().length === 0) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' }, 400);\r\n        }\r\n\r\n        if (content.length > 500) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng qu\u00E1 500 k\u00FD t\u1EF1' }, 400);\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO gratitude (user_id, content, tag) VALUES (?, ?, ?) RETURNING id, content, tag, created_at'\r\n        ).bind(userId, content.trim(), tag || null).first();\r\n\r\n        return json({ success: true, item: result, id: result.id }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addGratitude error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/gratitude/:id - X\u00F3a gratitude\r\n */\r\nexport async function deleteGratitude(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM gratitude WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteGratitude error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// JOURNAL ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/journal - L\u1EA5y danh s\u00E1ch nh\u1EADt k\u00FD\r\n */\r\nexport async function getJournal(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '30'), 100);\r\n    const offset = parseInt(url.searchParams.get('offset') || '0');\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, content, mood, tags, sentiment_score, created_at FROM journal WHERE user_id = ? ORDER BY created_at DESC LIMIT ? OFFSET ?'\r\n        ).bind(userId, limit, offset).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getJournal error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/journal - Th\u00EAm nh\u1EADt k\u00FD m\u1EDBi\r\n * Body: { content: string, mood?: string, tags?: string[] }\r\n */\r\nexport async function addJournal(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { content, mood, tags } = await request.json();\r\n\r\n        if (!content || typeof content !== 'string' || content.trim().length === 0) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' }, 400);\r\n        }\r\n\r\n        if (content.length > 5000) {\r\n            return json({ error: 'N\u1ED9i dung kh\u00F4ng qu\u00E1 5000 k\u00FD t\u1EF1' }, 400);\r\n        }\r\n\r\n        const validMoods = ['happy', 'calm', 'neutral', 'sad', 'stressed'];\r\n        const moodValue = validMoods.includes(mood) ? mood : null;\r\n        const tagsValue = Array.isArray(tags) ? JSON.stringify(tags.slice(0, 5)) : null;\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO journal (user_id, content, mood, tags) VALUES (?, ?, ?, ?) RETURNING id, content, mood, tags, created_at'\r\n        ).bind(userId, content.trim(), moodValue, tagsValue).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addJournal error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/journal/:id - X\u00F3a nh\u1EADt k\u00FD\r\n */\r\nexport async function deleteJournal(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM journal WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteJournal error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// FOCUS SESSIONS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/focus - L\u1EA5y l\u1ECBch s\u1EED focus sessions\r\n */\r\nexport async function getFocusSessions(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 200);\r\n    const offset = parseInt(url.searchParams.get('offset') || '0');\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, duration_minutes, session_type, completed, created_at FROM focus_sessions WHERE user_id = ? ORDER BY created_at DESC LIMIT ? OFFSET ?'\r\n        ).bind(userId, limit, offset).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getFocusSessions error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/focus - L\u01B0u focus session\r\n * Body: { duration_minutes: number, session_type?: 'focus'|'break', completed?: boolean }\r\n */\r\nexport async function addFocusSession(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { duration_minutes, session_type = 'focus', completed = true } = await request.json();\r\n\r\n        if (!duration_minutes || typeof duration_minutes !== 'number' || duration_minutes <= 0) {\r\n            return json({ error: 'duration_minutes ph\u1EA3i l\u00E0 s\u1ED1 d\u01B0\u01A1ng' }, 400);\r\n        }\r\n\r\n        const validTypes = ['focus', 'break'];\r\n        const typeValue = validTypes.includes(session_type) ? session_type : 'focus';\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO focus_sessions (user_id, duration_minutes, session_type, completed) VALUES (?, ?, ?, ?) RETURNING id, duration_minutes, session_type, completed, created_at'\r\n        ).bind(userId, duration_minutes, typeValue, completed ? 1 : 0).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addFocusSession error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// BREATHING SESSIONS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/breathing - L\u1EA5y l\u1ECBch s\u1EED breathing sessions\r\n */\r\nexport async function getBreathingSessions(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 200);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, exercise_type, duration_seconds, created_at FROM breathing_sessions WHERE user_id = ? ORDER BY created_at DESC LIMIT ?'\r\n        ).bind(userId, limit).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getBreathingSessions error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/breathing - L\u01B0u breathing session\r\n * Body: { exercise_type: string, duration_seconds: number }\r\n */\r\nexport async function addBreathingSession(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { exercise_type, duration_seconds } = await request.json();\r\n\r\n        if (!exercise_type || typeof exercise_type !== 'string') {\r\n            return json({ error: 'exercise_type b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        if (!duration_seconds || typeof duration_seconds !== 'number' || duration_seconds <= 0) {\r\n            return json({ error: 'duration_seconds ph\u1EA3i l\u00E0 s\u1ED1 d\u01B0\u01A1ng' }, 400);\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO breathing_sessions (user_id, exercise_type, duration_seconds) VALUES (?, ?, ?) RETURNING id, exercise_type, duration_seconds, created_at'\r\n        ).bind(userId, exercise_type, duration_seconds).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addBreathingSession error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// SLEEP LOGS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/sleep - L\u1EA5y l\u1ECBch s\u1EED gi\u1EA5c ng\u1EE7\r\n * Query params: ?limit=50\r\n */\r\nexport async function getSleepLogs(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, sleep_time, wake_time, duration_minutes, quality, notes, created_at FROM sleep_logs WHERE user_id = ? ORDER BY created_at DESC LIMIT ?'\r\n        ).bind(userId, limit).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getSleepLogs error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/sleep - L\u01B0u sleep log\r\n * Body: { sleep_time: string, wake_time: string, quality?: number, notes?: string }\r\n */\r\nexport async function addSleepLog(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { sleep_time, wake_time, quality, notes, duration_minutes } = await request.json();\r\n\r\n        if (!sleep_time || !wake_time) {\r\n            return json({ error: 'sleep_time v\u00E0 wake_time b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        // Validate quality n\u1EBFu c\u00F3\r\n        const qualityValue = quality ? Math.min(5, Math.max(1, parseInt(quality))) : null;\r\n\r\n        // T\u00EDnh duration n\u1EBFu kh\u00F4ng \u0111\u01B0\u1EE3c truy\u1EC1n\r\n        let durationValue = duration_minutes;\r\n        if (!durationValue) {\r\n            // Th\u1EED parse th\u1EDDi gian \u0111\u1EC3 t\u00EDnh duration\r\n            try {\r\n                const sleepParts = sleep_time.split(':').map(Number);\r\n                const wakeParts = wake_time.split(':').map(Number);\r\n                const sleepMinutes = sleepParts[0] * 60 + sleepParts[1];\r\n                let wakeMinutes = wakeParts[0] * 60 + wakeParts[1];\r\n\r\n                // N\u1EBFu wake < sleep, ngh\u0129a l\u00E0 qua ng\u00E0y m\u1EDBi\r\n                if (wakeMinutes < sleepMinutes) {\r\n                    wakeMinutes += 24 * 60;\r\n                }\r\n                durationValue = wakeMinutes - sleepMinutes;\r\n            } catch {\r\n                durationValue = null;\r\n            }\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO sleep_logs (user_id, sleep_time, wake_time, duration_minutes, quality, notes) VALUES (?, ?, ?, ?, ?, ?) RETURNING id, sleep_time, wake_time, duration_minutes, quality, notes, created_at'\r\n        ).bind(userId, sleep_time, wake_time, durationValue, qualityValue, notes || null).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addSleepLog error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/sleep/:id - X\u00F3a sleep log\r\n */\r\nexport async function deleteSleepLog(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM sleep_logs WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteSleepLog error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * PUT /api/data/sleep/:id - C\u1EADp nh\u1EADt sleep log\r\n */\r\nexport async function updateSleepLog(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { sleep_time, wake_time, quality, notes, duration_minutes } = await request.json();\r\n\r\n        // Verify ownership\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM sleep_logs WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).first();\r\n\r\n        if (!existing) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        const qualityValue = quality ? Math.min(5, Math.max(1, parseInt(quality))) : null;\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'UPDATE sleep_logs SET sleep_time = ?, wake_time = ?, duration_minutes = ?, quality = ?, notes = ? WHERE id = ? AND user_id = ? RETURNING *'\r\n        ).bind(sleep_time, wake_time, duration_minutes || null, qualityValue, notes || null, parseInt(id), userId).first();\r\n\r\n        return json({ success: true, item: result });\r\n    } catch (error) {\r\n        console.error('[Data] updateSleepLog error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// ACHIEVEMENTS ENDPOINTS\r\n// =============================================================================\r\n\r\n\r\n/**\r\n * GET /api/data/achievements - L\u1EA5y danh s\u00E1ch achievements \u0111\u00E3 m\u1EDF kh\u00F3a\r\n */\r\nexport async function getAchievements(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, achievement_id, unlocked_at FROM achievements WHERE user_id = ? ORDER BY unlocked_at DESC'\r\n        ).bind(userId).all();\r\n\r\n        return json({ items: result.results, count: result.results.length });\r\n    } catch (error) {\r\n        console.error('[Data] getAchievements error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/achievements - M\u1EDF kh\u00F3a achievement\r\n * Body: { achievement_id: string }\r\n */\r\nexport async function unlockAchievement(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { achievement_id } = await request.json();\r\n\r\n        if (!achievement_id || typeof achievement_id !== 'string') {\r\n            return json({ error: 'achievement_id b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        // Check if already unlocked\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM achievements WHERE user_id = ? AND achievement_id = ?'\r\n        ).bind(userId, achievement_id).first();\r\n\r\n        if (existing) {\r\n            return json({ success: true, alreadyUnlocked: true });\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO achievements (user_id, achievement_id) VALUES (?, ?) RETURNING id, achievement_id, unlocked_at'\r\n        ).bind(userId, achievement_id).first();\r\n\r\n        return json({ success: true, item: result, newUnlock: true }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] unlockAchievement error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// STATS ENDPOINT\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/stats - L\u1EA5y th\u1ED1ng k\u00EA t\u1ED5ng h\u1EE3p\r\n */\r\nexport async function getStats(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        // Gratitude count\r\n        const gratitudeCount = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count FROM gratitude WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Journal count v\u00E0 mood distribution\r\n        const journalCount = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count FROM journal WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        const moodDist = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT mood, COUNT(*) as count FROM journal WHERE user_id = ? AND mood IS NOT NULL GROUP BY mood'\r\n        ).bind(userId).all();\r\n\r\n        // Focus sessions count v\u00E0 total minutes\r\n        const focusStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count, COALESCE(SUM(duration_minutes), 0) as total_minutes FROM focus_sessions WHERE user_id = ? AND completed = 1'\r\n        ).bind(userId).first();\r\n\r\n        // Breathing sessions count v\u00E0 total seconds\r\n        const breathingStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count, COALESCE(SUM(duration_seconds), 0) as total_seconds FROM breathing_sessions WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Sleep statistics\r\n        const sleepStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count, COALESCE(AVG(duration_minutes), 0) as avg_duration, COALESCE(AVG(quality), 0) as avg_quality FROM sleep_logs WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Achievements count\r\n        const achievementsCount = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count FROM achievements WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Gratitude streak (ng\u00E0y li\u00EAn ti\u1EBFp c\u00F3 entry)\r\n        const streakResult = await env.ban_dong_hanh_db.prepare(`\r\n      SELECT DATE(created_at) as date FROM gratitude \r\n      WHERE user_id = ? \r\n      GROUP BY DATE(created_at) \r\n      ORDER BY date DESC\r\n    `).bind(userId).all();\r\n\r\n        let streak = 0;\r\n        if (streakResult.results.length > 0) {\r\n            const today = new Date().toISOString().split('T')[0];\r\n            const dates = streakResult.results.map(r => r.date);\r\n\r\n            // Check if today or yesterday has entry\r\n            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];\r\n            if (dates[0] === today || dates[0] === yesterday) {\r\n                streak = 1;\r\n                for (let i = 1; i < dates.length; i++) {\r\n                    const prevDate = new Date(dates[i - 1]);\r\n                    const currDate = new Date(dates[i]);\r\n                    const diffDays = (prevDate - currDate) / 86400000;\r\n                    if (diffDays === 1) {\r\n                        streak++;\r\n                    } else {\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Build mood distribution object\r\n        const moodDistribution = {};\r\n        if (moodDist.results) {\r\n            moodDist.results.forEach(m => { moodDistribution[m.mood] = m.count; });\r\n        }\r\n\r\n        return json({\r\n            gratitude: { count: gratitudeCount.count, streak },\r\n            journal: { count: journalCount.count, moodDistribution },\r\n            focus: { sessions: focusStats.count, totalMinutes: focusStats.total_minutes },\r\n            breathing: { sessions: breathingStats.count, totalSeconds: breathingStats.total_seconds },\r\n            sleep: {\r\n                logs: sleepStats.count,\r\n                avgMinutes: Math.round(sleepStats.avg_duration || 0),\r\n                avgQuality: parseFloat((sleepStats.avg_quality || 0).toFixed(1))\r\n            },\r\n            achievements: { count: achievementsCount.count }\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getStats error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// EXPORT/IMPORT ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/export - Xu\u1EA5t to\u00E0n b\u1ED9 d\u1EEF li\u1EC7u user\r\n */\r\nexport async function exportData(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const user = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT username, created_at FROM users WHERE id = ?'\r\n        ).bind(userId).first();\r\n\r\n        const gratitude = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT content, created_at FROM gratitude WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const journal = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT content, mood, tags, created_at FROM journal WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const focus = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT duration_minutes, session_type, completed, created_at FROM focus_sessions WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const breathing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT exercise_type, duration_seconds, created_at FROM breathing_sessions WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const sleepLogs = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT sleep_time, wake_time, duration_minutes, quality, notes, created_at FROM sleep_logs WHERE user_id = ? ORDER BY created_at'\r\n        ).bind(userId).all();\r\n\r\n        const achievements = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT achievement_id, unlocked_at FROM achievements WHERE user_id = ?'\r\n        ).bind(userId).all();\r\n\r\n        const settings = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT theme, notifications, sound, font_size FROM user_settings WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        return json({\r\n            exportedAt: new Date().toISOString(),\r\n            version: '1.1',\r\n            user: { username: user.username, created_at: user.created_at },\r\n            data: {\r\n                gratitude: gratitude.results,\r\n                journal: journal.results,\r\n                focus_sessions: focus.results,\r\n                breathing_sessions: breathing.results,\r\n                sleep_logs: sleepLogs.results,\r\n                achievements: achievements.results,\r\n                settings: settings || {}\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] exportData error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/import - Nh\u1EADp d\u1EEF li\u1EC7u t\u1EEB JSON\r\n * Body: { data: { gratitude: [], journal: [], ... } }\r\n */\r\nexport async function importData(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { data } = await request.json();\r\n        console.log('[Import] User', userId, 'importing data:', {\r\n            gratitude: data?.gratitude?.length || 0,\r\n            journal: data?.journal?.length || 0,\r\n            focus: data?.focus_sessions?.length || 0,\r\n            breathing: data?.breathing_sessions?.length || 0,\r\n            sleep: data?.sleep_logs?.length || 0,\r\n        });\r\n\r\n        if (!data || typeof data !== 'object') {\r\n            return json({ error: 'invalid_data_format' }, 400);\r\n        }\r\n\r\n        let imported = { gratitude: 0, journal: 0, focus: 0, breathing: 0 };\r\n\r\n        // Import gratitude\r\n        if (Array.isArray(data.gratitude)) {\r\n            for (const item of data.gratitude.slice(0, 1000)) {\r\n                if (item.content) {\r\n                    const createdAt = item.created_at || new Date().toISOString();\r\n                    // Ki\u1EC3m tra duplicate d\u1EF1a tr\u00EAn content v\u00E0 created_at (trong c\u00F9ng ng\u00E0y)\r\n                    const existing = await env.ban_dong_hanh_db.prepare(\r\n                        `SELECT id FROM gratitude \r\n                         WHERE user_id = ? AND content = ? \r\n                         AND date(created_at) = date(?)`\r\n                    ).bind(userId, item.content, createdAt).first();\r\n\r\n                    if (!existing) {\r\n                        await env.ban_dong_hanh_db.prepare(\r\n                            'INSERT INTO gratitude (user_id, content, created_at) VALUES (?, ?, ?)'\r\n                        ).bind(userId, item.content, createdAt).run();\r\n                        imported.gratitude++;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import journal\r\n        if (Array.isArray(data.journal)) {\r\n            for (const item of data.journal.slice(0, 500)) {\r\n                if (item.content) {\r\n                    const createdAt = item.created_at || new Date().toISOString();\r\n                    // Ki\u1EC3m tra duplicate d\u1EF1a tr\u00EAn content v\u00E0 created_at (trong c\u00F9ng ng\u00E0y)\r\n                    const dateOnly = createdAt.split('T')[0];\r\n                    const existing = await env.ban_dong_hanh_db.prepare(\r\n                        `SELECT id FROM journal \r\n                         WHERE user_id = ? AND content = ? \r\n                         AND date(created_at) = date(?)`\r\n                    ).bind(userId, item.content, createdAt).first();\r\n\r\n                    if (!existing) {\r\n                        await env.ban_dong_hanh_db.prepare(\r\n                            'INSERT INTO journal (user_id, content, mood, tags, created_at) VALUES (?, ?, ?, ?, ?)'\r\n                        ).bind(userId, item.content, item.mood || null, item.tags || null, createdAt).run();\r\n                        imported.journal++;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import focus sessions\r\n        if (Array.isArray(data.focus_sessions)) {\r\n            for (const item of data.focus_sessions.slice(0, 1000)) {\r\n                if (item.duration_minutes) {\r\n                    await env.ban_dong_hanh_db.prepare(\r\n                        'INSERT INTO focus_sessions (user_id, duration_minutes, session_type, completed, created_at) VALUES (?, ?, ?, ?, ?)'\r\n                    ).bind(userId, item.duration_minutes, item.session_type || 'focus', item.completed ?? 1, item.created_at || new Date().toISOString()).run();\r\n                    imported.focus++;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import breathing sessions\r\n        if (Array.isArray(data.breathing_sessions)) {\r\n            for (const item of data.breathing_sessions.slice(0, 1000)) {\r\n                if (item.exercise_type && item.duration_seconds) {\r\n                    await env.ban_dong_hanh_db.prepare(\r\n                        'INSERT INTO breathing_sessions (user_id, exercise_type, duration_seconds, created_at) VALUES (?, ?, ?, ?)'\r\n                    ).bind(userId, item.exercise_type, item.duration_seconds, item.created_at || new Date().toISOString()).run();\r\n                    imported.breathing++;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Import sleep logs\r\n        if (Array.isArray(data.sleep_logs)) {\r\n            for (const item of data.sleep_logs.slice(0, 500)) {\r\n                if (item.sleep_time && item.wake_time) {\r\n                    await env.ban_dong_hanh_db.prepare(\r\n                        'INSERT INTO sleep_logs (user_id, sleep_time, wake_time, duration_minutes, quality, notes, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)'\r\n                    ).bind(\r\n                        userId,\r\n                        item.sleep_time,\r\n                        item.wake_time,\r\n                        item.duration_minutes || null,\r\n                        item.quality || null,\r\n                        item.notes || null,\r\n                        item.created_at || new Date().toISOString()\r\n                    ).run();\r\n                    imported.sleep = (imported.sleep || 0) + 1;\r\n                }\r\n            }\r\n        }\r\n\r\n        console.log('[Import] Successfully imported for user', userId, ':', imported);\r\n        return json({ success: true, imported });\r\n    } catch (error) {\r\n        console.error('[Data] importData error:', error.message);\r\n        return json({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// GAME SCORES ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/game-scores - L\u1EA5y \u0111i\u1EC3m s\u1ED1 game\r\n * Query params: ?game_type=space_control&limit=10&leaderboard=true\r\n */\r\nexport async function getGameScores(request, env) {\r\n    const userId = getUserId(request);\r\n    const url = new URL(request.url);\r\n    const gameType = url.searchParams.get('game_type');\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '10'), 50);\r\n    const leaderboard = url.searchParams.get('leaderboard') === 'true';\r\n\r\n    try {\r\n        if (leaderboard) {\r\n            // Leaderboard to\u00E0n b\u1ED9 users (\u1EA9n danh)\r\n            const result = await env.ban_dong_hanh_db.prepare(`\r\n                SELECT gs.score, gs.level_reached, gs.created_at, \r\n                       'Player_' || SUBSTR(CAST(gs.user_id AS TEXT), 1, 3) as player_name\r\n                FROM game_scores gs\r\n                ${gameType ? 'WHERE gs.game_type = ?' : ''}\r\n                ORDER BY gs.score DESC\r\n                LIMIT ?\r\n            `).bind(...(gameType ? [gameType, limit] : [limit])).all();\r\n\r\n            return json({ leaderboard: result.results });\r\n        }\r\n\r\n        // Personal scores - c\u1EA7n \u0111\u0103ng nh\u1EADp\r\n        if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n        const query = gameType\r\n            ? 'SELECT id, game_type, score, level_reached, play_duration_seconds, created_at FROM game_scores WHERE user_id = ? AND game_type = ? ORDER BY score DESC LIMIT ?'\r\n            : 'SELECT id, game_type, score, level_reached, play_duration_seconds, created_at FROM game_scores WHERE user_id = ? ORDER BY created_at DESC LIMIT ?';\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(query)\r\n            .bind(...(gameType ? [userId, gameType, limit] : [userId, limit])).all();\r\n\r\n        // L\u1EA5y high score cho m\u1ED7i game\r\n        const highScores = await env.ban_dong_hanh_db.prepare(`\r\n            SELECT game_type, MAX(score) as high_score \r\n            FROM game_scores \r\n            WHERE user_id = ? \r\n            GROUP BY game_type\r\n        `).bind(userId).all();\r\n\r\n        return json({\r\n            items: result.results,\r\n            highScores: Object.fromEntries(highScores.results.map(h => [h.game_type, h.high_score]))\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getGameScores error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/game-scores - L\u01B0u \u0111i\u1EC3m game m\u1EDBi\r\n * Body: { game_type: string, score: number, level_reached?: number, play_duration_seconds?: number }\r\n */\r\nexport async function addGameScore(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { game_type, score, level_reached = 1, play_duration_seconds } = await request.json();\r\n\r\n        if (!game_type || typeof game_type !== 'string') {\r\n            return json({ error: 'game_type b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        if (typeof score !== 'number' || score < 0) {\r\n            return json({ error: 'score ph\u1EA3i l\u00E0 s\u1ED1 kh\u00F4ng \u00E2m' }, 400);\r\n        }\r\n\r\n        const validGames = ['space_control', 'space_pilot', 'bee_game', 'bubble_pop', 'color_match', 'doodle', 'reflex'];\r\n        if (!validGames.includes(game_type)) {\r\n            return json({ error: 'game_type kh\u00F4ng h\u1EE3p l\u1EC7' }, 400);\r\n        }\r\n\r\n        // L\u1EA5y high score hi\u1EC7n t\u1EA1i\r\n        const currentHigh = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT MAX(score) as high FROM game_scores WHERE user_id = ? AND game_type = ?'\r\n        ).bind(userId, game_type).first();\r\n\r\n        const isNewRecord = score > (currentHigh?.high || 0);\r\n\r\n        // L\u01B0u score m\u1EDBi\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO game_scores (user_id, game_type, score, level_reached, play_duration_seconds) VALUES (?, ?, ?, ?, ?) RETURNING *'\r\n        ).bind(userId, game_type, score, level_reached, play_duration_seconds || null).first();\r\n\r\n        // C\u1EADp nh\u1EADt user_stats n\u1EBFu l\u00E0 record m\u1EDBi\r\n        if (isNewRecord) {\r\n            await env.ban_dong_hanh_db.prepare(`\r\n                INSERT INTO user_stats (user_id, games_played, highest_game_score)\r\n                VALUES (?, 1, ?)\r\n                ON CONFLICT(user_id) DO UPDATE SET\r\n                    games_played = games_played + 1,\r\n                    highest_game_score = MAX(highest_game_score, ?),\r\n                    updated_at = datetime('now')\r\n            `).bind(userId, score, score).run();\r\n        }\r\n\r\n        return json({\r\n            success: true,\r\n            item: result,\r\n            isNewRecord,\r\n            previousHigh: currentHigh?.high || 0\r\n        }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addGameScore error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// NOTIFICATION SETTINGS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/notification-settings - L\u1EA5y c\u00E0i \u0111\u1EB7t th\u00F4ng b\u00E1o\r\n */\r\nexport async function getNotificationSettings(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const settings = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT daily_reminder, pomodoro_alerts, sleep_reminder, reminder_time, push_subscription FROM notification_settings WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        // Tr\u1EA3 v\u1EC1 default settings n\u1EBFu ch\u01B0a c\u00F3\r\n        return json({\r\n            settings: settings || {\r\n                daily_reminder: false,\r\n                pomodoro_alerts: true,\r\n                sleep_reminder: false,\r\n                reminder_time: null,\r\n                push_subscription: null\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getNotificationSettings error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/notification-settings - L\u01B0u c\u00E0i \u0111\u1EB7t th\u00F4ng b\u00E1o\r\n * Body: { daily_reminder?: boolean, pomodoro_alerts?: boolean, sleep_reminder?: boolean, reminder_time?: string, push_subscription?: object }\r\n */\r\nexport async function saveNotificationSettings(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { daily_reminder, pomodoro_alerts, sleep_reminder, reminder_time, push_subscription } = await request.json();\r\n\r\n        // Validate reminder_time format n\u1EBFu c\u00F3\r\n        if (reminder_time && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(reminder_time)) {\r\n            return json({ error: 'reminder_time ph\u1EA3i c\u00F3 \u0111\u1ECBnh d\u1EA1ng HH:MM' }, 400);\r\n        }\r\n\r\n        // Stringify push_subscription n\u1EBFu l\u00E0 object\r\n        const subscriptionValue = push_subscription ? JSON.stringify(push_subscription) : null;\r\n\r\n        await env.ban_dong_hanh_db.prepare(`\r\n            INSERT INTO notification_settings (user_id, daily_reminder, pomodoro_alerts, sleep_reminder, reminder_time, push_subscription)\r\n            VALUES (?, ?, ?, ?, ?, ?)\r\n            ON CONFLICT(user_id) DO UPDATE SET\r\n                daily_reminder = COALESCE(?, daily_reminder),\r\n                pomodoro_alerts = COALESCE(?, pomodoro_alerts),\r\n                sleep_reminder = COALESCE(?, sleep_reminder),\r\n                reminder_time = COALESCE(?, reminder_time),\r\n                push_subscription = COALESCE(?, push_subscription),\r\n                updated_at = datetime('now')\r\n        `).bind(\r\n            userId,\r\n            daily_reminder ? 1 : 0,\r\n            pomodoro_alerts !== false ? 1 : 0,\r\n            sleep_reminder ? 1 : 0,\r\n            reminder_time || null,\r\n            subscriptionValue,\r\n            daily_reminder !== undefined ? (daily_reminder ? 1 : 0) : null,\r\n            pomodoro_alerts !== undefined ? (pomodoro_alerts ? 1 : 0) : null,\r\n            sleep_reminder !== undefined ? (sleep_reminder ? 1 : 0) : null,\r\n            reminder_time || null,\r\n            subscriptionValue\r\n        ).run();\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] saveNotificationSettings error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// SOS LOGS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * POST /api/data/sos-log - Ghi log s\u1EF1 ki\u1EC7n SOS\r\n * Body: { event_type: string, risk_level?: string, trigger_text?: string, location?: {lat, lng}, metadata?: object }\r\n * Ch\u00FA th\u00EDch: endpoint n\u00E0y kh\u00F4ng y\u00EAu c\u1EA7u \u0111\u0103ng nh\u1EADp \u0111\u1EC3 h\u1ED7 tr\u1EE3 c\u1EA3 kh\u00E1ch\r\n */\r\nexport async function logSOSEvent(request, env) {\r\n    const userId = getUserId(request); // c\u00F3 th\u1EC3 null\r\n\r\n    try {\r\n        const { event_type, risk_level, trigger_text, location, metadata } = await request.json();\r\n\r\n        if (!event_type) {\r\n            return json({ error: 'event_type b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        const validEventTypes = ['overlay_opened', 'hotline_clicked', 'map_viewed', 'message_flagged', 'false_positive'];\r\n        if (!validEventTypes.includes(event_type)) {\r\n            return json({ error: 'event_type kh\u00F4ng h\u1EE3p l\u1EC7' }, 400);\r\n        }\r\n\r\n        // T\u1EA1o hashed_user_id \u1EA9n danh n\u1EBFu c\u00F3 userId\r\n        let hashedUserId = null;\r\n        if (userId) {\r\n            // Simple hash: ch\u1EC9 l\u1EA5y 8 k\u00FD t\u1EF1 \u0111\u1EA7u c\u1EE7a hash\r\n            const encoder = new TextEncoder();\r\n            const data = encoder.encode(userId.toString() + 'bdh_salt');\r\n            const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n            const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n            hashedUserId = hashArray.slice(0, 4).map(b => b.toString(16).padStart(2, '0')).join('');\r\n        }\r\n\r\n        await env.ban_dong_hanh_db.prepare(`\r\n            INSERT INTO sos_logs (user_id, hashed_user_id, event_type, risk_level, trigger_text, location_lat, location_lng, metadata)\r\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n        `).bind(\r\n            userId || null,\r\n            hashedUserId,\r\n            event_type,\r\n            risk_level || null,\r\n            trigger_text ? trigger_text.slice(0, 50) : null, // Ch\u1EC9 l\u01B0u 50 k\u00FD t\u1EF1 t\u1EEB kh\u00F3a\r\n            location?.lat || null,\r\n            location?.lng || null,\r\n            metadata ? JSON.stringify(metadata) : null\r\n        ).run();\r\n\r\n        // Log v\u1EDBi observability (structured logging)\r\n        // Note: Import observability n\u1EBFu c\u1EA7n, nh\u01B0ng tr\u00E1nh circular dependency\r\n        console.log(JSON.stringify({\r\n            type: 'sos_event',\r\n            event_type,\r\n            risk_level,\r\n            hashed_user_id: hashedUserId,\r\n            timestamp: new Date().toISOString(),\r\n        }));\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] logSOSEvent error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/admin/sos-logs - L\u1EA5y danh s\u00E1ch SOS logs (admin only)\r\n * Query params: ?limit=50&risk_level=red\r\n */\r\nexport async function getSOSLogs(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    // Ki\u1EC3m tra quy\u1EC1n admin\r\n    const user = await env.ban_dong_hanh_db.prepare(\r\n        'SELECT is_admin FROM users WHERE id = ?'\r\n    ).bind(userId).first();\r\n\r\n    if (!user?.is_admin) {\r\n        return json({ error: 'forbidden' }, 403);\r\n    }\r\n\r\n    try {\r\n        const url = new URL(request.url);\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 200);\r\n        const riskLevel = url.searchParams.get('risk_level');\r\n\r\n        const query = riskLevel\r\n            ? 'SELECT * FROM sos_logs WHERE risk_level = ? ORDER BY created_at DESC LIMIT ?'\r\n            : 'SELECT * FROM sos_logs ORDER BY created_at DESC LIMIT ?';\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(query)\r\n            .bind(...(riskLevel ? [riskLevel, limit] : [limit])).all();\r\n\r\n        // Th\u1ED1ng k\u00EA nhanh\r\n        const stats = await env.ban_dong_hanh_db.prepare(`\r\n            SELECT \r\n                risk_level,\r\n                COUNT(*) as count,\r\n                COUNT(DISTINCT hashed_user_id) as unique_users\r\n            FROM sos_logs\r\n            WHERE created_at > datetime('now', '-7 days')\r\n            GROUP BY risk_level\r\n        `).all();\r\n\r\n        return json({\r\n            logs: result.results,\r\n            stats: Object.fromEntries(stats.results.map(s => [s.risk_level || 'unknown', { count: s.count, unique_users: s.unique_users }]))\r\n        });\r\n    } catch (error) {\r\n        console.error('[Admin] getSOSLogs error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// RANDOM CARDS HISTORY ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/random-cards-history - L\u1EA5y l\u1ECBch s\u1EED th\u1EBB \u0111\u00E3 xem\r\n * Query params: ?limit=50\r\n */\r\nexport async function getRandomCardsHistory(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const url = new URL(request.url);\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT card_id, viewed_at, action_taken FROM random_cards_history WHERE user_id = ? ORDER BY viewed_at DESC LIMIT ?'\r\n        ).bind(userId, limit).all();\r\n\r\n        return json({ items: result.results });\r\n    } catch (error) {\r\n        console.error('[Data] getRandomCardsHistory error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/random-cards-history - Ghi l\u1EA1i th\u1EBB \u0111\u00E3 xem\r\n * Body: { card_id: string, action_taken?: boolean }\r\n */\r\nexport async function addRandomCardHistory(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { card_id, action_taken = false } = await request.json();\r\n\r\n        if (!card_id) {\r\n            return json({ error: 'card_id b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO random_cards_history (user_id, card_id, action_taken) VALUES (?, ?, ?)'\r\n        ).bind(userId, card_id, action_taken ? 1 : 0).run();\r\n\r\n        return json({ success: true }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addRandomCardHistory error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// USER STATS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/user-stats - L\u1EA5y th\u1ED1ng k\u00EA gamification c\u1EE7a user\r\n */\r\nexport async function getUserStats(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        let stats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT * FROM user_stats WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        if (!stats) {\r\n            // T\u1EA1o stats m\u1EDBi n\u1EBFu ch\u01B0a c\u00F3\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'INSERT INTO user_stats (user_id) VALUES (?)'\r\n            ).bind(userId).run();\r\n            stats = {\r\n                total_xp: 0,\r\n                current_level: 1,\r\n                breathing_total: 0,\r\n                gratitude_streak: 0,\r\n                max_gratitude_streak: 0,\r\n                journal_count: 0,\r\n                focus_total_minutes: 0,\r\n                games_played: 0,\r\n                highest_game_score: 0\r\n            };\r\n        }\r\n\r\n        // T\u00EDnh level t\u1EEB XP\r\n        const xpPerLevel = 100;\r\n        const level = Math.floor(stats.total_xp / xpPerLevel) + 1;\r\n        const xpForNextLevel = xpPerLevel - (stats.total_xp % xpPerLevel);\r\n\r\n        return json({\r\n            ...stats,\r\n            calculated_level: level,\r\n            xp_for_next_level: xpForNextLevel,\r\n            xp_progress_percent: Math.round(((stats.total_xp % xpPerLevel) / xpPerLevel) * 100)\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getUserStats error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/user-stats/add-xp - Th\u00EAm XP cho user\r\n * Body: { xp: number, source: string }\r\n */\r\nexport async function addUserXP(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { xp, source } = await request.json();\r\n\r\n        if (typeof xp !== 'number' || xp <= 0) {\r\n            return json({ error: 'xp ph\u1EA3i l\u00E0 s\u1ED1 d\u01B0\u01A1ng' }, 400);\r\n        }\r\n\r\n        // Gi\u1EDBi h\u1EA1n XP c\u1ED9ng m\u1ED7i l\u1EA7n \u0111\u1EC3 tr\u00E1nh abuse\r\n        const cappedXP = Math.min(xp, 100);\r\n\r\n        // L\u1EA5y stats hi\u1EC7n t\u1EA1i\r\n        const currentStats = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT total_xp, current_level FROM user_stats WHERE user_id = ?'\r\n        ).bind(userId).first();\r\n\r\n        const oldLevel = currentStats?.current_level || 1;\r\n        const oldXP = currentStats?.total_xp || 0;\r\n        const newXP = oldXP + cappedXP;\r\n        const xpPerLevel = 100;\r\n        const newLevel = Math.floor(newXP / xpPerLevel) + 1;\r\n\r\n        // C\u1EADp nh\u1EADt stats\r\n        await env.ban_dong_hanh_db.prepare(`\r\n            INSERT INTO user_stats (user_id, total_xp, current_level)\r\n            VALUES (?, ?, ?)\r\n            ON CONFLICT(user_id) DO UPDATE SET\r\n                total_xp = total_xp + ?,\r\n                current_level = ?,\r\n                updated_at = datetime('now')\r\n        `).bind(userId, newXP, newLevel, cappedXP, newLevel).run();\r\n\r\n        const leveledUp = newLevel > oldLevel;\r\n\r\n        console.log('[XP] Added:', { userId, xp: cappedXP, source, newLevel, leveledUp });\r\n\r\n        return json({\r\n            success: true,\r\n            xp_added: cappedXP,\r\n            total_xp: newXP,\r\n            level: newLevel,\r\n            leveled_up: leveledUp,\r\n            old_level: oldLevel\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] addUserXP error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// CHAT FEEDBACK & METRICS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * POST /api/data/chat/feedback - Submit feedback v\u1EC1 AI response\r\n * Body: { message_id: string, helpful: 0|1, reason?: string, response_quality?: 1-5 }\r\n */\r\nexport async function submitChatFeedback(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { message_id, helpful, reason, response_quality } = await request.json();\r\n\r\n        if (!message_id || typeof message_id !== 'string') {\r\n            return json({ error: 'message_id is required' }, 400);\r\n        }\r\n\r\n        if (helpful !== 0 && helpful !== 1) {\r\n            return json({ error: 'helpful must be 0 or 1' }, 400);\r\n        }\r\n\r\n        if (response_quality && (response_quality < 1 || response_quality > 5)) {\r\n            return json({ error: 'response_quality must be 1-5' }, 400);\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            `INSERT INTO chat_feedback \r\n             (user_id, message_id, helpful, reason, response_quality)\r\n             VALUES (?, ?, ?, ?, ?)\r\n             RETURNING id, message_id, helpful, reason, response_quality, created_at`\r\n        ).bind(\r\n            userId,\r\n            message_id,\r\n            helpful,\r\n            reason || null,\r\n            response_quality || null\r\n        ).first();\r\n\r\n        return json({ success: true, feedback: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] submitChatFeedback error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/data/chat/metrics - L\u1EA5y metrics v\u1EC1 chat quality (admin only ho\u1EB7c user's own)\r\n * Query params: ?days=7&user_id=123 (optional, admin only)\r\n */\r\nexport async function getChatMetrics(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const days = parseInt(url.searchParams.get('days') || '7');\r\n    const targetUserId = url.searchParams.get('user_id'); // Admin only\r\n\r\n    // TODO: Check admin permission if targetUserId is provided\r\n    const queryUserId = targetUserId ? parseInt(targetUserId) : userId;\r\n\r\n    try {\r\n        const sinceDate = new Date();\r\n        sinceDate.setDate(sinceDate.getDate() - days);\r\n        const sinceDateStr = sinceDate.toISOString();\r\n\r\n        // Get feedback stats\r\n        const feedbackStats = await env.ban_dong_hanh_db.prepare(\r\n            `SELECT \r\n                COUNT(*) as total_feedback,\r\n                SUM(CASE WHEN helpful = 1 THEN 1 ELSE 0 END) as helpful_count,\r\n                AVG(response_quality) as avg_quality\r\n             FROM chat_feedback\r\n             WHERE user_id = ? AND created_at >= ?`\r\n        ).bind(queryUserId, sinceDateStr).first();\r\n\r\n        // Get response stats\r\n        const responseStats = await env.ban_dong_hanh_db.prepare(\r\n            `SELECT \r\n                COUNT(*) as total_responses,\r\n                AVG(confidence) as avg_confidence,\r\n                AVG(latency_ms) as avg_latency,\r\n                SUM(CASE WHEN used_rag = 1 THEN 1 ELSE 0 END) as rag_used_count,\r\n                SUM(CASE WHEN risk_level = 'red' THEN 1 ELSE 0 END) as sos_count,\r\n                SUM(CASE WHEN risk_level = 'yellow' THEN 1 ELSE 0 END) as yellow_count,\r\n                AVG(tokens_used) as avg_tokens\r\n             FROM chat_responses\r\n             WHERE user_id = ? AND created_at >= ?`\r\n        ).bind(queryUserId, sinceDateStr).first();\r\n\r\n        // Calculate helpful rate\r\n        const totalFeedback = feedbackStats?.total_feedback || 0;\r\n        const helpfulCount = feedbackStats?.helpful_count || 0;\r\n        const helpfulRate = totalFeedback > 0 ? (helpfulCount / totalFeedback) : null;\r\n\r\n        // Calculate RAG usage rate\r\n        const totalResponses = responseStats?.total_responses || 0;\r\n        const ragUsedCount = responseStats?.rag_used_count || 0;\r\n        const ragUsageRate = totalResponses > 0 ? (ragUsedCount / totalResponses) : null;\r\n\r\n        return json({\r\n            period_days: days,\r\n            user_id: queryUserId,\r\n            feedback: {\r\n                total: totalFeedback,\r\n                helpful_count: helpfulCount,\r\n                helpful_rate: helpfulRate,\r\n                avg_quality: feedbackStats?.avg_quality || null,\r\n            },\r\n            responses: {\r\n                total: totalResponses,\r\n                avg_confidence: responseStats?.avg_confidence || null,\r\n                avg_latency_ms: responseStats?.avg_latency || null,\r\n                avg_tokens: responseStats?.avg_tokens || null,\r\n                rag_usage_rate: ragUsageRate,\r\n                sos_count: responseStats?.sos_count || 0,\r\n                yellow_count: responseStats?.yellow_count || 0,\r\n            },\r\n        });\r\n    } catch (error) {\r\n        console.error('[Data] getChatMetrics error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// BOOKMARKS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/bookmarks - L\u1EA5y danh s\u00E1ch bookmarks\r\n * Query params: ?type=story (optional filter)\r\n */\r\nexport async function getBookmarks(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ items: [] }); // Guest: return empty\r\n\r\n    const url = new URL(request.url);\r\n    const bookmarkType = url.searchParams.get('type');\r\n\r\n    try {\r\n        let query = 'SELECT id, bookmark_type, item_id, metadata, created_at FROM user_bookmarks WHERE user_id = ?';\r\n        const params = [userId];\r\n\r\n        if (bookmarkType) {\r\n            query += ' AND bookmark_type = ?';\r\n            params.push(bookmarkType);\r\n        }\r\n\r\n        query += ' ORDER BY created_at DESC';\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(query).bind(...params).all();\r\n        return json({ items: result.results || [], count: result.results?.length || 0 });\r\n    } catch (error) {\r\n        console.error('[Data] getBookmarks error:', error.message);\r\n        return json({ items: [], error: 'server_error' });\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/bookmarks - Th\u00EAm bookmark\r\n * Body: { bookmark_type: 'story'|'resource', item_id: string, metadata?: object }\r\n */\r\nexport async function addBookmark(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { bookmark_type, item_id, metadata } = await request.json();\r\n\r\n        if (!bookmark_type || !item_id) {\r\n            return json({ error: 'bookmark_type v\u00E0 item_id b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        const validTypes = ['story', 'resource'];\r\n        if (!validTypes.includes(bookmark_type)) {\r\n            return json({ error: 'bookmark_type kh\u00F4ng h\u1EE3p l\u1EC7' }, 400);\r\n        }\r\n\r\n        // Upsert - n\u1EBFu \u0111\u00E3 t\u1ED3n t\u1EA1i th\u00EC c\u1EADp nh\u1EADt metadata\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM user_bookmarks WHERE user_id = ? AND bookmark_type = ? AND item_id = ?'\r\n        ).bind(userId, bookmark_type, item_id).first();\r\n\r\n        if (existing) {\r\n            // Update metadata n\u1EBFu \u0111\u00E3 c\u00F3\r\n            if (metadata) {\r\n                await env.ban_dong_hanh_db.prepare(\r\n                    'UPDATE user_bookmarks SET metadata = ? WHERE id = ?'\r\n                ).bind(JSON.stringify(metadata), existing.id).run();\r\n            }\r\n            return json({ success: true, alreadyExists: true, id: existing.id });\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO user_bookmarks (user_id, bookmark_type, item_id, metadata) VALUES (?, ?, ?, ?) RETURNING id, bookmark_type, item_id, created_at'\r\n        ).bind(userId, bookmark_type, item_id, metadata ? JSON.stringify(metadata) : null).first();\r\n\r\n        return json({ success: true, item: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Data] addBookmark error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/bookmarks/:id - X\u00F3a bookmark b\u1EB1ng ID\r\n */\r\nexport async function deleteBookmarkById(request, env, id) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM user_bookmarks WHERE id = ? AND user_id = ?'\r\n        ).bind(parseInt(id), userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteBookmarkById error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/bookmarks - X\u00F3a bookmark theo type v\u00E0 item_id\r\n * Query params: ?type=story&item_id=abc123\r\n */\r\nexport async function deleteBookmark(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    const url = new URL(request.url);\r\n    const bookmarkType = url.searchParams.get('type');\r\n    const itemId = url.searchParams.get('item_id');\r\n\r\n    if (!bookmarkType || !itemId) {\r\n        return json({ error: 'type v\u00E0 item_id b\u1EAFt bu\u1ED9c' }, 400);\r\n    }\r\n\r\n    try {\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM user_bookmarks WHERE user_id = ? AND bookmark_type = ? AND item_id = ?'\r\n        ).bind(userId, bookmarkType, itemId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteBookmark error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// CHAT THREADS SYNC ENDPOINTS\r\n// Ch\u00FA th\u00EDch: Sync l\u1ECBch s\u1EED chat AI \u0111\u1EC3 ng\u01B0\u1EDDi d\u00F9ng xem l\u1EA1i tr\u00EAn c\u00E1c thi\u1EBFt b\u1ECB\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/data/chat/threads - L\u1EA5y danh s\u00E1ch chat threads c\u1EE7a user\r\n * Query params: ?limit=50\r\n */\r\nexport async function getChatThreads(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const url = new URL(request.url);\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n\r\n        // L\u1EA5y danh s\u00E1ch threads\r\n        const threads = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, title, created_at, updated_at FROM chat_threads WHERE user_id = ? ORDER BY updated_at DESC LIMIT ?'\r\n        ).bind(userId, limit).all();\r\n\r\n        // L\u1EA5y messages cho m\u1ED7i thread\r\n        const threadsWithMessages = [];\r\n        for (const thread of threads.results || []) {\r\n            const messages = await env.ban_dong_hanh_db.prepare(\r\n                'SELECT role, content, timestamp as ts, feedback, trace_id FROM chat_messages WHERE thread_id = ? AND user_id = ? ORDER BY timestamp ASC'\r\n            ).bind(thread.id, userId).all();\r\n\r\n            threadsWithMessages.push({\r\n                id: thread.id,\r\n                title: thread.title,\r\n                createdAt: thread.created_at,\r\n                updatedAt: thread.updated_at,\r\n                messages: messages.results || []\r\n            });\r\n        }\r\n\r\n        return json({ threads: threadsWithMessages });\r\n    } catch (error) {\r\n        console.error('[Data] getChatThreads error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/chat/threads - T\u1EA1o ho\u1EB7c c\u1EADp nh\u1EADt thread\r\n * Body: { id: string, title: string }\r\n */\r\nexport async function saveChatThread(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { id, title } = await request.json();\r\n\r\n        if (!id || typeof id !== 'string') {\r\n            return json({ error: 'id b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        // Upsert thread\r\n        await env.ban_dong_hanh_db.prepare(`\r\n            INSERT INTO chat_threads (id, user_id, title, updated_at)\r\n            VALUES (?, ?, ?, datetime('now'))\r\n            ON CONFLICT(id) DO UPDATE SET\r\n                title = ?,\r\n                updated_at = datetime('now')\r\n        `).bind(id, userId, title || 'Cu\u1ED9c tr\u00F2 chuy\u1EC7n m\u1EDBi', title || 'Cu\u1ED9c tr\u00F2 chuy\u1EC7n m\u1EDBi').run();\r\n\r\n        return json({ success: true, thread_id: id });\r\n    } catch (error) {\r\n        console.error('[Data] saveChatThread error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/chat/messages - L\u01B0u tin nh\u1EAFn v\u00E0o thread\r\n * Body: { thread_id: string, messages: [{role, content, ts, feedback?, trace_id?}] }\r\n */\r\nexport async function saveChatMessages(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { thread_id, messages } = await request.json();\r\n\r\n        if (!thread_id || !Array.isArray(messages)) {\r\n            return json({ error: 'thread_id v\u00E0 messages b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        // \u0110\u1EA3m b\u1EA3o thread t\u1ED3n t\u1EA1i\r\n        const thread = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM chat_threads WHERE id = ? AND user_id = ?'\r\n        ).bind(thread_id, userId).first();\r\n\r\n        if (!thread) {\r\n            // T\u1EF1 \u0111\u1ED9ng t\u1EA1o thread n\u1EBFu ch\u01B0a c\u00F3\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'INSERT INTO chat_threads (id, user_id, title) VALUES (?, ?, ?)'\r\n            ).bind(thread_id, userId, 'Cu\u1ED9c tr\u00F2 chuy\u1EC7n m\u1EDBi').run();\r\n        }\r\n\r\n        // X\u00F3a messages c\u0169 v\u00E0 insert m\u1EDBi (full sync)\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM chat_messages WHERE thread_id = ? AND user_id = ?'\r\n        ).bind(thread_id, userId).run();\r\n\r\n        // Insert messages m\u1EDBi (batch insert)\r\n        let inserted = 0;\r\n        for (const msg of messages.slice(0, 500)) { // Gi\u1EDBi h\u1EA1n 500 tin nh\u1EAFn\r\n            if (msg.role && msg.content) {\r\n                await env.ban_dong_hanh_db.prepare(\r\n                    'INSERT INTO chat_messages (thread_id, user_id, role, content, timestamp, feedback, trace_id) VALUES (?, ?, ?, ?, ?, ?, ?)'\r\n                ).bind(\r\n                    thread_id,\r\n                    userId,\r\n                    msg.role,\r\n                    msg.content,\r\n                    msg.ts || new Date().toISOString(),\r\n                    msg.feedback || null,\r\n                    msg.trace_id || msg.traceId || null\r\n                ).run();\r\n                inserted++;\r\n            }\r\n        }\r\n\r\n        // C\u1EADp nh\u1EADt updated_at c\u1EE7a thread\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'UPDATE chat_threads SET updated_at = datetime(\\'now\\') WHERE id = ?'\r\n        ).bind(thread_id).run();\r\n\r\n        return json({ success: true, inserted });\r\n    } catch (error) {\r\n        console.error('[Data] saveChatMessages error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/data/chat/threads/:id - X\u00F3a thread v\u00E0 messages\r\n */\r\nexport async function deleteChatThread(request, env, threadId) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        // X\u00F3a messages tr\u01B0\u1EDBc (do foreign key)\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM chat_messages WHERE thread_id = ? AND user_id = ?'\r\n        ).bind(threadId, userId).run();\r\n\r\n        // X\u00F3a thread\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM chat_threads WHERE id = ? AND user_id = ?'\r\n        ).bind(threadId, userId).run();\r\n\r\n        if (result.changes === 0) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Data] deleteChatThread error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/data/chat/sync - Sync to\u00E0n b\u1ED9 threads t\u1EEB client\r\n * Body: { threads: [{id, title, createdAt, updatedAt, messages: [{role, content, ts, feedback}]}] }\r\n */\r\nexport async function syncChatThreads(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        const { threads } = await request.json();\r\n\r\n        if (!Array.isArray(threads)) {\r\n            return json({ error: 'threads ph\u1EA3i l\u00E0 array' }, 400);\r\n        }\r\n\r\n        let synced = 0;\r\n        for (const thread of threads.slice(0, 50)) { // Gi\u1EDBi h\u1EA1n 50 threads\r\n            if (!thread.id) continue;\r\n\r\n            // Upsert thread\r\n            await env.ban_dong_hanh_db.prepare(`\r\n                INSERT INTO chat_threads (id, user_id, title, created_at, updated_at)\r\n                VALUES (?, ?, ?, ?, ?)\r\n                ON CONFLICT(id) DO UPDATE SET\r\n                    title = ?,\r\n                    updated_at = MAX(updated_at, ?)\r\n            `).bind(\r\n                thread.id,\r\n                userId,\r\n                thread.title || 'Cu\u1ED9c tr\u00F2 chuy\u1EC7n',\r\n                thread.createdAt || new Date().toISOString(),\r\n                thread.updatedAt || new Date().toISOString(),\r\n                thread.title || 'Cu\u1ED9c tr\u00F2 chuy\u1EC7n',\r\n                thread.updatedAt || new Date().toISOString()\r\n            ).run();\r\n\r\n            // Sync messages n\u1EBFu c\u00F3\r\n            if (Array.isArray(thread.messages) && thread.messages.length > 0) {\r\n                // X\u00F3a messages c\u0169\r\n                await env.ban_dong_hanh_db.prepare(\r\n                    'DELETE FROM chat_messages WHERE thread_id = ? AND user_id = ?'\r\n                ).bind(thread.id, userId).run();\r\n\r\n                // Insert messages m\u1EDBi\r\n                for (const msg of thread.messages.slice(0, 200)) {\r\n                    if (msg.role && msg.content) {\r\n                        await env.ban_dong_hanh_db.prepare(\r\n                            'INSERT INTO chat_messages (thread_id, user_id, role, content, timestamp, feedback, trace_id) VALUES (?, ?, ?, ?, ?, ?, ?)'\r\n                        ).bind(\r\n                            thread.id,\r\n                            userId,\r\n                            msg.role,\r\n                            msg.content,\r\n                            msg.ts || new Date().toISOString(),\r\n                            msg.feedback || null,\r\n                            msg.trace_id || msg.traceId || null\r\n                        ).run();\r\n                    }\r\n                }\r\n            }\r\n\r\n            synced++;\r\n        }\r\n\r\n        return json({ success: true, synced });\r\n    } catch (error) {\r\n        console.error('[Data] syncChatThreads error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n", "// backend/workers/forum-api.js\r\n// Ch\u00FA th\u00EDch: REST API cho di\u1EC5n \u0111\u00E0n \u1EA9n danh v\u1EDBi content moderation\r\n// T\u00EDch h\u1EE3p risk.js v\u00E0 sanitize.js \u0111\u1EC3 l\u1ECDc n\u1ED9i dung kh\u00F4ng ph\u00F9 h\u1EE3p\r\n\r\nimport { classifyRiskRules } from './risk.js';\r\nimport { sanitizeInput, hasInjection } from './sanitize.js';\r\n\r\n// =============================================================================\r\n// HELPERS\r\n// =============================================================================\r\n\r\n/**\r\n * Extract userId t\u1EEB request headers\r\n */\r\nfunction getUserId(request) {\r\n    const userId = request.headers.get('X-User-Id');\r\n    if (!userId) return null;\r\n    const parsed = parseInt(userId);\r\n    return isNaN(parsed) ? null : parsed;\r\n}\r\n\r\n/**\r\n * T\u1EA1o JSON response\r\n */\r\nfunction json(data, status = 200) {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json' }\r\n    });\r\n}\r\n\r\n/**\r\n * T\u1EA1o hashed user ID cho hi\u1EC3n th\u1ECB (\u1EA9n danh nh\u01B0ng nh\u1EA5t qu\u00E1n)\r\n */\r\nfunction hashUserId(userId) {\r\n    if (!userId) return null;\r\n    // Simple hash cho display - ch\u1EC9 d\u00F9ng 6 k\u00FD t\u1EF1 \u0111\u1EA7u\r\n    const hash = userId.toString(36) + Date.now().toString(36).slice(-4);\r\n    return hash.slice(0, 8).toUpperCase();\r\n}\r\n\r\n/**\r\n * Ki\u1EC3m tra v\u00E0 validate n\u1ED9i dung\r\n * @throws Error n\u1EBFu n\u1ED9i dung kh\u00F4ng h\u1EE3p l\u1EC7\r\n */\r\nfunction validateContent(content, maxLength = 2000) {\r\n    if (!content || typeof content !== 'string') {\r\n        throw new Error('empty_content');\r\n    }\r\n\r\n    const trimmed = content.trim();\r\n    if (trimmed.length === 0) {\r\n        throw new Error('empty_content');\r\n    }\r\n\r\n    if (trimmed.length > maxLength) {\r\n        throw new Error('content_too_long');\r\n    }\r\n\r\n    // Ki\u1EC3m tra injection\r\n    if (hasInjection(trimmed)) {\r\n        throw new Error('content_blocked');\r\n    }\r\n\r\n    // Ki\u1EC3m tra risk level\r\n    const risk = classifyRiskRules(trimmed);\r\n    if (risk === 'red') {\r\n        throw new Error('content_sensitive');\r\n    }\r\n\r\n    return trimmed;\r\n}\r\n\r\n/**\r\n * Ki\u1EC3m tra user c\u00F3 b\u1ECB ban kh\u00F4ng\r\n */\r\nasync function isUserBanned(userId, env) {\r\n    if (!userId) return false;\r\n\r\n    const banned = await env.ban_dong_hanh_db.prepare(\r\n        'SELECT id, banned_until FROM banned_users WHERE user_id = ?'\r\n    ).bind(userId).first();\r\n\r\n    if (!banned) return false;\r\n\r\n    // Ki\u1EC3m tra th\u1EDDi h\u1EA1n ban\r\n    if (banned.banned_until) {\r\n        const banEnd = new Date(banned.banned_until);\r\n        if (banEnd < new Date()) {\r\n            // \u0110\u00E3 h\u1EBFt h\u1EA1n ban, x\u00F3a record\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'DELETE FROM banned_users WHERE user_id = ?'\r\n            ).bind(userId).run();\r\n            return false;\r\n        }\r\n    }\r\n\r\n    return true;\r\n}\r\n\r\n/**\r\n * Ki\u1EC3m tra user c\u00F3 ph\u1EA3i admin kh\u00F4ng\r\n */\r\nasync function isAdmin(userId, env) {\r\n    if (!userId) return false;\r\n    const user = await env.ban_dong_hanh_db.prepare(\r\n        'SELECT is_admin FROM users WHERE id = ?'\r\n    ).bind(userId).first();\r\n    return user?.is_admin === 1;\r\n}\r\n\r\n// =============================================================================\r\n// FORUM POSTS ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * GET /api/forum/posts - L\u1EA5y danh s\u00E1ch b\u00E0i vi\u1EBFt\r\n * Query params: ?page=1&limit=20&tag=h\u1ECDc_t\u1EADp\r\n */\r\nexport async function getForumPosts(request, env) {\r\n    const url = new URL(request.url);\r\n    const page = Math.max(1, parseInt(url.searchParams.get('page') || '1'));\r\n    const limit = Math.min(parseInt(url.searchParams.get('limit') || '20'), 50);\r\n    const offset = (page - 1) * limit;\r\n    const tag = url.searchParams.get('tag');\r\n\r\n    try {\r\n        let query = 'SELECT id, hashed_user_id, title, content, tags, upvotes, comments_count, created_at FROM forum_posts WHERE is_hidden = 0';\r\n        const params = [];\r\n\r\n        if (tag) {\r\n            query += \" AND tags LIKE ?\";\r\n            params.push(`%\"${tag}\"%`);\r\n        }\r\n\r\n        // Sort by\r\n        const sortBy = url.searchParams.get('sort') || 'newest';\r\n        if (sortBy === 'popular') {\r\n            query += ' ORDER BY upvotes DESC, created_at DESC';\r\n        } else if (sortBy === 'oldest') {\r\n            query += ' ORDER BY created_at ASC';\r\n        } else {\r\n            query += ' ORDER BY created_at DESC';\r\n        }\r\n        \r\n        query += ' LIMIT ? OFFSET ?';\r\n        params.push(limit, offset);\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(query).bind(...params).all();\r\n\r\n        // Count total for pagination\r\n        let countQuery = 'SELECT COUNT(*) as total FROM forum_posts WHERE is_hidden = 0';\r\n        if (tag) {\r\n            countQuery += \" AND tags LIKE ?\";\r\n        }\r\n        const countResult = await env.ban_dong_hanh_db.prepare(countQuery)\r\n            .bind(...(tag ? [`%\"${tag}\"%`] : []))\r\n            .first();\r\n\r\n        return json({\r\n            items: result.results.map(post => ({\r\n                ...post,\r\n                content: post.content.length > 200 ? post.content.slice(0, 200) + '...' : post.content,\r\n                tags: post.tags ? JSON.parse(post.tags) : []\r\n            })),\r\n            pagination: {\r\n                page,\r\n                limit,\r\n                total: countResult.total,\r\n                totalPages: Math.ceil(countResult.total / limit)\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error('[Forum] getForumPosts error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/forum/post/:id - L\u1EA5y chi ti\u1EBFt b\u00E0i vi\u1EBFt v\u1EDBi comments\r\n */\r\nexport async function getForumPost(request, env, id) {\r\n    try {\r\n        const post = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, hashed_user_id, title, content, tags, upvotes, comments_count, is_locked, created_at FROM forum_posts WHERE id = ? AND is_hidden = 0'\r\n        ).bind(parseInt(id)).first();\r\n\r\n        if (!post) {\r\n            return json({ error: 'post_not_found' }, 404);\r\n        }\r\n\r\n        // L\u1EA5y comments\r\n        const comments = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, hashed_user_id, content, created_at FROM forum_comments WHERE post_id = ? AND is_hidden = 0 ORDER BY created_at ASC'\r\n        ).bind(parseInt(id)).all();\r\n\r\n        return json({\r\n            post: {\r\n                ...post,\r\n                tags: post.tags ? JSON.parse(post.tags) : []\r\n            },\r\n            comments: comments.results\r\n        });\r\n    } catch (error) {\r\n        console.error('[Forum] getForumPost error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/forum/post - T\u1EA1o b\u00E0i vi\u1EBFt m\u1EDBi\r\n * Body: { title?: string, content: string, tags?: string[], anonymous?: boolean }\r\n */\r\nexport async function createForumPost(request, env) {\r\n    const userId = getUserId(request);\r\n\r\n    try {\r\n        // Ki\u1EC3m tra ban status\r\n        if (userId && await isUserBanned(userId, env)) {\r\n            return json({ error: 'user_banned', message: 'T\u00E0i kho\u1EA3n c\u1EE7a b\u1EA1n \u0111\u00E3 b\u1ECB h\u1EA1n ch\u1EBF \u0111\u0103ng b\u00E0i' }, 403);\r\n        }\r\n\r\n        const { title, content, tags, anonymous } = await request.json();\r\n\r\n        // Validate content\r\n        let validatedContent;\r\n        try {\r\n            validatedContent = validateContent(content, 5000);\r\n        } catch (e) {\r\n            if (e.message === 'content_sensitive') {\r\n                return json({\r\n                    error: 'content_sensitive',\r\n                    message: 'N\u1ED9i dung c\u00F3 d\u1EA5u hi\u1EC7u nh\u1EA1y c\u1EA3m. N\u1EBFu b\u1EA1n \u0111ang g\u1EB7p kh\u00F3 kh\u0103n, h\u00E3y li\u00EAn h\u1EC7 \u0111\u01B0\u1EDDng d\u00E2y n\u00F3ng: 1800 599 920'\r\n                }, 400);\r\n            }\r\n            if (e.message === 'content_blocked') {\r\n                return json({ error: 'content_blocked', message: 'N\u1ED9i dung kh\u00F4ng \u0111\u01B0\u1EE3c ph\u00E9p' }, 400);\r\n            }\r\n            return json({ error: e.message }, 400);\r\n        }\r\n\r\n        // Validate title n\u1EBFu c\u00F3\r\n        let validatedTitle = null;\r\n        if (title) {\r\n            try {\r\n                validatedTitle = validateContent(title, 200);\r\n            } catch {\r\n                return json({ error: 'invalid_title' }, 400);\r\n            }\r\n        }\r\n\r\n        // Process tags\r\n        const validTags = Array.isArray(tags) ? tags.slice(0, 5).map(t => t.trim()).filter(t => t.length > 0 && t.length < 30) : [];\r\n\r\n        // T\u1EA1o hashed user ID\r\n        const hashedId = anonymous ? null : hashUserId(userId);\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO forum_posts (user_id, hashed_user_id, title, content, tags) VALUES (?, ?, ?, ?, ?) RETURNING id, hashed_user_id, title, content, tags, upvotes, comments_count, created_at'\r\n        ).bind(\r\n            anonymous ? null : userId,\r\n            hashedId,\r\n            validatedTitle,\r\n            validatedContent,\r\n            validTags.length > 0 ? JSON.stringify(validTags) : null\r\n        ).first();\r\n\r\n        return json({\r\n            success: true,\r\n            post: {\r\n                ...result,\r\n                tags: validTags\r\n            }\r\n        }, 201);\r\n    } catch (error) {\r\n        console.error('[Forum] createForumPost error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/forum/post/:id/comment - Th\u00EAm comment\r\n * Body: { content: string, anonymous?: boolean }\r\n */\r\nexport async function addComment(request, env, postId) {\r\n    const userId = getUserId(request);\r\n\r\n    try {\r\n        // Ki\u1EC3m tra ban status\r\n        if (userId && await isUserBanned(userId, env)) {\r\n            return json({ error: 'user_banned' }, 403);\r\n        }\r\n\r\n        // Ki\u1EC3m tra post t\u1ED3n t\u1EA1i v\u00E0 kh\u00F4ng b\u1ECB kh\u00F3a\r\n        const post = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, is_locked FROM forum_posts WHERE id = ? AND is_hidden = 0'\r\n        ).bind(parseInt(postId)).first();\r\n\r\n        if (!post) {\r\n            return json({ error: 'post_not_found' }, 404);\r\n        }\r\n\r\n        if (post.is_locked) {\r\n            return json({ error: 'post_locked', message: 'B\u00E0i vi\u1EBFt n\u00E0y \u0111\u00E3 b\u1ECB kh\u00F3a b\u00ECnh lu\u1EADn' }, 403);\r\n        }\r\n\r\n        const { content, anonymous } = await request.json();\r\n\r\n        // Validate content\r\n        let validatedContent;\r\n        try {\r\n            validatedContent = validateContent(content, 1000);\r\n        } catch (e) {\r\n            if (e.message === 'content_sensitive') {\r\n                return json({\r\n                    error: 'content_sensitive',\r\n                    message: 'N\u1ED9i dung c\u00F3 d\u1EA5u hi\u1EC7u nh\u1EA1y c\u1EA3m. N\u1EBFu b\u1EA1n \u0111ang g\u1EB7p kh\u00F3 kh\u0103n, h\u00E3y li\u00EAn h\u1EC7 \u0111\u01B0\u1EDDng d\u00E2y n\u00F3ng: 1800 599 920'\r\n                }, 400);\r\n            }\r\n            return json({ error: e.message }, 400);\r\n        }\r\n\r\n        const hashedId = anonymous ? null : hashUserId(userId);\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO forum_comments (post_id, user_id, hashed_user_id, content) VALUES (?, ?, ?, ?) RETURNING id, hashed_user_id, content, created_at'\r\n        ).bind(parseInt(postId), anonymous ? null : userId, hashedId, validatedContent).first();\r\n\r\n        // Update comments_count\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'UPDATE forum_posts SET comments_count = comments_count + 1 WHERE id = ?'\r\n        ).bind(parseInt(postId)).run();\r\n\r\n        return json({ success: true, comment: result }, 201);\r\n    } catch (error) {\r\n        console.error('[Forum] addComment error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/forum/post/:id/upvote - Upvote b\u00E0i vi\u1EBFt\r\n */\r\nexport async function upvotePost(request, env, postId) {\r\n    const userId = getUserId(request);\r\n    if (!userId) {\r\n        return json({ error: 'login_required', message: 'C\u1EA7n \u0111\u0103ng nh\u1EADp \u0111\u1EC3 upvote' }, 401);\r\n    }\r\n\r\n    try {\r\n        // Ki\u1EC3m tra \u0111\u00E3 upvote ch\u01B0a\r\n        const existing = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM forum_upvotes WHERE post_id = ? AND user_id = ?'\r\n        ).bind(parseInt(postId), userId).first();\r\n\r\n        if (existing) {\r\n            // \u0110\u00E3 upvote, b\u1ECF upvote\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'DELETE FROM forum_upvotes WHERE post_id = ? AND user_id = ?'\r\n            ).bind(parseInt(postId), userId).run();\r\n\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'UPDATE forum_posts SET upvotes = upvotes - 1 WHERE id = ?'\r\n            ).bind(parseInt(postId)).run();\r\n\r\n            return json({ success: true, action: 'removed' });\r\n        } else {\r\n            // Th\u00EAm upvote\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'INSERT INTO forum_upvotes (post_id, user_id) VALUES (?, ?)'\r\n            ).bind(parseInt(postId), userId).run();\r\n\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'UPDATE forum_posts SET upvotes = upvotes + 1 WHERE id = ?'\r\n            ).bind(parseInt(postId)).run();\r\n\r\n            return json({ success: true, action: 'added' });\r\n        }\r\n    } catch (error) {\r\n        console.error('[Forum] upvotePost error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// ADMIN ENDPOINTS\r\n// =============================================================================\r\n\r\n/**\r\n * DELETE /api/forum/post/:id - X\u00F3a/\u1EA9n b\u00E0i vi\u1EBFt (Admin)\r\n */\r\nexport async function deletePost(request, env, postId) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        // Ki\u1EC3m tra quy\u1EC1n admin\r\n        if (!await isAdmin(userId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        const { reason, permanent } = await request.json().catch(() => ({}));\r\n\r\n        if (permanent) {\r\n            // X\u00F3a v\u0129nh vi\u1EC5n\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'DELETE FROM forum_posts WHERE id = ?'\r\n            ).bind(parseInt(postId)).run();\r\n        } else {\r\n            // \u1EA8n b\u00E0i vi\u1EBFt\r\n            await env.ban_dong_hanh_db.prepare(\r\n                'UPDATE forum_posts SET is_hidden = 1 WHERE id = ?'\r\n            ).bind(parseInt(postId)).run();\r\n        }\r\n\r\n        // Log h\u00E0nh \u0111\u1ED9ng\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id, reason) VALUES (?, ?, ?, ?, ?)'\r\n        ).bind(userId, permanent ? 'delete_post' : 'hide_post', 'post', parseInt(postId), reason || null).run();\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Forum] deletePost error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/forum/comment/:id - X\u00F3a/\u1EA9n comment (Admin)\r\n */\r\nexport async function deleteComment(request, env, commentId) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        if (!await isAdmin(userId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        const { reason } = await request.json().catch(() => ({}));\r\n\r\n        // L\u1EA5y post_id tr\u01B0\u1EDBc khi \u1EA9n\r\n        const comment = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT post_id FROM forum_comments WHERE id = ?'\r\n        ).bind(parseInt(commentId)).first();\r\n\r\n        if (!comment) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        // \u1EA8n comment\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'UPDATE forum_comments SET is_hidden = 1 WHERE id = ?'\r\n        ).bind(parseInt(commentId)).run();\r\n\r\n        // Update comments_count\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'UPDATE forum_posts SET comments_count = comments_count - 1 WHERE id = ? AND comments_count > 0'\r\n        ).bind(comment.post_id).run();\r\n\r\n        // Log h\u00E0nh \u0111\u1ED9ng\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id, reason) VALUES (?, ?, ?, ?, ?)'\r\n        ).bind(userId, 'hide_comment', 'comment', parseInt(commentId), reason || null).run();\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Forum] deleteComment error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/forum/post/:id/lock - Kh\u00F3a/m\u1EDF kh\u00F3a b\u00E0i vi\u1EBFt (Admin)\r\n */\r\nexport async function toggleLockPost(request, env, postId) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        if (!await isAdmin(userId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        // Toggle lock status\r\n        const post = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT is_locked FROM forum_posts WHERE id = ?'\r\n        ).bind(parseInt(postId)).first();\r\n\r\n        if (!post) {\r\n            return json({ error: 'not_found' }, 404);\r\n        }\r\n\r\n        const newStatus = post.is_locked ? 0 : 1;\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'UPDATE forum_posts SET is_locked = ? WHERE id = ?'\r\n        ).bind(newStatus, parseInt(postId)).run();\r\n\r\n        // Log h\u00E0nh \u0111\u1ED9ng\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id) VALUES (?, ?, ?, ?)'\r\n        ).bind(userId, newStatus ? 'lock_post' : 'unlock_post', 'post', parseInt(postId)).run();\r\n\r\n        return json({ success: true, is_locked: newStatus === 1 });\r\n    } catch (error) {\r\n        console.error('[Forum] toggleLockPost error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/admin/ban-user - Ban user (Admin)\r\n * Body: { user_id: number, reason?: string, duration_days?: number }\r\n */\r\nexport async function banUser(request, env) {\r\n    const adminId = getUserId(request);\r\n    if (!adminId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        if (!await isAdmin(adminId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        const { user_id, reason, duration_days } = await request.json();\r\n\r\n        if (!user_id) {\r\n            return json({ error: 'user_id b\u1EAFt bu\u1ED9c' }, 400);\r\n        }\r\n\r\n        // T\u00EDnh ng\u00E0y h\u1EBFt h\u1EA1n ban\r\n        let bannedUntil = null;\r\n        if (duration_days && duration_days > 0) {\r\n            const date = new Date();\r\n            date.setDate(date.getDate() + duration_days);\r\n            bannedUntil = date.toISOString();\r\n        }\r\n\r\n        // Th\u00EAm ho\u1EB7c update ban record\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT OR REPLACE INTO banned_users (user_id, reason, banned_by, banned_until) VALUES (?, ?, ?, ?)'\r\n        ).bind(parseInt(user_id), reason || null, adminId, bannedUntil).run();\r\n\r\n        // Log h\u00E0nh \u0111\u1ED9ng\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id, reason) VALUES (?, ?, ?, ?, ?)'\r\n        ).bind(adminId, 'ban_user', 'user', parseInt(user_id), reason || null).run();\r\n\r\n        return json({ success: true, banned_until: bannedUntil });\r\n    } catch (error) {\r\n        console.error('[Forum] banUser error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * DELETE /api/admin/ban-user/:id - Unban user (Admin)\r\n */\r\nexport async function unbanUser(request, env, userId) {\r\n    const adminId = getUserId(request);\r\n    if (!adminId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        if (!await isAdmin(adminId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'DELETE FROM banned_users WHERE user_id = ?'\r\n        ).bind(parseInt(userId)).run();\r\n\r\n        // Log h\u00E0nh \u0111\u1ED9ng\r\n        await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO admin_logs (admin_user_id, action_type, target_type, target_id) VALUES (?, ?, ?, ?)'\r\n        ).bind(adminId, 'unban_user', 'user', parseInt(userId)).run();\r\n\r\n        return json({ success: true });\r\n    } catch (error) {\r\n        console.error('[Forum] unbanUser error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/admin/logs - L\u1EA5y l\u1ECBch s\u1EED admin actions\r\n */\r\nexport async function getAdminLogs(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        if (!await isAdmin(userId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        const url = new URL(request.url);\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT al.*, u.username as admin_username FROM admin_logs al LEFT JOIN users u ON al.admin_user_id = u.id ORDER BY al.created_at DESC LIMIT ?'\r\n        ).bind(limit).all();\r\n\r\n        return json({ items: result.results });\r\n    } catch (error) {\r\n        console.error('[Forum] getAdminLogs error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/admin/banned-users - L\u1EA5y danh s\u00E1ch user b\u1ECB ban\r\n */\r\nexport async function getBannedUsers(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        if (!await isAdmin(userId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT bu.*, u.username FROM banned_users bu LEFT JOIN users u ON bu.user_id = u.id ORDER BY bu.created_at DESC'\r\n        ).all();\r\n\r\n        return json({ items: result.results });\r\n    } catch (error) {\r\n        console.error('[Forum] getBannedUsers error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/admin/forum-stats - Th\u1ED1ng k\u00EA forum cho admin\r\n */\r\nexport async function getForumStats(request, env) {\r\n    const userId = getUserId(request);\r\n    if (!userId) return json({ error: 'not_authenticated' }, 401);\r\n\r\n    try {\r\n        if (!await isAdmin(userId, env)) {\r\n            return json({ error: 'forbidden' }, 403);\r\n        }\r\n\r\n        const [postsCount, commentsCount, bannedCount, hiddenPosts] = await Promise.all([\r\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts').first(),\r\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_comments').first(),\r\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM banned_users').first(),\r\n            env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts WHERE is_hidden = 1').first()\r\n        ]);\r\n\r\n        return json({\r\n            total_posts: postsCount.count,\r\n            total_comments: commentsCount.count,\r\n            banned_users: bannedCount.count,\r\n            hidden_posts: hiddenPosts.count\r\n        });\r\n    } catch (error) {\r\n        console.error('[Forum] getForumStats error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * GET /api/admin/users - L\u1EA5y danh s\u00E1ch t\u1EA5t c\u1EA3 users v\u1EDBi th\u1ED1ng k\u00EA\r\n * Query params: limit, offset, sort (created_at|last_login|journal_count|sos_count)\r\n */\r\nexport async function getAllUsers(request, env) {\r\n    // Verify admin JWT token (kh\u00F4ng d\u00F9ng userId t\u1EEB X-User-Id v\u00EC admin c\u00F3 JWT ri\u00EAng)\r\n    const authHeader = request.headers.get('Authorization');\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n        return json({ error: 'not_authenticated', message: 'C\u1EA7n \u0111\u0103ng nh\u1EADp admin' }, 401);\r\n    }\r\n\r\n    try {\r\n        const url = new URL(request.url);\r\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n        const offset = Math.max(parseInt(url.searchParams.get('offset') || '0'), 0);\r\n        const sortBy = url.searchParams.get('sort') || 'created_at';\r\n        \r\n        // L\u1EA5y danh s\u00E1ch users\r\n        const users = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id, username, created_at, last_login FROM users ORDER BY created_at DESC LIMIT ? OFFSET ?'\r\n        ).bind(limit, offset).all();\r\n\r\n        // L\u1EA5y th\u1ED1ng k\u00EA cho m\u1ED7i user\r\n        const usersWithStats = await Promise.all(\r\n            users.results.map(async (user) => {\r\n                const [journalCount, sosCount] = await Promise.all([\r\n                    env.ban_dong_hanh_db.prepare(\r\n                        'SELECT COUNT(*) as count FROM journal WHERE user_id = ?'\r\n                    ).bind(user.id).first().catch(() => ({ count: 0 })),\r\n                    env.ban_dong_hanh_db.prepare(\r\n                        'SELECT COUNT(*) as count FROM sos_logs WHERE hashed_user_id LIKE ? OR user_id = ?'\r\n                    ).bind(`%${user.id}%`, user.id).first().catch(() => ({ count: 0 }))\r\n                ]);\r\n\r\n                // L\u1EA5y SOS logs g\u1EA7n \u0111\u00E2y (7 ng\u00E0y) \u0111\u1EC3 \u0111\u00E1nh d\u1EA5u ai c\u1EA7n h\u1ED7 tr\u1EE3\r\n                // SOS logs c\u00F3 th\u1EC3 c\u00F3 hashed_user_id ho\u1EB7c user_id\r\n                const recentSOS = await env.ban_dong_hanh_db.prepare(\r\n                    `SELECT COUNT(*) as count FROM sos_logs \r\n                     WHERE (hashed_user_id LIKE ? OR user_id = ?) \r\n                     AND created_at >= datetime('now', '-7 days')`\r\n                ).bind(`%${user.id}%`, user.id).first().catch(() => ({ count: 0 }));\r\n\r\n                // L\u1EA5y journal entries g\u1EA7n \u0111\u00E2y (7 ng\u00E0y) \u0111\u1EC3 bi\u1EBFt ai \u0111ang t\u00EDch c\u1EF1c\r\n                const recentJournal = await env.ban_dong_hanh_db.prepare(\r\n                    `SELECT COUNT(*) as count FROM journal \r\n                     WHERE user_id = ? AND created_at >= datetime('now', '-7 days')`\r\n                ).bind(user.id).first().catch(() => ({ count: 0 }));\r\n\r\n                return {\r\n                    ...user,\r\n                    journal_count: journalCount.count || 0,\r\n                    sos_count: sosCount.count || 0,\r\n                    recent_sos_count: recentSOS.count || 0,\r\n                    recent_journal_count: recentJournal.count || 0,\r\n                    needs_support: (recentSOS.count || 0) > 0 // C\u00F3 SOS trong 7 ng\u00E0y qua\r\n                };\r\n            })\r\n        );\r\n\r\n        // S\u1EAFp x\u1EBFp theo sortBy\r\n        if (sortBy === 'sos_count') {\r\n            usersWithStats.sort((a, b) => b.sos_count - a.sos_count);\r\n        } else if (sortBy === 'journal_count') {\r\n            usersWithStats.sort((a, b) => b.journal_count - a.journal_count);\r\n        } else if (sortBy === 'last_login') {\r\n            usersWithStats.sort((a, b) => {\r\n                if (!a.last_login) return 1;\r\n                if (!b.last_login) return -1;\r\n                return new Date(b.last_login) - new Date(a.last_login);\r\n            });\r\n        }\r\n\r\n        // L\u1EA5y t\u1ED5ng s\u1ED1 users\r\n        const totalCount = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT COUNT(*) as count FROM users'\r\n        ).first().catch(() => ({ count: 0 }));\r\n\r\n        return json({\r\n            items: usersWithStats,\r\n            total: totalCount.count || 0,\r\n            limit,\r\n            offset\r\n        });\r\n    } catch (error) {\r\n        console.error('[Admin] getAllUsers error:', error.message);\r\n        return json({ error: 'server_error', message: error.message }, 500);\r\n    }\r\n}\r\n\r\n/**\r\n * POST /api/forum/report - B\u00E1o c\u00E1o b\u00E0i vi\u1EBFt ho\u1EB7c b\u00ECnh lu\u1EADn\r\n * Body: { target_type: 'post'|'comment', target_id: number, reason: string, details?: string }\r\n */\r\nexport async function reportContent(request, env) {\r\n    const userId = getUserId(request); // C\u00F3 th\u1EC3 null n\u1EBFu kh\u00E1ch\r\n\r\n    try {\r\n        const { target_type, target_id, reason, details } = await request.json();\r\n\r\n        // Validate\r\n        if (!target_type || !['post', 'comment'].includes(target_type)) {\r\n            return json({ error: 'invalid_target_type' }, 400);\r\n        }\r\n\r\n        if (!target_id || typeof target_id !== 'number') {\r\n            return json({ error: 'invalid_target_id' }, 400);\r\n        }\r\n\r\n        const validReasons = ['spam', 'harassment', 'inappropriate', 'misinformation', 'other'];\r\n        if (!reason || !validReasons.includes(reason)) {\r\n            return json({ error: 'invalid_reason' }, 400);\r\n        }\r\n\r\n        // Ki\u1EC3m tra target c\u00F3 t\u1ED3n t\u1EA1i kh\u00F4ng\r\n        const table = target_type === 'post' ? 'forum_posts' : 'forum_comments';\r\n        const target = await env.ban_dong_hanh_db.prepare(\r\n            `SELECT id FROM ${table} WHERE id = ?`\r\n        ).bind(target_id).first();\r\n\r\n        if (!target) {\r\n            return json({ error: 'target_not_found' }, 404);\r\n        }\r\n\r\n        // Ki\u1EC3m tra \u0111\u00E3 b\u00E1o c\u00E1o ch\u01B0a (tr\u00E1nh spam report)\r\n        const existingReport = await env.ban_dong_hanh_db.prepare(\r\n            'SELECT id FROM forum_reports WHERE target_type = ? AND target_id = ? AND reporter_user_id = ? AND status = ?'\r\n        ).bind(target_type, target_id, userId || null, 'pending').first();\r\n\r\n        if (existingReport) {\r\n            return json({ \r\n                error: 'already_reported', \r\n                message: 'B\u1EA1n \u0111\u00E3 b\u00E1o c\u00E1o n\u1ED9i dung n\u00E0y r\u1ED3i. Admin s\u1EBD xem x\u00E9t s\u1EDBm nh\u1EA5t.' \r\n            }, 400);\r\n        }\r\n\r\n        // L\u01B0u b\u00E1o c\u00E1o\r\n        const result = await env.ban_dong_hanh_db.prepare(\r\n            'INSERT INTO forum_reports (target_type, target_id, reporter_user_id, reason, details, status) VALUES (?, ?, ?, ?, ?, ?) RETURNING id, created_at'\r\n        ).bind(\r\n            target_type,\r\n            target_id,\r\n            userId || null,\r\n            reason,\r\n            details ? details.slice(0, 500) : null, // Gi\u1EDBi h\u1EA1n 500 k\u00FD t\u1EF1\r\n            'pending'\r\n        ).first();\r\n\r\n        console.log('[Forum] Content reported:', { target_type, target_id, reason, reporter: userId || 'guest' });\r\n\r\n        return json({\r\n            success: true,\r\n            report_id: result.id,\r\n            message: 'C\u1EA3m \u01A1n b\u1EA1n \u0111\u00E3 b\u00E1o c\u00E1o. Admin s\u1EBD xem x\u00E9t n\u1ED9i dung n\u00E0y s\u1EDBm nh\u1EA5t.'\r\n        }, 201);\r\n    } catch (error) {\r\n        console.error('[Forum] reportContent error:', error.message);\r\n        return json({ error: 'server_error' }, 500);\r\n    }\r\n}", "// backend/workers/router.js\r\n// Ch\u00FA th\u00EDch: Main router cho t\u1EA5t c\u1EA3 API endpoints\r\n// T\u00EDch h\u1EE3p: ai-proxy, auth, data-api\r\n\r\nimport {\r\n    handleRegister,\r\n    handleLogin,\r\n    handleCheckUsername,\r\n    handleGetMe,\r\n    handleDeleteAccount\r\n} from './auth.js';\r\n\r\nimport {\r\n    getGratitude, addGratitude, deleteGratitude,\r\n    getJournal, addJournal, deleteJournal,\r\n    getFocusSessions, addFocusSession,\r\n    getBreathingSessions, addBreathingSession,\r\n    getSleepLogs, addSleepLog, deleteSleepLog, updateSleepLog,\r\n    getAchievements, unlockAchievement,\r\n    getStats, exportData, importData,\r\n    // Phase 1 additions\r\n    getGameScores, addGameScore,\r\n    getNotificationSettings, saveNotificationSettings,\r\n    logSOSEvent, getSOSLogs,\r\n    getRandomCardsHistory, addRandomCardHistory,\r\n    getUserStats, addUserXP,\r\n    submitChatFeedback, getChatMetrics,\r\n    // Phase 8 additions - Bookmarks\r\n    getBookmarks, addBookmark, deleteBookmark, deleteBookmarkById,\r\n    // Phase 10 additions - Chat Threads Sync\r\n    getChatThreads, saveChatThread, saveChatMessages, deleteChatThread, syncChatThreads\r\n} from './data-api.js';\r\n\r\nimport {\r\n    getForumPosts, getForumPost, createForumPost,\r\n    addComment, upvotePost, deletePost, deleteComment,\r\n    toggleLockPost, banUser, unbanUser,\r\n    getAdminLogs, getBannedUsers, getForumStats, getAllUsers,\r\n    reportContent\r\n} from './forum-api.js';\r\n\r\nimport { classifyRiskRules, getRedTierResponse } from './risk.js';\r\nimport { sanitizeInput } from './sanitize.js';\r\nimport { formatMessagesForLLM, getRecentMessages } from './memory.js';\r\nimport { createTraceContext, addTraceHeader } from './observability.js';\r\nimport { rateLimitMiddleware } from './rate-limiter.js';\r\n\r\n// =============================================================================\r\n// CORS HELPERS\r\n// =============================================================================\r\nfunction getAllowedOrigin(request, env) {\r\n    const reqOrigin = request.headers.get('Origin') || '';\r\n    const allow = env.ALLOW_ORIGIN || '*';\r\n\r\n    if (allow === '*' || !reqOrigin) return allow === '*' ? '*' : reqOrigin || '*';\r\n\r\n    const list = allow.split(',').map((s) => s.trim());\r\n    if (list.includes(reqOrigin)) return reqOrigin;\r\n\r\n    for (const pattern of list) {\r\n        if (pattern.startsWith('*.')) {\r\n            const domain = pattern.slice(2);\r\n            const originHost = reqOrigin.replace(/^https?:\\/\\//, '');\r\n            if (originHost.endsWith('.' + domain) || originHost === domain) {\r\n                return reqOrigin;\r\n            }\r\n        }\r\n    }\r\n\r\n    if (reqOrigin.includes('.pages.dev')) return reqOrigin;\r\n    return 'null';\r\n}\r\n\r\nfunction corsHeaders(origin = '*') {\r\n    return {\r\n        'Access-Control-Allow-Origin': origin,\r\n        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n        'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-User-Id, X-Requested-With',\r\n        'Access-Control-Expose-Headers': 'X-Trace-Id',\r\n    };\r\n}\r\n\r\nfunction json(data, status = 200, origin = '*') {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders(origin) },\r\n    });\r\n}\r\n\r\nfunction handleOptions(request, env) {\r\n    const origin = getAllowedOrigin(request, env);\r\n    return new Response(null, { status: 204, headers: corsHeaders(origin) });\r\n}\r\n\r\n// =============================================================================\r\n// ROUTE MATCHING\r\n// =============================================================================\r\nfunction matchRoute(pathname, method) {\r\n    // Auth routes\r\n    if (pathname === '/api/auth/register' && method === 'POST') return 'auth:register';\r\n    if (pathname === '/api/auth/login' && method === 'POST') return 'auth:login';\r\n    if (pathname === '/api/auth/check' && method === 'GET') return 'auth:check';\r\n    if (pathname === '/api/auth/me' && method === 'GET') return 'auth:me';\r\n    if (pathname === '/api/auth/account' && method === 'DELETE') return 'auth:delete';\r\n\r\n    // Data routes - Gratitude\r\n    if (pathname === '/api/data/gratitude' && method === 'GET') return 'data:gratitude:list';\r\n    if (pathname === '/api/data/gratitude' && method === 'POST') return 'data:gratitude:add';\r\n    if (pathname.startsWith('/api/data/gratitude/') && method === 'DELETE') return 'data:gratitude:delete';\r\n\r\n    // Data routes - Journal\r\n    if (pathname === '/api/data/journal' && method === 'GET') return 'data:journal:list';\r\n    if (pathname === '/api/data/journal' && method === 'POST') return 'data:journal:add';\r\n    if (pathname.startsWith('/api/data/journal/') && method === 'DELETE') return 'data:journal:delete';\r\n\r\n    // Data routes - Focus\r\n    if (pathname === '/api/data/focus' && method === 'GET') return 'data:focus:list';\r\n    if (pathname === '/api/data/focus' && method === 'POST') return 'data:focus:add';\r\n\r\n    // Data routes - Breathing\r\n    if (pathname === '/api/data/breathing' && method === 'GET') return 'data:breathing:list';\r\n    if (pathname === '/api/data/breathing' && method === 'POST') return 'data:breathing:add';\r\n\r\n    // Data routes - Sleep logs\r\n    if (pathname === '/api/data/sleep' && method === 'GET') return 'data:sleep:list';\r\n    if (pathname === '/api/data/sleep' && method === 'POST') return 'data:sleep:add';\r\n    if (pathname.startsWith('/api/data/sleep/') && method === 'DELETE') return 'data:sleep:delete';\r\n    if (pathname.startsWith('/api/data/sleep/') && method === 'PUT') return 'data:sleep:update';\r\n\r\n    // Data routes - Achievements\r\n    if (pathname === '/api/data/achievements' && method === 'GET') return 'data:achievements:list';\r\n    if (pathname === '/api/data/achievements' && method === 'POST') return 'data:achievements:add';\r\n\r\n    // Data routes - Stats & Export\r\n    if (pathname === '/api/data/stats' && method === 'GET') return 'data:stats';\r\n    if (pathname === '/api/data/export' && method === 'GET') return 'data:export';\r\n    if (pathname === '/api/data/import' && method === 'POST') return 'data:import';\r\n\r\n    // Data routes - Game Scores\r\n    if (pathname === '/api/data/game-scores' && method === 'GET') return 'data:games:list';\r\n    if (pathname === '/api/data/game-scores' && method === 'POST') return 'data:games:add';\r\n\r\n    // Data routes - Notification Settings\r\n    if (pathname === '/api/data/notification-settings' && method === 'GET') return 'data:notifications:get';\r\n    if (pathname === '/api/data/notification-settings' && method === 'POST') return 'data:notifications:save';\r\n\r\n    // Data routes - SOS Logs\r\n    if (pathname === '/api/data/sos-log' && method === 'POST') return 'data:sos:log';\r\n\r\n    // Data routes - Random Cards History\r\n    if (pathname === '/api/data/random-cards-history' && method === 'GET') return 'data:cards:list';\r\n    if (pathname === '/api/data/random-cards-history' && method === 'POST') return 'data:cards:add';\r\n\r\n    // Data routes - Chat Feedback & Metrics\r\n    if (pathname === '/api/data/chat/feedback' && method === 'POST') return 'data:chat:feedback';\r\n    if (pathname === '/api/data/chat/metrics' && method === 'GET') return 'data:chat:metrics';\r\n\r\n    // Data routes - Chat Threads Sync\r\n    if (pathname === '/api/data/chat/threads' && method === 'GET') return 'data:chat:threads:list';\r\n    if (pathname === '/api/data/chat/threads' && method === 'POST') return 'data:chat:threads:save';\r\n    if (pathname === '/api/data/chat/messages' && method === 'POST') return 'data:chat:messages:save';\r\n    if (pathname.match(/^\\/api\\/data\\/chat\\/threads\\/[a-zA-Z0-9_]+$/) && method === 'DELETE') return 'data:chat:threads:delete';\r\n    if (pathname === '/api/data/chat/sync' && method === 'POST') return 'data:chat:sync';\r\n\r\n    // Data routes - User Stats / Gamification\r\n    if (pathname === '/api/data/user-stats' && method === 'GET') return 'data:user-stats:get';\r\n    if (pathname === '/api/data/user-stats/add-xp' && method === 'POST') return 'data:user-stats:xp';\r\n\r\n    // Data routes - Bookmarks\r\n    if (pathname === '/api/data/bookmarks' && method === 'GET') return 'data:bookmarks:list';\r\n    if (pathname === '/api/data/bookmarks' && method === 'POST') return 'data:bookmarks:add';\r\n    if (pathname === '/api/data/bookmarks' && method === 'DELETE') return 'data:bookmarks:delete';\r\n    if (pathname.match(/^\\/api\\/data\\/bookmarks\\/\\d+$/) && method === 'DELETE') return 'data:bookmarks:delete-id';\r\n\r\n    // AI Chat (legacy path)\r\n    if (pathname === '/' && method === 'POST') return 'ai:chat';\r\n    if (pathname === '/api/chat' && method === 'POST') return 'ai:chat';\r\n\r\n    // Forum routes\r\n    if (pathname === '/api/forum/posts' && method === 'GET') return 'forum:posts:list';\r\n    if (pathname === '/api/forum/post' && method === 'POST') return 'forum:post:create';\r\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+$/) && method === 'GET') return 'forum:post:get';\r\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+$/) && method === 'DELETE') return 'forum:post:delete';\r\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+\\/comment$/) && method === 'POST') return 'forum:comment:add';\r\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+\\/upvote$/) && method === 'POST') return 'forum:post:upvote';\r\n    if (pathname.match(/^\\/api\\/forum\\/post\\/\\d+\\/lock$/) && method === 'POST') return 'forum:post:lock';\r\n    if (pathname.match(/^\\/api\\/forum\\/comment\\/\\d+$/) && method === 'DELETE') return 'forum:comment:delete';\r\n    if (pathname === '/api/forum/report' && method === 'POST') return 'forum:report';\r\n\r\n    // TTS Proxy route\r\n    if (pathname === '/api/tts' && method === 'POST') return 'tts:synthesize';\r\n\r\n    // Admin routes\r\n    if (pathname === '/api/admin/login' && method === 'POST') return 'admin:login'; // NEW: Admin login\r\n    if (pathname === '/api/admin/verify' && method === 'GET') return 'admin:verify'; // NEW: Verify token\r\n    if (pathname === '/api/admin/ban-user' && method === 'POST') return 'admin:ban';\r\n    if (pathname.match(/^\\/api\\/admin\\/ban-user\\/\\d+$/) && method === 'DELETE') return 'admin:unban';\r\n    if (pathname === '/api/admin/logs' && method === 'GET') return 'admin:logs';\r\n    if (pathname === '/api/admin/banned-users' && method === 'GET') return 'admin:banned';\r\n    if (pathname === '/api/admin/forum-stats' && method === 'GET') return 'admin:forum-stats';\r\n    if (pathname === '/api/admin/sos-logs' && method === 'GET') return 'admin:sos-logs';\r\n    if (pathname === '/api/admin/users' && method === 'GET') return 'admin:users';\r\n    if (pathname === '/api/admin/comprehensive-stats' && method === 'GET') return 'admin:comprehensive-stats';\r\n    if (pathname === '/api/admin/activity-data' && method === 'GET') return 'admin:activity-data';\r\n    if (pathname === '/api/admin/chat-analytics' && method === 'GET') return 'admin:chat-analytics';\r\n    if (pathname === '/api/admin/reports' && method === 'GET') return 'admin:reports';\r\n\r\n    return null;\r\n}\r\n\r\nfunction extractId(pathname) {\r\n    const parts = pathname.split('/');\r\n    return parts[parts.length - 1];\r\n}\r\n\r\n// =============================================================================\r\n// MAIN HANDLER\r\n// =============================================================================\r\nexport default {\r\n    async fetch(request, env, ctx) {\r\n        // T\u1EA1o trace context cho observability\r\n        const trace = createTraceContext(request, env);\r\n\r\n        const origin = getAllowedOrigin(request, env);\r\n\r\n        // CORS preflight\r\n        if (request.method === 'OPTIONS') {\r\n            const response = handleOptions(request, env);\r\n            trace.logResponse(204);\r\n            return addTraceHeader(response, trace.traceId);\r\n        }\r\n\r\n        const url = new URL(request.url);\r\n        const route = matchRoute(url.pathname, request.method);\r\n\r\n        // Wrap response with CORS headers v\u00E0 trace ID\r\n        const wrapResponse = (response) => {\r\n            const newHeaders = new Headers(response.headers);\r\n            Object.entries(corsHeaders(origin)).forEach(([k, v]) => newHeaders.set(k, v));\r\n            newHeaders.set('X-Trace-Id', trace.traceId);\r\n\r\n            return new Response(response.body, {\r\n                status: response.status,\r\n                headers: newHeaders\r\n            });\r\n        };\r\n\r\n        // Rate limiting (skip cho OPTIONS)\r\n        if (request.method !== 'OPTIONS') {\r\n            const rateLimitResponse = await rateLimitMiddleware(request, env, url.pathname);\r\n            if (rateLimitResponse) {\r\n                trace.log('warn', 'rate_limit_exceeded', { path: url.pathname });\r\n                trace.logResponse(429);\r\n                return wrapResponse(rateLimitResponse);\r\n            }\r\n        }\r\n\r\n        try {\r\n            let response;\r\n\r\n            switch (route) {\r\n                // Auth endpoints\r\n                case 'auth:register':\r\n                    response = await handleRegister(request, env);\r\n                    break;\r\n                case 'auth:login':\r\n                    response = await handleLogin(request, env);\r\n                    break;\r\n                case 'auth:check':\r\n                    response = await handleCheckUsername(request, env);\r\n                    break;\r\n                case 'auth:me':\r\n                    response = await handleGetMe(request, env);\r\n                    break;\r\n                case 'auth:delete':\r\n                    response = await handleDeleteAccount(request, env);\r\n                    break;\r\n\r\n                // Gratitude endpoints\r\n                case 'data:gratitude:list':\r\n                    response = await getGratitude(request, env);\r\n                    break;\r\n                case 'data:gratitude:add':\r\n                    response = await addGratitude(request, env);\r\n                    break;\r\n                case 'data:gratitude:delete':\r\n                    response = await deleteGratitude(request, env, extractId(url.pathname));\r\n                    break;\r\n\r\n                // Journal endpoints\r\n                case 'data:journal:list':\r\n                    response = await getJournal(request, env);\r\n                    break;\r\n                case 'data:journal:add':\r\n                    response = await addJournal(request, env);\r\n                    break;\r\n                case 'data:journal:delete':\r\n                    response = await deleteJournal(request, env, extractId(url.pathname));\r\n                    break;\r\n\r\n                // Focus endpoints\r\n                case 'data:focus:list':\r\n                    response = await getFocusSessions(request, env);\r\n                    break;\r\n                case 'data:focus:add':\r\n                    response = await addFocusSession(request, env);\r\n                    break;\r\n\r\n                // Breathing endpoints\r\n                case 'data:breathing:list':\r\n                    response = await getBreathingSessions(request, env);\r\n                    break;\r\n                case 'data:breathing:add':\r\n                    response = await addBreathingSession(request, env);\r\n                    break;\r\n\r\n                // Sleep log endpoints\r\n                case 'data:sleep:list':\r\n                    response = await getSleepLogs(request, env);\r\n                    break;\r\n                case 'data:sleep:add':\r\n                    response = await addSleepLog(request, env);\r\n                    break;\r\n                case 'data:sleep:delete':\r\n                    response = await deleteSleepLog(request, env, extractId(url.pathname));\r\n                    break;\r\n                case 'data:sleep:update':\r\n                    response = await updateSleepLog(request, env, extractId(url.pathname));\r\n                    break;\r\n\r\n                // Achievements endpoints\r\n                case 'data:achievements:list':\r\n                    response = await getAchievements(request, env);\r\n                    break;\r\n                case 'data:achievements:add':\r\n                    response = await unlockAchievement(request, env);\r\n                    break;\r\n\r\n                // Stats & Export\r\n                case 'data:stats':\r\n                    response = await getStats(request, env);\r\n                    break;\r\n                case 'data:export':\r\n                    response = await exportData(request, env);\r\n                    break;\r\n                case 'data:import':\r\n                    response = await importData(request, env);\r\n                    break;\r\n\r\n                // Game Scores endpoints\r\n                case 'data:games:list':\r\n                    response = await getGameScores(request, env);\r\n                    break;\r\n                case 'data:games:add':\r\n                    response = await addGameScore(request, env);\r\n                    break;\r\n\r\n                // Notification Settings endpoints\r\n                case 'data:notifications:get':\r\n                    response = await getNotificationSettings(request, env);\r\n                    break;\r\n                case 'data:notifications:save':\r\n                    response = await saveNotificationSettings(request, env);\r\n                    break;\r\n\r\n                // SOS Log endpoint\r\n                case 'data:sos:log':\r\n                    response = await logSOSEvent(request, env);\r\n                    break;\r\n\r\n                // Random Cards History endpoints\r\n                case 'data:cards:list':\r\n                    response = await getRandomCardsHistory(request, env);\r\n                    break;\r\n                case 'data:cards:add':\r\n                    response = await addRandomCardHistory(request, env);\r\n                    break;\r\n\r\n                // Chat Feedback & Metrics endpoints\r\n                case 'data:chat:feedback':\r\n                    response = await submitChatFeedback(request, env);\r\n                    break;\r\n                case 'data:chat:metrics':\r\n                    response = await getChatMetrics(request, env);\r\n                    break;\r\n\r\n                // User Stats / Gamification endpoints\r\n                case 'data:user-stats:get':\r\n                    response = await getUserStats(request, env);\r\n                    break;\r\n                case 'data:user-stats:xp':\r\n                    response = await addUserXP(request, env);\r\n                    break;\r\n\r\n                // Bookmarks endpoints\r\n                case 'data:bookmarks:list':\r\n                    response = await getBookmarks(request, env);\r\n                    break;\r\n                case 'data:bookmarks:add':\r\n                    response = await addBookmark(request, env);\r\n                    break;\r\n                case 'data:bookmarks:delete':\r\n                    response = await deleteBookmark(request, env);\r\n                    break;\r\n                case 'data:bookmarks:delete-id':\r\n                    response = await deleteBookmarkById(request, env, extractId(url.pathname));\r\n                    break;\r\n\r\n                // Chat Threads Sync endpoints\r\n                case 'data:chat:threads:list':\r\n                    response = await getChatThreads(request, env);\r\n                    break;\r\n                case 'data:chat:threads:save':\r\n                    response = await saveChatThread(request, env);\r\n                    break;\r\n                case 'data:chat:messages:save':\r\n                    response = await saveChatMessages(request, env);\r\n                    break;\r\n                case 'data:chat:threads:delete':\r\n                    response = await deleteChatThread(request, env, extractId(url.pathname));\r\n                    break;\r\n                case 'data:chat:sync':\r\n                    response = await syncChatThreads(request, env);\r\n                    break;\r\n\r\n                // AI Chat - delegate to existing ai-proxy logic\r\n                case 'ai:chat':\r\n                    // Import dynamically to avoid circular dependency issues\r\n                    const aiProxy = await import('./ai-proxy.js');\r\n                    return aiProxy.default.fetch(request, env, ctx);\r\n\r\n                // Forum endpoints\r\n                case 'forum:posts:list':\r\n                    response = await getForumPosts(request, env);\r\n                    break;\r\n                case 'forum:post:create':\r\n                    response = await createForumPost(request, env);\r\n                    break;\r\n                case 'forum:post:get':\r\n                    response = await getForumPost(request, env, extractId(url.pathname));\r\n                    break;\r\n                case 'forum:post:delete':\r\n                    response = await deletePost(request, env, extractId(url.pathname));\r\n                    break;\r\n                case 'forum:comment:add':\r\n                    // Extract postId t\u1EEB pathname nh\u01B0 /api/forum/post/123/comment\r\n                    const commentPath = url.pathname.match(/\\/api\\/forum\\/post\\/(\\d+)\\/comment/);\r\n                    response = await addComment(request, env, commentPath ? commentPath[1] : null);\r\n                    break;\r\n                case 'forum:post:upvote':\r\n                    const upvotePath = url.pathname.match(/\\/api\\/forum\\/post\\/(\\d+)\\/upvote/);\r\n                    response = await upvotePost(request, env, upvotePath ? upvotePath[1] : null);\r\n                    break;\r\n                case 'forum:post:lock':\r\n                    const lockPath = url.pathname.match(/\\/api\\/forum\\/post\\/(\\d+)\\/lock/);\r\n                    response = await toggleLockPost(request, env, lockPath ? lockPath[1] : null);\r\n                    break;\r\n                case 'forum:comment:delete':\r\n                    const commentDelPath = url.pathname.match(/\\/api\\/forum\\/comment\\/(\\d+)/);\r\n                    response = await deleteComment(request, env, commentDelPath ? commentDelPath[1] : null);\r\n                    break;\r\n                case 'forum:report':\r\n                    response = await reportContent(request, env);\r\n                    break;\r\n\r\n                // Admin endpoints\r\n                // NEW: Admin login - standalone authentication\r\n                case 'admin:login':\r\n                    try {\r\n                        const { password } = await request.json();\r\n                        const adminPassword = env.ADMIN_PASSWORD || 'BanDongHanh2024@Admin';\r\n\r\n                        if (password !== adminPassword) {\r\n                            response = json({ error: 'invalid_password', message: 'Sai m\u1EADt kh\u1EA9u admin' }, 401);\r\n                            break;\r\n                        }\r\n\r\n                        // T\u1EA1o JWT \u0111\u01A1n gi\u1EA3n (expires in 24h)\r\n                        const jwtSecret = env.JWT_SECRET || 'default-secret';\r\n                        const expiry = Date.now() + (24 * 60 * 60 * 1000); // 24 hours\r\n                        const payload = { role: 'admin', exp: expiry };\r\n                        const token = btoa(JSON.stringify(payload)) + '.' + btoa(jwtSecret.slice(0, 8) + expiry);\r\n\r\n                        response = json({\r\n                            success: true,\r\n                            token,\r\n                            expiresAt: new Date(expiry).toISOString()\r\n                        });\r\n                    } catch (e) {\r\n                        response = json({ error: 'server_error', message: e.message }, 500);\r\n                    }\r\n                    break;\r\n\r\n                // NEW: Verify admin token\r\n                case 'admin:verify':\r\n                    try {\r\n                        const authHeader = request.headers.get('Authorization');\r\n                        if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n                            response = json({ error: 'no_token', valid: false }, 401);\r\n                            break;\r\n                        }\r\n\r\n                        const token = authHeader.split(' ')[1];\r\n                        const [payloadB64, sigB64] = token.split('.');\r\n\r\n                        if (!payloadB64 || !sigB64) {\r\n                            response = json({ error: 'invalid_token', valid: false }, 401);\r\n                            break;\r\n                        }\r\n\r\n                        const payload = JSON.parse(atob(payloadB64));\r\n                        const jwtSecret = env.JWT_SECRET || 'default-secret';\r\n                        const expectedSig = btoa(jwtSecret.slice(0, 8) + payload.exp);\r\n\r\n                        if (sigB64 !== expectedSig || payload.exp < Date.now()) {\r\n                            response = json({ error: 'expired_or_invalid', valid: false }, 401);\r\n                            break;\r\n                        }\r\n\r\n                        response = json({ valid: true, role: payload.role });\r\n                    } catch (e) {\r\n                        response = json({ error: 'invalid_token', valid: false }, 401);\r\n                    }\r\n                    break;\r\n\r\n                case 'admin:ban':\r\n                case 'admin:unban':\r\n                case 'admin:logs':\r\n                case 'admin:banned':\r\n                case 'admin:forum-stats':\r\n                case 'admin:sos-logs':\r\n                case 'admin:users':\r\n                case 'admin:comprehensive-stats':\r\n                case 'admin:activity-data':\r\n                case 'admin:chat-analytics':\r\n                case 'admin:reports':\r\n                    // Verify JWT token for all admin routes\r\n                    const adminAuthHeader = request.headers.get('Authorization');\r\n                    if (!adminAuthHeader || !adminAuthHeader.startsWith('Bearer ')) {\r\n                        response = json({ error: 'not_authenticated', message: 'C\u1EA7n \u0111\u0103ng nh\u1EADp admin' }, 401);\r\n                        break;\r\n                    }\r\n\r\n                    try {\r\n                        const adminToken = adminAuthHeader.split(' ')[1];\r\n                        const [payloadB64Admin, sigB64Admin] = adminToken.split('.');\r\n                        const payloadAdmin = JSON.parse(atob(payloadB64Admin));\r\n                        const jwtSecretAdmin = env.JWT_SECRET || 'default-secret';\r\n                        const expectedSigAdmin = btoa(jwtSecretAdmin.slice(0, 8) + payloadAdmin.exp);\r\n\r\n                        if (sigB64Admin !== expectedSigAdmin || payloadAdmin.exp < Date.now()) {\r\n                            response = json({ error: 'token_expired', message: 'Token h\u1EBFt h\u1EA1n' }, 401);\r\n                            break;\r\n                        }\r\n                    } catch {\r\n                        response = json({ error: 'invalid_token', message: 'Token kh\u00F4ng h\u1EE3p l\u1EC7' }, 401);\r\n                        break;\r\n                    }\r\n\r\n                    // JWT valid, handle each route\r\n                    try {\r\n                        switch (route) {\r\n                            case 'admin:forum-stats':\r\n                                // Return stats, fallback to zeros if tables don't exist\r\n                                try {\r\n                                    const [postsCount, commentsCount, bannedCount, hiddenPosts] = await Promise.all([\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_comments').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM banned_users').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts WHERE is_hidden = 1').first().catch(() => ({ count: 0 }))\r\n                                    ]);\r\n                                    response = json({\r\n                                        total_posts: postsCount?.count || 0,\r\n                                        total_comments: commentsCount?.count || 0,\r\n                                        banned_users: bannedCount?.count || 0,\r\n                                        hidden_posts: hiddenPosts?.count || 0\r\n                                    });\r\n                                } catch {\r\n                                    response = json({ total_posts: 0, total_comments: 0, banned_users: 0, hidden_posts: 0 });\r\n                                }\r\n                                break;\r\n\r\n                            case 'admin:logs':\r\n                                try {\r\n                                    const logsLimit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\r\n                                    const logsResult = await env.ban_dong_hanh_db.prepare(\r\n                                        'SELECT * FROM admin_logs ORDER BY created_at DESC LIMIT ?'\r\n                                    ).bind(logsLimit).all().catch(() => ({ results: [] }));\r\n                                    response = json({ items: logsResult?.results || [] });\r\n                                } catch {\r\n                                    response = json({ items: [] });\r\n                                }\r\n                                break;\r\n\r\n                            case 'admin:banned':\r\n                                try {\r\n                                    const bannedResult = await env.ban_dong_hanh_db.prepare(\r\n                                        'SELECT * FROM banned_users ORDER BY created_at DESC'\r\n                                    ).all().catch(() => ({ results: [] }));\r\n                                    response = json({ items: bannedResult?.results || [] });\r\n                                } catch {\r\n                                    response = json({ items: [] });\r\n                                }\r\n                                break;\r\n\r\n                            case 'admin:sos-logs':\r\n                                try {\r\n                                    const sosLogsResult = await env.ban_dong_hanh_db.prepare(\r\n                                        'SELECT * FROM sos_logs ORDER BY created_at DESC LIMIT 100'\r\n                                    ).all().catch(() => ({ results: [] }));\r\n                                    response = json({ items: sosLogsResult?.results || [] });\r\n                                } catch {\r\n                                    response = json({ items: [] });\r\n                                }\r\n                                break;\r\n\r\n                            case 'admin:ban':\r\n                                response = json({ error: 'not_implemented', message: 'T\u00EDnh n\u0103ng ban user ch\u01B0a s\u1EB5n s\u00E0ng (c\u1EA7n database)' }, 501);\r\n                                break;\r\n\r\n                            case 'admin:unban':\r\n                                response = json({ error: 'not_implemented', message: 'T\u00EDnh n\u0103ng unban user ch\u01B0a s\u1EB5n s\u00E0ng (c\u1EA7n database)' }, 501);\r\n                                break;\r\n\r\n                            case 'admin:users':\r\n                                response = await getAllUsers(request, env);\r\n                                break;\r\n\r\n                            // NEW: Comprehensive Stats - T\u1EA5t c\u1EA3 th\u1ED1ng k\u00EA t\u1EEB database\r\n                            case 'admin:comprehensive-stats':\r\n                                try {\r\n                                    const [\r\n                                        usersCount,\r\n                                        gratitudeCount,\r\n                                        journalCount,\r\n                                        focusCount,\r\n                                        breathingCount,\r\n                                        sleepCount,\r\n                                        gameScoresCount,\r\n                                        achievementsCount,\r\n                                        forumPostsCount,\r\n                                        forumCommentsCount,\r\n                                        sosLogsCount,\r\n                                        chatResponsesCount,\r\n                                        chatFeedbackCount,\r\n                                        bookmarksCount,\r\n                                        todayUsers,\r\n                                        weekUsers,\r\n                                        totalXP,\r\n                                        avgGameScore\r\n                                    ] = await Promise.all([\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM users').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM gratitude').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM journal').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count, COALESCE(SUM(duration_minutes), 0) as total_minutes FROM focus_sessions').first().catch(() => ({ count: 0, total_minutes: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count, COALESCE(SUM(duration_seconds), 0) as total_seconds FROM breathing_sessions').first().catch(() => ({ count: 0, total_seconds: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count, COALESCE(AVG(duration_minutes), 0) as avg_duration FROM sleep_logs').first().catch(() => ({ count: 0, avg_duration: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count, MAX(score) as max_score FROM game_scores').first().catch(() => ({ count: 0, max_score: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM achievements').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_posts').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM forum_comments').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM sos_logs').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM chat_responses').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count, AVG(response_quality) as avg_quality FROM chat_feedback').first().catch(() => ({ count: 0, avg_quality: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COUNT(*) as count FROM user_bookmarks').first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare(\"SELECT COUNT(DISTINCT user_id) as count FROM gratitude WHERE date(created_at) = date('now')\").first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare(\"SELECT COUNT(DISTINCT user_id) as count FROM gratitude WHERE created_at >= datetime('now', '-7 days')\").first().catch(() => ({ count: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT COALESCE(SUM(total_xp), 0) as total FROM user_stats').first().catch(() => ({ total: 0 })),\r\n                                        env.ban_dong_hanh_db.prepare('SELECT AVG(score) as avg FROM game_scores').first().catch(() => ({ avg: 0 }))\r\n                                    ]);\r\n\r\n                                    response = json({\r\n                                        users: {\r\n                                            total: usersCount?.count || 0,\r\n                                            activeToday: todayUsers?.count || 0,\r\n                                            activeWeek: weekUsers?.count || 0\r\n                                        },\r\n                                        content: {\r\n                                            gratitude: gratitudeCount?.count || 0,\r\n                                            journal: journalCount?.count || 0,\r\n                                            bookmarks: bookmarksCount?.count || 0\r\n                                        },\r\n                                        activities: {\r\n                                            focus: {\r\n                                                sessions: focusCount?.count || 0,\r\n                                                totalMinutes: focusCount?.total_minutes || 0\r\n                                            },\r\n                                            breathing: {\r\n                                                sessions: breathingCount?.count || 0,\r\n                                                totalSeconds: breathingCount?.total_seconds || 0\r\n                                            },\r\n                                            sleep: {\r\n                                                logs: sleepCount?.count || 0,\r\n                                                avgDuration: Math.round(sleepCount?.avg_duration || 0)\r\n                                            },\r\n                                            games: {\r\n                                                plays: gameScoresCount?.count || 0,\r\n                                                maxScore: gameScoresCount?.max_score || 0,\r\n                                                avgScore: Math.round(avgGameScore?.avg || 0)\r\n                                            }\r\n                                        },\r\n                                        gamification: {\r\n                                            achievements: achievementsCount?.count || 0,\r\n                                            totalXP: totalXP?.total || 0\r\n                                        },\r\n                                        community: {\r\n                                            forumPosts: forumPostsCount?.count || 0,\r\n                                            forumComments: forumCommentsCount?.count || 0\r\n                                        },\r\n                                        ai: {\r\n                                            chatResponses: chatResponsesCount?.count || 0,\r\n                                            feedbackCount: chatFeedbackCount?.count || 0,\r\n                                            avgQuality: parseFloat((chatFeedbackCount?.avg_quality || 0).toFixed(2))\r\n                                        },\r\n                                        safety: {\r\n                                            sosEvents: sosLogsCount?.count || 0\r\n                                        }\r\n                                    });\r\n                                } catch (statsError) {\r\n                                    console.error('[Admin] comprehensive-stats error:', statsError.message);\r\n                                    response = json({ error: 'server_error', message: statsError.message }, 500);\r\n                                }\r\n                                break;\r\n\r\n                            // NEW: Activity Data - D\u1EEF li\u1EC7u ho\u1EA1t \u0111\u1ED9ng theo th\u1EDDi gian\r\n                            case 'admin:activity-data':\r\n                                try {\r\n                                    const days = parseInt(url.searchParams.get('days') || '30');\r\n\r\n                                    // Get daily activity counts\r\n                                    const [gratitudeDaily, journalDaily, breathingDaily, focusDaily, gameDaily] = await Promise.all([\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT date(created_at) as date, COUNT(*) as count \r\n                                            FROM gratitude \r\n                                            WHERE created_at >= datetime('now', '-${days} days')\r\n                                            GROUP BY date(created_at)\r\n                                            ORDER BY date DESC\r\n                                        `).all().catch(() => ({ results: [] })),\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT date(created_at) as date, COUNT(*) as count \r\n                                            FROM journal \r\n                                            WHERE created_at >= datetime('now', '-${days} days')\r\n                                            GROUP BY date(created_at)\r\n                                            ORDER BY date DESC\r\n                                        `).all().catch(() => ({ results: [] })),\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT date(created_at) as date, COUNT(*) as count, SUM(duration_seconds) as total_seconds\r\n                                            FROM breathing_sessions \r\n                                            WHERE created_at >= datetime('now', '-${days} days')\r\n                                            GROUP BY date(created_at)\r\n                                            ORDER BY date DESC\r\n                                        `).all().catch(() => ({ results: [] })),\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT date(created_at) as date, COUNT(*) as count, SUM(duration_minutes) as total_minutes\r\n                                            FROM focus_sessions \r\n                                            WHERE created_at >= datetime('now', '-${days} days')\r\n                                            GROUP BY date(created_at)\r\n                                            ORDER BY date DESC\r\n                                        `).all().catch(() => ({ results: [] })),\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT date(created_at) as date, COUNT(*) as count, MAX(score) as max_score\r\n                                            FROM game_scores \r\n                                            WHERE created_at >= datetime('now', '-${days} days')\r\n                                            GROUP BY date(created_at)\r\n                                            ORDER BY date DESC\r\n                                        `).all().catch(() => ({ results: [] }))\r\n                                    ]);\r\n\r\n                                    response = json({\r\n                                        period: days,\r\n                                        gratitude: gratitudeDaily?.results || [],\r\n                                        journal: journalDaily?.results || [],\r\n                                        breathing: breathingDaily?.results || [],\r\n                                        focus: focusDaily?.results || [],\r\n                                        games: gameDaily?.results || []\r\n                                    });\r\n                                } catch (activityError) {\r\n                                    console.error('[Admin] activity-data error:', activityError.message);\r\n                                    response = json({ error: 'server_error', message: activityError.message }, 500);\r\n                                }\r\n                                break;\r\n\r\n                            // NEW: Chat Analytics\r\n                            case 'admin:chat-analytics':\r\n                                try {\r\n                                    const [\r\n                                        riskDistribution,\r\n                                        responseStats,\r\n                                        feedbackStats,\r\n                                        recentResponses\r\n                                    ] = await Promise.all([\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT risk_level, COUNT(*) as count \r\n                                            FROM chat_responses \r\n                                            WHERE risk_level IS NOT NULL\r\n                                            GROUP BY risk_level\r\n                                        `).all().catch(() => ({ results: [] })),\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT \r\n                                                COUNT(*) as total,\r\n                                                AVG(confidence) as avg_confidence,\r\n                                                AVG(latency_ms) as avg_latency,\r\n                                                AVG(tokens_used) as avg_tokens,\r\n                                                SUM(CASE WHEN used_rag = 1 THEN 1 ELSE 0 END) as rag_count\r\n                                            FROM chat_responses\r\n                                        `).first().catch(() => ({})),\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT \r\n                                                COUNT(*) as total,\r\n                                                SUM(CASE WHEN helpful = 1 THEN 1 ELSE 0 END) as helpful_count,\r\n                                                AVG(response_quality) as avg_quality\r\n                                            FROM chat_feedback\r\n                                        `).first().catch(() => ({})),\r\n                                        env.ban_dong_hanh_db.prepare(`\r\n                                            SELECT user_message, ai_response, risk_level, confidence, created_at\r\n                                            FROM chat_responses\r\n                                            ORDER BY created_at DESC\r\n                                            LIMIT 20\r\n                                        `).all().catch(() => ({ results: [] }))\r\n                                    ]);\r\n\r\n                                    response = json({\r\n                                        riskDistribution: riskDistribution?.results || [],\r\n                                        stats: {\r\n                                            total: responseStats?.total || 0,\r\n                                            avgConfidence: parseFloat((responseStats?.avg_confidence || 0).toFixed(3)),\r\n                                            avgLatencyMs: Math.round(responseStats?.avg_latency || 0),\r\n                                            avgTokens: Math.round(responseStats?.avg_tokens || 0),\r\n                                            ragUsageRate: responseStats?.total > 0\r\n                                                ? parseFloat((responseStats?.rag_count / responseStats?.total).toFixed(3))\r\n                                                : 0\r\n                                        },\r\n                                        feedback: {\r\n                                            total: feedbackStats?.total || 0,\r\n                                            helpfulRate: feedbackStats?.total > 0\r\n                                                ? parseFloat((feedbackStats?.helpful_count / feedbackStats?.total).toFixed(3))\r\n                                                : 0,\r\n                                            avgQuality: parseFloat((feedbackStats?.avg_quality || 0).toFixed(2))\r\n                                        },\r\n                                        recentResponses: recentResponses?.results || []\r\n                                    });\r\n                                } catch (chatError) {\r\n                                    console.error('[Admin] chat-analytics error:', chatError.message);\r\n                                    response = json({ error: 'server_error', message: chatError.message }, 500);\r\n                                }\r\n                                break;\r\n\r\n                            // NEW: Forum Reports\r\n                            case 'admin:reports':\r\n                                try {\r\n                                    const reportsResult = await env.ban_dong_hanh_db.prepare(`\r\n                                        SELECT r.*, \r\n                                            CASE \r\n                                                WHEN r.target_type = 'post' THEN p.content\r\n                                                WHEN r.target_type = 'comment' THEN c.content\r\n                                            END as target_content\r\n                                        FROM forum_reports r\r\n                                        LEFT JOIN forum_posts p ON r.target_type = 'post' AND r.target_id = p.id\r\n                                        LEFT JOIN forum_comments c ON r.target_type = 'comment' AND r.target_id = c.id\r\n                                        ORDER BY r.created_at DESC\r\n                                        LIMIT 100\r\n                                    `).all().catch(() => ({ results: [] }));\r\n\r\n                                    const pendingCount = await env.ban_dong_hanh_db.prepare(\r\n                                        \"SELECT COUNT(*) as count FROM forum_reports WHERE status = 'pending'\"\r\n                                    ).first().catch(() => ({ count: 0 }));\r\n\r\n                                    response = json({\r\n                                        items: reportsResult?.results || [],\r\n                                        pendingCount: pendingCount?.count || 0\r\n                                    });\r\n                                } catch (reportsError) {\r\n                                    console.error('[Admin] reports error:', reportsError.message);\r\n                                    response = json({ items: [], pendingCount: 0 });\r\n                                }\r\n                                break;\r\n\r\n                            default:\r\n                                response = json({ error: 'unknown_route' }, 404);\r\n                        }\r\n                    } catch (adminError) {\r\n                        console.error('[Admin API] Error:', adminError.message);\r\n                        response = json({ error: 'server_error', message: adminError.message }, 500);\r\n                    }\r\n                    break;\r\n\r\n                // TTS Synthesize via Hugging Face\r\n                case 'tts:synthesize':\r\n                    try {\r\n                        const { text, model = 'facebook/mms-tts-vie' } = await request.json();\r\n\r\n                        if (!text || text.trim().length === 0) {\r\n                            response = json({ error: 'Text is required' }, 400);\r\n                            break;\r\n                        }\r\n\r\n                        // Try both HF endpoints (new router and legacy)\r\n                        const endpoints = [\r\n                            `https://router.huggingface.co/hf-inference/models/${model}`,\r\n                            `https://api-inference.huggingface.co/models/${model}`\r\n                        ];\r\n\r\n                        let hfResponse = null;\r\n                        let lastError = null;\r\n\r\n                        for (const endpoint of endpoints) {\r\n                            console.log('[TTS] Trying endpoint:', endpoint);\r\n                            try {\r\n                                hfResponse = await fetch(endpoint, {\r\n                                    method: 'POST',\r\n                                    headers: {\r\n                                        'Content-Type': 'application/json',\r\n                                        ...(env.HF_API_TOKEN ? { 'Authorization': `Bearer ${env.HF_API_TOKEN}` } : {})\r\n                                    },\r\n                                    body: JSON.stringify({ inputs: text })\r\n                                });\r\n\r\n                                if (hfResponse.ok) {\r\n                                    console.log('[TTS] Success with endpoint:', endpoint);\r\n                                    break;\r\n                                }\r\n\r\n                                // Check if model is loading (503) - wait and retry\r\n                                if (hfResponse.status === 503) {\r\n                                    const retryData = await hfResponse.json().catch(() => ({}));\r\n                                    if (retryData.estimated_time) {\r\n                                        console.log('[TTS] Model loading, waiting...');\r\n                                        // Return loading message to frontend\r\n                                        response = json({\r\n                                            error: 'model_loading',\r\n                                            message: 'Model \u0111ang kh\u1EDFi \u0111\u1ED9ng, vui l\u00F2ng th\u1EED l\u1EA1i sau ' + Math.ceil(retryData.estimated_time) + ' gi\u00E2y',\r\n                                            estimated_time: retryData.estimated_time\r\n                                        }, 503);\r\n                                        break;\r\n                                    }\r\n                                }\r\n\r\n                                lastError = await hfResponse.text();\r\n                            } catch (fetchErr) {\r\n                                lastError = fetchErr.message;\r\n                            }\r\n                        }\r\n\r\n                        // If already responded (model loading case)\r\n                        if (response) break;\r\n\r\n                        if (!hfResponse || !hfResponse.ok) {\r\n                            console.error('[TTS] All endpoints failed:', lastError);\r\n                            response = json({ error: 'TTS failed', details: lastError }, 500);\r\n                            break;\r\n                        }\r\n\r\n                        // Return audio directly\r\n                        const audioBuffer = await hfResponse.arrayBuffer();\r\n                        response = new Response(audioBuffer, {\r\n                            status: 200,\r\n                            headers: {\r\n                                'Content-Type': 'audio/flac',\r\n                                'Cache-Control': 'public, max-age=3600'\r\n                            }\r\n                        });\r\n                    } catch (ttsError) {\r\n                        console.error('[TTS] Error:', ttsError);\r\n                        response = json({ error: 'TTS processing failed', message: ttsError.message }, 500);\r\n                    }\r\n                    break;\r\n\r\n                default:\r\n                    response = json({ error: 'not_found', path: url.pathname }, 404);\r\n            }\r\n\r\n            // Log response v\u1EDBi metrics\r\n            trace.logResponse(response.status);\r\n            return wrapResponse(response);\r\n\r\n        } catch (error) {\r\n            // Log error v\u1EDBi trace context\r\n            trace.logError(error, { route: route || 'unknown' });\r\n            const errorResponse = json({ error: 'server_error', message: error.message }, 500, origin);\r\n            trace.logResponse(500);\r\n            return wrapResponse(errorResponse);\r\n        }\r\n    }\r\n};\r\n", "// backend/workers/rate-limiter.js\r\n// Ch\u00FA th\u00EDch: Rate limiting cho Cloudflare Workers\r\n// S\u1EED d\u1EE5ng D1 database \u0111\u1EC3 l\u01B0u rate limit state (ho\u1EB7c c\u00F3 th\u1EC3 d\u00F9ng KV n\u1EBFu c\u1EA7n)\r\n\r\n/**\r\n * Rate limit configuration\r\n */\r\nconst RATE_LIMITS = {\r\n  // Per-user rate limits\r\n  user: {\r\n    windowMs: 60 * 1000, // 1 minute\r\n    maxRequests: 100, // 100 requests per minute\r\n  },\r\n  \r\n  // Per-IP rate limits (fallback khi kh\u00F4ng c\u00F3 user_id)\r\n  ip: {\r\n    windowMs: 60 * 1000,\r\n    maxRequests: 200, // 200 requests per minute per IP\r\n  },\r\n  \r\n  // AI chat endpoint c\u00F3 limit ri\u00EAng (t\u1ED1n token)\r\n  aiChat: {\r\n    windowMs: 60 * 1000,\r\n    maxRequests: 30, // 30 requests per minute\r\n  },\r\n};\r\n\r\n/**\r\n * Get rate limit key t\u1EEB request\r\n * @param {Request} request \r\n * @returns {string} Rate limit key\r\n */\r\nfunction getRateLimitKey(request, endpoint = '') {\r\n  const userId = request.headers.get('X-User-Id');\r\n  const ip = request.headers.get('CF-Connecting-IP') || \r\n             request.headers.get('X-Forwarded-For')?.split(',')[0] || \r\n             'unknown';\r\n  \r\n  // N\u1EBFu c\u00F3 user_id, d\u00F9ng user_id l\u00E0m key\r\n  if (userId) {\r\n    return `user:${userId}:${endpoint}`;\r\n  }\r\n  \r\n  // Fallback v\u1EC1 IP\r\n  return `ip:${ip}:${endpoint}`;\r\n}\r\n\r\n/**\r\n * Get rate limit config cho endpoint\r\n * @param {string} endpoint - Endpoint path\r\n * @returns {Object} Rate limit config\r\n */\r\nfunction getRateLimitConfig(endpoint) {\r\n  // AI chat c\u00F3 limit ri\u00EAng\r\n  if (endpoint.includes('/api/chat') || endpoint === '/') {\r\n    return RATE_LIMITS.aiChat;\r\n  }\r\n  \r\n  // Default: user limit\r\n  return RATE_LIMITS.user;\r\n}\r\n\r\n/**\r\n * Check rate limit\r\n * @param {Request} request \r\n * @param {Object} env - Cloudflare env v\u1EDBi D1 binding\r\n * @param {string} endpoint - Endpoint path\r\n * @returns {Promise<{allowed: boolean, remaining: number, resetAt: number}>}\r\n */\r\nexport async function checkRateLimit(request, env, endpoint = '') {\r\n  const key = getRateLimitKey(request, endpoint);\r\n  const config = getRateLimitConfig(endpoint);\r\n  const now = Date.now();\r\n  const windowStart = now - config.windowMs;\r\n\r\n  try {\r\n    // L\u1EA5y current count t\u1EEB D1\r\n    // Table: rate_limits (key TEXT PRIMARY KEY, count INTEGER, reset_at INTEGER)\r\n    const result = await env.ban_dong_hanh_db.prepare(\r\n      'SELECT count, reset_at FROM rate_limits WHERE key = ?'\r\n    ).bind(key).first();\r\n\r\n    if (!result) {\r\n      // Ch\u01B0a c\u00F3 record, t\u1EA1o m\u1EDBi\r\n      await env.ban_dong_hanh_db.prepare(\r\n        'INSERT INTO rate_limits (key, count, reset_at) VALUES (?, 1, ?)'\r\n      ).bind(key, now + config.windowMs).run();\r\n      \r\n      return {\r\n        allowed: true,\r\n        remaining: config.maxRequests - 1,\r\n        resetAt: now + config.windowMs,\r\n      };\r\n    }\r\n\r\n    // Check n\u1EBFu \u0111\u00E3 h\u1EBFt window, reset\r\n    if (result.reset_at < now) {\r\n      await env.ban_dong_hanh_db.prepare(\r\n        'UPDATE rate_limits SET count = 1, reset_at = ? WHERE key = ?'\r\n      ).bind(now + config.windowMs, key).run();\r\n      \r\n      return {\r\n        allowed: true,\r\n        remaining: config.maxRequests - 1,\r\n        resetAt: now + config.windowMs,\r\n      };\r\n    }\r\n\r\n    // Check n\u1EBFu v\u01B0\u1EE3t limit\r\n    if (result.count >= config.maxRequests) {\r\n      return {\r\n        allowed: false,\r\n        remaining: 0,\r\n        resetAt: result.reset_at,\r\n      };\r\n    }\r\n\r\n    // Increment count\r\n    await env.ban_dong_hanh_db.prepare(\r\n      'UPDATE rate_limits SET count = count + 1 WHERE key = ?'\r\n    ).bind(key).run();\r\n\r\n    return {\r\n      allowed: true,\r\n      remaining: config.maxRequests - result.count - 1,\r\n      resetAt: result.reset_at,\r\n    };\r\n\r\n  } catch (error) {\r\n    // N\u1EBFu c\u00F3 l\u1ED7i DB, cho ph\u00E9p request (fail open)\r\n    console.error('[RateLimit] Error:', error.message);\r\n    return {\r\n      allowed: true,\r\n      remaining: config.maxRequests,\r\n      resetAt: now + config.windowMs,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware function \u0111\u1EC3 check rate limit v\u00E0 tr\u1EA3 v\u1EC1 response n\u1EBFu v\u01B0\u1EE3t\r\n * @param {Request} request \r\n * @param {Object} env \r\n * @param {string} endpoint \r\n * @returns {Promise<Response|null>} Response n\u1EBFu v\u01B0\u1EE3t limit, null n\u1EBFu OK\r\n */\r\nexport async function rateLimitMiddleware(request, env, endpoint = '') {\r\n  const limit = await checkRateLimit(request, env, endpoint);\r\n  \r\n  if (!limit.allowed) {\r\n    return new Response(JSON.stringify({\r\n      error: 'rate_limit_exceeded',\r\n      message: 'B\u1EA1n \u0111\u00E3 g\u1EEDi qu\u00E1 nhi\u1EC1u y\u00EAu c\u1EA7u. Vui l\u00F2ng th\u1EED l\u1EA1i sau.',\r\n      resetAt: new Date(limit.resetAt).toISOString(),\r\n    }), {\r\n      status: 429,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-RateLimit-Limit': String(getRateLimitConfig(endpoint).maxRequests),\r\n        'X-RateLimit-Remaining': String(limit.remaining),\r\n        'X-RateLimit-Reset': String(limit.resetAt),\r\n        'Retry-After': String(Math.ceil((limit.resetAt - Date.now()) / 1000)),\r\n        // CORS headers s\u1EBD \u0111\u01B0\u1EE3c th\u00EAm b\u1EDFi router.js wrapResponse\r\n      },\r\n    });\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": ["json", "url", "wantsStream", "hybridSearch", "formatRAGContext", "bm25Search", "result", "getUserId", "json", "json", "getUserId", "getAllowedOrigin", "corsHeaders", "json", "handleOptions"]
}
